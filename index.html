<!DOCTYPE html>
<html lang="pt-BR">
<head><link rel="manifest" href="manifest.json">
<!-- Adicione também meta tags para theme-color se não estiverem no manifest -->
<meta name="theme-color" content="#007bff"> <!-- Use a cor principal do seu tema -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Professor Pro</title>
    <!-- Incluir html2pdf.js via CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* Reset Básico */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scroll */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
            transition: background-color 0.4s ease, color 0.4s ease, background-image 0.4s ease;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            position: relative;
            background-color: var(--bg-primary);
            background-image: var(--theme-background-image);
        }

        /* Variáveis de Tema (Default: Claro) */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --bg-secondary-alpha: rgba(248, 249, 250, 0.98);
            --bg-tertiary-alpha: rgba(233, 236, 239, 0.96);
            --bg-sticky-alpha: rgba(248, 249, 250, 0.98);
            --bg-modal-alpha: #ffffff;
            --bg-notification: #4caf50; /* Green for notifications */
            --text-notification: #ffffff;

            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-primary: #007bff;
            --accent-secondary: #6c757d;
            --accent-success: #28a745;
            --accent-danger: #dc3545;
            --accent-warning: #ffc107; /* Amarelo para FJ */
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --input-bg: #fff;
            --input-border: #ced4da;
            --nav-height: 65px;
            --fab-bottom-margin: 15px;
            --theme-background-image: none;
            --theme-background-opacity: 1;
            --theme-background-blend-mode: normal;
            --theme-background-filter: none;
             /* Grade Colors (Light) - Fallback if no custom ranges */
             --grade-low-bg: #f8d7da; --grade-low-text: #721c24;
             --grade-medium-bg: #fff3cd; --grade-medium-text: #856404;
             --grade-high-bg: #d4edda; --grade-high-text: #155724;
             /* Attendance Colors (Light) */
             --attendance-holiday-bg: #e2e3e5; --attendance-holiday-text: #495057; /* Non-school day */
             /* Classroom Map Colors */
             --map-seat-bg: var(--input-bg);
             --map-seat-border: var(--input-border);
             --map-seat-text: var(--text-secondary);
             --map-seat-occupied-bg: color-mix(in srgb, var(--accent-primary) 15%, transparent);
             --map-seat-occupied-text: var(--text-primary);
             --map-teacher-desk-bg: var(--bg-tertiary);
             --map-teacher-desk-border: var(--accent-secondary);
             --map-drag-over-bg: color-mix(in srgb, var(--accent-success) 30%, transparent);
             --map-seat-selected-border: var(--accent-warning);
             /* Teacher Desk Dimensions */
             --teacher-desk-width: 80px;
             --teacher-desk-height: 45px;
             --teacher-desk-border-width: 3px;
             /* Seat Dimensions */
             --seat-width: 65px;
             --seat-height: 45px;
             --seat-gap: 6px;
             /* Tools Grid */
             --tool-card-min-width: 130px;
             /* Calculator */
            --calc-display-bg: var(--bg-tertiary-alpha);
            --calc-button-bg: var(--accent-primary);
            --calc-button-text: #ffffff;
            --calc-op-button-bg: color-mix(in srgb, var(--accent-primary) 80%, #ffffff);
            --calc-util-button-bg: var(--accent-secondary);
            --calc-danger-button-bg: var(--accent-danger);
            --calc-warn-button-bg: var(--accent-warning);
            --calc-button-hover-opacity: 0.85;
            --calc-button-active-scale: 0.96;
            --calc-mode-button-bg: var(--bg-tertiary);
            --calc-mode-button-text: var(--text-secondary);
            --calc-mode-button-active-bg: var(--accent-primary);
            --calc-mode-button-active-text: #ffffff;

        }

        /* Pseudo-elemento para background pattern com opacidade */
        body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: var(--theme-background-image); background-color: transparent; background-repeat: repeat; background-attachment: fixed; background-size: auto; background-position: center; opacity: var(--theme-background-opacity); mix-blend-mode: var(--theme-background-blend-mode); filter: var(--theme-background-filter); z-index: -1; pointer-events: none; transition: opacity 0.4s ease; }

        /* --- TEMAS --- */
         body.theme-light { --bg-secondary-alpha: var(--bg-secondary); --bg-tertiary-alpha: var(--bg-tertiary); --bg-sticky-alpha: var(--bg-secondary); --bg-modal-alpha: var(--bg-primary); --theme-background-image: none; --theme-background-opacity: 0; --grade-low-bg: #f8d7da; --grade-low-text: #721c24; --grade-medium-bg: #fff3cd; --grade-medium-text: #856404; --grade-high-bg: #d4edda; --grade-high-text: #155724; --attendance-holiday-bg: #e2e3e5; --attendance-holiday-text: #495057; --bg-notification: #4caf50; --text-notification: #ffffff; }
         body.theme-light button.absent.justified.selected { color: var(--text-primary); }
         body.theme-light .monthly-attendance-table td.status-F { background-color: var(--grade-low-bg); color: var(--grade-low-text); }
         body.theme-light .monthly-attendance-table td.status-FJ { background-color: var(--grade-medium-bg); color: var(--grade-medium-text); }
         body.theme-light .monthly-attendance-table td.status-P { background-color: var(--grade-high-bg); color: var(--grade-high-text); }
         body.theme-light .monthly-attendance-table td.status-H { background-color: var(--attendance-holiday-bg); color: var(--attendance-holiday-text); font-style: italic; }
         body.theme-light .seat-placeholder-text { color: var(--map-seat-text); }
         body.theme-light .calculator-buttons button.op { background-color: #6c757d; color: #fff; }
         body.theme-light .calculator-buttons button.util { background-color: #adb5bd; color: var(--text-primary); }
         body.theme-light .calculator-buttons button.danger { background-color: #dc3545; color: #fff; }
         body.theme-light .calculator-buttons button.warn { background-color: #ffc107; color: var(--text-primary); }
         body.theme-light .calculator-buttons button.eq { background-color: #28a745; color: #fff; }
         body.theme-light .calculator-modal .pairs-list { background-color: var(--bg-tertiary-alpha); }
         body.theme-light .calculator-modal .pair-item { background-color: var(--bg-secondary-alpha); }
        body.theme-dark { --bg-primary: #212529; --bg-secondary: #343a40; --bg-tertiary: #495057; --bg-secondary-alpha: var(--bg-secondary); --bg-tertiary-alpha: var(--bg-tertiary); --bg-sticky-alpha: var(--bg-secondary); --bg-modal-alpha: #2c3034; --text-primary: #f8f9fa; --text-secondary: #adb5bd; --accent-primary: #3b82f6; --accent-secondary: #6b7280; --accent-success: #22c55e; --accent-danger: #ef4444; --accent-warning: #f59e0b; --border-color: #4b5563; --shadow-color: rgba(255, 255, 255, 0.08); --input-bg: #374151; --input-border: #4b5563; --theme-background-image: none; --theme-background-opacity: 0; --grade-low-bg: color-mix(in srgb, var(--accent-danger) 25%, transparent); --grade-low-text: #f8f9fa; --grade-medium-bg: color-mix(in srgb, var(--accent-warning) 30%, transparent); --grade-medium-text: #111827; --grade-high-bg: color-mix(in srgb, var(--accent-success) 25%, transparent); --grade-high-text: #f8f9fa; --attendance-holiday-bg: #495057; --attendance-holiday-text: #ced4da; --bg-notification: #22c55e; --text-notification: #111827; --map-seat-bg: var(--input-bg); --map-seat-border: var(--input-border); --map-seat-text: var(--text-secondary); --map-seat-occupied-bg: color-mix(in srgb, var(--accent-primary) 20%, transparent); --map-seat-occupied-text: var(--text-primary); --map-teacher-desk-bg: var(--bg-tertiary); --map-teacher-desk-border: var(--accent-secondary); --map-drag-over-bg: color-mix(in srgb, var(--accent-success) 35%, transparent); --map-seat-selected-border: var(--accent-warning); --calc-button-bg: var(--accent-primary); --calc-button-text: #ffffff; --calc-op-button-bg: color-mix(in srgb, var(--accent-primary) 70%, #000000); --calc-util-button-bg: var(--accent-secondary); --calc-danger-button-bg: var(--accent-danger); --calc-warn-button-bg: var(--accent-warning); --calc-mode-button-bg: var(--bg-tertiary); --calc-mode-button-text: var(--text-secondary); --calc-mode-button-active-bg: var(--accent-primary); --calc-mode-button-active-text: #ffffff; }
         body.theme-dark button.warning { color: #111827; }
         body.theme-dark button.absent.justified.selected { color: #111827; }
         body.theme-dark .monthly-attendance-table td.status-F { background-color: var(--grade-low-bg); color: var(--grade-low-text); }
         body.theme-dark .monthly-attendance-table td.status-FJ { background-color: var(--grade-medium-bg); color: var(--grade-medium-text); }
         body.theme-dark .monthly-attendance-table td.status-P { background-color: var(--grade-high-bg); color: var(--grade-high-text); }
         body.theme-dark .monthly-attendance-table td.status-H { background-color: var(--attendance-holiday-bg); color: var(--attendance-holiday-text); font-style: italic; }
         body.theme-dark .seat-placeholder-text { color: var(--map-seat-text); }
         body.theme-dark .calculator-buttons button.warn { color: var(--text-primary); }
         body.theme-dark .calculator-modal .pairs-list { background-color: var(--bg-tertiary-alpha); }
         body.theme-dark .calculator-modal .pair-item { background-color: var(--bg-secondary-alpha); border-color: var(--input-border); }
        body.theme-forest-green { --bg-primary: #f0fff4; --bg-secondary: #dff1e5; --bg-tertiary: #c8e6d1; --bg-secondary-alpha: var(--bg-secondary); --bg-tertiary-alpha: var(--bg-tertiary); --bg-sticky-alpha: var(--bg-secondary); --bg-modal-alpha: #e8f5e9; --text-primary: #1e3a1f; --text-secondary: #4a7c59; --accent-primary: #588157; --accent-secondary: #3a5a40; --accent-warning: #e9c46a; --border-color: #a3c9a8; --shadow-color: rgba(58, 90, 64, 0.15); --input-bg: #ffffff; --input-border: #a3c9a8; --theme-background-image: none; --theme-background-opacity: 0; --grade-low-bg: #f1dede; --grade-low-text: #a94442; --grade-medium-bg: #faf2cc; --grade-medium-text: #8a6d3b; --grade-high-bg: #dff1e5; --grade-high-text: #3c763d; --attendance-holiday-bg: #d1e7dd; --attendance-holiday-text: #4a7c59; --bg-notification: #588157; --text-notification: #ffffff; --map-seat-bg: var(--input-bg); --map-seat-border: var(--input-border); --map-seat-text: var(--text-secondary); --map-seat-occupied-bg: color-mix(in srgb, var(--accent-primary) 15%, transparent); --map-seat-occupied-text: var(--text-primary); --map-teacher-desk-bg: var(--bg-tertiary); --map-teacher-desk-border: var(--accent-secondary); --map-drag-over-bg: color-mix(in srgb, var(--accent-success) 30%, transparent); --map-seat-selected-border: var(--accent-warning); --calc-button-bg: var(--accent-primary); --calc-button-text: #ffffff; --calc-op-button-bg: color-mix(in srgb, var(--accent-primary) 85%, #ffffff); --calc-util-button-bg: var(--accent-secondary); --calc-danger-button-bg: #c1666b; --calc-warn-button-bg: var(--accent-warning); --calc-mode-button-bg: var(--bg-tertiary); --calc-mode-button-text: var(--text-secondary); --calc-mode-button-active-bg: var(--accent-primary); --calc-mode-button-active-text: #ffffff; }
         body.theme-forest-green button.warning { color: var(--text-primary); }
         body.theme-forest-green button.absent.justified.selected { color: var(--text-primary); }
         body.theme-forest-green .monthly-attendance-table td.status-F { background-color: var(--grade-low-bg); color: var(--grade-low-text); }
         body.theme-forest-green .monthly-attendance-table td.status-FJ { background-color: var(--grade-medium-bg); color: var(--grade-medium-text); }
         body.theme-forest-green .monthly-attendance-table td.status-P { background-color: var(--grade-high-bg); color: var(--grade-high-text); }
         body.theme-forest-green .monthly-attendance-table td.status-H { background-color: var(--attendance-holiday-bg); color: var(--attendance-holiday-text); font-style: italic; }
         body.theme-forest-green .seat-placeholder-text { color: var(--map-seat-text); }
         body.theme-forest-green .calculator-buttons button.warn { color: var(--text-primary); }
         body.theme-forest-green .calculator-modal .pairs-list { background-color: var(--bg-tertiary-alpha); }
         body.theme-forest-green .calculator-modal .pair-item { background-color: var(--bg-secondary-alpha); border-color: var(--input-border); }
        body.theme-math-master { --bg-primary: #e0f7ff; --bg-secondary: #ccecf7; --bg-tertiary: #b8e5f0; --bg-secondary-alpha: rgba(204, 236, 247, 0.96); --bg-tertiary-alpha: rgba(184, 229, 240, 0.94); --bg-sticky-alpha: rgba(204, 236, 247, 0.98); --bg-modal-alpha: #e0f7ff; --text-primary: #00405a; --text-secondary: #40788c; --accent-primary: #006688; --accent-secondary: #5a9cb0; --accent-warning: #fca311; --border-color: #a8d8e6; --input-bg: #ffffff; --input-border: #8fc5d6; --theme-background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 160 160'%3E%3Cstyle%3E text %7B fill: %23006688; opacity: 0.06; font-weight: 500; font-family: 'Cambria Math', 'Latin Modern Math', serif; %7D path, line %7B stroke: %23006688; opacity: 0.05; stroke-width: 1px; fill: none; %7D %3C/style%3E%3Ctext x='15' y='40' font-size='18' transform='rotate(-12 15,40)'%3Eƒ(x)%3C/text%3E%3Ctext x='100' y='30' font-size='22'%3E∑%3C/text%3E%3Cpath d='M 70 60 q 20 25 40 0 t 40 0' stroke-dasharray='3 3'/%3E%3Ctext x='30' y='110' font-size='20'%3E∫%3C/text%3E%3Cpath d='M 110 80 c -15 15 -15 40 0 55' /%3E%3Ctext x='130' y='145' font-size='16'%3E2πr%3C/text%3E%3Ctext x='60' y='135' font-size='24'%3E±%3C/text%3E%3Cline x1='10' y1='140' x2='40' y2='150'/%3E%3C/svg%3E"); --theme-background-opacity: 1; --theme-background-blend-mode: overlay; --theme-background-filter: grayscale(10%); --grade-low-bg: #f8d7da; --grade-low-text: #721c24; --grade-medium-bg: #fff3cd; --grade-medium-text: #856404; --grade-high-bg: #d4edda; --grade-high-text: #155724; --attendance-holiday-bg: #b8e5f0; --attendance-holiday-text: #00405a; --bg-notification: #006688; --text-notification: #ffffff; --map-seat-bg: var(--input-bg); --map-seat-border: var(--input-border); --map-seat-text: var(--text-secondary); --map-seat-occupied-bg: color-mix(in srgb, var(--accent-primary) 15%, transparent); --map-seat-occupied-text: var(--text-primary); --map-teacher-desk-bg: var(--bg-tertiary); --map-teacher-desk-border: var(--accent-secondary); --map-drag-over-bg: color-mix(in srgb, var(--accent-success) 30%, transparent); --map-seat-selected-border: var(--accent-warning); --calc-button-bg: #0077a0; --calc-button-text: #ffffff; --calc-op-button-bg: #005577; --calc-util-button-bg: var(--accent-secondary); --calc-danger-button-bg: #d9534f; --calc-warn-button-bg: var(--accent-warning); --calc-mode-button-bg: var(--bg-tertiary); --calc-mode-button-text: var(--text-secondary); --calc-mode-button-active-bg: var(--accent-primary); --calc-mode-button-active-text: #ffffff; }
         body.theme-math-master button.warning { color: var(--text-primary); }
         body.theme-math-master button.absent.justified.selected { color: #fff; }
         body.theme-math-master .monthly-attendance-table td.status-F { background-color: var(--grade-low-bg); color: var(--grade-low-text); }
         body.theme-math-master .monthly-attendance-table td.status-FJ { background-color: var(--grade-medium-bg); color: var(--grade-medium-text); }
         body.theme-math-master .monthly-attendance-table td.status-P { background-color: var(--grade-high-bg); color: var(--grade-high-text); }
         body.theme-math-master .monthly-attendance-table td.status-H { background-color: var(--attendance-holiday-bg); color: var(--attendance-holiday-text); font-style: italic; }
         body.theme-math-master .seat-placeholder-text { color: var(--map-seat-text); }
         body.theme-math-master .calculator-buttons button.warn { color: var(--text-primary); }
         body.theme-math-master .calculator-modal .pairs-list { background-color: var(--bg-tertiary-alpha); }
         body.theme-math-master .calculator-modal .pair-item { background-color: var(--bg-secondary-alpha); border-color: var(--input-border); }
        body.theme-historic-scroll { --bg-primary: #fdf6e3; --bg-secondary: #f5efdc; --bg-tertiary: #ebe3cd; --bg-secondary-alpha: rgba(245, 239, 220, 0.97); --bg-tertiary-alpha: rgba(235, 227, 205, 0.96); --bg-sticky-alpha: rgba(245, 239, 220, 0.98); --bg-modal-alpha: #fdf6e3; --text-primary: #654b28; --text-secondary: #8c785e; --accent-primary: #8b4513; --accent-secondary: #a0522d; --accent-warning: #d4a373; --border-color: #d2b48c; --input-bg: #fffaf0; --input-border: #deb887; --theme-background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'%3E%3Cstyle%3E text %7B fill: %238b4513; opacity: 0.08; font-family: 'Segoe UI Symbol', sans-serif; %7D path %7B stroke: %238b4513; opacity: 0.07; stroke-width: 0.7px; fill: none; %7D %3C/style%3E%3Ctext x='20' y='45' font-size='30'%3E𓂀%3C/text%3E %3C!-- Eye of Horus --%3E%3Ctext x='120' y='35' font-size='26'%3E𓆗%3C/text%3E %3C!-- Cobra --%3E%3Cpath d='M 60 70 h 50 v 15 h -50 z' /%3E%3Ctext x='30' y='120' font-size='28'%3E𓅊%3C/text%3E %3C!-- Bird --%3E%3Cpath d='M 100 90 l 25 50 l -50 0 z' /%3E%3Ctext x='130' y='150' font-size='24'%3E𓍑%3C/text%3E%3C!-- Staff --%3E%3Ctext x='70' y='140' font-size='22'%3E🏺%3C/text%3E%3C/svg%3E"); --theme-background-opacity: 1; --theme-background-blend-mode: multiply; --theme-background-filter: sepia(25%); --grade-low-bg: #f1dede; --grade-low-text: #a94442; --grade-medium-bg: #faf2cc; --grade-medium-text: #8a6d3b; --grade-high-bg: #dff1e5; --grade-high-text: #3c763d; --attendance-holiday-bg: #ebe3cd; --attendance-holiday-text: #654b28; --bg-notification: #8b4513; --text-notification: #fdf6e3; --map-seat-bg: var(--input-bg); --map-seat-border: var(--input-border); --map-seat-text: var(--text-secondary); --map-seat-occupied-bg: color-mix(in srgb, var(--accent-primary) 15%, transparent); --map-seat-occupied-text: var(--text-primary); --map-teacher-desk-bg: var(--bg-tertiary); --map-teacher-desk-border: var(--accent-secondary); --map-drag-over-bg: color-mix(in srgb, var(--accent-success) 30%, transparent); --map-seat-selected-border: var(--accent-warning); --calc-button-bg: var(--accent-primary); --calc-button-text: #fdf6e3; --calc-op-button-bg: var(--accent-secondary); --calc-util-button-bg: #b08968; --calc-danger-button-bg: #ae2012; --calc-warn-button-bg: var(--accent-warning); --calc-mode-button-bg: var(--bg-tertiary); --calc-mode-button-text: var(--text-secondary); --calc-mode-button-active-bg: var(--accent-primary); --calc-mode-button-active-text: #fdf6e3; }
         body.theme-historic-scroll button.warning { color: var(--text-primary); }
         body.theme-historic-scroll button.absent.justified.selected { color: var(--text-primary); }
         body.theme-historic-scroll .monthly-attendance-table td.status-F { background-color: var(--grade-low-bg); color: var(--grade-low-text); }
         body.theme-historic-scroll .monthly-attendance-table td.status-FJ { background-color: var(--grade-medium-bg); color: var(--grade-medium-text); }
         body.theme-historic-scroll .monthly-attendance-table td.status-P { background-color: var(--grade-high-bg); color: var(--grade-high-text); }
         body.theme-historic-scroll .monthly-attendance-table td.status-H { background-color: var(--attendance-holiday-bg); color: var(--attendance-holiday-text); font-style: italic; }
         body.theme-historic-scroll .seat-placeholder-text { color: var(--map-seat-text); }
         body.theme-historic-scroll .calculator-buttons button.warn { color: var(--text-primary); }
         body.theme-historic-scroll .calculator-modal .pairs-list { background-color: var(--bg-tertiary-alpha); }
         body.theme-historic-scroll .calculator-modal .pair-item { background-color: var(--bg-secondary-alpha); border-color: var(--input-border); }
        body.theme-alchemist { --bg-primary: #2a2a3e; --bg-secondary: #3a3a52; --bg-tertiary: #4a4a66; --bg-secondary-alpha: rgba(58, 58, 82, 0.97); --bg-tertiary-alpha: rgba(74, 74, 102, 0.95); --bg-sticky-alpha: rgba(58, 58, 82, 0.98); --bg-modal-alpha: #2a2a3e; --text-primary: #e0e0ff; --text-secondary: #a0a0cc; --accent-primary: #ffd700; --accent-secondary: #c0c0c0; --accent-success: #32cd32; --accent-danger: #dc143c; --accent-warning: #ff8c00; --border-color: #5a5a7a; --shadow-color: rgba(0, 0, 0, 0.25); --input-bg: #4a4a66; --input-border: #6a6a8a; --theme-background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150' viewBox='0 0 150 150'%3E%3Cstyle%3E text %7B fill: %23ffd700; opacity: 0.07; font-size: 24px; %7D path, circle %7B stroke: %23ffd700; opacity: 0.06; stroke-width: 0.8px; fill: none; %7D %3C/style%3E%3Ctext x='20' y='45'%3E☉%3C/text%3E%3Ccircle cx='95' cy='35' r='12'/%3E%3Cpath d='M 90 35 h 10 M 95 30 v 10'/%3E%3Ctext x='30' y='110' font-size='28'%3E△%3C/text%3E%3Cpath d='M 70 85 l 40 0 l -20 35 z' transform='rotate(180 90 102.5)'/%3E%3Ctext x='120' y='135' font-size='20'%3E♃%3C/text%3E%3Ctext x='65' y='70' font-size='28'%3E☾%3C/text%3E%3Ctext x='100' y='80' font-size='22'%3E⚕%3C/text%3E%3C/svg%3E"); --theme-background-opacity: 1; --theme-background-blend-mode: overlay; --grade-low-bg: color-mix(in srgb, var(--accent-danger) 25%, transparent); --grade-low-text: #f8f9fa; --grade-medium-bg: color-mix(in srgb, var(--accent-warning) 30%, transparent); --grade-medium-text: #1a1a2e; --grade-high-bg: color-mix(in srgb, var(--accent-success) 25%, transparent); --grade-high-text: #f8f9fa; --attendance-holiday-bg: #4a4a66; --attendance-holiday-text: #a0a0cc; --bg-notification: #ffd700; --text-notification: #2a2a3e; --map-seat-bg: var(--input-bg); --map-seat-border: var(--input-border); --map-seat-text: var(--text-secondary); --map-seat-occupied-bg: color-mix(in srgb, var(--accent-primary) 20%, transparent); --map-seat-occupied-text: var(--text-primary); --map-teacher-desk-bg: var(--bg-tertiary); --map-teacher-desk-border: var(--accent-secondary); --map-drag-over-bg: color-mix(in srgb, var(--accent-success) 35%, transparent); --map-seat-selected-border: var(--accent-warning); --calc-button-bg: #6a6a8a; --calc-button-text: #e0e0ff; --calc-op-button-bg: #5a5a7a; --calc-util-button-bg: var(--accent-secondary); --calc-danger-button-bg: var(--accent-danger); --calc-warn-button-bg: var(--accent-warning); --calc-mode-button-bg: var(--bg-tertiary); --calc-mode-button-text: var(--text-secondary); --calc-mode-button-active-bg: var(--accent-primary); --calc-mode-button-active-text: #2a2a3e; }
         body.theme-alchemist button.warning { color: #1a1a2e; }
         body.theme-alchemist button.absent.justified.selected { color: #1a1a2e; }
         body.theme-alchemist .monthly-attendance-table td.status-F { background-color: var(--grade-low-bg); color: var(--grade-low-text); }
         body.theme-alchemist .monthly-attendance-table td.status-FJ { background-color: var(--grade-medium-bg); color: var(--grade-medium-text); }
         body.theme-alchemist .monthly-attendance-table td.status-P { background-color: var(--grade-high-bg); color: var(--grade-high-text); }
         body.theme-alchemist .monthly-attendance-table td.status-H { background-color: var(--attendance-holiday-bg); color: var(--attendance-holiday-text); font-style: italic; }
         body.theme-alchemist .seat-placeholder-text { color: var(--map-seat-text); }
         body.theme-alchemist .calculator-buttons button.warn { color: var(--text-primary); }
         body.theme-alchemist .calculator-modal .pairs-list { background-color: var(--bg-tertiary-alpha); }
         body.theme-alchemist .calculator-modal .pair-item { background-color: var(--bg-secondary-alpha); border-color: var(--input-border); }
         body.theme-alchemist .calculator-buttons button.num,
         body.theme-alchemist .calculator-buttons button.op,
         body.theme-alchemist .calculator-buttons button.util,
         body.theme-alchemist .calculator-buttons button.eq { color: var(--text-primary); }
         body.theme-alchemist .calculator-buttons button.warn { color: #1a1a2e; }
        /* --- FIM TEMAS --- */

        /* Estilos Gerais, Layout Principal, Seções, Cards, Listas, Modal, Tabelas */
        body { background-color: var(--bg-primary); color: var(--text-primary); }
        h1, h2, h3, h4, h5, h6 { color: var(--text-primary); margin-bottom: 0.75rem; font-weight: 600; }
        h2 { text-align: center; width: 100%; margin-top: 0.5rem; margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5em; }
        p { color: var(--text-secondary); line-height: 1.6; margin-bottom: 1rem; }
        a { color: var(--accent-primary); text-decoration: none; transition: color 0.2s ease; }
        a:hover { color: var(--accent-secondary); text-decoration: underline; }
        button, .button-like { padding: 0.6rem 1.2rem; border: none; border-radius: 5px; cursor: pointer; font-size: 0.95rem; font-weight: 500; transition: background-color 0.2s ease, transform 0.15s cubic-bezier(0.2, 0, 0.38, 0.9), opacity 0.2s ease; background-color: var(--accent-primary); color: #fff; margin: 0.25rem; display: inline-flex; align-items: center; justify-content: center; text-align: center; vertical-align: middle; line-height: 1.4; user-select: none; /* Prevent text selection */ }
        button:hover, .button-like:hover { opacity: 0.85; }
        button:active, .button-like:active { transform: scale(0.96); }
        button:disabled, .button-like:disabled { opacity: 0.6; cursor: not-allowed; background-color: var(--accent-secondary); }
        form button:not([type="submit"]) { type: button; }
        button.secondary, .button-like.secondary { background-color: var(--accent-secondary); color: #fff; }
        button.danger, .button-like.danger { background-color: var(--accent-danger); color: #fff; }
        button.success, .button-like.success { background-color: var(--accent-success); color: #fff; }
        button.warning, .button-like.warning { background-color: var(--accent-warning); color: var(--text-primary); }
        button.icon-button, .button-like.icon-button { padding: 0.4rem; font-size: 1.1rem; line-height: 1; background-color: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 5px; margin: 0 2px; }
        button.icon-button:hover, .button-like.icon-button:hover { color: var(--accent-primary); background-color: var(--bg-tertiary-alpha); border-color: var(--accent-primary); }
        button.icon-button:disabled { background-color: transparent; border-color: var(--border-color); color: var(--text-secondary); opacity: 0.5; }
        input[type="text"], input[type="time"], input[type="number"], input[type="date"], select, textarea, input[type="search"], input[type="color"] { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid var(--input-border); border-radius: 5px; background-color: var(--input-bg); color: var(--text-primary); font-size: 1rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        input[type="color"] { padding: 0.2rem; height: 40px; width: 50px; vertical-align: middle; cursor: pointer;}
        input:focus, select:focus, textarea:focus, input[type="search"]:focus, input[type="color"]:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-primary) 20%, transparent); }
        input[type="checkbox"] { width: auto; margin-bottom: 0; margin-right: 5px; vertical-align: middle; }
        textarea { min-height: 100px; resize: vertical; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        label[for*="checkbox"], label[for*="radio"] { display: inline; font-weight: normal; margin-bottom: 0; }
        .form-group { margin-bottom: 1rem; }
        .checkbox-group { margin-bottom: 0.5rem; padding: 5px 0; display: flex; align-items: center;}
        .app-header { background-color: var(--bg-secondary-alpha); padding: 0.6rem 1rem; border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 4px var(--shadow-color); position: sticky; top: 0; z-index: 1000; flex-shrink: 0; transition: background-color 0.4s ease; display: flex; flex-direction: column; gap: 0.5rem; }
        .header-top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 0.8rem; min-height: 2em; }
        .app-header h1 { margin: 0; font-size: 1.3rem; color: var(--accent-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; min-width: 0; flex-basis: auto; }
        .header-info { font-size: 0.8rem; color: var(--text-secondary); text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; min-width: 0; margin-left: auto; padding-left: 10px; }
        #search-input { width: 100%; margin: 0; padding: 0.4rem 0.8rem; font-size: 0.9rem; margin-bottom: 0; }
        .app-content { flex-grow: 1; overflow-y: auto; padding: 1rem; background-color: transparent; -webkit-overflow-scrolling: touch; padding-bottom: calc(var(--nav-height) + 10px); }
        .app-nav { background-color: var(--bg-secondary-alpha); padding: 0.4rem 0; display: flex; justify-content: space-around; align-items: stretch; border-top: 1px solid var(--border-color); position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; flex-shrink: 0; height: var(--nav-height); box-shadow: 0 -2px 5px var(--shadow-color); transition: background-color 0.4s ease; }
        /* Ajuste para 7 botões */
        .nav-button { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.7rem; /* Reduzido */ text-align: center; padding: 0.4rem 0.2rem; /* Reduzido padding horizontal */ display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; height: 100%; border-radius: 0; transition: background-color 0.25s ease, color 0.25s ease; overflow: hidden; }
        .nav-button .icon { font-size: 1.3rem; /* Levemente reduzido */ margin-bottom: 0.1rem; }
        .nav-button span:not(.icon) { white-space: nowrap; /* Garante que fique em uma linha */ }
        .nav-button.active { color: var(--accent-primary); background-color: var(--bg-tertiary-alpha); }
        .nav-button:hover:not(.active) { background-color: var(--bg-tertiary-alpha); }
        .nav-button:disabled { opacity: 0.5; cursor: not-allowed; background-color: transparent !important; }
        .section { display: none; animation: fadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .card { background-color: var(--bg-secondary-alpha); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 5px var(--shadow-color); transition: box-shadow 0.3s ease, background-color 0.4s ease, padding-bottom 0.3s ease; }
        .card:hover { box-shadow: 0 5px 12px color-mix(in srgb, var(--shadow-color) 150%, black); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 5px; }
        .card-header h3 { margin: 0; font-size: 1.1rem; flex-basis: calc(100% - 50px); margin-bottom: 5px; display: flex; align-items: center; gap: 0.5em; margin-top: 0.1rem; }
        .card-header .options { display: flex; align-items: center; flex-wrap: wrap; gap: 5px; margin-left: auto; flex-shrink: 0; }
        .card-actions button, .card-actions .button-like { margin-left: 0.3rem; padding: 0.3rem 0.6rem; font-size: 0.85rem; }
        .card-content { padding-top: 0.5rem; transition: opacity 0.3s ease, max-height 0.4s ease-out; max-height: 1500px; overflow: hidden; opacity: 1; }
        .card-toggle-button { padding: 0.3rem !important; font-size: 0.9rem !important; line-height: 1; background: transparent !important; border: none !important; color: var(--text-secondary); cursor: pointer; margin-left: auto; order: 99; margin-top: 0.1rem; }
        .card-toggle-button:hover { color: var(--accent-primary); }
        .card.collapsed { padding-bottom: 0.5rem; }
        .card.collapsed .card-content { max-height: 0; opacity: 0; padding-top: 0; margin-top: -1px; border-top: none; visibility: hidden; }
        .card.collapsed .card-header { border-bottom: none; margin-bottom: 0; }
        .item-list { list-style: none; padding: 0; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background-color: var(--bg-secondary-alpha); border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 0.5rem; cursor: pointer; transition: background-color 0.25s ease; }
        .list-item:hover { background-color: var(--bg-tertiary-alpha); }
        .list-item span, .list-item .item-info { flex-grow: 1; margin-right: 1rem; overflow: hidden; text-overflow: ellipsis; }
        .list-item .item-info p { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item .item-info h4 { margin-bottom: 0.2rem; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item-actions { flex-shrink: 0; display: flex; gap: 3px; }
        .list-item-actions button, .list-item-actions .button-like { margin-left: 0; padding: 0.3rem; font-size: 1rem; }
        .search-result-item .item-info { margin-right: 0.5rem; }
        .search-result-item .result-type { font-size: 0.75rem; color: var(--text-secondary); background-color: var(--bg-tertiary); padding: 0.1rem 0.4rem; border-radius: 3px; margin-left: auto; flex-shrink: 0; }
        .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; animation: modalFadeIn 0.3s ease-out; }
        .modal.show { display: flex; }
        .modal-content { background-color: var(--bg-modal-alpha); margin: auto; padding: 15px; border: 1px solid var(--border-color); border-radius: 10px; width: 95%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 25px var(--shadow-color); animation: modalSlideIn 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94); transition: background-color 0.4s ease; }
         .monthly-attendance-modal .modal-content { max-width: 95%; width: auto; }
         /* Specific modal styles */
        .name-sorter-modal .modal-content { max-width: 450px; }
        .name-sorter-modal #sorter-result-display { min-height: 60px; background-color: var(--bg-tertiary); border: 1px dashed var(--border-color); border-radius: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem; margin-bottom: 1rem; font-size: 1.4rem; font-weight: bold; text-align: center; word-break: break-word; }
        .name-sorter-modal .sorter-controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; margin-bottom: 1rem;}
        .name-sorter-modal .sorter-info { font-size: 0.8rem; color: var(--text-secondary); }
        .timer-modal .modal-content { max-width: 400px; }
        .timer-modal #timer-display { font-size: 3rem; font-weight: bold; text-align: center; margin-bottom: 1.5rem; background-color: var(--bg-tertiary); padding: 1rem; border-radius: 5px; font-family: monospace; }
        .timer-modal .timer-controls { display: flex; justify-content: space-around; gap: 10px; }
        .timer-modal .timer-controls button { flex-grow: 1; }
        /* Group Generator Modal */
        .group-generator-modal .modal-content { max-width: 90%; width: auto; }
        .group-generator-modal .group-options { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);}
        .group-generator-modal .group-options .radio-group { display: flex; align-items: center; gap: 5px; margin-bottom: 0; }
        .group-generator-modal .group-options input[type="radio"] { width: auto; margin: 0; }
        .group-generator-modal .group-options label { margin-bottom: 0; }
        .group-generator-modal .group-options input[type="number"] { width: 70px; margin-bottom: 0; padding: 0.4rem; font-size: 0.9rem; }
        .group-generator-modal #group-results-container { margin-top: 1rem; max-height: 50vh; overflow-y: auto; padding-right: 5px;}
        .group-generator-modal .generated-group { margin-bottom: 1rem; padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--bg-tertiary-alpha); }
        .group-generator-modal .generated-group h5 { margin-bottom: 0.5rem; font-size: 1rem; color: var(--accent-primary); }
        .group-generator-modal .generated-group ul { list-style: none; padding-left: 0; }
        .group-generator-modal .generated-group li { font-size: 0.9rem; margin-bottom: 0.3rem; display: flex; align-items: baseline; }
        .group-generator-modal .generated-group li .student-number { font-weight: bold; margin-right: 6px; min-width: 20px; text-align: right; font-size: 0.8em; color: var(--text-secondary); }
        /* Advanced Calculator Modal */
        .calculator-modal .modal-content { max-width: 380px; padding: 10px; }
        .calculator-mode-selector { display: flex; gap: 5px; margin-bottom: 10px; }
        .calculator-mode-selector button { flex: 1; font-size: 0.85rem; padding: 0.4rem 0.6rem; background-color: var(--calc-mode-button-bg); color: var(--calc-mode-button-text); border: 1px solid var(--border-color); }
        .calculator-mode-selector button.active { background-color: var(--calc-mode-button-active-bg); color: var(--calc-mode-button-active-text); border-color: var(--calc-mode-button-active-bg); }
        .calculator-display { width: 100%; background-color: var(--calc-display-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px 15px; font-size: 2rem; text-align: right; margin-bottom: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-height: 60px; display: flex; align-items: center; justify-content: flex-end; }
        .calculator-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 10px; }
        .calculator-buttons button { padding: 0.8rem; font-size: 1.1rem; margin: 0; border: 1px solid transparent; background-color: var(--calc-button-bg); color: var(--calc-button-text); transition: background-color 0.2s ease, opacity 0.2s ease; }
        .calculator-buttons button:hover { opacity: var(--calc-button-hover-opacity); }
        .calculator-buttons button:active { transform: scale(var(--calc-button-active-scale)); }
        .calculator-buttons button.num { background-color: var(--calc-button-bg); color: var(--calc-button-text); }
        .calculator-buttons button.op { background-color: var(--calc-op-button-bg); }
        .calculator-buttons button.util { background-color: var(--calc-util-button-bg); }
        .calculator-buttons button.danger { background-color: var(--calc-danger-button-bg); }
        .calculator-buttons button.warn { background-color: var(--calc-warn-button-bg); }
        .calculator-buttons button.eq { background-color: var(--accent-success); }
        .calculator-buttons button.zero { grid-column: span 2; }
        .calculator-buttons button.disabled { opacity: 0.5; cursor: not-allowed; background-color: var(--accent-secondary) !important; }
        .weighted-average-section { padding-top: 10px; border-top: 1px solid var(--border-color); }
        .weighted-average-section h5 { font-size: 1rem; margin-bottom: 0.8rem; text-align: center; color: var(--text-secondary); }
        .grade-weight-input-group { display: flex; gap: 8px; margin-bottom: 0.8rem; }
        .grade-weight-input-group input[type="number"] { margin-bottom: 0; padding: 0.5rem; font-size: 0.9rem; text-align: center; width: 40%; }
        .grade-weight-input-group button { padding: 0.5rem 0.8rem; font-size: 0.9rem; width: auto; flex-shrink: 0; margin: 0; }
        .pairs-list { list-style: none; padding: 8px; margin-bottom: 0.8rem; max-height: 150px; overflow-y: auto; background-color: var(--bg-tertiary-alpha); border: 1px dashed var(--border-color); border-radius: 5px; }
        .pairs-list p { font-size: 0.8rem; color: var(--text-secondary); text-align: center; margin: 1rem 0; }
        .pair-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-secondary-alpha); padding: 5px 8px; border-radius: 4px; margin-bottom: 5px; font-size: 0.9rem; border: 1px solid var(--border-color); }
        .pair-item span { flex-grow: 1; }
        .pair-item button { padding: 0.1rem 0.4rem; font-size: 0.8rem; line-height: 1; margin-left: 8px; }
        .weighted-average-result { margin-top: 0.5rem; font-weight: bold; text-align: center; background-color: var(--bg-tertiary); padding: 8px; border-radius: 5px; min-height: 30px; }
        .weighted-average-section button.calculate { width: 100%; }

        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; flex-shrink: 0; }
        .modal-header h2 { margin: 0; font-size: 1.2rem; text-align: left; justify-content: flex-start; gap: 0; }
        .close-button { background: none; border: none; font-size: 1.8rem; font-weight: bold; color: var(--text-secondary); cursor: pointer; padding: 0 0.5rem; line-height: 1; }
        .close-button:hover { color: var(--text-primary); }
        .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 5px; padding-bottom: 5px; /* Remove explicit padding if calc modal needs full space */ }
         .calculator-modal .modal-body { padding: 0 5px 5px 5px; } /* Adjust calculator padding */
        .modal-body form { margin-bottom: 0; }
        .modal-body textarea { min-height: 150px; }
        .modal-footer { border-top: 1px solid var(--border-color); padding-top: 10px; margin-top: 15px; text-align: right; flex-shrink: 0; display: flex; justify-content: flex-end; gap: 5px; }
        .modal-footer button { margin-left: 0; }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalSlideIn { from { transform: translateY(-25px) scale(0.98); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .justification-modal .modal-body textarea { min-height: 250px; }
        .text-sm { font-size: 0.8rem; }

        /* Tabela de Dados */
        .table-scroll-wrapper { width: 100%; overflow-x: auto; margin-top: 0.5rem; -webkit-overflow-scrolling: touch; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--bg-primary); }
        .data-table { width: 100%; min-width: 280px; border-collapse: collapse; font-size: 0.85rem; table-layout: fixed; word-wrap: break-word; border: none; }
        .data-table th, .data-table td { border: 1px solid var(--border-color); padding: 0.5rem 0.4rem; text-align: left; vertical-align: middle; white-space: nowrap; }
        .data-table th { background-color: var(--bg-tertiary); font-weight: 600; position: sticky; top: 0; z-index: 2; font-size: 0.8rem; }
        .data-table th:first-child, .data-table td:first-child { position: sticky; left: 0; z-index: 1; background-color: var(--bg-sticky-alpha); border-right: 1px solid var(--border-color); white-space: normal; }
        .data-table th:first-child { z-index: 3; }
        .data-table td input[type="number"], .data-table td select { padding: 0.3rem; margin-bottom: 0; font-size: 0.85rem; width: 55px; max-width: 100%; border-radius: 3px; text-align: center; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-primary); }
        .data-table td input.grade-input { transition: background-color 0.3s ease, color 0.3s ease; }
        .data-table td select { width: 80px; }
        .data-table td button { padding: 0.2rem 0.4rem; font-size: 0.75rem; margin: 0 1px; min-width: 30px; }
        .data-table td textarea { display: none; }

       /* --- ATTENDANCE TABLE --- */
        #attendance-table-container .data-table .attendance-status { width: 90px; text-align: center; vertical-align: middle; flex-shrink: 0; border-left: none; }
        #attendance-table-container .data-table .attendance-status.status-H { font-weight: bold; font-style: italic; color: var(--attendance-holiday-text); background-color: var(--attendance-holiday-bg); cursor: default; }
        #attendance-table-container .data-table .student-col { width: auto; min-width: 160px; white-space: normal; word-break: break-word; display: flex; align-items: center; gap: 5px; padding-left: 0.6rem; border-right: none; }
        #attendance-table-container .data-table th.attendance-status { text-align: center; border-left: none;}
        #attendance-table-container .data-table th.student-col { text-align: left; padding-left: 0.6rem;}
        #attendance-table-container .data-table .student-col .student-number { flex-shrink: 0; min-width: 20px; text-align: right; font-weight: bold; font-size: 0.8rem; }
        #attendance-table-container .data-table .student-col .student-name { flex-grow: 1; white-space: normal; word-break: break-word; font-size: 0.85rem; }

        /* --- GRADES TABLE --- */
        #grades-table-container .data-table .grade-col { width: 55px; text-align: center; }
        #grades-table-container .data-table .sum-col { width: 60px; text-align: center; }
        #grades-table-container .data-table .avg-col { width: 60px; text-align: center; font-weight: bold; transition: background-color 0.3s ease, color 0.3s ease; }
        #grades-table-container .data-table .student-col { width: 120px; min-width: 100px; white-space: normal; word-break: break-word; border-right: 2px solid var(--border-color); }
        .data-table td.average.grade-low { background-color: var(--grade-low-bg); color: var(--grade-low-text); }
        .data-table td.average.grade-medium { background-color: var(--grade-medium-bg); color: var(--grade-medium-text); }
        .data-table td.average.grade-high { background-color: var(--grade-high-bg); color: var(--grade-high-text); }

        /* Attendance Buttons Styling */
        .attendance-toggle { padding: 0.3rem 0.45rem; margin: 0 1px; font-size: 0.8rem; font-weight: 600; opacity: 0.7; border: 2px solid transparent; min-width: 34px; transition: all 0.2s cubic-bezier(0.68, -0.55, 0.27, 1.55); display: inline-flex; align-items: center; justify-content: center; gap: 0.2em; line-height: 1; vertical-align: middle; }
        #attendance-table-container .data-table .attendance-status { text-align: center; white-space: nowrap; }
        .attendance-toggle .icon { margin-right: 0; font-size: 0.9em; }
        .attendance-toggle.selected { opacity: 1; border-width: 2px; border-style: solid; transform: scale(1.05); }
        .attendance-toggle.present.selected { background-color: var(--accent-success); border-color: var(--accent-success); color: #fff; }
        .attendance-toggle.absent.selected:not(.justified) { background-color: var(--accent-danger); border-color: var(--accent-danger); color: #fff; }
        .attendance-toggle.absent.justified.selected { background-color: var(--accent-warning); border-color: var(--accent-warning); }
        .attendance-toggle:disabled { opacity: 0.4 !important; cursor: not-allowed !important; background-color: transparent !important; border-color: transparent !important; transform: none !important; color: var(--text-secondary) !important; }

        /* --- Attendance Actions Container --- */
        .attendance-actions-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px; margin-top: 0.5rem; margin-bottom: 0.8rem; }
        .attendance-actions-container button { margin: 0; padding: 0.4rem 0.7rem; font-size: 0.8rem; flex-grow: 1; flex-basis: 0; max-width: 50%; white-space: nowrap; }
        .attendance-actions-container button .icon { margin-right: 0.3em; }

        /* --- Monthly Attendance --- */
        #monthly-attendance-controls { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 0.5rem; }
        #monthly-attendance-controls .date-selectors { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        #monthly-attendance-controls label { margin-bottom: 0; }
        #monthly-attendance-controls select { width: auto; padding: 0.4rem; font-size: 0.9rem; margin-bottom: 0; }
        #monthly-attendance-controls .export-buttons { display: flex; gap: 5px; }
        #monthly-attendance-table-wrapper { max-height: 60vh; overflow: auto; margin-top: 10px; }
        .monthly-attendance-table { width: 100%; min-width: 800px; border-collapse: collapse; font-size: 0.75rem; }
        .monthly-attendance-table th, .monthly-attendance-table td { border: 1px solid var(--border-color); padding: 0.3rem; text-align: center; min-width: 32px; white-space: nowrap; }
        .monthly-attendance-table th { background-color: var(--bg-tertiary); font-weight: 600; }
        .monthly-attendance-table th.student-col-monthly, .monthly-attendance-table td.student-col-monthly { min-width: 150px; text-align: left; position: sticky; left: 0; background-color: var(--bg-sticky-alpha); z-index: 1; white-space: normal; border-right: 2px solid var(--border-color); }
        .monthly-attendance-table th.student-col-monthly { z-index: 3; }
        .monthly-attendance-table th.freq-col-monthly, .monthly-attendance-table td.freq-col-monthly { min-width: 50px; font-weight: bold; position: sticky; right: 0; background-color: var(--bg-sticky-alpha); z-index: 1; border-left: 2px solid var(--border-color); }
         .monthly-attendance-table th.freq-col-monthly { z-index: 3; }
        .monthly-attendance-table td.weekend { background-color: var(--bg-tertiary-alpha); opacity: 0.7; cursor: not-allowed; }
        .monthly-attendance-table td.status-H { background-color: var(--attendance-holiday-bg); color: var(--attendance-holiday-text); font-style: italic; font-weight: bold; }
        #monthly-attendance-summary { margin-top: 1rem; text-align: center; font-weight: bold; }
        #monthly-attendance-chart-container { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); display: flex; flex-wrap: wrap; gap: 5px; align-items: flex-end; min-height: 100px; overflow-x: auto; padding-bottom: 10px; }
        .chart-bar-container { display: flex; flex-direction: column; align-items: center; flex: 0 0 auto; min-width: 40px; text-align: center; }
        .chart-bar { width: 25px; background-color: var(--accent-primary); border-radius: 3px 3px 0 0; transition: height 0.3s ease-out; position: relative; }
         .chart-bar::after { content: attr(data-percentage); position: absolute; top: -1.5em; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.7); color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.7rem; white-space: nowrap; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
         .chart-bar:hover::after { opacity: 1; }
        .chart-label { font-size: 0.7rem; margin-top: 3px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 50px; }

        /* --- Student Observations --- */
        #student-observations-list { max-height: 45vh; overflow-y: auto; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 5px; padding: 0.5rem; background-color: var(--bg-tertiary-alpha); }
        .observation-item { background-color: var(--bg-secondary-alpha); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.6rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .observation-item .observation-details { flex-grow: 1; }
        .observation-item .observation-date { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.25rem; display: block; }
        .observation-item .observation-text { font-size: 0.9rem; white-space: pre-wrap; word-break: break-word; }
        .observation-item .delete-observation-button { flex-shrink: 0; padding: 0.2rem 0.4rem; font-size: 0.8rem; margin-left: 5px; background-color: var(--accent-danger); color: #fff; border: none; }
         #add-observation-section { margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem; }
         #add-observation-section label { margin-bottom: 0.3rem; font-size: 0.9rem; }
         #new-observation-text { min-height: 80px; margin-bottom: 0.5rem; font-size: 0.95rem; }
         #add-observation-button { width: 100%; }

        /* Ajustes específicos */
        #save-grades-button, #save-attendance-button, #save-lesson-plan-button, #save-monthly-attendance-button, #save-map-button { margin-top: 0.8rem !important; }
        .fab-button { position: fixed; bottom: calc(var(--nav-height) + var(--fab-bottom-margin)); right: 20px; width: 50px; height: 50px; border-radius: 50%; font-size: 1.8rem; line-height: 1; box-shadow: 0 4px 10px var(--shadow-color); z-index: 1010; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .fab-button:active { transform: scale(0.9); }
        #classes-section h2, #class-details-section h2 { color: var(--accent-primary); font-size: 1.3rem; margin-bottom: 1rem; display: flex; align-items: center; position: relative; text-align: center; justify-content: center; padding-left: 45px; padding-right: 45px; gap: 0.5em; }
        #classes-section h2 .back-button, #class-details-section h2 .back-button { position: absolute; left: 0; top: 50%; transform: translateY(-50%); margin-right: 0; padding: 0.3rem 0.6rem; font-size: 1rem; }
        #classes-section h2 span:not(.icon):not(.back-button), #class-details-section h2 span:not(.icon):not(.back-button) { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1; text-align: center; }
        .icon { display: inline-block; font-style: normal; font-variant: normal; text-rendering: auto; -webkit-font-smoothing: antialiased; margin-right: 0; line-height: 1; flex-shrink: 0; }
        .icon-only { margin-right: 0 !important; }
        .icon-horario::before { content: "🕒"; font-size: 1.1em; } .icon-escola::before { content: "🏫"; font-size: 1.1em; } .icon-turmas::before { content: "📚"; font-size: 1.1em; } .icon-alunos::before { content: "🧑‍🎓"; font-size: 1.1em; } .icon-notas::before { content: "📊"; font-size: 1.1em; } .icon-config::before { content: "⚙️"; font-size: 1.1em; } .icon-contato::before { content: "✉️"; font-size: 1.1em; } .icon-editar::before { content: "✏️"; } .icon-excluir::before { content: "🗑️"; } .icon-anotacao::before { content: "📝"; } .icon-salvar::before { content: "💾"; } .icon-voltar::before { content: "⬅️"; } .icon-presenca::before { content: "✔️"; } .icon-falta::before { content: "❌"; } .icon-justificar::before { content: "💬"; } .icon-adicionar::before { content: "➕"; font-size: 1.1em; } .icon-estrutura::before { content: "🧱"; } .icon-calendario::before { content: "📅"; } .icon-plano::before { content: "🗒️"; } .icon-copiar::before { content: "📋"; } .icon-pdf::before { content: "📄"; font-size: 1.0em;}
        .icon-mover::before { content: "🔁"; font-size: 1.0em; }
        .icon-todos-presentes::before { content: "👥✔️"; font-size: 1.0em; }
        .icon-notificacao-on::before { content: "🔔"; font-size: 1em; color: var(--accent-warning); }
        .icon-notificacao-off::before { content: "🔕"; font-size: 1em; color: var(--text-secondary); opacity: 0.6; }
        .icon-nao-letivo::before { content: "🏖️"; font-size: 1.0em; }
         .icon-mapa::before { content: "🗺️"; font-size: 1.1em; }
         .icon-chevron-down::before { content: "▼"; font-size: 0.8em; }
         .icon-chevron-up::before { content: "▲"; font-size: 0.8em; }
         .icon-som::before { content: "🔊"; font-size: 1em; }
         .icon-arquivo::before { content: "📁"; font-size: 1em; }
         /* Tool Icons */
         .icon-ferramentas::before { content: "🔧"; font-size: 1.1em; }
         .icon-sorteio::before { content: "🎲"; font-size: 1.3em; }
         .icon-cronometro::before { content: "⏱️"; font-size: 1.3em; }
         .icon-grupos::before { content: "👨‍👩‍👧‍👦"; font-size: 1.3em; }
         .icon-calculadora-avancada::before { content: "🧮"; font-size: 1.3em; }

        .hidden { display: none !important; } .text-center { text-align: center; } .text-right { text-align: right; } .mt-1 { margin-top: 0.5rem; } .mt-2 { margin-top: 1rem; } .mb-0 { margin-bottom: 0; } .mb-1 { margin-bottom: 0.5rem; } .mb-2 { margin-bottom: 1rem; } .mr-1 { margin-right: 0.5rem; } .ml-1 { margin-left: 0.5rem; } .d-flex { display: flex; } .justify-between { justify-content: space-between; } .align-center { align-items: center; } .w-100 { width: 100%; }
        .list-item.active { background-color: var(--bg-tertiary-alpha); border-left: 4px solid var(--accent-primary); }

        /* Schedule List specific styles */
        .schedule-day-group { margin-bottom: 1.5rem; }
        .schedule-day-title { font-size: 1.2rem; font-weight: 600; color: var(--accent-primary); margin-bottom: 0.5rem; padding-bottom: 0.3rem; border-bottom: 2px solid var(--accent-primary); text-align: left; justify-content: flex-start; gap: 0; }
        .schedule-item { display: flex; align-items: center; padding: 0.6rem 0.8rem; background-color: var(--bg-secondary-alpha); border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 0.5rem; }
        .schedule-time { font-weight: 600; width: 100px; flex-shrink: 0; }
        .schedule-info { flex-grow: 1; margin: 0 0.8rem; }
        .schedule-info .school-name { font-weight: 500; }
        .schedule-info .note { font-size: 0.8rem; color: var(--text-secondary); }
        .schedule-actions { flex-shrink: 0; display: flex; align-items: center; gap: 4px;}
        .schedule-actions button { padding: 0.2rem 0.4rem; font-size: 0.8rem; }
        .notification-toggle-button { padding: 0.2rem 0.3rem !important; font-size: 1rem !important; background: transparent !important; border: none !important; cursor: pointer; }
        .notification-toggle-button:hover { opacity: 0.7; }

        /* --- Grade Structure Modal Styles --- */
        .grade-structure-modal .card { padding: 0.8rem; margin-bottom: 0.8rem; }
        .grade-structure-modal .card-header { padding-bottom: 0.4rem; margin-bottom: 0.4rem; align-items: flex-start; gap: 8px; }
        .grade-structure-modal .gs-name { font-size: 1.05rem; margin-bottom: 0 !important; flex-grow: 1; padding: 0.5rem; }
        .grade-structure-modal .delete-gs-button { margin-left: auto; flex-shrink: 0; }
        .grade-structure-modal .gs-section { border-top: 1px solid var(--border-color); margin-top: 0.8rem; padding-top: 0.8rem; }
        .grade-structure-modal .gs-section h4 { font-size: 0.95rem; color: var(--text-secondary); margin-bottom: 0.6rem; font-weight: 500; }
        .grade-structure-modal .gs-instruments-container { padding-top: 0rem; }
        .grade-label-item { display: flex; align-items: center; margin-bottom: 0.5rem; gap: 5px; }
        .grade-label-item input { flex-grow: 1; margin-right: 0; margin-bottom: 0; font-size: 0.95rem; padding: 0.5rem; }
        .grade-label-item button { flex-shrink: 0; }
        .grade-structure-modal .add-gs-label-button { font-size: 0.85rem !important; padding: 0.3rem 0.8rem !important; margin-top: 0.5rem !important; }
        #add-grade-set-button { width: 100%; margin-top: 0.5rem; }
        /* Color Range Styles */
        .color-range-item { display: flex; align-items: center; gap: 8px; margin-bottom: 0.6rem; border: 1px dashed var(--border-color); padding: 0.5rem; border-radius: 4px; flex-wrap: wrap; }
        .color-range-item label { margin-bottom: 0; font-size: 0.85rem; flex-shrink: 0;}
        .color-range-item input[type="number"] { width: 65px; padding: 0.4rem; margin-bottom: 0; font-size: 0.9rem; text-align: center;}
        .color-range-item input[type="color"] { width: 40px; height: 30px; padding: 2px; margin-bottom: 0;}
        .color-range-item button { flex-shrink: 0; margin-left: auto; }
        .grade-structure-modal .add-color-range-button { font-size: 0.85rem !important; padding: 0.3rem 0.8rem !important; margin-top: 0.3rem !important; display: block; margin-left: auto; margin-right: auto; }

        /* --- Notas e Médias Header Adjustment --- */
         #class-details-section > .card:nth-of-type(4) .card-header .options { display: flex; align-items: center; flex-wrap: wrap; gap: 5px; margin-left: auto; }
         #class-details-section > .card:nth-of-type(4) .card-header .options label { margin-bottom: 0; font-size: 0.85rem; white-space: nowrap; margin-right: 2px; }
         #class-details-section > .card:nth-of-type(4) .card-header .options select { padding: 0.3rem 0.4rem; font-size: 0.85rem; margin-bottom: 0; flex-shrink: 0; margin-right: 5px; }
         #class-details-section > .card:nth-of-type(4) .card-header .options button.icon-button { margin-left: 0; margin-right: 5px; }
         #class-details-section > .card:nth-of-type(4) .card-header .options .export-buttons { display: flex; gap: 5px; margin-left: 0; }

        /* --- Class Notes Area Adjustment --- */
         #class-notes-edit textarea { min-height: 120px; margin-bottom: 0.5rem;}
         #class-notes-edit .text-right { margin-bottom: 0.5rem; margin-top: 0; }
        /* --- Lesson Plan Area --- */
        #lesson-plan-textarea { min-height: 100px; margin-bottom: 0.5rem; }

        .footer-message { text-align: center; font-size: 0.85rem; color: var(--text-secondary); margin-top: 2rem; margin-bottom: 1rem; padding: 0 1rem; }
        #contact-section .card p { margin-bottom: 1rem; }
        #contact-section .card a { font-weight: 500; word-break: break-all; }
        #contact-section .card h4 { font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; }

        /* Estilos para Chave PIX e Botão Copiar */
        .pix-key-container { background-color: var(--bg-tertiary-alpha); padding: 0.8rem; border-radius: 5px; font-family: monospace, 'Courier New', Courier; word-break: break-all; margin-top: 0.5rem; margin-bottom: 1rem; border: 1px dashed var(--border-color); user-select: all; cursor: text; }
        #copy-pix-button { width: 100%; max-width: 300px; margin: 0 auto; display: flex; gap: 0.5em; background-color: var(--accent-success); transition: background-color 0.3s ease; }
        #copy-pix-button.error { background-color: var(--accent-danger); }

        /* --- Notification Banner Styles --- */
        #notification-banner { position: fixed; top: 0; left: 0; width: 100%; background-color: var(--bg-notification); color: var(--text-notification); padding: 10px 15px; z-index: 2000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; transform: translateY(-120%); transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); font-size: 0.9rem; line-height: 1.3; }
        #notification-banner.show { transform: translateY(0); }
        #notification-message { flex-grow: 1; margin-right: 10px; }
        #notification-close-button { background: none; border: none; color: inherit; opacity: 0.8; font-size: 1.6rem; font-weight: bold; cursor: pointer; padding: 0 5px; line-height: 1; }
        #notification-close-button:hover { opacity: 1; }

        /* --- Settings: Custom Notification Sound Styles --- */
        .custom-sound-container { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        .custom-sound-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 0.5rem; flex-wrap: wrap; }
        #custom-sound-filename { font-size: 0.85rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1; background: var(--bg-tertiary-alpha); padding: 0.4rem 0.6rem; border-radius: 4px; border: 1px solid var(--border-color); min-width: 100px; }
        #current-custom-sound-display { border: 1px dashed var(--border-color); background-color: var(--bg-tertiary-alpha); padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary); display: flex; align-items: center; justify-content: space-between; }
        #current-custom-sound-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: calc(100% - 40px); }
        #remove-custom-sound-button { padding: 0.3rem 0.5rem; font-size: 0.8rem; flex-shrink: 0; }

        /* --- Classroom Map Styles (FINAL - Grid Layout & Desk Alignment v4) --- */
        .classroom-container { display: grid; grid-template-rows: auto 1fr auto; grid-template-columns: auto 1fr auto; gap: 10px; padding: 15px; border: 1px solid var(--border-color); border-radius: 5px; margin-top: 1rem; overflow: auto; align-items: center; justify-items: center; min-height: 200px; }
        .classroom-map-grid { grid-area: 2 / 2 / 3 / 3; display: grid; gap: var(--seat-gap); justify-content: center; padding: 5px; width: fit-content; max-width: 100%; }
        .seat { width: var(--seat-width); height: var(--seat-height); border: 2px solid var(--map-seat-border); background-color: var(--map-seat-bg); border-radius: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-size: 0.7rem; color: var(--map-seat-text); overflow: hidden; cursor: default; position: relative; transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease; }
        .seat.occupied { background-color: var(--map-seat-occupied-bg); color: var(--map-seat-occupied-text); font-weight: 500; border-style: solid; }
        .map-edit-area .seat.occupied { cursor: pointer; }
        .map-edit-area .seat.empty { cursor: pointer; }
        .map-edit-area .seat.occupied[draggable="true"] { cursor: grab; }
        .map-edit-area .seat.occupied[draggable="true"]:active { cursor: grabbing; }
        .seat.occupied .seat-student-number { font-size: 0.65rem; opacity: 0.8; display: block; line-height: 1; margin-bottom: 2px; pointer-events: none; }
        .seat.occupied .seat-student-name { display: block; line-height: 1.1; max-height: 2.2em; overflow: hidden; padding: 0 2px; pointer-events: none; }
        .seat.empty::before { display: none; }
        .seat.empty .seat-placeholder-text { font-size: 0.65rem; line-height: 1.1; padding: 2px; display: block; opacity: 0.6; color: var(--map-seat-text); }
        .seat span.seat-placeholder-text { display: none; }
        .teacher-desk { border: var(--teacher-desk-border-width) solid var(--map-teacher-desk-border); background-color: var(--map-teacher-desk-bg); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--text-primary); z-index: 5; transition: transform 0.3s, width 0.3s, height 0.3s, grid-area 0s; width: var(--teacher-desk-width); height: var(--teacher-desk-height); transform-origin: center center; margin: 0; }
        .teacher-desk.position-top-center    { grid-area: 1 / 2 / 2 / 3; }
        .teacher-desk.position-bottom-center { grid-area: 3 / 2 / 4 / 3; }
        .teacher-desk.position-left-center   { grid-area: 2 / 1 / 3 / 2; transform: rotate(-90deg); }
        .teacher-desk.position-right-center  { grid-area: 2 / 3 / 3 / 4; transform: rotate(90deg); }
        .teacher-desk.position-top-left   { grid-area: 1 / 2 / 2 / 3; justify-self: start; }
        .teacher-desk.position-top-right  { grid-area: 1 / 2 / 2 / 3; justify-self: end;   }
        .teacher-desk.position-bottom-left   { grid-area: 3 / 2 / 4 / 3; justify-self: start; }
        .teacher-desk.position-bottom-right  { grid-area: 3 / 2 / 4 / 3; justify-self: end;   }
        .teacher-desk.position-left-top    { grid-area: 2 / 1 / 3 / 2; align-self: start; transform: rotate(-90deg); }
        .teacher-desk.position-left-bottom { grid-area: 2 / 1 / 3 / 2; align-self: end;   transform: rotate(-90deg); }
        .teacher-desk.position-right-top    { grid-area: 2 / 3 / 3 / 4; align-self: start; transform: rotate(90deg); }
        .teacher-desk.position-right-bottom { grid-area: 2 / 3 / 3 / 4; align-self: end;   transform: rotate(90deg); }
        .classroom-map-edit-controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .classroom-map-edit-controls .form-group { margin-bottom: 0; display: flex; align-items: center; gap: 5px;}
        .classroom-map-edit-controls label { margin-bottom: 0; flex-shrink: 0; }
        .classroom-map-edit-controls input[type="number"], .classroom-map-edit-controls select { width: auto; max-width: 80px; margin-bottom: 0; padding: 0.4rem; font-size: 0.9rem; }
        .classroom-map-edit-controls select { max-width: 140px; }
        .map-edit-area { display: flex; gap: 20px; margin-top: 1rem; flex-wrap: wrap; }
        .unassigned-students-list { border: 1px dashed var(--map-seat-border); padding: 10px; border-radius: 5px; min-height: 100px; max-height: 40vh; overflow-y: auto; background-color: var(--bg-tertiary-alpha); flex: 1; min-width: 180px; }
        .unassigned-students-list h5 { margin-bottom: 0.5rem; font-size: 0.9rem; text-align: center; color: var(--text-secondary); }
         .draggable-student { background-color: var(--map-seat-occupied-bg); color: var(--map-seat-occupied-text); padding: 5px 8px; border: 1px solid var(--map-seat-border); border-radius: 4px; margin-bottom: 5px; font-size: 0.8rem; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; user-select: none; }
         .draggable-student[draggable="true"]:active { cursor: grabbing; }
         .draggable-student .student-number { font-weight: bold; margin-right: 4px; pointer-events: none; }
         .draggable-student .student-name { pointer-events: none; }
         .seat.drag-over { border-color: var(--accent-success); background-color: var(--map-drag-over-bg); box-shadow: 0 0 8px var(--map-drag-over-bg); }
         .unassigned-students-list.drag-over { border-color: var(--accent-danger); background-color: color-mix(in srgb, var(--accent-danger) 15%, transparent); }
         .seat.occupied.dragging, .draggable-student.dragging { opacity: 0.4; }
         .seat.selected-for-assignment { border-color: var(--map-seat-selected-border); box-shadow: 0 0 0 3px color-mix(in srgb, var(--map-seat-selected-border) 40%, transparent); }

        /* --- Tools Grid --- */
        .tools-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(var(--tool-card-min-width), 1fr)); gap: 1rem; padding: 0.5rem 0; }
        .tool-card { background-color: var(--bg-secondary-alpha); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.2rem 0.8rem; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 2px 4px var(--shadow-color); min-height: 100px; }
        .tool-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px color-mix(in srgb, var(--shadow-color) 120%, black); }
        .tool-card:active { transform: scale(0.97); }
        .tool-card .icon { font-size: 2rem; margin-bottom: 0.6rem; color: var(--accent-primary); }
        .tool-card-title { font-size: 0.9rem; font-weight: 500; color: var(--text-primary); line-height: 1.3; }

    </style>
</head>
<body>

    <div id="notification-banner"> <span id="notification-message">Mensagem...</span> <button id="notification-close-button" type="button">&times;</button> </div>
    <audio id="notification-sound-default" preload="auto"> <source src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YUReT18AAAAAAAAAAAAAAAAAAAAAAP////8AAAAA///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////8=" type="audio/wav"> </audio>
    <header class="app-header"> <div class="header-top-row"> <h1>Super Professor Pro</h1> <div id="header-info" class="header-info"></div> </div> <input type="search" id="search-input" placeholder="Buscar aluno, turma, escola..."> </header>
    <main class="app-content" id="main-content">
        <section id="schedule-section" class="section"> <h2><span class="icon icon-horario"></span>Meus Horários</h2> <button type="button" id="add-schedule-button" class="fab-button success"><span class="icon icon-adicionar icon-only"></span></button> <div id="schedule-list"><p style="text-align: center; padding: 1rem;">Nenhum horário cadastrado.</p></div> <p class="footer-message">Feito com ❤️ para professores</p> </section>
        <section id="schools-section" class="section"> <h2><span class="icon icon-escola"></span>Minhas Escolas</h2> <button type="button" id="add-school-button" class="fab-button success"><span class="icon icon-adicionar icon-only"></span></button> <div id="school-list"><p style="text-align: center; padding: 1rem;">Nenhuma escola cadastrada.</p></div> </section>
        <section id="classes-section" class="section"> <h2> <button type="button" id="back-to-schools-button" class="button-like secondary icon-button back-button"><span class="icon icon-voltar icon-only"></span></button> <span class="icon icon-turmas"></span>Turmas - <span id="classes-school-name">Selecione Escola</span> </h2> <button type="button" id="add-class-button" class="fab-button success"><span class="icon icon-adicionar icon-only"></span></button> <div id="class-list"><p style="text-align: center; padding: 1rem;">Selecione uma escola.</p></div> </section>
        <section id="class-details-section" class="section"> <h2 id="class-details-header"> <button type="button" id="back-to-classes-button" class="button-like secondary icon-button back-button"><span class="icon icon-voltar icon-only"></span></button> <span id="class-details-title">Detalhes da Turma</span> </h2>
            <div class="card"> <div class="card-header"> <h3><span class="icon icon-alunos"></span>Alunos</h3> <div class="options"> <button type="button" id="add-student-button" class="success"><span class="icon icon-adicionar"></span> Novo Aluno</button> <button type="button" class="card-toggle-button" title="Esconder Alunos"><span class="icon icon-chevron-up"></span></button> </div> </div> <div id="student-list-container" class="card-content collapsible-content"><p style="text-align: center; padding: 1rem;">Nenhum aluno nesta turma.</p></div> </div>
            <div class="card"> <div class="card-header"> <h3><span class="icon icon-mapa"></span>Mapa da Sala</h3> <div class="options"> <button type="button" id="edit-map-button" class="secondary icon-button" title="Editar Mapa"><span class="icon icon-editar icon-only"></span></button> <button type="button" class="card-toggle-button" title="Esconder Mapa"><span class="icon icon-chevron-up"></span></button> </div> </div> <div class="card-content collapsible-content"> <div id="classroom-map-edit-controls" class="classroom-map-edit-controls hidden"> <div class="form-group"> <label for="map-rows-input">Fileiras:</label> <input type="number" id="map-rows-input" min="1" max="20" value="5"> </div> <div class="form-group"> <label for="map-cols-input">Colunas:</label> <input type="number" id="map-cols-input" min="1" max="20" value="6"> </div> <div class="form-group"> <label for="teacher-desk-position-select">Mesa Prof.:</label> <select id="teacher-desk-position-select"> <option value="top-center">Topo (Centro)</option> <option value="top-left">Topo (Esquerda)</option> <option value="top-right">Topo (Direita)</option> <option value="bottom-center">Fundo (Centro)</option> <option value="bottom-left">Fundo (Esquerda)</option> <option value="bottom-right">Fundo (Direita)</option> <option value="left-center">Esquerda (Centro)</option> <option value="left-top">Esquerda (Topo)</option> <option value="left-bottom">Esquerda (Fundo)</option> <option value="right-center">Direita (Centro)</option> <option value="right-top">Direita (Topo)</option> <option value="right-bottom">Direita (Fundo)</option> </select> </div> <div class="form-group" style="margin-left: auto;"> <button type="button" id="cancel-map-edit-button" class="secondary">Cancelar</button> <button type="button" id="save-map-button" class="success"><span class="icon icon-salvar"></span> Salvar Mapa</button> </div> </div> <div id="map-edit-area" class="map-edit-area hidden"> <div id="unassigned-students-container" class="unassigned-students-list" droppable="true"> <h5>Alunos sem lugar (Clique aqui após selecionar mesa vazia)</h5> </div> <div id="classroom-container-edit" class="classroom-container"> </div> </div> <div id="classroom-container-display" class="classroom-container"> <div class="teacher-desk">🧑‍🏫</div> <div class="classroom-map-grid"> <p style="padding: 1rem; text-align: center; grid-column: 1 / -1;">Configure o mapa clicando no botão <span class="icon icon-editar"></span>.</p> </div> </div> </div> </div>
            <div class="card"> <div class="card-header"> <h3><span class="icon icon-presenca"></span>Presença</h3> <div class="options"> <label for="attendance-date" class="mb-0 mr-1 align-center">Data:</label> <input type="date" id="attendance-date" style="width: auto; padding: 0.3rem 0.5rem; margin-bottom: 0;"> <button type="button" id="view-monthly-attendance-button" class="secondary icon-button ml-1" title="Ver Frequência Mensal"><span class="icon icon-calendario icon-only"></span></button> <button type="button" class="card-toggle-button" title="Esconder Presença"><span class="icon icon-chevron-up"></span></button> </div> </div> <div class="card-content collapsible-content"> <div id="attendance-actions-container" class="attendance-actions-container hidden"> <button type="button" id="mark-all-present-button" class="success"> <span class="icon icon-todos-presentes"></span>Todos P. </button> <button type="button" id="mark-non-school-day-button" class="secondary"> <span class="icon icon-nao-letivo"></span>Não Letivo </button> </div> <div class="table-scroll-wrapper"> <div id="attendance-table-container"><p style="padding: 1rem; text-align: center;">Selecione uma data.</p></div> </div> <button type="button" id="save-attendance-button" class="success mt-1 hidden"><span class="icon icon-salvar"></span>Salvar Presença</button> </div> </div>
            <div class="card"> <div class="card-header"> <h3><span class="icon icon-notas"></span>Notas e Médias</h3> <div class="options"> <label for="grade-set-select" class="mb-0 align-center">Conjunto:</label> <select id="grade-set-select"> <option value="">--</option> </select> <button type="button" id="manage-grade-structure-button" class="secondary icon-button" title="Gerenciar Estrutura de Notas"><span class="icon icon-estrutura icon-only"></span></button> <div class="export-buttons"> <button type="button" id="export-grades-csv-button" class="secondary icon-button hidden" title="Exportar Notas (CSV)"><span class="icon">📤</span></button> <button type="button" id="export-grades-pdf-button" class="secondary icon-button hidden" title="Exportar Notas (PDF)"><span class="icon icon-pdf"></span></button> </div> <button type="button" class="card-toggle-button" title="Esconder Notas"><span class="icon icon-chevron-up"></span></button> </div> </div> <div class="card-content collapsible-content"> <div class="table-scroll-wrapper"> <div id="grades-table-container"><p style="padding: 1rem; text-align: center;">Selecione um conjunto de notas ou configure a estrutura.</p></div> </div> <button type="button" id="save-grades-button" class="success mt-1 hidden"><span class="icon icon-salvar"></span>Salvar Notas</button> </div> </div>
             <div class="card"> <div class="card-header"> <h3><span class="icon icon-plano"></span>Planejamento da Aula</h3> <div class="options"> <label for="lesson-plan-date" class="mb-0 mr-1 align-center">Data:</label> <input type="date" id="lesson-plan-date" style="display: inline-block; width: auto; padding: 0.3rem 0.5rem; margin-bottom: 0;"> <button type="button" class="card-toggle-button" title="Esconder Planejamento"><span class="icon icon-chevron-up"></span></button> </div> </div> <div class="card-content collapsible-content"> <textarea id="lesson-plan-textarea" placeholder="Digite o conteúdo/tópico da aula para esta data..."></textarea> <button type="button" id="save-lesson-plan-button" class="success mt-1 hidden"><span class="icon icon-salvar"></span>Salvar Plano</button> </div> </div>
             <div class="card"> <div class="card-header"> <h3><span class="icon icon-anotacao"></span>Anotações da Turma</h3> <div class="options"> <button type="button" id="edit-class-notes-button" class="secondary icon-button" title="Editar Anotações"><span class="icon icon-editar icon-only"></span></button> <button type="button" class="card-toggle-button" title="Esconder Anotações"><span class="icon icon-chevron-up"></span></button> </div> </div> <div id="class-notes-display" class="card-content collapsible-content"> <p id="class-notes-content">Nenhuma anotação para esta turma.</p> </div> <div id="class-notes-edit" class="hidden card-content collapsible-content"> <textarea id="class-notes-textarea" placeholder="Digite suas anotações sobre a turma..."></textarea> <div class="text-right mt-1 mb-1"> <button type="button" id="cancel-class-notes-button" class="secondary">Cancelar</button> <button type="button" id="save-class-notes-button" class="success"><span class="icon icon-salvar"></span> Salvar</button> </div> </div> </div>
        </section>
        <section id="tools-section" class="section"> <h2><span class="icon icon-ferramentas"></span>Ferramentas</h2> <div class="tools-grid"> <button type="button" class="tool-card" data-tool="name-sorter"> <span class="icon icon-sorteio"></span> <span class="tool-card-title">Sorteador de Nomes</span> </button> <button type="button" class="tool-card" data-tool="timer-stopwatch"> <span class="icon icon-cronometro"></span> <span class="tool-card-title">Cronômetro/ Timer</span> </button> <button type="button" class="tool-card" data-tool="group-generator"> <span class="icon icon-grupos"></span> <span class="tool-card-title">Gerador de Grupos</span> </button> <button type="button" class="tool-card" data-tool="advanced-calculator"> <span class="icon icon-calculadora-avancada"></span> <span class="tool-card-title">Calculadora Avançada</span> </button> </div> <p class="footer-message">Feito com ❤️ para professores</p> </section>
        <section id="contact-section" class="section"> <h2><span class="icon icon-contato"></span>Contato & Apoio</h2> <div class="card"> <h3 style="text-align: center; color: var(--accent-primary);">Gostou do App? Apoie o Desenvolvedor!</h3> <p class="mt-2">Olá, Professor(a)! 👋</p> <p>O Super Professor Pro foi criado com muito carinho e dedicação para ser uma ferramenta útil e gratuita no seu dia a dia.</p> <p>Se este app tem facilitado sua rotina e você gostaria de incentivar a continuidade do projeto (novas funcionalidades, melhorias e correções!), considere fazer uma contribuição voluntária via PIX.</p> <p>É como pagar um cafezinho ☕ pelo bom trabalho! Qualquer valor é bem-vindo e ajuda muito a manter a ferramenta evoluindo.</p> <h4 class="text-center">PIX Copia e Cola:</h4> <div id="pix-key-text" class="pix-key-container">00020126580014BR.GOV.BCB.PIX01365787c86e-c2cb-44ac-8799-428e17e6b4635204000053039865802BR5925Paulo Ricardo Correa de A6009SAO PAULO6214051058aRkBp4Fm6304175C</div> <button type="button" id="copy-pix-button" class="success"> <span class="icon icon-copiar"></span> Copiar Código PIX </button> <p class="text-center mt-2"><strong>Muito obrigado pelo seu apoio!</strong></p> <hr style="border: none; border-top: 1px solid var(--border-color); margin: 1.5rem 0;"> <p>Para dúvidas, sugestões ou reporte de erros:</p> <p style="text-align: center;"> <a href="mailto:paulinhoandroidnf@gmail.com">paulinhoandroidnf@gmail.com</a> </p> </div> <p class="footer-message">Feito com ❤️ para professores</p> </section>
        <section id="settings-section" class="section"> <h2><span class="icon icon-config"></span>Configurações</h2> <div class="card"> <h3>Temas</h3> <div id="theme-selector" style="display: flex; flex-wrap: wrap; gap: 5px;"> <button type="button" class="theme-button" data-theme="theme-light">Claro</button> <button type="button" class="theme-button" data-theme="theme-dark">Escuro</button> <button type="button" class="theme-button" data-theme="theme-forest-green">Verde Floresta</button> <button type="button" class="theme-button" data-theme="theme-math-master">Mestre da Matemática</button> <button type="button" class="theme-button" data-theme="theme-historic-scroll">Papiro Histórico</button> <button type="button" class="theme-button" data-theme="theme-alchemist">O Alquimista</button> </div> </div> <div class="card mt-2"> <h3>Dados</h3> <div style="display: flex; flex-direction: column; gap: 10px;"> <button type="button" id="export-data-button" class="secondary"><span class="icon">📤</span> Exportar Dados (JSON)</button> <label for="import-data-input" class="button-like secondary" style="cursor: pointer;"><span class="icon">📥</span> Importar Dados (JSON)</label> <input type="file" id="import-data-input" accept=".json" class="hidden"> <button type="button" id="clear-data-button" class="danger"><span class="icon">⚠️</span> Limpar Todos os Dados</button> </div> </div> <div class="card mt-2"> <h3>Notificações de Horários</h3> <div class="checkbox-group"> <input type="checkbox" id="enable-global-notifications"> <label for="enable-global-notifications">Ativar Notificações Globais</label> </div> <div class="checkbox-group"> <input type="checkbox" id="enable-notification-sound"> <label for="enable-notification-sound">Ativar Som nas Notificações</label> </div> <div class="custom-sound-container"> <label for="custom-notification-sound-input">Som Personalizado (Opcional - máx 2MB):</label> <div class="custom-sound-input-group"> <label for="custom-notification-sound-input" class="button-like secondary" style="cursor: pointer;"><span class="icon icon-arquivo"></span> Escolher arquivo</label> <span id="custom-sound-filename">Nenhum arquivo escolhido</span> <input type="file" id="custom-notification-sound-input" accept="audio/*" class="hidden"> </div> <div id="current-custom-sound-display" class="hidden"> <span id="current-custom-sound-name"></span> <button type="button" id="remove-custom-sound-button" class="danger icon-button" title="Remover Som Personalizado"><span class="icon icon-excluir icon-only"></span></button> </div> </div> <p class="text-sm text-secondary mt-1"> Notificações podem ser ativadas/desativadas individualmente para cada horário na tela "Meus Horários" (clicando no 🔔/🔕). Elas aparecerão 5 minutos antes do início e do fim da aula programada. </p> </div> <p class="footer-message">Feito com ❤️ para professores</p> </section>
    </main>
    <nav class="app-nav"> <button type="button" class="nav-button" data-section="schedule-section"><span class="icon icon-horario"></span>Horários</button> <button type="button" class="nav-button" data-section="schools-section"><span class="icon icon-escola"></span>Escolas</button> <button type="button" class="nav-button" data-section="classes-section" id="nav-classes-button" disabled><span class="icon icon-turmas"></span>Turmas</button> <button type="button" class="nav-button" data-section="class-details-section" id="nav-details-button" disabled><span class="icon icon-alunos"></span>Detalhes</button> <button type="button" class="nav-button" data-section="tools-section"><span class="icon icon-ferramentas"></span>Ferramentas</button> <button type="button" class="nav-button" data-section="contact-section"><span class="icon icon-contato"></span>Contato</button> <button type="button" class="nav-button" data-section="settings-section"><span class="icon icon-config"></span>Config</button> </nav>

    <!-- Generic Modal -->
    <div id="generic-modal" class="modal"> <div class="modal-content"> <div class="modal-header"> <h2 id="modal-title">Título do Modal</h2> <button type="button" class="close-button" data-dismiss="modal">&times;</button> </div> <div id="modal-body" class="modal-body"></div> <div id="modal-footer" class="modal-footer"> <button type="button" data-dismiss="modal" class="secondary">Fechar</button> </div> </div> </div>

    <!-- Advanced Calculator Modal -->
    <div id="advanced-calculator-modal" class="modal calculator-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="calculator-modal-title">Calculadora Avançada</h2>
                <button type="button" class="close-button" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="calculator-mode-selector">
                    <button type="button" id="calc-mode-standard" class="active" data-mode="standard">Padrão</button>
                    <button type="button" id="calc-mode-weighted" data-mode="weighted">Média Ponderada</button>
                </div>

                <!-- Standard Calculator Section -->
                <div id="calculator-standard-section">
                    <div id="calculator-display" class="calculator-display">0</div>
                    <div class="calculator-buttons">
                        <button type="button" class="danger util" data-action="clearAll">AC</button>
                        <button type="button" class="warn util" data-action="clearEntry">C</button>
                        <button type="button" class="util" data-action="backspace">←</button>
                        <button type="button" class="op" data-operator="divide">÷</button>

                        <button type="button" class="num" data-value="7">7</button>
                        <button type="button" class="num" data-value="8">8</button>
                        <button type="button" class="num" data-value="9">9</button>
                        <button type="button" class="op" data-operator="multiply">×</button>

                        <button type="button" class="num" data-value="4">4</button>
                        <button type="button" class="num" data-value="5">5</button>
                        <button type="button" class="num" data-value="6">6</button>
                        <button type="button" class="op" data-operator="subtract">−</button>

                        <button type="button" class="num" data-value="1">1</button>
                        <button type="button" class="num" data-value="2">2</button>
                        <button type="button" class="num" data-value="3">3</button>
                        <button type="button" class="op" data-operator="add">+</button>

                        <button type="button" class="num zero" data-value="0">0</button>
                        <button type="button" class="num" data-action="decimal">.</button>
                        <button type="button" class="eq" data-action="calculate">=</button>
                    </div>
                </div>

                <!-- Weighted Average Section -->
                <div id="calculator-weighted-section" class="weighted-average-section hidden">
                    <h5>Adicionar Notas e Pesos</h5>
                    <div class="grade-weight-input-group">
                        <input type="number" id="weighted-grade-input" placeholder="Nota" step="any">
                        <input type="number" id="weighted-weight-input" placeholder="Peso" step="any">
                        <button type="button" id="add-pair-button" class="success"><span class="icon icon-adicionar"></span> Add</button>
                    </div>
                    <h5>Pares Adicionados:</h5>
                    <ul id="weighted-pairs-list" class="pairs-list">
                        <p>Nenhum par adicionado.</p>
                    </ul>
                    <button type="button" id="calculate-weighted-avg-button" class="success calculate">
                        <span class="icon icon-calculadora-avancada"></span> Calcular Média Ponderada
                    </button>
                    <div id="weighted-average-result" class="weighted-average-result">--</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" data-dismiss="modal" class="secondary">Fechar</button>
            </div>
        </div>
    </div>


    <!-- Templates -->
     <template id="school-item-template"> <div class="list-item" data-id=""> <div class="item-info"> <h4 class="school-name"></h4> </div> <div class="list-item-actions"> <button type="button" class="view-classes-button primary" title="Ver Turmas"><span class="icon icon-turmas"></span> Turmas</button> <button type="button" class="edit-school-button secondary icon-button" title="Editar Escola"><span class="icon icon-editar icon-only"></span></button> <button type="button" class="delete-school-button danger icon-button" title="Excluir Escola"><span class="icon icon-excluir icon-only"></span></button> </div> </div> </template>
    <template id="class-item-template"> <div class="list-item" data-id=""> <div class="item-info"> <h4 class="class-name"></h4> <p class="class-details"></p> </div> <div class="list-item-actions"> <button type="button" class="view-details-button primary" title="Ver Detalhes"><span class="icon icon-alunos"></span> Ver</button> <button type="button" class="edit-class-button secondary icon-button" title="Editar Turma"><span class="icon icon-editar icon-only"></span></button> <button type="button" class="delete-class-button danger icon-button" title="Excluir Turma"><span class="icon icon-excluir icon-only"></span></button> </div> </div> </template>
    <template id="student-list-item-template"> <div class="list-item" data-id=""> <span class="student-number" style="font-weight: bold; margin-right: 10px; min-width: 30px; text-align: right;"></span> <span class="student-name" style="white-space: normal; word-break: break-word;"></span> <div class="list-item-actions"> <button type="button" class="edit-student-button secondary icon-button" title="Editar Aluno"><span class="icon icon-editar icon-only"></span></button> <button type="button" class="delete-student-button danger icon-button" title="Excluir Aluno"><span class="icon icon-excluir icon-only"></span></button> <button type="button" class="notes-student-button warning icon-button" title="Observações do Aluno"><span class="icon icon-anotacao icon-only"></span></button> <button type="button" class="move-student-button secondary icon-button" title="Mover Aluno para Outra Turma"><span class="icon icon-mover icon-only"></span></button> </div> </div> </template>
    <template id="grades-header-template"> <th class="student-col">Aluno</th> <th class="sum-col">Soma</th> <th class="avg-col">Média</th> </template>
    <template id="grades-row-template"> <tr> <td class="student-col"> <span class="student-number" style="font-weight:bold; margin-right: 5px;"></span> <span class="student-name"></span> </td> <td class="sum-col sum">--</td> <td class="avg-col average">--</td> </tr> </template>
    <template id="attendance-row-template"> <tr> <td class="student-col"> <span class="student-number"></span> <span class="student-name"></span> </td> <td class="attendance-status"></td> </tr> </template>
    <template id="observation-item-template"> <div class="observation-item" data-index=""> <div class="observation-details"> <span class="observation-date"></span> <p class="observation-text"></p> </div> <button type="button" class="delete-observation-button danger icon-button" title="Excluir Observação"><span class="icon icon-excluir icon-only"></span></button> </div> </template>
    <template id="schedule-item-template"> <div class="schedule-item" data-id=""> <span class="schedule-time"></span> <div class="schedule-info"> <div class="school-name"></div> <div class="note"></div> </div> <div class="schedule-actions"> <button type="button" class="notification-toggle-button" title="Ativar/Desativar Notificações"> <span class="icon notification-indicator"></span> </button> <button type="button" class="edit-schedule-button secondary icon-button" title="Editar Horário"> <span class="icon icon-editar icon-only"></span> </button> <button type="button" class="delete-schedule-button danger icon-button" title="Excluir Horário"> <span class="icon icon-excluir icon-only"></span> </button> </div> </div> </template>
    <template id="grade-label-item-template"> <div class="grade-label-item"> <input type="text" class="gs-label" value="" placeholder="Nome da Avaliação (Ex: Prova 1)"> <button type="button" class="delete-gs-label-button danger icon-button" title="Excluir Instrumento"><span class="icon icon-excluir icon-only"></span></button> </div> </template>
    <template id="color-range-item-template"> <div class="color-range-item"> <label>De:</label> <input type="number" class="gs-color-min" step="0.1" placeholder="0.0" value=""> <label>Até:</label> <input type="number" class="gs-color-max" step="0.1" placeholder="10.0" value=""> <label>Cor:</label> <input type="color" class="gs-color-input" value="#ffffff"> <button type="button" class="delete-color-range-button danger icon-button" title="Excluir Faixa"> <span class="icon icon-excluir icon-only"></span> </button> </div> </template>
    <template id="seat-template"> <div class="seat" draggable="false"> <span class="seat-student-number"></span> <span class="seat-student-name"></span> <span class="seat-placeholder-text"></span> </div> </template>
    <template id="draggable-student-template"> <div class="draggable-student" draggable="true"> <span class="student-number"></span> <span class="student-name"></span> </div> </template>
    <template id="teacher-desk-template"> <div class="teacher-desk">🧑‍🏫</div> </template>
    <template id="classroom-grid-template"> <div class="classroom-map-grid"></div> </template>
    <!-- Template for Weighted Pair Item -->
    <template id="weighted-pair-item-template">
        <li class="pair-item" data-index="">
            <span>Nota: <strong></strong>, Peso: <strong></strong></span>
            <button type="button" class="delete-pair-button danger icon-button" title="Remover Par"><span class="icon icon-excluir icon-only"></span></button>
        </li>
    </template>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Seletores Globais (Existentes) ---
            const mainContent = document.getElementById('main-content');
            const sections = document.querySelectorAll('.section');
            const navButtons = document.querySelectorAll('.nav-button');
            const modal = document.getElementById('generic-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            const headerInfo = document.getElementById('header-info');
            const searchInput = document.getElementById('search-input');
            const scheduleListContainer = document.getElementById('schedule-list');
            const schoolListContainer = document.getElementById('school-list');
            const classListContainer = document.getElementById('class-list');
            const classesSchoolName = document.getElementById('classes-school-name');
            const studentListContainer = document.getElementById('student-list-container');
            const classDetailsSection = document.getElementById('class-details-section');
            const classDetailsHeader = document.getElementById('class-details-header');
            const classDetailsTitle = document.getElementById('class-details-title');
            const backToSchoolsButton = document.getElementById('back-to-schools-button');
            const backToClassesButton = document.getElementById('back-to-classes-button');
            const navClassesButton = document.getElementById('nav-classes-button');
            const navDetailsButton = document.getElementById('nav-details-button');
            const gradesTableContainer = document.getElementById('grades-table-container');
            const attendanceTableContainer = document.getElementById('attendance-table-container');
            const gradeSetSelect = document.getElementById('grade-set-select');
            const manageGradeStructureButton = document.getElementById('manage-grade-structure-button');
            const saveGradesButton = document.getElementById('save-grades-button');
            const exportGradesCsvButton = document.getElementById('export-grades-csv-button');
            const exportGradesPdfButton = document.getElementById('export-grades-pdf-button');
            const attendanceDateInput = document.getElementById('attendance-date');
            const saveAttendanceButton = document.getElementById('save-attendance-button');
            const viewMonthlyAttendanceButton = document.getElementById('view-monthly-attendance-button');
            const attendanceActionsContainer = document.getElementById('attendance-actions-container');
            const markAllPresentButton = document.getElementById('mark-all-present-button');
            const markNonSchoolDayButton = document.getElementById('mark-non-school-day-button');
            const lessonPlanDateInput = document.getElementById('lesson-plan-date');
            const lessonPlanTextarea = document.getElementById('lesson-plan-textarea');
            const saveLessonPlanButton = document.getElementById('save-lesson-plan-button');
            const classNotesDisplay = document.getElementById('class-notes-display');
            const classNotesContent = document.getElementById('class-notes-content');
            const classNotesEdit = document.getElementById('class-notes-edit');
            const classNotesTextarea = document.getElementById('class-notes-textarea');
            const editClassNotesButton = document.getElementById('edit-class-notes-button');
            const saveClassNotesButton = document.getElementById('save-class-notes-button');
            const cancelClassNotesButton = document.getElementById('cancel-class-notes-button');
            const addScheduleButton = document.getElementById('add-schedule-button');
            const addSchoolButton = document.getElementById('add-school-button');
            const addClassButton = document.getElementById('add-class-button');
            const copyPixButton = document.getElementById('copy-pix-button');
            const pixKeyTextElement = document.getElementById('pix-key-text');
            const notificationBanner = document.getElementById('notification-banner');
            const notificationMessage = document.getElementById('notification-message');
            const notificationCloseButton = document.getElementById('notification-close-button');
            const defaultNotificationSound = document.getElementById('notification-sound-default');
            const enableGlobalNotificationsCheckbox = document.getElementById('enable-global-notifications');
            const enableNotificationSoundCheckbox = document.getElementById('enable-notification-sound');
            const customNotificationSoundInput = document.getElementById('custom-notification-sound-input');
            const customSoundFilenameDisplay = document.getElementById('custom-sound-filename');
            const currentCustomSoundDisplay = document.getElementById('current-custom-sound-display');
            const currentCustomSoundName = document.getElementById('current-custom-sound-name');
            const removeCustomSoundButton = document.getElementById('remove-custom-sound-button');
            const editMapButton = document.getElementById('edit-map-button');
            const classroomContainerDisplay = document.getElementById('classroom-container-display');
            const classroomContainerEdit = document.getElementById('classroom-container-edit');
            const mapEditArea = document.getElementById('map-edit-area');
            const classroomMapEditControls = document.getElementById('classroom-map-edit-controls');
            const mapRowsInput = document.getElementById('map-rows-input');
            const mapColsInput = document.getElementById('map-cols-input');
            const teacherDeskPositionSelect = document.getElementById('teacher-desk-position-select');
            const unassignedStudentsContainer = document.getElementById('unassigned-students-container');
            const cancelMapEditButton = document.getElementById('cancel-map-edit-button');
            const saveMapButton = document.getElementById('save-map-button');
            const teacherDeskTemplate = document.getElementById('teacher-desk-template');
            const classroomGridTemplate = document.getElementById('classroom-grid-template');
            const toolsGrid = document.querySelector('#tools-section .tools-grid');

            // --- Seletores da Calculadora ---
            const calculatorModal = document.getElementById('advanced-calculator-modal');
            const calculatorDisplay = document.getElementById('calculator-display');
            const standardCalcSection = document.getElementById('calculator-standard-section');
            const weightedCalcSection = document.getElementById('calculator-weighted-section');
            const calcModeStandardBtn = document.getElementById('calc-mode-standard');
            const calcModeWeightedBtn = document.getElementById('calc-mode-weighted');
            const calcButtonsContainer = document.querySelector('.calculator-buttons'); // For standard buttons
            const weightedGradeInput = document.getElementById('weighted-grade-input');
            const weightedWeightInput = document.getElementById('weighted-weight-input');
            const addPairButton = document.getElementById('add-pair-button');
            const weightedPairsList = document.getElementById('weighted-pairs-list');
            const calculateWeightedAvgButton = document.getElementById('calculate-weighted-avg-button');
            const weightedAverageResult = document.getElementById('weighted-average-result');


            const weekdays = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const NOTIFICATION_LEAD_TIME_MINUTES = 5;
            const MAX_CUSTOM_SOUND_SIZE_MB = 2;
            let notificationCheckInterval = null;
            let shownNotificationsThisMinute = {};
            let draggedStudentId = null;
            let draggedElement = null;
            let tempClassroomLayout = null;
            let selectedSeatForAssignment = null;

            // Tool States
            let sorterStudentList = [];
            let sorterAvailableStudents = [];
            let sorterDrawnStudents = [];
            let stopwatchInterval = null;
            let stopwatchSeconds = 0;
            let isStopwatchRunning = false;

            // Calculator State
            let calculator = {
                displayValue: '0',
                firstOperand: null,
                waitingForSecondOperand: false,
                operator: null,
                mode: 'standard', // 'standard' or 'weighted'
                weightedPairs: [] // Array of { grade: number, weight: number }
            };


            let appData = {
                schools: [], classes: [], students: [], schedule: [],
                settings: { theme: 'theme-light', globalNotificationsEnabled: true, notificationSoundEnabled: true, customNotificationSound: null }
            };
            let currentSchoolId = null; let currentClassId = null; let currentSection = 'schedule-section';

            // --- Funções de Estado e Persistência (Existentes, sem mudanças aqui) ---
            const saveAppState = () => { try { localStorage.setItem('lastSection', currentSection || 'schedule-section'); localStorage.setItem('lastSchoolId', currentSchoolId || ''); localStorage.setItem('lastClassId', currentClassId || ''); } catch (e) { console.error("Erro ao salvar estado:", e); } };
            const restoreAppState = () => { const lastSection = localStorage.getItem('lastSection'); const lastSchoolId = localStorage.getItem('lastSchoolId'); const lastClassId = localStorage.getItem('lastClassId'); console.log("Restoring App State:", {lastSection, lastSchoolId, lastClassId}); currentSection = 'schedule-section'; currentSchoolId = null; currentClassId = null; if (appData.schools.length > 0) { currentSchoolId = lastSchoolId || appData.schools[0].id; if (!findSchoolById(currentSchoolId)) { currentSchoolId = appData.schools[0]?.id || null; currentClassId = null; currentSection = currentSchoolId ? 'classes-section' : 'schools-section'; } else { currentClassId = lastClassId || null; if (currentClassId && !findClassById(currentClassId)) { currentClassId = null; } if (lastSection) { if (lastSection === 'class-details-section' && currentClassId && findClassById(currentClassId)) { currentSection = 'class-details-section'; } else if (lastSection === 'classes-section' && currentSchoolId) { currentSection = 'classes-section'; currentClassId = null; } else if (lastSection === 'schools-section') { currentSection = 'schools-section'; currentSchoolId = null; currentClassId = null; } else if (['schedule-section', 'tools-section', 'contact-section', 'settings-section'].includes(lastSection)){ const sectionExists = document.getElementById(lastSection); if(sectionExists) { currentSection = lastSection; if(['schedule-section', 'tools-section', 'contact-section', 'settings-section'].includes(lastSection)) { currentSchoolId = null; currentClassId = null; } } else { currentSection = currentSchoolId ? 'classes-section' : 'schools-section'; currentClassId = null; } } else { currentSection = currentSchoolId ? 'classes-section' : 'schools-section'; currentClassId = null; } } else { if (currentClassId) currentSection = 'class-details-section'; else if (currentSchoolId) currentSection = 'classes-section'; else currentSection = 'schools-section'; } } } else { currentSection = 'schedule-section'; } if(['contact-section', 'settings-section', 'tools-section'].includes(lastSection)){ currentSection = lastSection; } console.log(`Estado Final Restaurado: Section=${currentSection}, School=${currentSchoolId}, Class=${currentClassId}`); };

            // --- Funções Utilitárias (Existentes, sem mudanças aqui) ---
            const generateId = (prefix = 'id') => `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const saveData = () => { try { localStorage.setItem('superProfessorProData_v14', JSON.stringify(appData)); console.log("Data saved (v14)."); } catch (e) { console.error("Erro salvar:", e); if (e.name === 'QuotaExceededError') { alert("Erro: Não há espaço suficiente para salvar os dados. Isso pode ser devido a um arquivo de som personalizado muito grande."); } else { alert("Erro ao salvar dados."); } } };
            const loadData = () => {
                const dataV14 = localStorage.getItem('superProfessorProData_v14');
                let dataToParse = dataV14; let importedVersion = 14;
                if (!dataToParse) { const dataV13 = localStorage.getItem('superProfessorProData_v13'); if (dataV13) { console.log("Importing data from v13..."); dataToParse = dataV13; importedVersion = 13; } }

                if (dataToParse) {
                    try {
                        appData = JSON.parse(dataToParse);
                        appData.schools = appData.schools || []; appData.classes = appData.classes || []; appData.students = appData.students || []; appData.schedule = appData.schedule || []; appData.settings = appData.settings || {};
                        appData.settings.theme = appData.settings.theme || 'theme-light';
                        appData.settings.globalNotificationsEnabled = appData.settings.globalNotificationsEnabled !== undefined ? appData.settings.globalNotificationsEnabled : true;
                        appData.settings.notificationSoundEnabled = appData.settings.notificationSoundEnabled !== undefined ? appData.settings.notificationSoundEnabled : true;
                        appData.settings.customNotificationSound = appData.settings.customNotificationSound || null;
                        if (appData.settings.nonSchoolDays) { delete appData.settings.nonSchoolDays; }
                        appData.classes.forEach(c => {
                            c.notes = c.notes || ''; c.schoolId = c.schoolId || null;
                            c.gradeStructure = c.gradeStructure || [];
                            c.gradeStructure.forEach(gs => { delete gs.periodType; if (gs.colorRanges === undefined) { gs.colorRanges = []; } });
                            c.lessonPlans = c.lessonPlans || {};
                            if (!c.classroomLayout) { c.classroomLayout = { rows: 5, cols: 6, teacherDeskPosition: 'top-center', seats: [] }; } else { c.classroomLayout.seats = c.classroomLayout.seats || []; const validPositions = ['top-left', 'top-center', 'top-right', 'bottom-left', 'bottom-center', 'bottom-right', 'left-top', 'left-center', 'left-bottom', 'right-top', 'right-center', 'right-bottom']; if (!validPositions.includes(c.classroomLayout.teacherDeskPosition)) { c.classroomLayout.teacherDeskPosition = 'top-center'; } }
                         });
                        appData.students.forEach(s => {
                            s.grades = s.grades || {}; s.attendance = s.attendance || {};
                            Object.keys(s.attendance).forEach(date => { const record = s.attendance[date]; if (record && typeof record === 'object') { record.status = record.status || null; record.justification = String(record.justification || ''); } else { s.attendance[date] = { status: null, justification: '' }; } });
                            s.notes = s.notes || []; if (typeof s.notes === 'string') { const oldNotes = s.notes.trim(); s.notes = oldNotes ? [{ date: 'N/A', text: oldNotes }] : []; } else if (!Array.isArray(s.notes)) { s.notes = []; } s.notes = s.notes.map(note => ({ date: note?.date || 'N/A', text: note?.text || '' })).filter(note => note.text.trim()); });
                        appData.schedule.forEach(item => { if (item.notificationsEnabled === undefined) { item.notificationsEnabled = true; } });

                        console.log(`Data loaded (from version ${importedVersion}):`, appData);
                        if (importedVersion < 14) {
                            if (appData.settings.customNotificationSound === undefined) { appData.settings.customNotificationSound = null; }
                            saveData();
                            if (localStorage.getItem('superProfessorProData_v13')) localStorage.removeItem('superProfessorProData_v13');
                            console.log("Migrated data saved as v14.");
                        }
                    } catch (e) {
                        console.error("Erro carregar ou migrar dados:", e);
                        appData = { schools: [], classes: [], students: [], schedule: [], settings: { theme: 'theme-light', globalNotificationsEnabled: true, notificationSoundEnabled: true, customNotificationSound: null } };
                        localStorage.removeItem('superProfessorProData_v13');
                        localStorage.removeItem('superProfessorProData_v14');
                    }
                } else { appData = { schools: [], classes: [], students: [], schedule: [], settings: { theme: 'theme-light', globalNotificationsEnabled: true, notificationSoundEnabled: true, customNotificationSound: null } }; }
                applyTheme(appData.settings.theme);
                updateNotificationSettingsUI();
                updateCustomSoundUI();
            };

            const applyTheme = (themeName) => { document.body.className = themeName || 'theme-light'; appData.settings.theme = themeName; document.querySelectorAll('.theme-button').forEach(btn => { btn.style.border = btn.dataset.theme === themeName ? '2px solid var(--accent-primary)' : 'none'; }); };
            const showSection = (sectionId) => { sections.forEach(section => section.classList.toggle('active', section.id === sectionId)); navButtons.forEach(button => button.classList.toggle('active', button.dataset.section === sectionId)); currentSection = sectionId; navClassesButton.disabled = !currentSchoolId; navDetailsButton.disabled = !currentClassId; updateHeaderInfo(); document.querySelectorAll('.fab-button').forEach(fab => fab.classList.add('hidden')); let fabToShow = null; if (sectionId === 'schedule-section') fabToShow = addScheduleButton; else if (sectionId === 'schools-section') fabToShow = addSchoolButton; else if (sectionId === 'classes-section') fabToShow = addClassButton; if (fabToShow) fabToShow.classList.remove('hidden'); mainContent.scrollTop = 0; saveAppState(); if(sectionId === 'settings-section') { updateNotificationSettingsUI(); updateCustomSoundUI(); } };
            const updateHeaderInfo = () => { let info = ''; if (currentSection === 'classes-section' && currentSchoolId) { const school = findSchoolById(currentSchoolId); info = `Escola: ${school?.name || '?'}`; } else if (currentSection === 'class-details-section' && currentClassId) { const classData = findClassById(currentClassId); const school = findSchoolById(classData?.schoolId); info = `Escola: ${school?.name || '?'} / Turma: ${classData?.name || '?'}`; } else if (currentSection === 'tools-section') { info = 'Ferramentas'; } headerInfo.textContent = info; headerInfo.title = info; };
            const showModal = (title, contentHtml, footerButtonsHtml = '', modalClass = '') => { modalTitle.textContent = title; modalBody.innerHTML = contentHtml; const defaultFooter = `<button type="button" data-dismiss="modal" class="secondary">Fechar</button>`; modalFooter.innerHTML = footerButtonsHtml ? footerButtonsHtml + defaultFooter : defaultFooter; modal.className = 'modal'; if (modalClass) modal.classList.add(modalClass); modal.classList.add('show'); modal.querySelectorAll('[data-dismiss="modal"]').forEach(btn => { if (!btn.listenerAttached) { btn.addEventListener('click', hideModal); btn.listenerAttached = true; } }); };
             const hideModal = () => {
                 if (stopwatchInterval) { clearInterval(stopwatchInterval); stopwatchInterval = null; isStopwatchRunning = false; }
                 // Hide generic modal
                 modal.classList.remove('show');
                 // Hide calculator modal specifically if it's the one being shown
                 calculatorModal?.classList.remove('show');

                 setTimeout(() => {
                     // Reset generic modal content
                     modalTitle.textContent = '';
                     modalBody.innerHTML = '';
                     modalFooter.innerHTML = '';
                     modal.className = 'modal';
                     // Reset calculator modal state if needed (might be done in openAdvancedCalculatorModal)
                 }, 300);
            };
            const findSchoolById = (id) => appData.schools.find(s => s.id === id);
            const findClassById = (id) => appData.classes.find(c => c.id === id);
            const findStudentById = (id) => appData.students.find(s => s.id === id);
            const findScheduleById = (id) => appData.schedule.find(sch => sch.id === id);
            const getStudentsByClass = (classId) => appData.students.filter(s => s.classId === classId).sort((a, b) => { const numA = parseInt(a.number) || Infinity; const numB = parseInt(b.number) || Infinity; if (numA !== numB) return numA - numB; return a.name.localeCompare(b.name); });
            const formatDate = (dateString) => { if(!dateString || dateString === 'N/A') return 'Data Indefinida'; try { const date = new Date(dateString + 'T00:00:00'); if (isNaN(date.getTime())) return 'Data Inválida'; return date.toLocaleDateString('pt-BR'); } catch { return dateString; } };
            const getCurrentDateString = () => new Date().toISOString().slice(0, 10);
            const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const getDayOfWeek = (year, month, day) => new Date(year, month, day).getDay();
            const sanitizeHTML = (str) => { if (str === null || str === undefined) return ''; const temp = document.createElement('div'); temp.textContent = String(str); return temp.innerHTML; };
            function getContrastYIQ(hexcolor){ if (!hexcolor || hexcolor.length < 4) return '#000000'; hexcolor = hexcolor.replace("#", ""); let r,g,b; if (hexcolor.length === 3) { r = parseInt(hexcolor.substr(0,1)+hexcolor.substr(0,1), 16); g = parseInt(hexcolor.substr(1,1)+hexcolor.substr(1,1), 16); b = parseInt(hexcolor.substr(2,1)+hexcolor.substr(2,1), 16); } else if (hexcolor.length === 6) { r = parseInt(hexcolor.substr(0,2), 16); g = parseInt(hexcolor.substr(2,2), 16); b = parseInt(hexcolor.substr(4,2), 16); } else { return '#000000'; } const yiq = ((r*299)+(g*587)+(b*114))/1000; return (yiq >= 128) ? '#000000' : '#FFFFFF'; }
            const getGradeBackgroundColor = (value, ranges) => { if (value === null || value === undefined || !Array.isArray(ranges) || ranges.length === 0) { return null; } const numericValue = parseFloat(value); if (isNaN(numericValue)) { return null; } for (const range of ranges) { const min = parseFloat(range.min); const max = parseFloat(range.max); if (!isNaN(min) && !isNaN(max) && numericValue >= min && numericValue <= max) { return range.color; } } return null; };
            const applyGradeColor = (element, value, ranges) => { const bgColor = getGradeBackgroundColor(value, ranges); if (bgColor) { element.style.backgroundColor = bgColor; element.style.color = getContrastYIQ(bgColor); } else { element.style.backgroundColor = ''; element.style.color = ''; } };

            // --- Funções de Renderização (Existentes) ---
            const renderScheduleList = () => { scheduleListContainer.innerHTML = ''; if (appData.schedule.length === 0) { scheduleListContainer.innerHTML = '<p style="text-align: center; padding: 1rem;">Nenhum horário cadastrado.</p>'; return; } const scheduleByDay = {}; weekdays.forEach(day => scheduleByDay[day] = []); appData.schedule.forEach(item => { if (scheduleByDay[item.day]) scheduleByDay[item.day].push(item); }); for (const day in scheduleByDay) { scheduleByDay[day].sort((a, b) => (a.startTime || '').localeCompare(b.startTime || '')); } const scheduleTemplate = document.getElementById('schedule-item-template'); weekdays.forEach(day => { if (scheduleByDay[day].length > 0) { const dayGroup = document.createElement('div'); dayGroup.classList.add('schedule-day-group'); const dayTitle = document.createElement('h3'); dayTitle.classList.add('schedule-day-title'); dayTitle.textContent = day; dayGroup.appendChild(dayTitle); scheduleByDay[day].forEach(item => { const clone = scheduleTemplate.content.cloneNode(true); const scheduleElement = clone.querySelector('.schedule-item'); scheduleElement.dataset.id = item.id; const school = findSchoolById(item.schoolId); scheduleElement.querySelector('.schedule-time').textContent = `${item.startTime || '?'} - ${item.endTime || '?'}`; scheduleElement.querySelector('.school-name').textContent = school ? sanitizeHTML(school.name) : 'Escola não encontrada'; scheduleElement.querySelector('.note').textContent = sanitizeHTML(item.note || ''); const notificationButton = clone.querySelector('.notification-toggle-button'); const notificationIndicator = clone.querySelector('.notification-indicator'); updateNotificationIcon(notificationIndicator, item.notificationsEnabled); notificationButton.addEventListener('click', (e) => { e.stopPropagation(); toggleScheduleNotification(item.id, notificationIndicator); }); clone.querySelector('.edit-schedule-button').addEventListener('click', (e) => { e.stopPropagation(); openScheduleModal(item.id); }); clone.querySelector('.delete-schedule-button').addEventListener('click', (e) => { e.stopPropagation(); if (confirm(`Excluir horário (${item.startTime} na ${school?.name || 'escola'})?`)) { deleteScheduleEntry(item.id); } }); dayGroup.appendChild(clone); }); scheduleListContainer.appendChild(dayGroup); } }); };
            const updateNotificationIcon = (indicatorElement, isEnabled) => { if (!indicatorElement) return; indicatorElement.classList.remove('icon-notificacao-on', 'icon-notificacao-off'); if (isEnabled) { indicatorElement.classList.add('icon-notificacao-on'); indicatorElement.parentElement.title = "Notificações Ativadas (Clique para desativar)"; } else { indicatorElement.classList.add('icon-notificacao-off'); indicatorElement.parentElement.title = "Notificações Desativadas (Clique para ativar)"; } };
            const renderSchoolList = () => { schoolListContainer.innerHTML = ''; if (appData.schools.length === 0) { schoolListContainer.innerHTML = '<p style="text-align: center; padding: 1rem;">Nenhuma escola cadastrada.</p>'; return; } const template = document.getElementById('school-item-template'); appData.schools.sort((a,b) => a.name.localeCompare(b.name)).forEach(school => { const clone = template.content.cloneNode(true); const item = clone.querySelector('.list-item'); item.dataset.id = school.id; item.querySelector('.school-name').textContent = sanitizeHTML(school.name); item.querySelector('.view-classes-button').addEventListener('click', (e) => { e.stopPropagation(); selectSchool(school.id); showSection('classes-section'); }); item.querySelector('.edit-school-button').addEventListener('click', (e) => { e.stopPropagation(); openSchoolModal(school.id); }); item.querySelector('.delete-school-button').addEventListener('click', (e) => { e.stopPropagation(); if (confirm(`Excluir escola "${sanitizeHTML(school.name)}" e TODOS os dados associados?`)) { deleteSchool(school.id); } }); item.addEventListener('click', () => { selectSchool(school.id); showSection('classes-section'); }); schoolListContainer.appendChild(clone); }); };
            const renderClassList = (schoolId) => { classListContainer.innerHTML = ''; const school = findSchoolById(schoolId); classesSchoolName.textContent = school ? sanitizeHTML(school.name) : 'Selecione Escola'; if (!school) { classListContainer.innerHTML = '<p style="text-align: center; padding: 1rem;">Escola não encontrada.</p>'; return; } const classesInSchool = appData.classes.filter(c => c.schoolId === schoolId); if (classesInSchool.length === 0) { classListContainer.innerHTML = `<p style="text-align: center; padding: 1rem;">Nenhuma turma cadastrada para ${sanitizeHTML(school.name)}.</p>`; return; } const template = document.getElementById('class-item-template'); classesInSchool.sort((a,b) => a.name.localeCompare(b.name)).forEach(cls => { const clone = template.content.cloneNode(true); const item = clone.querySelector('.list-item'); item.dataset.id = cls.id; item.querySelector('.class-name').textContent = sanitizeHTML(cls.name); item.querySelector('.class-details').textContent = `${sanitizeHTML(cls.subject || 'Sem matéria')} - ${sanitizeHTML(cls.shift || 'Sem turno')} - ${sanitizeHTML(cls.schedule || 'Sem horário')}`; if(cls.id === currentClassId) item.classList.add('active'); item.querySelector('.view-details-button').addEventListener('click', (e) => { e.stopPropagation(); selectClass(cls.id); showSection('class-details-section'); }); item.querySelector('.edit-class-button').addEventListener('click', (e) => { e.stopPropagation(); openClassModal(cls.id); }); item.querySelector('.delete-class-button').addEventListener('click', (e) => { e.stopPropagation(); if (confirm(`Excluir turma "${sanitizeHTML(cls.name)}" e TODOS os dados associados?`)) { deleteClass(cls.id); } }); item.addEventListener('click', () => { selectClass(cls.id); showSection('class-details-section'); }); classListContainer.appendChild(clone); }); };
            const renderStudentList = (classId) => { studentListContainer.innerHTML = ''; const studentsInClass = getStudentsByClass(classId); if (studentsInClass.length === 0) { studentListContainer.innerHTML = '<p style="text-align: center; padding: 1rem;">Nenhum aluno nesta turma ainda.</p>'; return; } const template = document.getElementById('student-list-item-template'); studentsInClass.forEach(std => { const clone = template.content.cloneNode(true); const item = clone.querySelector('.list-item'); item.dataset.id = std.id; item.querySelector('.student-number').textContent = std.number ? `${std.number}.` : '-.'; item.querySelector('.student-name').textContent = sanitizeHTML(std.name); item.querySelector('.edit-student-button').addEventListener('click', (e) => { e.stopPropagation(); openStudentModal(std.id); }); item.querySelector('.delete-student-button').addEventListener('click', (e) => { e.stopPropagation(); if (confirm(`Excluir aluno "${sanitizeHTML(std.name)}"?`)) { deleteStudent(std.id); } }); item.querySelector('.notes-student-button').addEventListener('click', (e) => { e.stopPropagation(); openStudentNotesModal(std.id); }); item.querySelector('.move-student-button').addEventListener('click', (e) => { e.stopPropagation(); openMoveStudentModal(std.id); }); item.style.cursor = 'default'; studentListContainer.appendChild(clone); }); };
            const renderGradeSets = (classId) => { gradeSetSelect.innerHTML = ''; const currentClass = findClassById(classId); if (!currentClass || !currentClass.gradeStructure || currentClass.gradeStructure.length === 0) { gradeSetSelect.innerHTML = '<option value="">Configure</option>'; gradesTableContainer.innerHTML = '<p style="padding: 1rem; text-align: center;">Configure a estrutura de notas clicando no ícone <span class="icon icon-estrutura"></span>.</p>'; saveGradesButton.classList.add('hidden'); manageGradeStructureButton.style.borderColor = 'var(--accent-warning)'; exportGradesCsvButton.classList.add('hidden'); exportGradesPdfButton.classList.add('hidden'); return; } manageGradeStructureButton.style.borderColor = 'transparent'; currentClass.gradeStructure.forEach(gs => { const option = document.createElement('option'); option.value = gs.id; option.textContent = sanitizeHTML(gs.name); gradeSetSelect.appendChild(option); }); if (getStudentsByClass(classId).length > 0) { renderGradesTable(classId, gradeSetSelect.value); } else { gradesTableContainer.innerHTML = '<p style="padding: 1rem; text-align: center;">Adicione alunos para registrar notas.</p>'; saveGradesButton.classList.add('hidden'); exportGradesCsvButton.classList.add('hidden'); exportGradesPdfButton.classList.add('hidden'); } };
            const renderGradesTable = (classId, gradeSetId) => { gradesTableContainer.innerHTML = ''; const currentClass = findClassById(classId); const gradeSet = currentClass?.gradeStructure?.find(gs => gs.id === gradeSetId); const studentsInClass = getStudentsByClass(classId); const colorRanges = gradeSet?.colorRanges || []; if (!gradeSet || studentsInClass.length === 0) { gradesTableContainer.innerHTML = `<p style="padding: 1rem; text-align: center;">${!gradeSet ? 'Selecione um conjunto de notas válido.' : 'Nenhum aluno para exibir notas.'}</p>`; saveGradesButton.classList.add('hidden'); if(exportGradesCsvButton) exportGradesCsvButton.classList.add('hidden'); if(exportGradesPdfButton) exportGradesPdfButton.classList.add('hidden'); return; } saveGradesButton.classList.remove('hidden'); if(exportGradesCsvButton) exportGradesCsvButton.classList.remove('hidden'); if(exportGradesPdfButton) exportGradesPdfButton.classList.remove('hidden'); const table = document.createElement('table'); table.classList.add('data-table'); const thead = table.createTHead(); const tbody = table.createTBody(); const headerRow = thead.insertRow(); const headerTemplate = document.getElementById('grades-header-template'); const headerContent = headerTemplate.content.cloneNode(true); headerRow.appendChild(headerContent.querySelector('.student-col').cloneNode(true)); gradeSet.gradeLabels.forEach(label => { const th = document.createElement('th'); th.classList.add('grade-col'); th.textContent = sanitizeHTML(label); headerRow.appendChild(th); }); headerRow.appendChild(headerContent.querySelector('.sum-col').cloneNode(true)); headerRow.appendChild(headerContent.querySelector('.avg-col').cloneNode(true)); const rowTemplate = document.getElementById('grades-row-template'); studentsInClass.forEach(std => { const clone = rowTemplate.content.cloneNode(true); const row = clone.querySelector('tr'); row.dataset.studentId = std.id; const studentCol = row.querySelector('.student-col'); if(studentCol) { studentCol.querySelector('.student-number').textContent = std.number ? `${std.number}.` : '-.'; studentCol.querySelector('.student-name').textContent = sanitizeHTML(std.name); } const sumCellTemplate = row.querySelector('.sum'); const avgCellTemplate = row.querySelector('.average'); if(sumCellTemplate) sumCellTemplate.remove(); if(avgCellTemplate) avgCellTemplate.remove(); const studentGradesForSet = std.grades[gradeSetId] || {}; const fragment = document.createDocumentFragment(); gradeSet.gradeLabels.forEach(label => { const td = document.createElement('td'); td.classList.add('grade-col'); const input = document.createElement('input'); input.type = 'number'; input.classList.add('grade-input'); input.dataset.label = label; input.min = "0"; input.max = "100"; input.step = "0.1"; input.placeholder = sanitizeHTML(label); const gradeValue = studentGradesForSet[label] ?? ''; input.value = gradeValue; applyGradeColor(input, gradeValue, colorRanges); input.addEventListener('input', (e) => { applyGradeColor(e.target, e.target.value, colorRanges); calculateAndUpdateSumAndAverage(row, gradeSet.gradeLabels, colorRanges); }); td.appendChild(input); fragment.appendChild(td); }); studentCol.after(fragment); if(sumCellTemplate) row.appendChild(sumCellTemplate); if(avgCellTemplate) row.appendChild(avgCellTemplate); calculateAndUpdateSumAndAverage(row, gradeSet.gradeLabels, colorRanges); tbody.appendChild(row); }); gradesTableContainer.appendChild(table); };
            const calculateAndUpdateSumAndAverage = (tableRow, gradeLabels, colorRanges) => { let sum = 0; let count = 0; gradeLabels.forEach(label => { const input = tableRow.querySelector(`input[data-label="${label}"]`); const value = parseFloat(input?.value); if (!isNaN(value)) { sum += value; count++; } }); const sumCell = tableRow.querySelector('.sum'); const avgCell = tableRow.querySelector('.average'); if (sumCell) { sumCell.textContent = count > 0 ? sum.toFixed(1) : '--'; } if (avgCell) { const avg = count > 0 ? (sum / count) : null; avgCell.textContent = avg !== null ? avg.toFixed(1) : '--'; if (colorRanges && colorRanges.length > 0) { applyGradeColor(avgCell, avg, colorRanges); avgCell.classList.remove('grade-low', 'grade-medium', 'grade-high'); } else { avgCell.style.backgroundColor = ''; avgCell.style.color = ''; avgCell.classList.remove('grade-low', 'grade-medium', 'grade-high'); if(avg !== null) { if (avg < 5) avgCell.classList.add('grade-low'); else if (avg < 7) avgCell.classList.add('grade-medium'); else avgCell.classList.add('grade-high'); } } } };
            const calculateSumAndAverageForData = (gradesObject) => { let sum = 0; let count = 0; let average = null; if (gradesObject) { for(const label in gradesObject) { if (label !== 'average' && label !== 'sum') { const value = parseFloat(gradesObject[label]); if (!isNaN(value)) { sum += value; count++; } } } } if (count > 0) { average = parseFloat((sum / count).toFixed(1)); sum = parseFloat(sum.toFixed(1)); } else { sum = null; } return { sum: sum, average: average }; };
            const renderAttendanceTable = (classId, date) => { attendanceTableContainer.innerHTML = ''; saveAttendanceButton.classList.add('hidden'); attendanceActionsContainer.classList.add('hidden'); const studentsInClass = getStudentsByClass(classId); if (!date) { attendanceTableContainer.innerHTML = '<p style="padding: 1rem; text-align: center;">Selecione uma data.</p>'; return; } if (studentsInClass.length === 0) { attendanceTableContainer.innerHTML = '<p style="padding: 1rem; text-align: center;">Nenhum aluno para registrar presença.</p>'; return; } const isNonSchoolDay = studentsInClass.every(std => std.attendance[date]?.status === 'H'); console.log(`Rendering attendance for ${date}. Is Non-School Day: ${isNonSchoolDay}`); attendanceActionsContainer.classList.remove('hidden'); saveAttendanceButton.classList.remove('hidden'); markAllPresentButton.disabled = isNonSchoolDay; if (isNonSchoolDay) { markNonSchoolDayButton.innerHTML = `<span class="icon icon-nao-letivo"></span>Desm. Não Letivo`; markNonSchoolDayButton.classList.remove('secondary'); markNonSchoolDayButton.classList.add('danger'); markNonSchoolDayButton.title = "Reverter para dia letivo normal"; } else { markNonSchoolDayButton.innerHTML = `<span class="icon icon-nao-letivo"></span>Não Letivo`; markNonSchoolDayButton.classList.remove('danger'); markNonSchoolDayButton.classList.add('secondary'); markNonSchoolDayButton.title = "Marcar este dia como não letivo"; } const table = document.createElement('table'); table.classList.add('data-table'); table.innerHTML = `<thead><tr><th class="student-col">Aluno</th><th class="attendance-status">Status</th></tr></thead><tbody></tbody>`; const tbody = table.querySelector('tbody'); const template = document.getElementById('attendance-row-template'); studentsInClass.forEach(std => { const studentId = std.id; const clone = template.content.cloneNode(true); const row = clone.querySelector('tr'); row.dataset.studentId = studentId; const studentCol = row.querySelector('.student-col'); studentCol.querySelector('.student-number').textContent = std.number ? `${std.number}.` : '-.'; studentCol.querySelector('.student-name').textContent = sanitizeHTML(std.name); const statusCell = row.querySelector('.attendance-status'); if (!std.attendance[date]) std.attendance[date] = { status: null, justification: '' }; const currentStatus = std.attendance[date].status; const currentJustification = std.attendance[date].justification || ''; statusCell.innerHTML = ''; if (currentStatus === 'H') { statusCell.textContent = 'H'; statusCell.classList.add('status-H'); } else { statusCell.classList.remove('status-H'); statusCell.innerHTML = ` <button type="button" class="attendance-toggle present" data-status="P" title="Presente"><span class="icon icon-presenca"></span> P</button> <button type="button" class="attendance-toggle absent" data-status="F" title="Faltou/Justificar"><span class="icon icon-falta"></span> F</button> `; const presentButton = statusCell.querySelector('.attendance-toggle.present'); const absentButton = statusCell.querySelector('.attendance-toggle.absent'); presentButton.disabled = isNonSchoolDay; absentButton.disabled = isNonSchoolDay; const updateButtonUI = (status, justification) => { presentButton.classList.toggle('selected', status === 'P'); absentButton.classList.toggle('selected', status === 'F'); absentButton.classList.toggle('justified', status === 'F' && !!justification); const isJustified = status === 'F' && !!justification; absentButton.innerHTML = `<span class="icon icon-falta"></span> ${isJustified ? 'FJ' : 'F'}`; absentButton.title = isJustified ? `Falta Justificada: ${sanitizeHTML(justification.substring(0, 30))}... (Clique para editar)` : 'Faltou (Clique para justificar)'; }; updateButtonUI(currentStatus, currentJustification); presentButton.addEventListener('click', () => { if (presentButton.disabled) return; const student = findStudentById(studentId); if (!student) return; if (!student.attendance[date]) student.attendance[date] = { status: null, justification: '' }; if (student.attendance[date].status === 'P') { student.attendance[date].status = null; } else { student.attendance[date].status = 'P'; } student.attendance[date].justification = ''; updateButtonUI(student.attendance[date].status, ''); console.log(`Data updated for ${studentId}:`, student.attendance[date]); }); absentButton.addEventListener('click', () => { if (absentButton.disabled) return; const student = findStudentById(studentId); if (!student) return; if (!student.attendance[date]) student.attendance[date] = { status: null, justification: '' }; if (student.attendance[date].status === 'F') { openJustificationModal(studentId, date); } else { student.attendance[date].status = 'F'; student.attendance[date].justification = ''; updateButtonUI('F', ''); console.log(`Data updated for ${studentId}:`, student.attendance[date]); } }); } tbody.appendChild(row); }); attendanceTableContainer.appendChild(table); };
            const renderLessonPlan = (classId, date) => { const currentClass = findClassById(classId); if (!currentClass || !date || !lessonPlanTextarea) { if(lessonPlanTextarea) lessonPlanTextarea.value = ''; if(saveLessonPlanButton) saveLessonPlanButton.classList.add('hidden'); return; } currentClass.lessonPlans = currentClass.lessonPlans || {}; const plan = currentClass.lessonPlans[date] || ''; lessonPlanTextarea.value = plan; saveLessonPlanButton.classList.remove('hidden'); };

            // --- Funções de CRUD (Existentes, sem mudanças aqui) ---
            const openScheduleModal = (scheduleIdToEdit = null) => { const isEditing = scheduleIdToEdit !== null; const scheduleData = isEditing ? findScheduleById(scheduleIdToEdit) : { day: weekdays[new Date().getDay()], notificationsEnabled: true }; const title = isEditing ? 'Editar Horário' : 'Novo Horário'; let schoolOptions = '<option value="">-- Selecione --</option>'; appData.schools.sort((a, b) => a.name.localeCompare(b.name)).forEach(s => { schoolOptions += `<option value="${s.id}" ${scheduleData.schoolId === s.id ? 'selected' : ''}>${sanitizeHTML(s.name)}</option>`; }); let dayOptions = ''; weekdays.slice(1, 6).forEach(day => { dayOptions += `<option value="${day}" ${scheduleData.day === day ? 'selected' : ''}>${day}</option>`; }); if (weekdays.includes(scheduleData.day) && !weekdays.slice(1, 6).includes(scheduleData.day)) { dayOptions += `<option value="${scheduleData.day}" selected>${scheduleData.day}</option>`; } if (!weekdays.includes(scheduleData.day)) { dayOptions += `<option value="Sábado" ${scheduleData.day === 'Sábado' ? 'selected' : ''}>Sábado</option>`; dayOptions += `<option value="Domingo" ${scheduleData.day === 'Domingo' ? 'selected' : ''}>Domingo</option>`; } const modalContent = ` <form id="schedule-form"> <input type="hidden" id="schedule-id" value="${isEditing ? scheduleIdToEdit : ''}"> <div class="form-group"> <label for="schedule-day">Dia:</label> <select id="schedule-day" required>${dayOptions}</select> </div> <div class="form-group d-flex"> <div style="flex: 1; margin-right: 5px;"> <label for="schedule-start-time">Início:</label> <input type="time" id="schedule-start-time" required value="${scheduleData.startTime || ''}"> </div> <div style="flex: 1; margin-left: 5px;"> <label for="schedule-end-time">Fim:</label> <input type="time" id="schedule-end-time" required value="${scheduleData.endTime || ''}"> </div> </div> <div class="form-group"> <label for="schedule-school">Escola:</label> <select id="schedule-school" required>${schoolOptions}</select> </div> <div class="form-group"> <label for="schedule-note">Anotação:</label> <input type="text" id="schedule-note" placeholder="Ex: Aula Turma 8B" value="${sanitizeHTML(scheduleData.note || '')}"> </div> <div class="checkbox-group"> <input type="checkbox" id="enable-schedule-notification" ${scheduleData.notificationsEnabled ? 'checked' : ''}> <label for="enable-schedule-notification">Ativar Notificações para este Horário</label> </div> </form> `; const footerButtons = `<button type="button" id="save-schedule-button" class="success"><span class="icon icon-salvar"></span> Salvar</button>`; showModal(title, modalContent, footerButtons); document.getElementById('save-schedule-button').addEventListener('click', saveScheduleEntry); };
             const saveScheduleEntry = () => { const form = document.getElementById('schedule-form'); if (!form || !form.checkValidity()) { alert('Preencha os campos obrigatórios (Dia, Horários, Escola).'); form?.reportValidity(); return; } const id = document.getElementById('schedule-id').value; const newData = { id: id || generateId('sch'), day: document.getElementById('schedule-day').value, startTime: document.getElementById('schedule-start-time').value, endTime: document.getElementById('schedule-end-time').value, schoolId: document.getElementById('schedule-school').value, note: document.getElementById('schedule-note').value.trim(), notificationsEnabled: document.getElementById('enable-schedule-notification').checked }; if (!newData.schoolId) { alert('Selecione uma escola.'); return; } if (id) { const index = appData.schedule.findIndex(item => item.id === id); if (index > -1) appData.schedule[index] = newData; } else { appData.schedule.push(newData); } saveData(); renderScheduleList(); hideModal(); };
             const deleteScheduleEntry = (id) => { appData.schedule = appData.schedule.filter(item => item.id !== id); saveData(); renderScheduleList(); };
             const toggleScheduleNotification = (scheduleId, indicatorElement) => { const item = findScheduleById(scheduleId); if (item) { item.notificationsEnabled = !item.notificationsEnabled; saveData(); updateNotificationIcon(indicatorElement, item.notificationsEnabled); console.log(`Notification for ${scheduleId} set to: ${item.notificationsEnabled}`); } };
             const openSchoolModal = (schoolIdToEdit = null) => { const isEditing = schoolIdToEdit !== null; const schoolData = isEditing ? findSchoolById(schoolIdToEdit) : {}; const title = isEditing ? 'Editar Escola' : 'Nova Escola'; const modalContent = `<form id="school-form"><input type="hidden" id="school-id" value="${isEditing ? schoolIdToEdit : ''}"><div class="form-group"><label for="school-name">Nome:</label><input type="text" id="school-name" required value="${sanitizeHTML(schoolData.name || '')}"></div></form>`; const footerButtons = `<button type="button" id="save-school-button" class="success"><span class="icon icon-salvar"></span> Salvar</button>`; showModal(title, modalContent, footerButtons); document.getElementById('save-school-button').addEventListener('click', saveSchool); };
             const saveSchool = () => { const form = document.getElementById('school-form'); if (!form || !form.checkValidity()) { alert('Preencha o nome da escola.'); form?.reportValidity(); return; } const id = document.getElementById('school-id').value; const newSchoolData = { id: id || generateId('sch'), name: document.getElementById('school-name').value.trim() }; if (id) { const index = appData.schools.findIndex(s => s.id === id); if (index > -1) appData.schools[index] = newSchoolData; } else { appData.schools.push(newSchoolData); } saveData(); renderSchoolList(); if(currentSection === 'schedule-section') renderScheduleList(); hideModal(); };
             const deleteSchool = (id) => { const classesToDelete = appData.classes.filter(c => c.schoolId === id).map(c => c.id); appData.schools = appData.schools.filter(s => s.id !== id); appData.classes = appData.classes.filter(c => c.schoolId !== id); appData.students = appData.students.filter(s => !classesToDelete.includes(s.classId)); appData.schedule = appData.schedule.filter(sch => sch.schoolId !== id); if (currentSchoolId === id) { currentSchoolId = null; currentClassId = null; showSection('schools-section'); } saveData(); renderSchoolList(); if (currentSection === 'schedule-section') renderScheduleList(); if (currentSection === 'classes-section' && !currentSchoolId) { showSection('schools-section'); } else if (currentSection === 'classes-section') { renderClassList(currentSchoolId); } saveAppState(); };
             const selectSchool = (id) => { currentSchoolId = id; currentClassId = null; renderClassList(id); navClassesButton.disabled = false; navDetailsButton.disabled = true; updateHeaderInfo(); saveAppState(); };
             const openClassModal = (classIdToEdit = null) => { if (!currentSchoolId) return; const isEditing = classIdToEdit !== null; const classData = isEditing ? findClassById(classIdToEdit) : {}; const title = isEditing ? 'Editar Turma' : 'Nova Turma'; const schoolName = findSchoolById(currentSchoolId)?.name || '?'; const modalContent = `<form id="class-form"><input type="hidden" id="class-id" value="${isEditing ? classIdToEdit : ''}"><p class="mb-1"><strong>Escola:</strong> ${sanitizeHTML(schoolName)}</p><div class="form-group"><label for="class-name">Nome Turma:</label><input type="text" id="class-name" required value="${sanitizeHTML(classData.name || '')}"></div><div class="form-group"><label for="class-subject">Matéria:</label><input type="text" id="class-subject" value="${sanitizeHTML(classData.subject || '')}"></div><div class="form-group d-flex"><div style="flex: 1; margin-right: 5px;"><label for="class-schedule">Horário:</label><input type="time" id="class-schedule" value="${classData.schedule || ''}"></div><div style="flex: 1; margin-left: 5px;"><label for="class-shift">Turno:</label><select id="class-shift"><option value="">--</option><option value="Manhã" ${classData.shift === 'Manhã' ? 'selected' : ''}>Manhã</option><option value="Tarde" ${classData.shift === 'Tarde' ? 'selected' : ''}>Tarde</option><option value="Noite" ${classData.shift === 'Noite' ? 'selected' : ''}>Noite</option><option value="Integral" ${classData.shift === 'Integral' ? 'selected' : ''}>Integral</option></select></div></div></form>`; const footerButtons = `<button type="button" id="save-class-button" class="success"><span class="icon icon-salvar"></span> Salvar</button>`; showModal(title, modalContent, footerButtons); document.getElementById('save-class-button').addEventListener('click', saveClass); };
             const saveClass = () => { const form = document.getElementById('class-form'); if (!form || !form.checkValidity() || !currentSchoolId) { alert('Preencha nome da turma e verifique escola.'); form?.reportValidity(); return; } const id = document.getElementById('class-id').value; const isEditing = !!id; const newClassData = { id: id || generateId('cls'), schoolId: currentSchoolId, name: document.getElementById('class-name').value.trim(), subject: document.getElementById('class-subject').value.trim(), schedule: document.getElementById('class-schedule').value, shift: document.getElementById('class-shift').value, notes: '', gradeStructure: [], lessonPlans: {}, classroomLayout: { rows: 5, cols: 6, teacherDeskPosition: 'top-center', seats: [] } }; if (isEditing) { const index = appData.classes.findIndex(c => c.id === id); if (index > -1) { newClassData.notes = appData.classes[index].notes || ''; newClassData.gradeStructure = appData.classes[index].gradeStructure || []; newClassData.lessonPlans = appData.classes[index].lessonPlans || {}; newClassData.classroomLayout = appData.classes[index].classroomLayout || { rows: 5, cols: 6, teacherDeskPosition: 'top-center', seats: [] }; appData.classes[index] = newClassData; } } else { appData.classes.push(newClassData); } saveData(); renderClassList(currentSchoolId); if (id && id === currentClassId && currentSection === 'class-details-section') { selectClass(id, true); } hideModal(); };
             const deleteClass = (id) => { appData.classes = appData.classes.filter(c => c.id !== id); appData.students = appData.students.filter(s => s.classId !== id); if (currentClassId === id) { currentClassId = null; showSection('classes-section'); } saveData(); renderClassList(currentSchoolId); if (!currentClassId) navDetailsButton.disabled = true; updateHeaderInfo(); saveAppState(); };
             const selectClass = (id, forceReload = false) => { if (currentClassId !== id || forceReload) { console.log(`Selecionando Turma: ${id}, Forçar Recarga: ${forceReload}`); if (tempClassroomLayout) { cancelClassroomMapEdit(); } currentClassId = id; const selectedClass = findClassById(id); if (selectedClass) { classDetailsTitle.textContent = `${sanitizeHTML(selectedClass.name)} (${sanitizeHTML(selectedClass.subject || 'Sem matéria')})`; renderStudentList(id); renderGradeSets(id); const currentDate = attendanceDateInput.value || getCurrentDateString(); attendanceDateInput.value = currentDate; lessonPlanDateInput.value = currentDate; renderAttendanceTable(id, currentDate); renderLessonPlan(id, currentDate); renderClassroomMap(id); classNotesContent.textContent = sanitizeHTML(selectedClass.notes || 'Nenhuma anotação.'); classNotesTextarea.value = selectedClass.notes || ''; classNotesEdit.classList.add('hidden'); classNotesDisplay.classList.remove('hidden'); if (currentSection === 'classes-section') renderClassList(selectedClass.schoolId); navDetailsButton.disabled = false; classDetailsSection.querySelectorAll('.card').forEach(card => { card.classList.remove('collapsed'); const toggleBtn = card.querySelector('.card-toggle-button .icon'); if (toggleBtn) { toggleBtn.classList.remove('icon-chevron-down'); toggleBtn.classList.add('icon-chevron-up'); toggleBtn.parentElement.title = 'Esconder'; } }); } else { currentClassId = null; classDetailsTitle.textContent = "Erro: Turma não encontrada"; studentListContainer.innerHTML = '<p>Erro</p>'; gradesTableContainer.innerHTML = '<p>Erro</p>'; attendanceTableContainer.innerHTML = '<p>Erro</p>'; lessonPlanTextarea.value = ''; saveLessonPlanButton.classList.add('hidden'); classNotesContent.textContent = 'Erro'; classroomContainerDisplay.innerHTML = '<p style="padding: 1rem; text-align: center; grid-column: 1 / -1; grid-row: 1 / -1;">Erro ao carregar mapa.</p>'; navDetailsButton.disabled = true; } updateHeaderInfo(); saveAppState(); } else if (forceReload && currentSection === 'class-details-section') { console.log(`Forçando recarga da Turma ${id}`); if (tempClassroomLayout) { cancelClassroomMapEdit(); } renderStudentList(id); renderGradeSets(id); renderAttendanceTable(id, attendanceDateInput.value || getCurrentDateString()); renderLessonPlan(id, lessonPlanDateInput.value || getCurrentDateString()); renderClassroomMap(id); } else { console.log(`Turma ${id} já selecionada, sem recarga forçada.`); } };
             const openStudentModal = (studentIdToEdit = null) => { if (!currentClassId) return; const isEditing = studentIdToEdit !== null; const studentData = isEditing ? findStudentById(studentIdToEdit) : {}; const title = isEditing ? 'Editar Aluno' : 'Novo Aluno'; const className = findClassById(currentClassId)?.name || '?'; const modalContent = `<form id="student-form"><p class="mb-1"><strong>Turma:</strong> ${sanitizeHTML(className)}</p><input type="hidden" id="student-id" value="${isEditing ? studentIdToEdit : ''}"><div class="form-group d-flex align-items-center"><div style="width: 80px; margin-right: 10px;"><label for="student-number">Nº:</label><input type="number" id="student-number" min="1" step="1" value="${studentData.number || ''}" style="padding: 0.7rem 0.5rem;"></div><div style="flex-grow: 1;"><label for="student-name">Nome:</label><input type="text" id="student-name" required value="${sanitizeHTML(studentData.name || '')}"></div></div></form>`; const footerButtons = `<button type="button" id="save-student-button" class="success"><span class="icon icon-salvar"></span> Salvar</button>`; showModal(title, modalContent, footerButtons); document.getElementById('save-student-button').addEventListener('click', saveStudent); };
             const saveStudent = () => { const form = document.getElementById('student-form'); if (!form || !form.checkValidity()) { alert('Preencha o nome do aluno.'); form?.reportValidity(); return; } const id = document.getElementById('student-id').value; const studentName = document.getElementById('student-name').value.trim(); const studentNumberInput = document.getElementById('student-number').value; const studentNumber = studentNumberInput ? parseInt(studentNumberInput) : null; if (!currentClassId) return; if (id) { const student = findStudentById(id); if (student) { student.name = studentName; student.number = studentNumber; } } else { const newStudent = { id: generateId('std'), name: studentName, number: studentNumber, classId: currentClassId, grades: {}, attendance: {}, notes: [] }; appData.students.push(newStudent); } saveData(); renderStudentList(currentClassId); if (gradeSetSelect.value) renderGradesTable(currentClassId, gradeSetSelect.value); if (attendanceDateInput.value) renderAttendanceTable(currentClassId, attendanceDateInput.value); renderClassroomMap(currentClassId); hideModal(); };
             const deleteStudent = (id) => { if (currentClassId) { const cls = findClassById(currentClassId); if (cls?.classroomLayout?.seats) { cls.classroomLayout.seats.forEach(seat => { if (seat.studentId === id) { seat.studentId = null; } }); } } appData.students = appData.students.filter(s => s.id !== id); saveData(); renderStudentList(currentClassId); if (gradeSetSelect.value) renderGradesTable(currentClassId, gradeSetSelect.value); if (attendanceDateInput.value) renderAttendanceTable(currentClassId, attendanceDateInput.value); renderClassroomMap(currentClassId); };
             const openStudentNotesModal = (studentId) => { const student = findStudentById(studentId); if (!student) return; if (!Array.isArray(student.notes)) { student.notes = []; } const title = `Observações - ${student.number ? student.number + '. ' : ''}${sanitizeHTML(student.name)}`; const modalContent = `<div id="student-observations-list"></div><div id="add-observation-section"><form id="add-observation-form"><label for="new-observation-text">Nova Observação:</label><textarea id="new-observation-text" placeholder="Digite a nova observação..."></textarea><button type="button" id="add-observation-button" class="success"><span class="icon icon-adicionar"></span> Adicionar Observação</button></form></div>`; showModal(title, modalContent, '', 'student-notes-modal'); renderStudentObservations(studentId); document.getElementById('add-observation-button').addEventListener('click', () => { const newText = document.getElementById('new-observation-text').value.trim(); if (newText) { addStudentObservation(studentId, newText); document.getElementById('new-observation-text').value = ''; } }); document.getElementById('student-observations-list').addEventListener('click', (e) => { const deleteButton = e.target.closest('.delete-observation-button'); if (deleteButton) { const itemElement = deleteButton.closest('.observation-item'); const index = parseInt(itemElement.dataset.index, 10); if (!isNaN(index) && confirm("Excluir esta observação?")) { deleteStudentObservation(studentId, index); } } }); };
             const renderStudentObservations = (studentId) => { const student = findStudentById(studentId); const listContainer = document.getElementById('student-observations-list'); if (!student || !listContainer) return; listContainer.innerHTML = ''; if (!student.notes || student.notes.length === 0) { listContainer.innerHTML = '<p style="text-align: center; padding: 1rem; color: var(--text-secondary);">Nenhuma observação registrada.</p>'; return; } const sortedNotes = [...student.notes].sort((a, b) => (b.date || '').localeCompare(a.date || '')); const template = document.getElementById('observation-item-template'); sortedNotes.forEach(note => { const originalIndex = student.notes.findIndex(n => n.date === note.date && n.text === note.text); if (originalIndex === -1) return; const clone = template.content.cloneNode(true); const itemElement = clone.querySelector('.observation-item'); itemElement.dataset.index = originalIndex; itemElement.querySelector('.observation-date').textContent = formatDate(note.date); itemElement.querySelector('.observation-text').textContent = sanitizeHTML(note.text); listContainer.appendChild(clone); }); };
             const addStudentObservation = (studentId, text) => { const student = findStudentById(studentId); if (!student) return; const newObservation = { date: getCurrentDateString(), text: text }; if (!Array.isArray(student.notes)) { student.notes = []; } student.notes.push(newObservation); saveData(); renderStudentObservations(studentId); };
             const deleteStudentObservation = (studentId, index) => { const student = findStudentById(studentId); if (!student || !Array.isArray(student.notes) || index < 0 || index >= student.notes.length) { console.error("Erro ao excluir observação: índice inválido ou aluno não encontrado.", studentId, index); return; } student.notes.splice(index, 1); saveData(); renderStudentObservations(studentId); };
             const openMoveStudentModal = (studentId) => { const student = findStudentById(studentId); if (!student) { alert("Erro: Aluno não encontrado."); return; } const currentClass = findClassById(student.classId); if (!currentClass) { alert("Erro: Turma atual do aluno não encontrada."); return; } const school = findSchoolById(currentClass.schoolId); if (!school) { alert("Erro: Escola do aluno não encontrada."); return; } const otherClassesInSchool = appData.classes .filter(c => c.schoolId === school.id && c.id !== currentClass.id) .sort((a, b) => a.name.localeCompare(b.name)); let classOptionsHtml = '<option value="">-- Selecione a Turma de Destino --</option>'; if (otherClassesInSchool.length > 0) { otherClassesInSchool.forEach(cls => { classOptionsHtml += `<option value="${cls.id}">${sanitizeHTML(cls.name)} (${sanitizeHTML(cls.subject || 'N/A')})</option>`; }); } else { classOptionsHtml = '<option value="" disabled>Nenhuma outra turma nesta escola</option>'; } const title = `Mover Aluno: ${sanitizeHTML(student.name)}`; const modalContent = ` <form id="move-student-form"> <p><strong>Aluno:</strong> ${sanitizeHTML(student.name)} (#${student.number || 'S/N'})</p> <p class="mb-1"><strong>Turma Atual:</strong> ${sanitizeHTML(currentClass.name)}</p> <input type="hidden" id="move-student-id" value="${studentId}"> <div class="form-group"> <label for="move-student-destination-class">Mover para a Turma:</label> <select id="move-student-destination-class" required ${otherClassesInSchool.length === 0 ? 'disabled' : ''}> ${classOptionsHtml} </select> ${otherClassesInSchool.length === 0 ? '<p class="text-secondary text-sm mt-1">Não há outras turmas cadastradas nesta escola para mover o aluno.</p>' : ''} </div> <div class="form-group"> <label>Opções de Dados:</label> <div class="checkbox-group"> <input type="checkbox" id="move-student-attendance-checkbox" checked> <label for="move-student-attendance-checkbox">Mover Histórico de Frequência?</label> </div> <p class="text-sm text-secondary mt-1">Nota: O histórico de notas NÃO será movido.</p> </div> </form> `; const footerButtons = ` <button type="button" id="confirm-move-student-button" class="success" ${otherClassesInSchool.length === 0 ? 'disabled' : ''}> <span class="icon icon-mover"></span> Mover Aluno </button>`; showModal(title, modalContent, footerButtons, 'move-student-modal'); const confirmButton = document.getElementById('confirm-move-student-button'); if (confirmButton) { confirmButton.replaceWith(confirmButton.cloneNode(true)); document.getElementById('confirm-move-student-button').addEventListener('click', confirmMoveStudent); } };
             const confirmMoveStudent = () => { const studentId = document.getElementById('move-student-id')?.value; const destinationClassId = document.getElementById('move-student-destination-class')?.value; const moveAttendance = document.getElementById('move-student-attendance-checkbox')?.checked; if (!studentId || !destinationClassId) { alert("Erro: Por favor, selecione a turma de destino."); return; } const student = findStudentById(studentId); if (!student) { alert("Erro: Aluno não encontrado."); return; } const destinationClass = findClassById(destinationClassId); if (!destinationClass) { alert("Erro: Turma de destino não encontrada."); return; } const originalClass = findClassById(student.classId); if (student.classId === destinationClassId) { alert("O aluno já está nesta turma."); return; } if (!confirm(`Mover ${sanitizeHTML(student.name)} da turma "${sanitizeHTML(originalClass?.name)}" para "${sanitizeHTML(destinationClass.name)}"?\n\nATENÇÃO: O histórico de notas será RESETADO.\nFrequência será ${moveAttendance ? 'mantida' : 'removida'}.`)) { return; } console.log(`Moving student ${studentId} to class ${destinationClassId}. Move Attendance: ${moveAttendance}`); if (originalClass?.classroomLayout?.seats) { originalClass.classroomLayout.seats.forEach(seat => { if (seat.studentId === studentId) { seat.studentId = null; } }); } student.classId = destinationClassId; student.grades = {}; console.log(` -> Grades cleared for student ${studentId}`); if (!moveAttendance) { student.attendance = {}; console.log(` -> Attendance cleared for student ${studentId}`); } saveData(); hideModal(); if (currentClassId === originalClass?.id && currentSection === 'class-details-section') { renderStudentList(originalClass.id); if (gradeSetSelect.value) renderGradesTable(originalClass.id, gradeSetSelect.value); if (attendanceDateInput.value) renderAttendanceTable(originalClass.id, attendanceDateInput.value); renderClassroomMap(originalClass.id); } else if (currentClassId === destinationClassId && currentSection === 'class-details-section') { renderClassroomMap(destinationClassId); } alert(`Aluno ${sanitizeHTML(student.name)} movido para a turma ${sanitizeHTML(destinationClass.name)} com sucesso! (Histórico de notas resetado)`); };
             const openGradeStructureModal = () => { if (!currentClassId) return; const currentClass = findClassById(currentClassId); const title = `Estrutura Notas - ${sanitizeHTML(currentClass.name)}`; let structureHtml = ''; const gradeStructure = currentClass.gradeStructure || []; if (gradeStructure.length > 0) { gradeStructure.forEach((gs, index) => { const colorRanges = gs.colorRanges || []; let colorRangesHtml = ''; colorRanges.forEach((range, rIndex) => { colorRangesHtml += ` <div class="color-range-item" data-range-index="${rIndex}"> <label>De:</label> <input type="number" class="gs-color-min" step="0.1" placeholder="0.0" value="${range.min ?? ''}"> <label>Até:</label> <input type="number" class="gs-color-max" step="0.1" placeholder="10.0" value="${range.max ?? ''}"> <label>Cor:</label> <input type="color" class="gs-color-input" value="${range.color || '#ffffff'}"> <button type="button" class="delete-color-range-button danger icon-button" title="Excluir Faixa"> <span class="icon icon-excluir icon-only"></span> </button> </div> `; }); structureHtml += ` <div class="card mb-2" data-gs-index="${index}" data-gs-id="${gs.id}"> <div class="card-header"> <input type="text" class="gs-name" value="${sanitizeHTML(gs.name)}" placeholder="Nome do Conjunto de Notas"> <button type="button" class="delete-gs-button danger icon-button" title="Excluir Conjunto ${sanitizeHTML(gs.name)}"> <span class="icon icon-excluir icon-only"></span> </button> </div> <div class="card-content"> <div class="gs-section gs-instruments-container"> <h4>Instrumentos de Avaliação</h4> ${gs.gradeLabels.map((label, lblIndex) => ` <div class="grade-label-item" data-label-index="${lblIndex}"> <input type="text" class="gs-label" value="${sanitizeHTML(label)}" placeholder="Nome da Avaliação (Ex: Prova 1)"> <button type="button" class="delete-gs-label-button danger icon-button" title="Excluir Instrumento"> <span class="icon icon-excluir icon-only"></span> </button> </div>`).join('')} <button type="button" class="add-gs-label-button success mt-1"><span class="icon icon-adicionar"></span> Instrumento</button> </div> <div class="gs-section gs-color-ranges-container"> <h4>Faixas de Cores para Notas</h4> <div class="color-ranges-list">${colorRangesHtml}</div> <button type="button" class="add-color-range-button success mt-1"><span class="icon icon-adicionar"></span> Faixa de Cor</button> </div> </div> </div>`; }); } else { structureHtml = '<p>Nenhuma estrutura definida. Clique em "Adicionar Conjunto".</p>'; } const modalContent = ` <form id="grade-structure-form"> <div id="grade-sets-list">${structureHtml}</div> <button type="button" id="add-grade-set-button" class="success mt-2"><span class="icon icon-adicionar"></span> Adicionar Conjunto</button> </form>`; const footerButtons = `<button type="button" id="save-grade-structure-button" class="success"><span class="icon icon-salvar"></span> Salvar Estrutura</button>`; showModal(title, modalContent, footerButtons, 'grade-structure-modal'); setupGradeStructureModalListeners(); };
             const setupGradeStructureModalListeners = () => { const gradeSetsListContainer = document.getElementById('grade-sets-list'); if (!gradeSetsListContainer) return; const addSetButton = document.getElementById('add-grade-set-button'); const saveStructureButton = document.getElementById('save-grade-structure-button'); gradeSetsListContainer.removeEventListener('click', handleGradeStructureClicks); gradeSetsListContainer.addEventListener('click', handleGradeStructureClicks); if (addSetButton) { addSetButton.replaceWith(addSetButton.cloneNode(true)); document.getElementById('add-grade-set-button').addEventListener('click', addGradeSet); } if (saveStructureButton) { saveStructureButton.replaceWith(saveStructureButton.cloneNode(true)); document.getElementById('save-grade-structure-button').addEventListener('click', saveGradeStructure); } };
             const handleGradeStructureClicks = (e) => { if (e.target.classList.contains('add-gs-label-button') || e.target.closest('.add-gs-label-button')) { const button = e.target.closest('.add-gs-label-button'); const instrumentsContainer = button.closest('.gs-instruments-container'); const template = document.getElementById('grade-label-item-template'); const clone = template.content.cloneNode(true); instrumentsContainer.insertBefore(clone, button); } else if (e.target.classList.contains('delete-gs-label-button') || e.target.closest('.delete-gs-label-button')) { const itemToDelete = e.target.closest('.grade-label-item'); itemToDelete?.remove(); } else if (e.target.classList.contains('add-color-range-button') || e.target.closest('.add-color-range-button')) { const button = e.target.closest('.add-color-range-button'); const rangesList = button.previousElementSibling; const template = document.getElementById('color-range-item-template'); const clone = template.content.cloneNode(true); rangesList.appendChild(clone); } else if (e.target.classList.contains('delete-color-range-button') || e.target.closest('.delete-color-range-button')) { const itemToDelete = e.target.closest('.color-range-item'); itemToDelete?.remove(); } else if (e.target.classList.contains('delete-gs-button') || e.target.closest('.delete-gs-button')) { const cardToDelete = e.target.closest('.card[data-gs-index]'); const setName = cardToDelete?.querySelector('.gs-name')?.value || 'este conjunto'; if (confirm(`Tem certeza que deseja excluir "${setName}" e todas as notas associadas?`)) { const list = cardToDelete?.parentElement; cardToDelete?.remove(); list?.querySelectorAll('.card[data-gs-index]').forEach((card, i) => card.dataset.gsIndex = i); if (list && list.children.length === 0) { list.innerHTML = '<p>Nenhuma estrutura definida.</p>'; } } } };
             const addGradeSet = () => { const list = document.getElementById('grade-sets-list'); const newSetIndex = list.querySelectorAll('.card[data-gs-index]').length; const defaultRangesHtml = ` <div class="color-range-item" data-range-index="0"> <label>De:</label> <input type="number" class="gs-color-min" step="0.1" placeholder="0.0" value="0"> <label>Até:</label> <input type="number" class="gs-color-max" step="0.1" placeholder="4.9" value="4.9"> <label>Cor:</label> <input type="color" class="gs-color-input" value="#dc3545"> <button type="button" class="delete-color-range-button danger icon-button" title="Excluir Faixa"><span class="icon icon-excluir icon-only"></span></button> </div> <div class="color-range-item" data-range-index="1"> <label>De:</label> <input type="number" class="gs-color-min" step="0.1" placeholder="5.0" value="5.0"> <label>Até:</label> <input type="number" class="gs-color-max" step="0.1" placeholder="6.9" value="6.9"> <label>Cor:</label> <input type="color" class="gs-color-input" value="#ffc107"> <button type="button" class="delete-color-range-button danger icon-button" title="Excluir Faixa"><span class="icon icon-excluir icon-only"></span></button> </div> <div class="color-range-item" data-range-index="2"> <label>De:</label> <input type="number" class="gs-color-min" step="0.1" placeholder="7.0" value="7.0"> <label>Até:</label> <input type="number" class="gs-color-max" step="0.1" placeholder="10.0" value="10.0"> <label>Cor:</label> <input type="color" class="gs-color-input" value="#d4edda"> <button type="button" class="delete-color-range-button danger icon-button" title="Excluir Faixa"><span class="icon icon-excluir icon-only"></span></button> </div> `; const newSetHtml = ` <div class="card mb-2" data-gs-index="${newSetIndex}" data-gs-id=""> <div class="card-header"> <input type="text" class="gs-name" value="Novo Conjunto ${newSetIndex + 1}" placeholder="Nome do Conjunto de Notas"> <button type="button" class="delete-gs-button danger icon-button" title="Excluir Conjunto"> <span class="icon icon-excluir icon-only"></span> </button> </div> <div class="card-content"> <div class="gs-section gs-instruments-container"> <h4>Instrumentos de Avaliação</h4> <div class="grade-label-item" data-label-index="0"> <input type="text" class="gs-label" value="Nota 1" placeholder="Nome da Avaliação"> <button type="button" class="delete-gs-label-button danger icon-button" title="Excluir Instrumento"> <span class="icon icon-excluir icon-only"></span> </button> </div> <button type="button" class="add-gs-label-button success mt-1"><span class="icon icon-adicionar"></span> Instrumento</button> </div> <div class="gs-section gs-color-ranges-container"> <h4>Faixas de Cores para Notas</h4> <div class="color-ranges-list">${defaultRangesHtml}</div> <button type="button" class="add-color-range-button success mt-1"><span class="icon icon-adicionar"></span> Faixa de Cor</button> </div> </div> </div>`; const noStructureP = list.querySelector('p'); if (noStructureP) noStructureP.remove(); list.insertAdjacentHTML('beforeend', newSetHtml); };
             const saveGradeStructure = () => { if (!currentClassId) return; const currentClass = findClassById(currentClassId); if (!currentClass) return; const newStructure = []; const gradeSetCards = document.querySelectorAll('#grade-sets-list .card[data-gs-index]'); let valid = true; const existingSetIds = new Set(currentClass.gradeStructure.map(gs => gs.id)); const currentSetIds = new Set(); gradeSetCards.forEach(card => { if (!valid) return; const nameInput = card.querySelector('.gs-name'); const name = nameInput.value.trim(); const setId = card.dataset.gsId || `gs_${currentClassId}_${Date.now()}_${Math.random().toString(16).slice(5)}`; currentSetIds.add(setId); const labels = []; const labelInputs = card.querySelectorAll('.gs-label'); if (!name) { alert('Nome do conjunto é obrigatório.'); nameInput.focus(); valid = false; return; } if (labelInputs.length === 0) { alert(`Conjunto "${name}" precisa ter pelo menos um Instrumento de Avaliação.`); valid = false; return; } labelInputs.forEach(lblInput => { const label = lblInput.value.trim(); if (!label) { alert(`Nome do Instrumento em "${name}" é obrigatório.`); lblInput.focus(); valid = false; } if (valid) labels.push(label); }); if (!valid) return; const colorRanges = []; const rangeItems = card.querySelectorAll('.color-range-item'); rangeItems.forEach(item => { if (!valid) return; const minInput = item.querySelector('.gs-color-min'); const maxInput = item.querySelector('.gs-color-max'); const colorInput = item.querySelector('.gs-color-input'); const min = parseFloat(minInput.value); const max = parseFloat(maxInput.value); const color = colorInput.value; if (isNaN(min) || isNaN(max)) { alert(`Valores Mínimo e Máximo da faixa de cor em "${name}" devem ser números.`); (isNaN(min) ? minInput : maxInput).focus(); valid = false; return; } if (min > max) { alert(`Valor Mínimo (${min}) não pode ser maior que o Máximo (${max}) na faixa de cor em "${name}".`); minInput.focus(); valid = false; return; } colorRanges.push({ min: min, max: max, color: color }); }); if (!valid) return; newStructure.push({ id: setId, name: name, gradeLabels: labels, colorRanges: colorRanges }); }); if (valid) { const deletedSetIds = [...existingSetIds].filter(id => !currentSetIds.has(id)); if (deletedSetIds.length > 0) { console.log("Removing grades for deleted sets:", deletedSetIds); appData.students.forEach(student => { if (student.classId === currentClassId) { deletedSetIds.forEach(deletedId => { if (student.grades[deletedId]) { delete student.grades[deletedId]; } }); } }); } currentClass.gradeStructure = newStructure; saveData(); hideModal(); renderGradeSets(currentClassId); } };
             const saveGrades = () => { const gradeSetId = gradeSetSelect.value; if (!currentClassId || !gradeSetId) { console.warn("Cannot save grades: No class or grade set selected."); return; } const currentClass = findClassById(currentClassId); const gradeSet = currentClass?.gradeStructure?.find(gs => gs.id === gradeSetId); if(!gradeSet) { console.warn("Cannot save grades: Grade set not found."); return; } console.log("Saving grades for set:", gradeSetId); const rows = gradesTableContainer.querySelectorAll('tbody tr'); if(rows.length === 0) { console.warn("No student rows found to save grades."); return; } rows.forEach(row => { const studentId = row.dataset.studentId; const student = findStudentById(studentId); if (student) { if (!student.grades[gradeSetId]) student.grades[gradeSetId] = {}; const currentGrades = {}; gradeSet.gradeLabels.forEach(label => { const input = row.querySelector(`input[data-label="${label}"]`); const value = input?.value.trim(); currentGrades[label] = (value !== '' && !isNaN(parseFloat(value))) ? parseFloat(value) : null; }); const calculated = calculateSumAndAverageForData(currentGrades); student.grades[gradeSetId] = { ...currentGrades, sum: calculated.sum, average: calculated.average }; } else { console.warn(`Student with ID ${studentId} not found during grade save.`); } }); saveData(); alert(`Notas de "${sanitizeHTML(gradeSet.name)}" salvas!`); renderGradesTable(currentClassId, gradeSetId); };
             const escapeCsvField = (field) => { if (field === null || field === undefined) { return '""'; } let fieldStr = String(field); fieldStr = fieldStr.replace(/"/g, '""'); if (fieldStr.includes(',') || fieldStr.includes('"') || fieldStr.includes('\n') || fieldStr.includes('\r')) { return `"${fieldStr}"`; } return fieldStr; };
             const exportGradesCSV = () => { const gradeSetId = gradeSetSelect.value; if (!currentClassId || !gradeSetId) { alert("Selecione uma turma e um conjunto de notas para exportar."); return; } const currentClass = findClassById(currentClassId); const gradeSet = currentClass?.gradeStructure?.find(gs => gs.id === gradeSetId); const students = getStudentsByClass(currentClassId); if (!gradeSet || students.length === 0) { alert("Nenhum dado de nota para exportar."); return; } const className = currentClass?.name.replace(/[^a-z0-9]/gi, '_') || 'Turma'; const setName = gradeSet.name.replace(/[^a-z0-9]/gi, '_') || 'Conjunto'; let csvContent = "\uFEFF"; let header = [escapeCsvField("Aluno"), escapeCsvField("No.")]; gradeSet.gradeLabels.forEach(label => header.push(escapeCsvField(label))); header.push(escapeCsvField("Soma")); header.push(escapeCsvField("Média")); csvContent += header.join(",") + "\r\n"; students.forEach(student => { const studentGrades = student.grades[gradeSetId] || {}; const calculated = calculateSumAndAverageForData(studentGrades); let row = [escapeCsvField(student.name), escapeCsvField(student.number || '')]; gradeSet.gradeLabels.forEach(label => { const gradeValue = studentGrades[label]; row.push(escapeCsvField(gradeValue)); }); row.push(escapeCsvField(calculated.sum !== null ? calculated.sum.toFixed(1) : '')); row.push(escapeCsvField(calculated.average !== null ? calculated.average.toFixed(1) : '')); csvContent += row.join(",") + "\r\n"; }); const encodedUri = encodeURI(`data:text/csv;charset=utf-8,${csvContent}`); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `notas_${className}_${setName}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
             const exportGradesPDF = async () => { const gradeSetId = gradeSetSelect.value; const button = exportGradesPdfButton; if (!currentClassId || !gradeSetId) { alert("Selecione uma turma e um conjunto de notas para exportar para PDF."); return; } const currentClass = findClassById(currentClassId); const gradeSet = currentClass?.gradeStructure?.find(gs => gs.id === gradeSetId); const students = getStudentsByClass(currentClassId); if (!gradeSet || students.length === 0) { alert("Nenhum dado de nota para exportar para PDF."); return; } const classNameSanitized = currentClass?.name.replace(/[^a-z0-9]/gi, '_') || 'Turma'; const setNameSanitized = gradeSet.name.replace(/[^a-z0-9]/gi, '_') || 'Conjunto'; const filename = `notas_${classNameSanitized}_${setNameSanitized}.pdf`; let tableHTML = ` <style> body { font-family: sans-serif; font-size: 9pt; } .pdf-table { border-collapse: collapse; width: 100%; margin-top: 10px; table-layout: fixed; } .pdf-table th, .pdf-table td { border: 1px solid #ccc; padding: 3px 4px; text-align: left; word-wrap: break-word; overflow-wrap: break-word; } .pdf-table th { background-color: #f2f2f2; font-weight: bold; text-align: center; font-size: 8pt; } .pdf-table td { font-size: 8pt; } .pdf-table td.grade, .pdf-table td.sum, .pdf-table td.avg { text-align: center; } .pdf-table td.student-name { min-width: 100px; white-space: normal; } .pdf-table th.student-col { min-width: 105px; } .pdf-table th.grade-col { min-width: 40px; } .pdf-table th.sum-col, .pdf-table th.avg-col { min-width: 45px; } .pdf-table .number { font-weight: bold; display: inline-block; min-width: 15px; text-align: right; margin-right: 4px;} h4 { text-align: center; margin-bottom: 10px; font-size: 11pt; } </style> <h4>Notas - Turma: ${sanitizeHTML(currentClass.name)} - Conjunto: ${sanitizeHTML(gradeSet.name)}</h4> <table class="pdf-table"> <thead> <tr> <th class="student-col">Aluno</th> `; gradeSet.gradeLabels.forEach(label => { tableHTML += `<th class="grade-col">${sanitizeHTML(label)}</th>`; }); tableHTML += `<th class="sum-col">Soma</th><th class="avg-col">Média</th></tr></thead><tbody>`; students.forEach(student => { const studentGrades = student.grades[gradeSetId] || {}; const calculated = calculateSumAndAverageForData(studentGrades); tableHTML += `<tr><td class="student-name"><span class="number">${student.number || '-.'}</span>${sanitizeHTML(student.name)}</td>`; gradeSet.gradeLabels.forEach(label => { const gradeValue = studentGrades[label]; tableHTML += `<td class="grade">${(gradeValue !== null && gradeValue !== undefined) ? sanitizeHTML(gradeValue) : '-'}</td>`; }); tableHTML += `<td class="sum">${(calculated.sum !== null) ? calculated.sum.toFixed(1) : '-'}</td>`; tableHTML += `<td class="avg">${(calculated.average !== null) ? calculated.average.toFixed(1) : '-'}</td>`; tableHTML += `</tr>`; }); tableHTML += `</tbody></table>`; const opt = { margin: [8, 5, 8, 5], filename: filename, image: { type: 'jpeg', quality: 0.95 }, html2canvas: { scale: 2, useCORS: true, logging: false, }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }, pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } }; const originalButtonText = button.innerHTML; button.disabled = true; button.innerHTML = '<span class="icon">⏳</span>'; try { console.log("Generating PDF with options:", opt); await html2pdf().set(opt).from(tableHTML).save(); console.log("PDF de notas gerado com sucesso."); } catch (error) { console.error("Erro ao gerar PDF de notas:", error); alert("Ocorreu um erro ao gerar o PDF de notas. Verifique o console para detalhes."); } finally { button.disabled = false; button.innerHTML = originalButtonText; } };
             const saveAttendance = () => { const date = attendanceDateInput.value; if (!currentClassId || !date) { console.warn("Cannot save attendance: No class or date selected."); alert("Selecione uma turma e uma data."); return; } console.log("Saving all attendance data for", date); saveData(); alert(`Presença de ${formatDate(date)} salva!`); };
             const openJustificationModal = (studentId, date) => { const student = findStudentById(studentId); if (!student || !date) return; if (!student.attendance[date]) student.attendance[date] = { status: 'F', justification: '' }; else student.attendance[date].status = 'F'; const currentJustification = student.attendance[date].justification || ''; const title = `Justificativa - ${sanitizeHTML(student.name)} (${formatDate(date)})`; const modalContent = `<form id="justification-form"><div class="form-group"><label for="justification-modal-text">Motivo da Falta:</label><textarea id="justification-modal-text" placeholder="Digite a justificativa aqui..." style="min-height: 200px;">${sanitizeHTML(currentJustification)}</textarea></div></form>`; const footerButtons = `<button type="button" id="save-justification-button" data-student-id="${studentId}" data-date="${date}" class="success"><span class="icon icon-salvar"></span> Salvar Justificativa</button>`; showModal(title, modalContent, footerButtons, 'justification-modal'); const saveBtn = document.getElementById('save-justification-button'); if(saveBtn) { saveBtn.replaceWith(saveBtn.cloneNode(true)); document.getElementById('save-justification-button').addEventListener('click', (e) => { const sId = e.target.dataset.studentId || e.target.closest('button').dataset.studentId; const jDate = e.target.dataset.date || e.target.closest('button').dataset.date; const justificationText = document.getElementById('justification-modal-text').value.trim(); const studentToUpdate = findStudentById(sId); if (studentToUpdate && jDate) { if (!studentToUpdate.attendance[jDate]) studentToUpdate.attendance[jDate] = { status: 'F', justification: '' }; studentToUpdate.attendance[jDate].status = 'F'; studentToUpdate.attendance[jDate].justification = justificationText; console.log(`Justification updated in data for ${sId}:`, studentToUpdate.attendance[jDate]); hideModal(); renderAttendanceTable(currentClassId, jDate); } else { console.error("Could not save justification: student or date missing"); alert("Erro ao salvar justificativa."); } }); } };
             const saveLessonPlan = () => { const date = lessonPlanDateInput.value; if (!currentClassId || !date) { alert("Selecione uma turma e uma data para salvar o plano."); return; } const currentClass = findClassById(currentClassId); if (!currentClass) return; const planText = lessonPlanTextarea.value.trim(); currentClass.lessonPlans = currentClass.lessonPlans || {}; if (planText) { currentClass.lessonPlans[date] = planText; console.log(`Lesson plan saved for ${date}:`, planText); } else { delete currentClass.lessonPlans[date]; console.log(`Lesson plan removed for ${date}`); } saveData(); alert(`Plano de aula para ${formatDate(date)} salvo!`); };
             const openMonthlyAttendanceModal = () => { if (!currentClassId) { alert("Selecione uma turma primeiro."); return; } const currentClass = findClassById(currentClassId); const title = `Frequência Mensal - ${sanitizeHTML(currentClass.name)}`; const today = new Date(); const currentYear = today.getFullYear(); const currentMonth = today.getMonth(); let yearOptions = ''; for (let y = currentYear + 1; y >= currentYear - 5; y--) { yearOptions += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`; } let monthOptions = ''; monthNames.forEach((name, index) => { monthOptions += `<option value="${index}" ${index === currentMonth ? 'selected' : ''}>${name}</option>`; }); const modalContent = ` <div id="monthly-attendance-controls"> <div class="date-selectors"> <label for="monthly-attendance-month">Mês:</label> <select id="monthly-attendance-month">${monthOptions}</select> <label for="monthly-attendance-year">Ano:</label> <select id="monthly-attendance-year">${yearOptions}</select> </div> <div class="export-buttons"> <button type="button" id="export-attendance-csv-button" class="secondary icon-button hidden" title="Exportar CSV"><span class="icon">📤</span></button> <button type="button" id="export-attendance-pdf-button" class="secondary icon-button hidden" title="Exportar PDF"><span class="icon icon-pdf"></span></button> </div> </div> <div id="monthly-attendance-table-wrapper"> <p>Selecione o mês/ano para carregar os dados.</p> </div> <div id="monthly-attendance-chart-container" class="hidden"></div> <div id="monthly-attendance-summary"></div> `; showModal(title, modalContent, '', 'monthly-attendance-modal'); const monthSelect = document.getElementById('monthly-attendance-month'); const yearSelect = document.getElementById('monthly-attendance-year'); const exportCsvButton = document.getElementById('export-attendance-csv-button'); const exportPdfButton = document.getElementById('export-attendance-pdf-button'); const updateMonthlyView = () => { const selectedMonth = parseInt(monthSelect.value); const selectedYear = parseInt(yearSelect.value); renderMonthlyAttendanceData(currentClassId, selectedYear, selectedMonth); }; monthSelect.addEventListener('change', updateMonthlyView); yearSelect.addEventListener('change', updateMonthlyView); exportCsvButton.addEventListener('click', () => { const selectedMonth = parseInt(monthSelect.value); const selectedYear = parseInt(yearSelect.value); exportMonthlyAttendanceCSV(currentClassId, selectedYear, selectedMonth); }); exportPdfButton.addEventListener('click', () => { const selectedMonth = parseInt(monthSelect.value); const selectedYear = parseInt(yearSelect.value); exportMonthlyAttendancePDF(currentClassId, selectedYear, selectedMonth, exportPdfButton); }); updateMonthlyView(); };
             const renderMonthlyAttendanceData = (classId, year, month) => { const students = getStudentsByClass(classId); const currentModal = document.querySelector('#generic-modal.show.monthly-attendance-modal'); if (!currentModal) return; const tableWrapper = currentModal.querySelector('#monthly-attendance-table-wrapper'); const summaryContainer = currentModal.querySelector('#monthly-attendance-summary'); const chartContainer = currentModal.querySelector('#monthly-attendance-chart-container'); const exportCsvBtn = currentModal.querySelector('#export-attendance-csv-button'); const exportPdfBtn = currentModal.querySelector('#export-attendance-pdf-button'); if (!tableWrapper || !summaryContainer || !chartContainer) { console.error("Um ou mais elementos do modal mensal não encontrados."); return; } tableWrapper.innerHTML = ''; summaryContainer.innerHTML = ''; chartContainer.innerHTML = ''; if (students.length === 0) { tableWrapper.innerHTML = '<p style="text-align:center; padding: 1rem;">Nenhum aluno nesta turma.</p>'; if (exportCsvBtn) exportCsvBtn.classList.add('hidden'); if (exportPdfBtn) exportPdfBtn.classList.add('hidden'); chartContainer.classList.add('hidden'); return; } if (exportCsvBtn) exportCsvBtn.classList.remove('hidden'); if (exportPdfBtn) exportPdfBtn.classList.remove('hidden'); chartContainer.classList.remove('hidden'); const daysInMonth = getDaysInMonth(year, month); const table = document.createElement('table'); table.classList.add('monthly-attendance-table'); const thead = table.createTHead(); const tbody = table.createTBody(); const headerRow = thead.insertRow(); headerRow.innerHTML = `<th class="student-col-monthly">Aluno</th>`; for (let day = 1; day <= daysInMonth; day++) { headerRow.innerHTML += `<th>${day}</th>`; } headerRow.innerHTML += `<th class="freq-col-monthly">% Freq.</th>`; let totalClassP = 0; let totalClassPossibleAttendances = 0; const studentFrequencies = []; students.forEach(student => { const row = tbody.insertRow(); row.innerHTML = `<td class="student-col-monthly"><span class="student-number">${student.number || '-'}.</span> ${sanitizeHTML(student.name)}</td>`; let studentP = 0; let studentPossibleDays = 0; for (let day = 1; day <= daysInMonth; day++) { const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; const attendanceRecord = student.attendance[dateStr]; const status = attendanceRecord?.status; const justification = attendanceRecord?.justification || ''; const dayOfWeek = getDayOfWeek(year, month, day); const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; let cellContent = '-'; let cellClass = ''; if (isWeekend) { cellClass = 'weekend'; cellContent = ''; } else if (status === 'H') { cellClass = 'status-H'; cellContent = 'H'; } else { studentPossibleDays++; totalClassPossibleAttendances++; if (status === 'P') { cellContent = 'P'; cellClass = 'status-P'; studentP++; totalClassP++; } else if (status === 'F') { cellClass = justification ? 'status-FJ' : 'status-F'; cellContent = justification ? 'FJ' : 'F'; } else { cellContent = '-'; } } row.innerHTML += `<td class="${cellClass}">${cellContent}</td>`; } const frequencyPercent = studentPossibleDays > 0 ? Math.round((studentP / studentPossibleDays) * 100) : 0; const frequencyText = studentPossibleDays > 0 ? frequencyPercent + '%' : '--'; row.innerHTML += `<td class="freq-col-monthly">${frequencyText}</td>`; studentFrequencies.push({ name: student.name, number: student.number, freq: frequencyPercent }); }); tableWrapper.appendChild(table); const classFrequency = totalClassPossibleAttendances > 0 ? ((totalClassP / totalClassPossibleAttendances) * 100).toFixed(0) + '%' : '--'; summaryContainer.textContent = `Frequência Média da Turma (dias letivos): ${classFrequency}`; renderMonthlyAttendanceChart(studentFrequencies); };
             const renderMonthlyAttendanceChart = (frequencies) => { const currentModal = document.querySelector('#generic-modal.show.monthly-attendance-modal'); const chartContainer = currentModal?.querySelector('#monthly-attendance-chart-container'); if (!chartContainer) return; chartContainer.innerHTML = ''; if (frequencies.length === 0) { return; } const maxFreq = 100; const chartHeight = 100; frequencies.forEach(item => { const barContainer = document.createElement('div'); barContainer.classList.add('chart-bar-container'); const bar = document.createElement('div'); bar.classList.add('chart-bar'); const barHeightValue = (item.freq / maxFreq) * chartHeight; bar.style.height = `${barHeightValue}px`; bar.style.backgroundColor = item.freq >= 70 ? 'var(--accent-success)' : item.freq >= 50 ? 'var(--accent-warning)' : 'var(--accent-danger)'; bar.dataset.percentage = `${item.freq}%`; const label = document.createElement('div'); label.classList.add('chart-label'); label.textContent = item.number ? `${item.number}.` : ''; label.title = sanitizeHTML(item.name); barContainer.appendChild(bar); barContainer.appendChild(label); chartContainer.appendChild(barContainer); }); };
             const exportMonthlyAttendanceCSV = (classId, year, month) => { const students = getStudentsByClass(classId); if (students.length === 0) { alert("Nenhum aluno na turma para exportar."); return; } const currentClass = findClassById(classId); const className = currentClass?.name.replace(/[^a-z0-9]/gi, '_') || 'Turma'; const monthName = monthNames[month]; const daysInMonth = getDaysInMonth(year, month); let csvContent = "\uFEFF"; let header = [escapeCsvField("Aluno"), escapeCsvField("No.")]; for (let day = 1; day <= daysInMonth; day++) { header.push(escapeCsvField(String(day))); } header.push(escapeCsvField("Presente")); header.push(escapeCsvField("Falta")); header.push(escapeCsvField("Falta Just.")); header.push(escapeCsvField("Dias Não Letivos")); header.push(escapeCsvField("% Freq.")); csvContent += header.join(",") + "\r\n"; students.forEach(student => { let row = [escapeCsvField(student.name), escapeCsvField(student.number || '')]; let studentP = 0, studentF = 0, studentFJ = 0, studentH = 0, studentPossibleDays = 0; for (let day = 1; day <= daysInMonth; day++) { const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; const attendanceRecord = student.attendance[dateStr]; const status = attendanceRecord?.status; const justification = attendanceRecord?.justification || ''; const dayOfWeek = getDayOfWeek(year, month, day); const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; let cellValue = ''; if (isWeekend) { cellValue = ''; } else if (status === 'H') { cellValue = 'H'; studentH++; } else { studentPossibleDays++; if (status === 'P') { cellValue = 'P'; studentP++; } else if (status === 'F') { if (justification) { cellValue = 'FJ'; studentFJ++; } else { cellValue = 'F'; studentF++; } } else { cellValue = '-'; } } row.push(escapeCsvField(cellValue)); } const frequency = studentPossibleDays > 0 ? ((studentP / studentPossibleDays) * 100).toFixed(0) + '%' : ''; row.push(escapeCsvField(studentP)); row.push(escapeCsvField(studentF)); row.push(escapeCsvField(studentFJ)); row.push(escapeCsvField(studentH)); row.push(escapeCsvField(frequency)); csvContent += row.join(",") + "\r\n"; }); const encodedUri = encodeURI(`data:text/csv;charset=utf-8,${csvContent}`); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `frequencia_${className}_${year}_${monthName}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
             const exportMonthlyAttendancePDF = async (classId, year, month, button) => { const students = getStudentsByClass(classId); if (students.length === 0) { alert("Nenhum aluno na turma para exportar para PDF."); return; } const currentClass = findClassById(classId); const classNameSanitized = currentClass?.name.replace(/[^a-z0-9]/gi, '_') || 'Turma'; const monthName = monthNames[month]; const filename = `frequencia_${classNameSanitized}_${year}_${monthName}.pdf`; const daysInMonth = getDaysInMonth(year, month); let tableHTML = ` <style> body { font-family: sans-serif; font-size: 7pt; } .pdf-table { border-collapse: collapse; width: 100%; margin-top: 8px; table-layout: fixed; } .pdf-table th, .pdf-table td { border: 1px solid #ccc; padding: 2px 3px; text-align: center; word-wrap: break-word; overflow-wrap: break-word; } .pdf-table th { background-color: #f2f2f2; font-weight: bold; font-size: 7pt; } .pdf-table td { font-size: 7pt; } .pdf-table td.student-col { text-align: left; min-width: 90px; white-space: normal; } .pdf-table th.student-col { min-width: 90px; } .pdf-table th.day-col, .pdf-table td.day-col { min-width: 15px; max-width:16px; } .pdf-table td.weekend { background-color: #eee; } .pdf-table td.status-H { background-color: #e2e3e5; color: #495057; font-style: italic; } .pdf-table th.summary-col, .pdf-table td.summary-col { font-weight: bold; min-width: 20px; max-width: 25px; font-size: 6pt; } .pdf-table .number { font-weight: bold; display: inline-block; min-width: 12px; text-align: right; margin-right: 3px;} h4 { text-align: center; margin-bottom: 6px; font-size: 10pt; } </style> <h4>Frequência Mensal - Turma: ${sanitizeHTML(currentClass.name)} - ${monthName}/${year}</h4> <table class="pdf-table"> <thead> <tr> <th class="student-col">Aluno</th>`; for (let day = 1; day <= daysInMonth; day++) { tableHTML += `<th class="day-col">${day}</th>`; } tableHTML += `<th class="summary-col">P</th><th class="summary-col">F</th><th class="summary-col">FJ</th><th class="summary-col">H</th><th class="summary-col">%</th></tr></thead><tbody>`; students.forEach(student => { tableHTML += `<tr><td class="student-col"><span class="number">${student.number || '-.'}</span>${sanitizeHTML(student.name)}</td>`; let studentP = 0, studentF = 0, studentFJ = 0, studentH = 0, studentPossibleDays = 0; for (let day = 1; day <= daysInMonth; day++) { const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; const attendanceRecord = student.attendance[dateStr]; const status = attendanceRecord?.status; const justification = attendanceRecord?.justification || ''; const dayOfWeek = getDayOfWeek(year, month, day); const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; let cellContent = ''; let cellClass = 'day-col'; if (isWeekend) { cellClass += ' weekend'; } else if (status === 'H') { cellContent = 'H'; cellClass += ' status-H'; studentH++; } else { studentPossibleDays++; if (status === 'P') { cellContent = 'P'; studentP++; } else if (status === 'F') { if (justification) { cellContent = 'FJ'; studentFJ++; } else { cellContent = 'F'; studentF++; } } else { cellContent = '-'; } } tableHTML += `<td class="${cellClass}">${cellContent}</td>`; } const frequency = studentPossibleDays > 0 ? ((studentP / studentPossibleDays) * 100).toFixed(0) : '-'; tableHTML += `<td class="summary-col">${studentP}</td>`; tableHTML += `<td class="summary-col">${studentF}</td>`; tableHTML += `<td class="summary-col">${studentFJ}</td>`; tableHTML += `<td class="summary-col">${studentH}</td>`; tableHTML += `<td class="summary-col">${frequency}${frequency !== '-' ? '%' : ''}</td>`; tableHTML += `</tr>`; }); tableHTML += `</tbody></table>`; const opt = { margin: [5, 5, 5, 5], filename: filename, image: { type: 'jpeg', quality: 0.9 }, html2canvas: { scale: 2, useCORS: true, logging: false, }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }, pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } }; const originalButtonText = button.innerHTML; button.disabled = true; button.innerHTML = '<span class="icon">⏳</span>'; try { console.log("Generating PDF with options:", opt); await html2pdf().set(opt).from(tableHTML).save(); console.log("PDF de frequência gerado com sucesso."); } catch (error) { console.error("Erro ao gerar PDF de frequência:", error); alert("Ocorreu um erro ao gerar o PDF de frequência. Verifique o console para detalhes."); } finally { button.disabled = false; button.innerHTML = originalButtonText; } };
             const performSearch = (term) => { term = term.toLowerCase().trim(); if (!term) { hideModal(); return; } const results = { schools: [], classes: [], students: [] }; results.schools = appData.schools.filter(s => s.name.toLowerCase().includes(term)); results.classes = appData.classes.filter(c => c.name.toLowerCase().includes(term) || (c.subject && c.subject.toLowerCase().includes(term))); results.students = appData.students.filter(s => s.name.toLowerCase().includes(term) || (s.number && String(s.number) === term)); renderSearchResults(results, term); };
             const renderSearchResults = (results, term) => { let resultsHtml = `<p>Resultados para: <strong>${sanitizeHTML(term)}</strong></p><div class="item-list mt-1">`; let count = 0; const renderItem = (item, type, details = '') => { count++; const itemSchoolId = type === 'school' ? item.id : (item.schoolId || findClassById(item.classId)?.schoolId); const itemClassId = type === 'student' ? item.classId : (type === 'class' ? item.id : ''); return `<div class="list-item search-result-item" data-type="${type}" data-id="${item.id}" ${itemSchoolId ? `data-school-id="${itemSchoolId}"` : ''} ${itemClassId ? `data-class-id="${itemClassId}"` : ''}> <div class="item-info">${sanitizeHTML(item.name)} ${details ? `<small style='display:block; color: var(--text-secondary);'>${sanitizeHTML(details)}</small>` : ''}</div> <span class="result-type">${type.charAt(0).toUpperCase() + type.slice(1)}</span> </div>`; }; if (results.schools.length > 0) { resultsHtml += `<h5>Escolas</h5>`; results.schools.forEach(s => resultsHtml += renderItem(s, 'school')); } if (results.classes.length > 0) { resultsHtml += `<h5 class="mt-2">Turmas</h5>`; results.classes.forEach(c => { const school = findSchoolById(c.schoolId); resultsHtml += renderItem(c, 'class', `(${c.subject || 'N/A'}) - ${school?.name || '?'}`); }); } if (results.students.length > 0) { resultsHtml += `<h5 class="mt-2">Alunos</h5>`; results.students.forEach(s => { const cls = findClassById(s.classId); const school = findSchoolById(cls?.schoolId); resultsHtml += renderItem(s, 'student', `${s.number || '-'}. ${cls?.name || '?'} / ${school?.name || '?'}`); }); } if (count === 0) { resultsHtml += `<p style="text-align:center; padding: 1rem;">Nenhum resultado encontrado.</p>`; } resultsHtml += `</div>`; showModal(`Resultados da Busca`, resultsHtml, '', 'search-results-modal'); modalBody.querySelectorAll('.search-result-item').forEach(item => { item.addEventListener('click', () => { const type = item.dataset.type; const id = item.dataset.id; const classId = item.dataset.classId; const schoolId = item.dataset.schoolId; hideModal(); searchInput.value = ''; if (type === 'school') { selectSchool(id); showSection('classes-section'); } else if (type === 'class') { if(schoolId) selectSchool(schoolId); selectClass(id); showSection('class-details-section'); } else if (type === 'student') { if(schoolId) selectSchool(schoolId); if(classId) selectClass(classId); showSection('class-details-section'); setTimeout(() => { const studentElement = studentListContainer.querySelector(`.list-item[data-id="${id}"]`); studentElement?.scrollIntoView({ behavior: 'smooth', block: 'center' }); studentElement?.classList.add('active'); setTimeout(() => studentElement?.classList.remove('active'), 2000); }, 300); } }); }); };
             const toggleClassNotesEdit = (showEdit) => { classNotesDisplay.classList.toggle('hidden', showEdit); classNotesEdit.classList.toggle('hidden', !showEdit); if (showEdit) { const currentClass = findClassById(currentClassId); classNotesTextarea.value = currentClass?.notes || ''; classNotesTextarea.focus(); } };
             const saveClassNotes = () => { if(!currentClassId) return; const currentClass = findClassById(currentClassId); if(currentClass) { currentClass.notes = classNotesTextarea.value.trim(); classNotesContent.textContent = sanitizeHTML(currentClass.notes || 'Nenhuma anotação.'); saveData(); toggleClassNotesEdit(false); } };
             const exportData = () => { const dataStr = JSON.stringify(appData, null, 2); const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr); const exportFileDefaultName = `super_professor_pro_backup_${new Date().toISOString().slice(0,10)}.json`; const linkElement = document.createElement('a'); linkElement.setAttribute('href', dataUri); linkElement.setAttribute('download', exportFileDefaultName); linkElement.click(); linkElement.remove(); };
             const importData = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const importedData = JSON.parse(e.target.result); if (importedData && typeof importedData === 'object') { if (confirm("Importar dados substituirá os atuais. Continuar?")) { appData = { schools: importedData.schools || [], classes: importedData.classes || [], students: importedData.students || [], schedule: importedData.schedule || [], settings: importedData.settings || { theme: 'theme-light', globalNotificationsEnabled: true, notificationSoundEnabled: true, customNotificationSound: null } }; if (typeof appData.settings !== 'object' || appData.settings === null) appData.settings = {}; appData.settings.theme = appData.settings.theme || 'theme-light'; appData.settings.globalNotificationsEnabled = appData.settings.globalNotificationsEnabled !== undefined ? appData.settings.globalNotificationsEnabled : true; appData.settings.notificationSoundEnabled = appData.settings.notificationSoundEnabled !== undefined ? appData.settings.notificationSoundEnabled : true; appData.settings.customNotificationSound = appData.settings.customNotificationSound || null; if (appData.settings.nonSchoolDays) delete appData.settings.nonSchoolDays; if (appData.settings.customNotificationSound && typeof appData.settings.customNotificationSound === 'string' && !appData.settings.customNotificationSound.startsWith('data:audio')) { console.warn("Imported custom sound data is invalid. Removing."); appData.settings.customNotificationSound = null; } appData.students.forEach(s => { s.attendance = s.attendance || {}; Object.keys(s.attendance).forEach(date => { if(s.attendance[date] && typeof s.attendance[date] === 'object') { s.attendance[date].status = s.attendance[date].status || null; s.attendance[date].justification = String(s.attendance[date].justification || ''); } else { s.attendance[date] = { status: null, justification: ''}; } }); s.notes = s.notes || []; if (typeof s.notes === 'string') { const oldNotes = s.notes.trim(); s.notes = oldNotes ? [{ date: 'N/A', text: oldNotes }] : []; } else if (!Array.isArray(s.notes)) { s.notes = []; } s.notes = s.notes.map(note => ({ date: note.date || 'N/A', text: note.text || '' })).filter(note => note.text.trim()); }); appData.classes.forEach(c => { c.lessonPlans = c.lessonPlans || {}; c.gradeStructure = c.gradeStructure || []; c.gradeStructure.forEach(gs => { delete gs.periodType; if(gs.colorRanges === undefined) gs.colorRanges = []; }); const validPositions = ['top-left', 'top-center', 'top-right', 'bottom-left', 'bottom-center', 'bottom-right', 'left-top', 'left-center', 'left-bottom', 'right-top', 'right-center', 'right-bottom']; if (!c.classroomLayout) c.classroomLayout = { rows: 5, cols: 6, teacherDeskPosition: 'top-center', seats: [] }; else { c.classroomLayout.seats = c.classroomLayout.seats || []; if (!validPositions.includes(c.classroomLayout.teacherDeskPosition)) c.classroomLayout.teacherDeskPosition = 'top-center'; } }); appData.schedule.forEach(item => { if (item.notificationsEnabled === undefined) { item.notificationsEnabled = true; } }); currentSchoolId = null; currentClassId = null; saveData(); applyTheme(appData.settings.theme); updateNotificationSettingsUI(); updateCustomSoundUI(); restoreAppState(); renderSchoolList(); renderScheduleList(); if (currentSection === 'class-details-section' && currentClassId) { selectClass(currentClassId, true); } else if (currentSection === 'classes-section' && currentSchoolId) { renderClassList(currentSchoolId); } showSection(currentSection || 'schedule-section'); alert("Dados importados!"); } } else { alert("Erro: Arquivo JSON inválido."); } } catch (error) { console.error("Erro importar:", error); alert("Erro ao ler arquivo JSON."); } finally { event.target.value = null; } }; reader.readAsText(file); };
             const clearAllData = () => { if (confirm("ATENÇÃO! Apagar TODOS os dados? Isso inclui escolas, turmas, alunos, notas, frequências, horários e configurações.")) { if (confirm("SEGUNDA CONFIRMAÇÃO: Tem certeza ABSOLUTA que deseja apagar TUDO? Esta ação não pode ser desfeita.")) { appData = { schools: [], classes: [], students: [], schedule: [], settings: { theme: 'theme-light', globalNotificationsEnabled: true, notificationSoundEnabled: true, customNotificationSound: null } }; currentSchoolId = null; currentClassId = null; saveData(); applyTheme(appData.settings.theme); updateNotificationSettingsUI(); updateCustomSoundUI(); restoreAppState(); renderSchoolList(); renderScheduleList(); classListContainer.innerHTML = '<p style="padding: 1rem; text-align: center;">Selecione escola.</p>'; studentListContainer.innerHTML = '<p style="padding: 1rem; text-align: center;">Selecione turma.</p>'; gradesTableContainer.innerHTML = '<p style="padding: 1rem; text-align: center;">Selecione conjunto.</p>'; attendanceTableContainer.innerHTML = '<p style="padding: 1rem; text-align: center;">Selecione data.</p>'; lessonPlanTextarea.value = ''; saveGradesButton.classList.add('hidden'); saveAttendanceButton.classList.add('hidden'); saveLessonPlanButton.classList.add('hidden'); attendanceActionsContainer.classList.add('hidden'); classroomContainerDisplay.innerHTML = '<p style="padding: 1rem; text-align: center; grid-column: 1 / -1; grid-row: 1 / -1;">Configure o mapa.</p>'; showSection(currentSection || 'schedule-section'); alert("Todos os dados foram apagados."); } } };
             if (copyPixButton && pixKeyTextElement) { copyPixButton.addEventListener('click', () => { const pixKey = pixKeyTextElement.textContent || pixKeyTextElement.innerText; const originalText = copyPixButton.innerHTML; if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(pixKey).then(() => { copyPixButton.innerHTML = '<span class="icon icon-copiar"></span> Copiado! ✅'; setTimeout(() => {                                  copyPixButton.innerHTML = originalText;
                             }, 2000);
                         }).catch(err => {
                             console.error('Erro ao copiar PIX (API): ', err);
                             alert("Erro ao copiar automaticamente. Por favor, selecione e copie o código manualmente.");
                             copyPixButton.innerHTML = 'ERRO ⚠️';
                             copyPixButton.classList.add('error');
                             setTimeout(() => {
                                 copyPixButton.innerHTML = originalText;
                                 copyPixButton.classList.remove('error');
                             }, 2000);
                         });
                     } else {
                         try {
                             const textArea = document.createElement("textarea");
                             textArea.value = pixKey;
                             textArea.style.position = "fixed";
                             textArea.style.left = "-9999px";
                             document.body.appendChild(textArea);
                             textArea.focus();
                             textArea.select();
                             document.execCommand('copy');
                             document.body.removeChild(textArea);
                             copyPixButton.innerHTML = '<span class="icon icon-copiar"></span> Copiado! ✅';
                             setTimeout(() => {
                                 copyPixButton.innerHTML = originalText;
                             }, 2000);
                         } catch (err) {
                             console.error('Erro ao copiar PIX (Fallback): ', err);
                             alert("Erro ao copiar automaticamente. Por favor, selecione e copie o código manualmente.");
                             copyPixButton.innerHTML = 'ERRO ⚠️';
                             copyPixButton.classList.add('error');
                             setTimeout(() => {
                                 copyPixButton.innerHTML = originalText;
                                 copyPixButton.classList.remove('error');
                             }, 2000);
                         }
                     }
                 });
             }

             // --- Touch Swipe Logic (Existente, sem mudanças aqui) ---
             let touchStartX = 0; let touchEndX = 0; let touchStartY = 0; let isSwiping = false; const swipeThreshold = 110; const verticalThreshold = 60; mainContent.addEventListener('touchstart', (e) => { const targetTagName = e.target.tagName.toLowerCase(); const isInteractive = ['input', 'button', 'select', 'textarea', 'a'].includes(targetTagName); const isInScrollable = e.target.closest('.table-scroll-wrapper, .modal-body, .list-item-actions, #monthly-attendance-table-wrapper, #student-observations-list, .classroom-container, .unassigned-students-list'); if (isInteractive || isInScrollable) { isSwiping = false; return; } touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; touchEndX = touchStartX; isSwiping = true; }, { passive: true }); mainContent.addEventListener('touchmove', (e) => { if (!isSwiping) return; touchEndX = e.changedTouches[0].screenX; const touchEndY = e.changedTouches[0].screenY; if (Math.abs(touchEndY - touchStartY) > verticalThreshold) { isSwiping = false; } }, { passive: true }); mainContent.addEventListener('touchend', (e) => { if (!isSwiping) { touchStartX = 0; touchEndX = 0; touchStartY = 0; return; } isSwiping = false; const deltaX = touchEndX - touchStartX; const deltaY = e.changedTouches[0].screenY - touchStartY; if (Math.abs(deltaX) > swipeThreshold && Math.abs(deltaX) > Math.abs(deltaY) * 1.8) { const visibleNavButtons = Array.from(navButtons).filter(btn => !btn.disabled && !btn.parentElement.classList.contains('hidden')); const currentActiveIndex = visibleNavButtons.findIndex(btn => btn.classList.contains('active')); if (currentActiveIndex === -1) return; let nextIndex; if (deltaX < 0) { nextIndex = currentActiveIndex + 1; if (nextIndex >= visibleNavButtons.length) return; } else { nextIndex = currentActiveIndex - 1; if (nextIndex < 0) return; } const targetButton = visibleNavButtons[nextIndex]; if(targetButton) { targetButton.click(); } } touchStartX = 0; touchEndX = 0; touchStartY = 0; });

             // --- Notification Functions (Existentes, sem mudanças aqui) ---
              const notificationMessages = { start: ["🚀 Preparar... Apontar... Aula! Sua aula ({CLASS}) na {SCHOOL} começa em 5 minutos.", "☕ Último gole de café? Sua aula ({CLASS}) na {SCHOOL} começa em 5 minutos!", "🔔 O sino quase tocou! Aula ({CLASS}) na {SCHOOL} em 5 minutos. ", "🏃 Corre, professor! Faltam 5 minutos para a aula ({CLASS}) na {SCHOOL} começar.", "✨ Hora de brilhar! Sua aula ({CLASS}) na {SCHOOL} inicia em 5 minutos.", "⏰ Tic-tac... 5 minutos para o início da aula ({CLASS}) na {SCHOOL}!"], end: ["🏁 Quase lá! Sua aula ({CLASS}) na {SCHOOL} termina em 5 minutos.", "😮‍💨 Ufa! Só mais 5 minutinhos de aula ({CLASS}) na {SCHOOL}.", "🔔 O sino da liberdade (quase)! Aula ({CLASS}) na {SCHOOL} acaba em 5 minutos.", "🎯 Missão quase completa! A aula ({CLASS}) na {SCHOOL} termina em 5 minutos.", "👏 Bom trabalho! Reta final da aula ({CLASS}) na {SCHOOL} - 5 minutos restantes.", "⏳ Contagem regressiva: 5 minutos para o fim da aula ({CLASS}) na {SCHOOL}."] };
             const getRandomMessage = (type, scheduleItem) => { const messages = notificationMessages[type]; if (!messages || messages.length === 0) return "Alerta de Horário!"; const randomIndex = Math.floor(Math.random() * messages.length); let message = messages[randomIndex]; const school = findSchoolById(scheduleItem.schoolId); message = message.replace('{CLASS}', sanitizeHTML(scheduleItem.note || '')); message = message.replace('{SCHOOL}', sanitizeHTML(school?.name || 'escola')); return message; };
             const showNotification = (message) => { if (!notificationBanner || !notificationMessage) return; notificationMessage.innerHTML = message; notificationBanner.classList.add('show'); playSound(); setTimeout(hideNotification, 10000); };
             const hideNotification = () => { if (notificationBanner) notificationBanner.classList.remove('show'); };
             const playSound = () => { if (!appData.settings.notificationSoundEnabled) return; if (appData.settings.customNotificationSound) { try { const customAudio = new Audio(appData.settings.customNotificationSound); customAudio.play().catch(error => { console.warn("Erro ao tocar som personalizado:", error); defaultNotificationSound?.play().catch(e => console.warn("Erro ao tocar som padrão (fallback):", e)); }); } catch (error) { console.error("Erro ao criar Audio com som personalizado:", error); defaultNotificationSound?.play().catch(e => console.warn("Erro ao tocar som padrão (fallback 2):", e)); } } else { defaultNotificationSound?.play().catch(error => { console.warn("Erro ao tocar som da notificação padrão:", error); }); } };
             const checkNotifications = () => { shownNotificationsThisMinute = {}; if (!appData.settings.globalNotificationsEnabled) { return; } const now = new Date(); const currentDayIndex = now.getDay(); const currentDayName = weekdays[currentDayIndex]; const currentHour = now.getHours(); const currentMinute = now.getMinutes(); appData.schedule.forEach(item => { if (!item.notificationsEnabled || item.day !== currentDayName || !item.startTime || !item.endTime) { return; } const notificationKeyBase = item.id; try { const [startHour, startMinute] = item.startTime.split(':').map(Number); const [endHour, endMinute] = item.endTime.split(':').map(Number); if (isNaN(startHour) || isNaN(startMinute) || isNaN(endHour) || isNaN(endMinute)) { console.warn(`Invalid time format for schedule item ${item.id}`); return; } let notifyStartMinute = startMinute - NOTIFICATION_LEAD_TIME_MINUTES; let notifyStartHour = startHour; if (notifyStartMinute < 0) { notifyStartMinute += 60; notifyStartHour -= 1; if (notifyStartHour < 0) notifyStartHour = 23; } let notifyEndMinute = endMinute - NOTIFICATION_LEAD_TIME_MINUTES; let notifyEndHour = endHour; if (notifyEndMinute < 0) { notifyEndMinute += 60; notifyEndHour -= 1; if (notifyEndHour < 0) notifyEndHour = 23; } const startNotificationKey = notificationKeyBase + '_start'; if (currentHour === notifyStartHour && currentMinute === notifyStartMinute) { if (!shownNotificationsThisMinute[startNotificationKey]) { console.log(`Triggering START notification for ${item.id}`); const message = getRandomMessage('start', item); showNotification(message); shownNotificationsThisMinute[startNotificationKey] = true; } } const endNotificationKey = notificationKeyBase + '_end'; if (currentHour === notifyEndHour && currentMinute === notifyEndMinute) { if (!shownNotificationsThisMinute[endNotificationKey]) { console.log(`Triggering END notification for ${item.id}`); const message = getRandomMessage('end', item); showNotification(message); shownNotificationsThisMinute[endNotificationKey] = true; } } } catch (error) { console.error(`Error processing schedule item ${item.id}:`, error); } }); };
             const startNotificationChecker = () => { if (notificationCheckInterval) { clearInterval(notificationCheckInterval); } console.log("Starting notification checker..."); checkNotifications(); notificationCheckInterval = setInterval(checkNotifications, 60000); };
             const stopNotificationChecker = () => { if (notificationCheckInterval) { clearInterval(notificationCheckInterval); notificationCheckInterval = null; console.log("Stopped notification checker."); } };
             const updateNotificationSettingsUI = () => { if (enableGlobalNotificationsCheckbox && enableNotificationSoundCheckbox) { enableGlobalNotificationsCheckbox.checked = appData.settings.globalNotificationsEnabled; enableNotificationSoundCheckbox.checked = appData.settings.notificationSoundEnabled; enableNotificationSoundCheckbox.disabled = !appData.settings.globalNotificationsEnabled; } };

             // --- Custom Sound UI and Logic (Existentes, sem mudanças aqui) ---
             const updateCustomSoundUI = () => { if (!customSoundFilenameDisplay || !currentCustomSoundDisplay || !currentCustomSoundName || !removeCustomSoundButton) return; const soundName = localStorage.getItem('superProfessorPro_customSoundName'); if (appData.settings.customNotificationSound && soundName) { customSoundFilenameDisplay.textContent = soundName; customSoundFilenameDisplay.title = soundName; currentCustomSoundName.textContent = soundName; currentCustomSoundDisplay.classList.remove('hidden'); } else { appData.settings.customNotificationSound = null; localStorage.removeItem('superProfessorPro_customSoundName'); customSoundFilenameDisplay.textContent = 'Nenhum arquivo escolhido'; customSoundFilenameDisplay.title = ''; currentCustomSoundDisplay.classList.add('hidden'); currentCustomSoundName.textContent = ''; } if (customNotificationSoundInput) customNotificationSoundInput.value = null; };
             const handleCustomSoundUpload = (event) => { const file = event.target.files[0]; if (!file) { return; } if (!file.type.startsWith('audio/')) { alert('Por favor, selecione um arquivo de áudio válido (MP3, WAV, OGG, etc.).'); updateCustomSoundUI(); return; } const fileSizeMB = file.size / 1024 / 1024; if (fileSizeMB > MAX_CUSTOM_SOUND_SIZE_MB) { alert(`Arquivo muito grande (${fileSizeMB.toFixed(1)}MB). O limite é ${MAX_CUSTOM_SOUND_SIZE_MB}MB.`); updateCustomSoundUI(); return; } const reader = new FileReader(); reader.onload = (e) => { appData.settings.customNotificationSound = e.target.result; localStorage.setItem('superProfessorPro_customSoundName', file.name); saveData(); updateCustomSoundUI(); alert(`Som "${file.name}" carregado com sucesso!`); }; reader.onerror = (e) => { console.error("Erro ao ler arquivo de áudio:", e); alert("Ocorreu um erro ao tentar carregar o arquivo de som."); updateCustomSoundUI(); }; reader.readAsDataURL(file); };
             const removeCustomSound = () => { if (confirm("Remover o som de notificação personalizado?")) { appData.settings.customNotificationSound = null; localStorage.removeItem('superProfessorPro_customSoundName'); saveData(); updateCustomSoundUI(); alert("Som personalizado removido."); } };

             // --- Attendance Action Buttons (Existentes, sem mudanças aqui) ---
              const markAllStudentsPresent = () => { const date = attendanceDateInput.value; if (!currentClassId || !date) { alert("Selecione uma turma e uma data primeiro."); return; } const studentsInClass = getStudentsByClass(currentClassId); if (studentsInClass.length === 0) return; console.log(`Action: Marking all present for class ${currentClassId} on ${date}`); studentsInClass.forEach(student => { if (!student.attendance[date]) student.attendance[date] = { status: null, justification: '' }; if (student.attendance[date].status !== 'H') { student.attendance[date].status = 'P'; student.attendance[date].justification = ''; } }); renderAttendanceTable(currentClassId, date); console.log("Data updated for Mark All Present. Remember to Save."); };
              const toggleNonSchoolDay = () => { const date = attendanceDateInput.value; if (!currentClassId || !date) { alert("Selecione uma turma e uma data primeiro."); return; } const studentsInClass = getStudentsByClass(currentClassId); if (studentsInClass.length === 0) return; const isCurrentlyNonSchool = studentsInClass.every(std => std.attendance[date]?.status === 'H'); if (isCurrentlyNonSchool) { if (confirm(`Deseja desmarcar ${formatDate(date)} como dia NÃO LETIVO?\nA presença dos alunos será resetada para esta data.`)) { studentsInClass.forEach(student => { if (!student.attendance[date]) student.attendance[date] = {}; student.attendance[date].status = null; student.attendance[date].justification = ''; }); console.log("Action: Unmarked Non-School Day in data."); renderAttendanceTable(currentClassId, date); alert(`Dia ${formatDate(date)} desmarcado como não letivo. Clique em Salvar Presença para confirmar.`); } } else { if (confirm(`Deseja marcar ${formatDate(date)} como dia NÃO LETIVO para esta turma?\nToda a presença registrada nesta data será substituída por 'H'.`)) { studentsInClass.forEach(student => { if (!student.attendance[date]) student.attendance[date] = {}; student.attendance[date].status = 'H'; student.attendance[date].justification = ''; }); console.log("Action: Marked Non-School Day in data."); renderAttendanceTable(currentClassId, date); alert(`Dia ${formatDate(date)} marcado como não letivo. Clique em Salvar Presença para confirmar.`); } } };

             // --- Classroom Map Functions (Existentes, sem mudanças aqui) ---
             const renderClassroomMap = (classId, isEditing = false) => {
                 const cls = findClassById(classId);
                 if (!cls) { console.error("Class not found for map:", classId); classroomContainerDisplay.innerHTML = '<p style="padding: 1rem; text-align: center; grid-column: 1 / -1; grid-row: 1 / -1;">Erro: Turma não encontrada.</p>'; classroomContainerEdit.innerHTML = ''; mapEditArea.classList.add('hidden'); return; }
                 const layout = cls.classroomLayout || { rows: 5, cols: 6, teacherDeskPosition: 'top-center', seats: [] };
                 const currentLayoutData = isEditing ? tempClassroomLayout : layout;
                 const students = getStudentsByClass(classId);
                 const container = isEditing ? classroomContainerEdit : classroomContainerDisplay;
                 container.innerHTML = '';

                 const teacherDeskClone = teacherDeskTemplate.content.cloneNode(true);
                 const teacherDeskElement = teacherDeskClone.querySelector('.teacher-desk');
                 const gridClone = classroomGridTemplate.content.cloneNode(true);
                 const gridContainerElement = gridClone.querySelector('.classroom-map-grid');

                 teacherDeskElement.className = 'teacher-desk';
                 teacherDeskElement.classList.add(`position-${currentLayoutData.teacherDeskPosition}`);
                 gridContainerElement.style.gridTemplateColumns = `repeat(${currentLayoutData.cols}, auto)`;

                 container.appendChild(teacherDeskElement);
                 container.appendChild(gridContainerElement);

                 const seatTemplate = document.getElementById('seat-template');
                 const emptySeatPlaceholder = "Toque/Arraste Aluno";
                 if (isEditing) clearSeatSelection();

                 if (currentLayoutData.rows > 0 && currentLayoutData.cols > 0) {
                     for (let r = 1; r <= currentLayoutData.rows; r++) {
                         for (let c = 1; c <= currentLayoutData.cols; c++) {
                             const seatData = currentLayoutData.seats.find(s => s.row === r && s.col === c);
                             const studentId = seatData?.studentId;
                             const student = studentId ? findStudentById(studentId) : null;
                             const seatClone = seatTemplate.content.cloneNode(true);
                             const seatElement = seatClone.querySelector('.seat');
                             seatElement.dataset.row = r; seatElement.dataset.col = c;
                             const numberSpan = seatElement.querySelector('.seat-student-number');
                             const nameSpan = seatElement.querySelector('.seat-student-name');
                             const placeholderSpan = seatElement.querySelector('.seat-placeholder-text');
                             numberSpan.textContent = ''; nameSpan.textContent = ''; placeholderSpan.textContent = ''; placeholderSpan.classList.remove('seat-placeholder-text');
                             seatElement.classList.remove('occupied', 'empty', 'selected-for-assignment');
                             seatElement.removeAttribute('data-student-id'); seatElement.setAttribute('draggable', 'false');

                             if (student) {
                                 seatElement.classList.add('occupied'); seatElement.dataset.studentId = student.id;
                                 numberSpan.textContent = student.number ? `${student.number}.` : ''; nameSpan.textContent = sanitizeHTML(student.name);
                                 if (isEditing) { seatElement.setAttribute('draggable', 'true'); seatElement.addEventListener('dragstart', handleSeatDragStart); seatElement.addEventListener('click', handleOccupiedSeatClick); seatElement.style.cursor = 'grab'; }
                                 else { seatElement.style.cursor = 'default'; }
                             } else {
                                 seatElement.classList.add('empty');
                                 if (isEditing) { seatElement.addEventListener('click', handleSeatClickForAssignment); placeholderSpan.textContent = emptySeatPlaceholder; placeholderSpan.classList.add('seat-placeholder-text'); seatElement.style.cursor = 'pointer'; }
                                 else { seatElement.style.cursor = 'default'; }
                             }
                             if (isEditing) { seatElement.addEventListener('dragover', handleDragOver); seatElement.addEventListener('dragleave', handleDragLeave); seatElement.addEventListener('drop', handleDropOnSeat); }
                             gridContainerElement.appendChild(seatElement);
                         }
                     }
                 } else if (!isEditing) {
                      gridContainerElement.innerHTML = '<p style="padding: 1rem; text-align: center; grid-column: 1 / -1;">Configure o mapa clicando no botão <span class="icon icon-editar"></span>.</p>';
                 } else {
                      gridContainerElement.innerHTML = '<p style="padding: 1rem; text-align: center; grid-column: 1 / -1;">Dimensões inválidas (0 fileiras ou colunas).</p>';
                 }


                 if (isEditing) { renderUnassignedStudents(classId); }
                 classroomContainerDisplay.classList.toggle('hidden', isEditing);
                 mapEditArea.classList.toggle('hidden', !isEditing);
             };
             const editClassroomMap = () => {
                 const cls = findClassById(currentClassId); if (!cls) return;
                 tempClassroomLayout = JSON.parse(JSON.stringify(cls.classroomLayout || { rows: 5, cols: 6, teacherDeskPosition: 'top-center', seats: [] }));
                 clearSeatSelection();
                 mapRowsInput.value = tempClassroomLayout.rows; mapColsInput.value = tempClassroomLayout.cols; teacherDeskPositionSelect.value = tempClassroomLayout.teacherDeskPosition;
                 classroomMapEditControls.classList.remove('hidden');
                 renderClassroomMap(currentClassId, true);
                 mapRowsInput.removeEventListener('input', handleDimensionChange);
                 mapColsInput.removeEventListener('input', handleDimensionChange);
                 teacherDeskPositionSelect.removeEventListener('change', handleTeacherDeskChange);
                 mapRowsInput.addEventListener('input', handleDimensionChange);
                 mapColsInput.addEventListener('input', handleDimensionChange);
                 teacherDeskPositionSelect.addEventListener('change', handleTeacherDeskChange);
             };
             const cancelClassroomMapEdit = () => {
                 tempClassroomLayout = null; clearSeatSelection();                 classroomMapEditControls.classList.add('hidden');
                 renderClassroomMap(currentClassId, false); // Renderiza no container de display
                 mapRowsInput.removeEventListener('input', handleDimensionChange);
                 mapColsInput.removeEventListener('input', handleDimensionChange);
                 teacherDeskPositionSelect.removeEventListener('change', handleTeacherDeskChange);
             };
             const saveClassroomLayout = () => { if (!currentClassId || !tempClassroomLayout) return; const cls = findClassById(currentClassId); if (!cls) return; const newLayout = { rows: parseInt(mapRowsInput.value) || 5, cols: parseInt(mapColsInput.value) || 6, teacherDeskPosition: teacherDeskPositionSelect.value || 'top-center', seats: tempClassroomLayout.seats }; if (newLayout.rows < 1 || newLayout.rows > 20 || newLayout.cols < 1 || newLayout.cols > 20) { alert("Fileiras e Colunas devem estar entre 1 e 20."); return; } cls.classroomLayout = newLayout; saveData(); tempClassroomLayout = null; cancelClassroomMapEdit(); alert("Mapa da sala salvo!"); };
             const handleDimensionChange = () => { if (!tempClassroomLayout) return; const newRows = parseInt(mapRowsInput.value) || tempClassroomLayout.rows; const newCols = parseInt(mapColsInput.value) || tempClassroomLayout.cols; if (newRows !== tempClassroomLayout.rows || newCols !== tempClassroomLayout.cols) { const oldSeats = tempClassroomLayout.seats; tempClassroomLayout.rows = newRows; tempClassroomLayout.cols = newCols; tempClassroomLayout.seats = oldSeats.filter(seat => seat.row <= newRows && seat.col <= newCols); renderClassroomMap(currentClassId, true); } };
             const handleTeacherDeskChange = () => { if (!tempClassroomLayout) return; tempClassroomLayout.teacherDeskPosition = teacherDeskPositionSelect.value; renderClassroomMap(currentClassId, true); };
             const renderUnassignedStudents = (classId) => { if (!tempClassroomLayout) return; const allStudents = getStudentsByClass(classId); const assignedStudentIds = new Set(tempClassroomLayout.seats.map(s => s.studentId).filter(id => id)); unassignedStudentsContainer.innerHTML = '<h5>Alunos sem lugar (Clique aqui após selecionar mesa vazia)</h5>'; const studentTemplate = document.getElementById('draggable-student-template'); allStudents.forEach(student => { if (!assignedStudentIds.has(student.id)) { const clone = studentTemplate.content.cloneNode(true); const studentDiv = clone.querySelector('.draggable-student'); studentDiv.dataset.studentId = student.id; studentDiv.querySelector('.student-number').textContent = student.number ? `${student.number}.` : ''; studentDiv.querySelector('.student-name').textContent = sanitizeHTML(student.name); const oldNode = studentDiv; studentDiv.replaceWith(oldNode.cloneNode(true)); const newNode = unassignedStudentsContainer.appendChild(oldNode); newNode.addEventListener('dragstart', handleStudentListDragStart); newNode.addEventListener('click', handleUnassignedStudentClickForAssignment); } }); };

             // --- Drag and Drop Handlers (Existentes, sem mudanças aqui) ---
             const handleStudentListDragStart = (e) => { draggedElement = e.target; draggedStudentId = e.target.dataset.studentId; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', draggedStudentId); setTimeout(() => draggedElement?.classList.add('dragging'), 0); clearSeatSelection(); console.log(`Drag Start (List): Student ID ${draggedStudentId}`); };
             const handleSeatDragStart = (e) => { draggedElement = e.target; draggedStudentId = e.target.dataset.studentId; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', draggedStudentId); setTimeout(() => draggedElement?.classList.add('dragging'), 0); clearSeatSelection(); console.log(`Drag Start (Seat): Student ID ${draggedStudentId} from Row ${e.target.dataset.row}, Col ${e.target.dataset.col}`); };
             const handleDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; const target = e.target.closest('.seat, .unassigned-students-list'); if (target) { const targetIsSeat = target.classList.contains('seat'); const targetIsUnassigned = target.classList.contains('unassigned-students-list'); const draggingFromSeat = draggedElement && draggedElement.classList.contains('seat'); if (targetIsSeat && !target.classList.contains('occupied')) { target.classList.add('drag-over'); } else if (targetIsSeat && target.classList.contains('occupied') && draggedStudentId !== target.dataset.studentId) { target.classList.add('drag-over'); } else if (targetIsUnassigned && draggingFromSeat) { target.classList.add('drag-over'); } } };
             const handleDragLeave = (e) => { const target = e.target.closest('.seat, .unassigned-students-list'); if (target) { target.classList.remove('drag-over'); } };
             const handleDropOnSeat = (e) => { e.preventDefault(); const targetSeat = e.target.closest('.seat'); if (!targetSeat || !draggedStudentId || !tempClassroomLayout) return; targetSeat.classList.remove('drag-over'); const targetRow = parseInt(targetSeat.dataset.row); const targetCol = parseInt(targetSeat.dataset.col); const studentBeingDroppedId = e.dataTransfer.getData('text/plain') || draggedStudentId; console.log(`Drop: Student ${studentBeingDroppedId} onto Row ${targetRow}, Col ${targetCol}`); const existingStudentIdInTarget = targetSeat.dataset.studentId; tempClassroomLayout.seats = tempClassroomLayout.seats.filter(seat => seat.studentId !== studentBeingDroppedId); if (existingStudentIdInTarget && existingStudentIdInTarget !== studentBeingDroppedId) { console.log(` -> Target occupied by ${existingStudentIdInTarget}. Unassigning ${existingStudentIdInTarget}.`); tempClassroomLayout.seats = tempClassroomLayout.seats.filter(seat => !(seat.row === targetRow && seat.col === targetCol)); } let seatEntry = tempClassroomLayout.seats.find(s => s.row === targetRow && s.col === targetCol); if (!seatEntry) { seatEntry = { row: targetRow, col: targetCol, studentId: null }; tempClassroomLayout.seats.push(seatEntry); } else if (seatEntry.studentId && seatEntry.studentId !== studentBeingDroppedId){ seatEntry.studentId = null; } seatEntry.studentId = studentBeingDroppedId; console.log(" -> Updated Temp Layout (Drop on Seat):", JSON.parse(JSON.stringify(tempClassroomLayout.seats))); renderClassroomMap(currentClassId, true); draggedElement?.classList.remove('dragging'); draggedStudentId = null; draggedElement = null; };
             const handleDropOnUnassignedList = (e) => { e.preventDefault(); const targetList = e.target.closest('.unassigned-students-list'); if (!targetList || !draggedStudentId || !tempClassroomLayout) return; targetList.classList.remove('drag-over'); const studentBeingDroppedId = e.dataTransfer.getData('text/plain') || draggedStudentId; console.log(`Drop: Student ${studentBeingDroppedId} onto Unassigned List`); const wasSeatOccupied = tempClassroomLayout.seats.some(seat => seat.studentId === studentBeingDroppedId); if (!wasSeatOccupied) { console.log(" -> Student was already unassigned. No change needed."); draggedElement?.classList.remove('dragging'); draggedStudentId = null; draggedElement = null; return; } tempClassroomLayout.seats = tempClassroomLayout.seats.filter(seat => seat.studentId !== studentBeingDroppedId); console.log(" -> Updated Temp Layout (Drop on Unassigned):", JSON.parse(JSON.stringify(tempClassroomLayout.seats))); renderClassroomMap(currentClassId, true); draggedElement?.classList.remove('dragging'); draggedStudentId = null; draggedElement = null; };

             // --- Click-to-Assign Handlers (Existentes, sem mudanças aqui) ---
             const clearSeatSelection = () => { if (selectedSeatForAssignment) { selectedSeatForAssignment.classList.remove('selected-for-assignment'); selectedSeatForAssignment = null; console.log("Seat selection cleared."); } };
             const handleSeatClickForAssignment = (event) => { const clickedSeat = event.currentTarget; if (!clickedSeat.classList.contains('empty') || !tempClassroomLayout) return; if (selectedSeatForAssignment === clickedSeat) { clearSeatSelection(); } else { clearSeatSelection(); selectedSeatForAssignment = clickedSeat; selectedSeatForAssignment.classList.add('selected-for-assignment'); console.log(`Seat selected for assignment: Row ${clickedSeat.dataset.row}, Col ${clickedSeat.dataset.col}`); } };
             const handleOccupiedSeatClick = (event) => { const clickedSeat = event.currentTarget; if (!tempClassroomLayout || !clickedSeat.classList.contains('occupied')) return; const studentIdToUnassign = clickedSeat.dataset.studentId; const row = parseInt(clickedSeat.dataset.row); const col = parseInt(clickedSeat.dataset.col); if (!studentIdToUnassign) return; const student = findStudentById(studentIdToUnassign); if (confirm(`Desassociar aluno ${sanitizeHTML(student?.name || studentIdToUnassign)} desta mesa (R${row}, C${col})?`)) { console.log(`Click Unassign: Student ${studentIdToUnassign} from Row ${row}, Col ${col}`); tempClassroomLayout.seats = tempClassroomLayout.seats.filter(seat => !(seat.row === row && seat.col === col)); clearSeatSelection(); renderClassroomMap(currentClassId, true); } };
             const handleUnassignedStudentClickForAssignment = (event) => { if (!selectedSeatForAssignment) { console.log("Unassigned student clicked, but no seat selected."); return; } const clickedStudentElement = event.currentTarget; const studentIdToAssign = clickedStudentElement.dataset.studentId; const targetRow = parseInt(selectedSeatForAssignment.dataset.row); const targetCol = parseInt(selectedSeatForAssignment.dataset.col); if (!studentIdToAssign || isNaN(targetRow) || isNaN(targetCol) || !tempClassroomLayout) { console.error("Error during click assignment: Missing data"); clearSeatSelection(); return; } console.log(`Click Assign: Student ${studentIdToAssign} to Row ${targetRow}, Col ${targetCol}`); let seatEntry = tempClassroomLayout.seats.find(s => s.row === targetRow && s.col === targetCol); if (!seatEntry) { seatEntry = { row: targetRow, col: targetCol, studentId: null }; tempClassroomLayout.seats.push(seatEntry); } else if (seatEntry.studentId) { console.warn(`Target seat ${targetRow}-${targetCol} was already occupied by ${seatEntry.studentId} during click assignment. Overwriting.`); } seatEntry.studentId = studentIdToAssign; console.log(" -> Updated Temp Layout (Click Assign):", JSON.parse(JSON.stringify(tempClassroomLayout.seats))); clearSeatSelection(); renderClassroomMap(currentClassId, true); };

            // Function to toggle card collapse state
            const toggleCardCollapse = (button) => { const card = button.closest('.card'); const icon = button.querySelector('.icon'); if (card && icon) { const isCollapsed = card.classList.toggle('collapsed'); icon.classList.toggle('icon-chevron-down', isCollapsed); icon.classList.toggle('icon-chevron-up', !isCollapsed); button.title = isCollapsed ? 'Mostrar' : 'Esconder'; } };

            // --- Tool Functions (Sorteador, Cronômetro, Gerador de Grupos) - Existentes, sem mudanças ---
            const openNameSorterModal = () => { const title = "Sorteador de Nomes"; let content = ''; let footer = ''; const currentClass = currentClassId ? findClassById(currentClassId) : null; const students = currentClass ? getStudentsByClass(currentClassId) : []; if (!currentClass) { content = '<p>Por favor, selecione uma turma na aba "Detalhes" para usar o sorteador.</p>'; } else if (students.length === 0) { content = `<p>Não há alunos cadastrados na turma "${sanitizeHTML(currentClass.name)}".</p>`; } else { sorterStudentList = [...students]; sorterAvailableStudents = [...students]; sorterDrawnStudents = []; content = `<p class="mb-1 text-sm text-secondary">Turma: ${sanitizeHTML(currentClass.name)}</p> <div id="sorter-result-display">-- Clique em Sortear --</div> <div class="sorter-controls mt-2"> <div class="checkbox-group mb-0"> <input type="checkbox" id="sorter-no-repeat"> <label for="sorter-no-repeat">Sortear sem Repetição</label> </div> <span id="sorter-remaining-count" class="sorter-info hidden">${students.length} restantes</span> </div>`; footer = `<button type="button" id="reset-sorter-button" class="secondary"><span class="icon">🔄</span> Reiniciar</button> <button type="button" id="sort-next-button" class="success"><span class="icon icon-sorteio"></span> Sortear Próximo</button>`; } showModal(title, content, footer, 'name-sorter-modal'); if (currentClass && students.length > 0) { const sortButton = document.getElementById('sort-next-button'); const resetButton = document.getElementById('reset-sorter-button'); const noRepeatCheckbox = document.getElementById('sorter-no-repeat'); const remainingCountDisplay = document.getElementById('sorter-remaining-count'); const resultDisplay = document.getElementById('sorter-result-display'); const updateRemainingCount = () => { if (noRepeatCheckbox.checked) { remainingCountDisplay.textContent = `${sorterAvailableStudents.length} restantes`; remainingCountDisplay.classList.remove('hidden'); sortButton.disabled = sorterAvailableStudents.length === 0; } else { remainingCountDisplay.classList.add('hidden'); sortButton.disabled = false; } }; sortButton.addEventListener('click', () => sortNextName(resultDisplay, noRepeatCheckbox.checked, updateRemainingCount)); resetButton.addEventListener('click', () => resetSorter(resultDisplay, updateRemainingCount)); noRepeatCheckbox.addEventListener('change', () => resetSorter(resultDisplay, updateRemainingCount)); } };
            const sortNextName = (displayElement, noRepeat, updateCountCallback) => { let listToDrawFrom = noRepeat ? sorterAvailableStudents : sorterStudentList; if (listToDrawFrom.length === 0) { displayElement.textContent = "Fim!"; updateCountCallback(); return; } const randomIndex = Math.floor(Math.random() * listToDrawFrom.length); const drawnStudent = listToDrawFrom[randomIndex]; displayElement.innerHTML = `<span style="font-weight:normal; font-size: 0.8em; display:block;">${drawnStudent.number || '-.'}</span> ${sanitizeHTML(drawnStudent.name)}`; if (noRepeat) { sorterDrawnStudents.push(drawnStudent); sorterAvailableStudents.splice(randomIndex, 1); } updateCountCallback(); };
            const resetSorter = (displayElement, updateCountCallback) => { sorterAvailableStudents = [...sorterStudentList]; sorterDrawnStudents = []; displayElement.textContent = "-- Reiniciado --"; updateCountCallback(); };
            const formatTime = (totalSeconds) => { const hours = Math.floor(totalSeconds / 3600); const minutes = Math.floor((totalSeconds % 3600) / 60); const seconds = totalSeconds % 60; return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; };
            const updateStopwatchDisplay = () => { const display = document.getElementById('timer-display'); if (display) { display.textContent = formatTime(stopwatchSeconds); } };
            const startStopwatch = () => { if (isStopwatchRunning) return; isStopwatchRunning = true; document.getElementById('start-timer-button')?.classList.add('hidden'); document.getElementById('pause-timer-button')?.classList.remove('hidden'); stopwatchInterval = setInterval(() => { stopwatchSeconds++; updateStopwatchDisplay(); }, 1000); };
            const pauseStopwatch = () => { if (!isStopwatchRunning) return; isStopwatchRunning = false; clearInterval(stopwatchInterval); stopwatchInterval = null; document.getElementById('start-timer-button')?.classList.remove('hidden'); document.getElementById('pause-timer-button')?.classList.add('hidden'); };
            const resetStopwatch = () => { pauseStopwatch(); stopwatchSeconds = 0; updateStopwatchDisplay(); };
            const openTimerModal = () => { const title = "Cronômetro / Timer"; if (stopwatchInterval) clearInterval(stopwatchInterval); stopwatchInterval = null; stopwatchSeconds = 0; isStopwatchRunning = false; const content = `<div id="timer-display">00:00:00</div> <div class="timer-controls"> <button type="button" id="start-timer-button" class="success"><span class="icon">▶️</span> Iniciar</button> <button type="button" id="pause-timer-button" class="warning hidden"><span class="icon">⏸️</span> Pausar</button> <button type="button" id="reset-timer-button" class="secondary"><span class="icon">🔄</span> Zerar</button> </div> <hr style="margin: 1.5rem 0 1rem 0; border-color: var(--border-color);"> <p class="text-center text-secondary text-sm">Funcionalidade de Timer (contagem regressiva) em desenvolvimento.</p>`; showModal(title, content, '', 'timer-modal'); document.getElementById('start-timer-button')?.addEventListener('click', startStopwatch); document.getElementById('pause-timer-button')?.addEventListener('click', pauseStopwatch); document.getElementById('reset-timer-button')?.addEventListener('click', resetStopwatch); modal.addEventListener('click', (e) => { if (e.target === modal || e.target.closest('.close-button')) { pauseStopwatch(); } }); };
            const openGroupGeneratorModal = () => { const title = "Gerador de Grupos"; let content = ''; let footer = ''; const currentClass = currentClassId ? findClassById(currentClassId) : null; const students = currentClass ? getStudentsByClass(currentClassId) : []; if (!currentClass) { content = '<p>Por favor, selecione uma turma na aba "Detalhes" para usar o gerador.</p>'; } else if (students.length === 0) { content = `<p>Não há alunos cadastrados na turma "${sanitizeHTML(currentClass.name)}".</p>`; } else { content = ` <p class="mb-1 text-sm text-secondary">Turma: ${sanitizeHTML(currentClass.name)} (${students.length} alunos)</p> <div class="group-options"> <div class="radio-group"> <input type="radio" id="group-by-number" name="group-method" value="number" checked> <label for="group-by-number">Dividir em:</label> <input type="number" id="group-number-input" value="2" min="2"> <label for="group-number-input">grupos</label> </div> <div class="radio-group"> <input type="radio" id="group-by-size" name="group-method" value="size"> <label for="group-by-size">Grupos de:</label> <input type="number" id="group-size-input" value="2" min="1"> <label for="group-size-input">alunos</label> </div> </div> <div id="group-results-container"> <!-- Results will be displayed here --> <p class="text-secondary text-center mt-2">Clique em "Gerar Grupos".</p> </div> `; footer = `<button type="button" id="generate-groups-button" class="success"><span class="icon icon-grupos"></span> Gerar Grupos</button>`; } showModal(title, content, footer, 'group-generator-modal'); if (currentClass && students.length > 0) { const generateButton = document.getElementById('generate-groups-button'); const numberInput = document.getElementById('group-number-input'); const sizeInput = document.getElementById('group-size-input'); const numberRadio = document.getElementById('group-by-number'); const sizeRadio = document.getElementById('group-by-size'); const resultsContainer = document.getElementById('group-results-container'); numberRadio.addEventListener('change', () => { numberInput.disabled = false; sizeInput.disabled = true; }); sizeRadio.addEventListener('change', () => { numberInput.disabled = true; sizeInput.disabled = false; }); numberInput.disabled = !numberRadio.checked; sizeInput.disabled = !sizeRadio.checked; generateButton.addEventListener('click', () => generateGroups(students, resultsContainer)); } };
            const shuffleArray = (array) => { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; };
            const generateGroups = (studentList, resultsContainer) => { const method = document.querySelector('input[name="group-method"]:checked').value; const numberInput = document.getElementById('group-number-input'); const sizeInput = document.getElementById('group-size-input'); const shuffledStudents = shuffleArray([...studentList]); let groups = []; resultsContainer.innerHTML = ''; try { if (method === 'number') { const numGroups = parseInt(numberInput.value); if (isNaN(numGroups) || numGroups < 2 || numGroups > shuffledStudents.length) { alert("Número de grupos inválido. Deve ser entre 2 e o número de alunos."); return; } for (let i = 0; i < numGroups; i++) groups.push([]); let currentGroupIndex = 0; shuffledStudents.forEach(student => { groups[currentGroupIndex].push(student); currentGroupIndex = (currentGroupIndex + 1) % numGroups; }); } else { const groupSize = parseInt(sizeInput.value); if (isNaN(groupSize) || groupSize < 1) { alert("Tamanho do grupo inválido. Deve ser pelo menos 1."); return; } for (let i = 0; i < shuffledStudents.length; i += groupSize) { groups.push(shuffledStudents.slice(i, i + groupSize)); } } if (groups.length > 0) { groups.forEach((group, index) => { const groupDiv = document.createElement('div'); groupDiv.classList.add('generated-group'); const groupTitle = document.createElement('h5'); groupTitle.textContent = `Grupo ${index + 1}`; groupDiv.appendChild(groupTitle); const ul = document.createElement('ul'); group.forEach(student => { const li = document.createElement('li'); li.innerHTML = `<span class="student-number">${student.number || '-.'}</span> ${sanitizeHTML(student.name)}`; ul.appendChild(li); }); groupDiv.appendChild(ul); resultsContainer.appendChild(groupDiv); }); } else { resultsContainer.innerHTML = '<p class="text-secondary text-center mt-2">Não foi possível gerar grupos com essas opções.</p>'; } } catch (error) { console.error("Erro ao gerar grupos:", error); resultsContainer.innerHTML = '<p class="text-danger text-center mt-2">Ocorreu um erro ao gerar os grupos.</p>'; } };

            // --- Advanced Calculator Functions ---
             const updateCalculatorDisplay = () => {
                 if(calculatorDisplay) {
                    calculatorDisplay.textContent = calculator.displayValue.replace('.', ','); // Display comma
                 }
             };

             const resetCalculator = () => {
                 calculator.displayValue = '0';
                 calculator.firstOperand = null;
                 calculator.waitingForSecondOperand = false;
                 calculator.operator = null;
                 calculator.weightedPairs = [];
                 if(weightedAverageResult) weightedAverageResult.textContent = '--';
                 renderWeightedPairsList();
                 updateCalculatorDisplay();
                 console.log('Calculator reset');
             };

             const inputDigit = (digit) => {
                 const { displayValue, waitingForSecondOperand } = calculator;
                 if (waitingForSecondOperand) {
                     calculator.displayValue = digit;
                     calculator.waitingForSecondOperand = false;
                 } else {
                     // Prevent leading zeros unless it's the only digit
                     calculator.displayValue = displayValue === '0' ? digit : displayValue + digit;
                 }
                 updateCalculatorDisplay();
             };

             const inputDecimal = () => {
                 if (calculator.waitingForSecondOperand) {
                     calculator.displayValue = '0.';
                     calculator.waitingForSecondOperand = false;
                     updateCalculatorDisplay();
                     return;
                 }
                 if (!calculator.displayValue.includes('.')) {
                     calculator.displayValue += '.';
                 }
                 updateCalculatorDisplay();
             };

             const handleOperator = (nextOperator) => {
                 const { firstOperand, displayValue, operator } = calculator;
                 // Convert display value with comma back to dot for calculation
                 const inputValue = parseFloat(displayValue.replace(',', '.'));

                 if (operator && calculator.waitingForSecondOperand) {
                     calculator.operator = nextOperator;
                     console.log('Operator changed to', nextOperator);
                     return;
                 }

                 if (firstOperand === null && !isNaN(inputValue)) {
                     calculator.firstOperand = inputValue;
                 } else if (operator) {
                     const result = performCalculation[operator](firstOperand, inputValue);
                     // Use dot internally, convert to comma only for display
                     const resultString = Number.isFinite(result) ? String(result) : 'Erro';
                     calculator.displayValue = resultString; // Store internal value with dot
                     calculator.firstOperand = result;
                     updateCalculatorDisplay(); // This function will handle comma display
                 }

                 calculator.waitingForSecondOperand = true;
                 calculator.operator = nextOperator;
                 console.log('State after operator:', JSON.parse(JSON.stringify(calculator)));
             };

             const performCalculation = {
                 // Keep internal representation simple
                 'divide': (first, second) => second === 0 ? NaN : first / second,
                 'multiply': (first, second) => first * second,
                 'add': (first, second) => first + second,
                 'subtract': (first, second) => first - second,
                 '=': (first, second) => second, // For final calculation trigger
             };

             const clearAll = () => {
                 resetCalculator();
             };

             const clearEntry = () => {
                if (calculator.waitingForSecondOperand) {
                    // If result of previous op is shown, C acts like AC
                    resetCalculator();
                } else {
                    calculator.displayValue = '0';
                    // Don't reset firstOperand or operator here
                }
                 updateCalculatorDisplay();
             };

             const backspace = () => {
                if (calculator.waitingForSecondOperand) return; // Don't backspace if result is shown
                 calculator.displayValue = calculator.displayValue.slice(0, -1);
                 if (calculator.displayValue === '' || calculator.displayValue === '-') {
                     calculator.displayValue = '0';
                 }
                 updateCalculatorDisplay();
             };

             const handleCalculatorButtonClick = (event) => {
                const { target } = event;
                if (!target.matches('button')) return; // Exit if the click wasn't on a button

                const action = target.dataset.action;
                const value = target.dataset.value;
                const operator = target.dataset.operator;

                console.log(`Button Click: action=${action}, value=${value}, operator=${operator}`);


                if (value !== undefined) { inputDigit(value); }
                else if (operator !== undefined) { handleOperator(operator); }
                else if (action === 'decimal') { inputDecimal(); }
                else if (action === 'clearAll') { clearAll(); }
                else if (action === 'clearEntry') { clearEntry(); }
                else if (action === 'backspace') { backspace(); }
                else if (action === 'calculate') {
                    if (calculator.operator && calculator.firstOperand !== null) {
                        handleOperator(calculator.operator); // Perform calculation with current operator
                        calculator.operator = null; // Reset operator after '='
                        calculator.waitingForSecondOperand = false; // Allow new number input
                    }
                 }
             };

            // --- Weighted Average Functions ---
            const addWeightedPair = () => {
                const gradeStr = weightedGradeInput.value.trim().replace(',', '.');
                const weightStr = weightedWeightInput.value.trim().replace(',', '.');
                const grade = parseFloat(gradeStr);
                const weight = parseFloat(weightStr);

                if (isNaN(grade)) {
                    alert("Por favor, insira uma nota válida.");
                    weightedGradeInput.focus();
                    return;
                }
                 if (isNaN(weight) || weight <= 0) {
                    alert("Por favor, insira um peso válido (maior que zero).");
                     weightedWeightInput.focus();
                    return;
                }

                calculator.weightedPairs.push({ grade, weight });
                renderWeightedPairsList();
                weightedGradeInput.value = '';
                weightedWeightInput.value = '';
                weightedGradeInput.focus();
                weightedAverageResult.textContent = '--'; // Clear previous result
            };

            const renderWeightedPairsList = () => {
                if (!weightedPairsList) return;
                weightedPairsList.innerHTML = ''; // Clear the list
                if (calculator.weightedPairs.length === 0) {
                    weightedPairsList.innerHTML = '<p>Nenhum par adicionado.</p>';
                    if (calculateWeightedAvgButton) calculateWeightedAvgButton.disabled = true;
                    return;
                }

                if (calculateWeightedAvgButton) calculateWeightedAvgButton.disabled = false;
                const template = document.getElementById('weighted-pair-item-template');
                calculator.weightedPairs.forEach((pair, index) => {
                    const clone = template.content.cloneNode(true);
                    const li = clone.querySelector('.pair-item');
                    li.dataset.index = index;
                    const textSpan = li.querySelector('span');
                    // Display with comma
                    textSpan.querySelector('strong:nth-child(1)').textContent = String(pair.grade).replace('.', ',');
                    textSpan.querySelector('strong:nth-child(2)').textContent = String(pair.weight).replace('.', ',');

                    const deleteButton = li.querySelector('.delete-pair-button');
                    // Ensure listener is attached correctly
                    deleteButton.addEventListener('click', () => removeWeightedPair(index));

                    weightedPairsList.appendChild(clone);
                });
            };

            const removeWeightedPair = (index) => {
                if (index >= 0 && index < calculator.weightedPairs.length) {
                    calculator.weightedPairs.splice(index, 1);
                    renderWeightedPairsList();
                    if(weightedAverageResult) weightedAverageResult.textContent = '--'; // Clear result as list changed
                }
            };

            const calculateWeightedAverage = () => {
                 if (!weightedAverageResult) return;
                if (calculator.weightedPairs.length === 0) {
                    weightedAverageResult.textContent = '--';
                    return;
                }

                let totalWeightedSum = 0;
                let totalWeight = 0;

                calculator.weightedPairs.forEach(pair => {
                    totalWeightedSum += pair.grade * pair.weight;
                    totalWeight += pair.weight;
                });

                if (totalWeight === 0) {
                    weightedAverageResult.textContent = 'Erro (Peso 0)';
                    return;
                }

                const average = totalWeightedSum / totalWeight;
                // Limit to 2 decimal places for display, use comma
                weightedAverageResult.textContent = `Média: ${average.toFixed(2).replace('.', ',')}`;
            };

            const switchCalculatorMode = (mode) => {
                 calculator.mode = mode;
                 resetCalculator(); // Reset state when switching modes
                 if (mode === 'standard') {
                     standardCalcSection?.classList.remove('hidden');
                     weightedCalcSection?.classList.add('hidden');
                     calcModeStandardBtn?.classList.add('active');
                     calcModeWeightedBtn?.classList.remove('active');
                 } else { // weighted
                     standardCalcSection?.classList.add('hidden');
                     weightedCalcSection?.classList.remove('hidden');
                     calcModeStandardBtn?.classList.remove('active');
                     calcModeWeightedBtn?.classList.add('active');
                 }
            };

             const openAdvancedCalculatorModal = () => {
                 resetCalculator(); // Ensure clean state on open
                 switchCalculatorMode('standard'); // Default to standard mode
                 calculatorModal?.classList.add('show');

                 // --- Add Listeners Specific to Calculator ---
                 // Remove previous listeners might not be strictly needed if elements are stable
                 // Re-attach listeners to ensure they point to the current elements/functions
                 const currentCalcButtonsContainer = document.querySelector('#calculator-standard-section .calculator-buttons');
                 currentCalcButtonsContainer?.removeEventListener('click', handleCalculatorButtonClick); // Remove old before adding new
                 currentCalcButtonsContainer?.addEventListener('click', handleCalculatorButtonClick);


                 if(calcModeStandardBtn) calcModeStandardBtn.onclick = () => switchCalculatorMode('standard');
                 if(calcModeWeightedBtn) calcModeWeightedBtn.onclick = () => switchCalculatorMode('weighted');
                 if(addPairButton) addPairButton.onclick = addWeightedPair;
                 if(calculateWeightedAvgButton) calculateWeightedAvgButton.onclick = calculateWeightedAverage;

                 // Listener for closing the modal (added for robustness)
                 calculatorModal?.querySelectorAll('[data-dismiss="modal"]').forEach(btn => {
                     btn.onclick = hideModal; // Overwrite any previous onclick
                 });
                 // Listener for background click
                 calculatorModal?.addEventListener('click', (e) => {
                     if (e.target === calculatorModal) {
                         hideModal();
                     }
                 }, { once: false }); // Add persistently
             };

             const openToolModal = (toolType) => { // Generalized tool opener
                 if (toolType === 'advanced-calculator') {
                    openAdvancedCalculatorModal();
                    return; // Don't show the generic modal
                 }

                let title = "Ferramenta";
                let content = "<p>Funcionalidade em desenvolvimento.</p>";
                let modalClass = '';
                let footer = '';

                 switch (toolType) {
                     case 'name-sorter':
                         openNameSorterModal(); // Use specific function
                         return; // Don't show the generic modal
                     case 'timer-stopwatch':
                         openTimerModal(); // Use specific function
                         return; // Don't show the generic modal
                     case 'group-generator':
                         openGroupGeneratorModal(); // Use specific function
                         return; // Don't show the generic modal
                     // Keep placeholder for truly undeveloped tools
                     default:
                         title = "Funcionalidade Indisponível";
                         content = "<p>Esta ferramenta ainda não foi implementada.</p>";
                 }
                 showModal(title, content, footer, modalClass);
             };


            // --- Event Listeners Globais ---
            navButtons.forEach(button => { button.addEventListener('click', () => { const targetSection = button.dataset.section; if (button.disabled) return; showSection(targetSection); }); });
            addScheduleButton.addEventListener('click', () => openScheduleModal());
            addSchoolButton.addEventListener('click', () => openSchoolModal());
            addClassButton.addEventListener('click', () => { if(currentSchoolId) openClassModal(); else alert("Selecione uma escola primeiro!"); });
            backToSchoolsButton.addEventListener('click', () => { currentSchoolId = null; currentClassId = null; showSection('schools-section'); });
            backToClassesButton.addEventListener('click', () => { if (tempClassroomLayout) { cancelClassroomMapEdit(); } showSection('classes-section'); });
             // Generic modal close listener
             modal.addEventListener('click', (e) => {
                 if (e.target === modal || e.target.closest('.close-button[data-dismiss="modal"]') || e.target.matches('button[data-dismiss="modal"]')) {
                     // Check if it's a specific tool modal needing cleanup before calling generic hide
                     if (modal.querySelector('.timer-modal .modal-content')) { pauseStopwatch(); }
                     // Add other generic tool cleanup here if needed
                     hideModal(); // Hide the generic modal
                 }
             });
             // Specific listener for calculator modal background/close button click (moved from openAdvancedCalculatorModal for consistency)
            //  calculatorModal?.addEventListener('click', (e) => {
            //       if (e.target === calculatorModal || e.target.closest('.close-button[data-dismiss="modal"]') || e.target.matches('button[data-dismiss="modal"]')) {
            //          hideModal(); // Use the generic hide function which now also handles the calc modal
            //      }
            //  });
             // Combine modal closing logic:
             const combinedModalCloseHandler = (e) => {
                 const targetModal = e.currentTarget; // The modal that triggered the event
                 if (e.target === targetModal || e.target.closest('.close-button[data-dismiss="modal"]') || e.target.matches('button[data-dismiss="modal"]')) {
                     if (targetModal.id === 'generic-modal' && targetModal.querySelector('.timer-modal .modal-content')) {
                         pauseStopwatch();
                     }
                     // Add cleanup for other generic modals if necessary

                     // Regardless of which modal, call hideModal which hides both
                     hideModal();
                 }
             };
            modal.addEventListener('click', combinedModalCloseHandler);
            calculatorModal.addEventListener('click', combinedModalCloseHandler);


            document.getElementById('add-student-button').addEventListener('click', () => { if(currentClassId) openStudentModal(); else alert("Selecione uma turma primeiro!"); });
            gradeSetSelect.addEventListener('change', (e) => { if(currentClassId) { renderGradesTable(currentClassId, e.target.value); } });
            manageGradeStructureButton.addEventListener('click', openGradeStructureModal);
            saveGradesButton.addEventListener('click', saveGrades);
            exportGradesCsvButton?.addEventListener('click', exportGradesCSV);
            exportGradesPdfButton?.addEventListener('click', () => exportGradesPDF());
            attendanceDateInput.addEventListener('change', (e) => { if(currentClassId) { renderAttendanceTable(currentClassId, e.target.value); } });
            markAllPresentButton.addEventListener('click', markAllStudentsPresent);
            markNonSchoolDayButton.addEventListener('click', toggleNonSchoolDay);
            lessonPlanDateInput.addEventListener('change', (e) => { if(currentClassId) { renderLessonPlan(currentClassId, e.target.value); } });
            saveLessonPlanButton.addEventListener('click', saveLessonPlan);
            saveAttendanceButton.addEventListener('click', saveAttendance);
            viewMonthlyAttendanceButton.addEventListener('click', openMonthlyAttendanceModal);
            editClassNotesButton.addEventListener('click', () => toggleClassNotesEdit(true));
            saveClassNotesButton.addEventListener('click', saveClassNotes);
            cancelClassNotesButton.addEventListener('click', () => toggleClassNotesEdit(false));
            document.querySelectorAll('.theme-button').forEach(button => { button.addEventListener('click', () => {applyTheme(button.dataset.theme); saveData();}); });
            document.getElementById('export-data-button').addEventListener('click', exportData);
            document.getElementById('import-data-input').addEventListener('change', importData);
            document.getElementById('clear-data-button').addEventListener('click', clearAllData);
             searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { performSearch(searchInput.value); } });
             searchInput.addEventListener('input', () => { /* No dynamic search */ });
             searchInput.addEventListener('search', () => { if (!searchInput.value) { hideModal(); } });
             notificationCloseButton?.addEventListener('click', hideNotification);
             enableGlobalNotificationsCheckbox?.addEventListener('change', (e) => { appData.settings.globalNotificationsEnabled = e.target.checked; enableNotificationSoundCheckbox.disabled = !e.target.checked; if (!e.target.checked) { stopNotificationChecker(); hideNotification(); } else { startNotificationChecker(); } saveData(); });
             enableNotificationSoundCheckbox?.addEventListener('change', (e) => { appData.settings.notificationSoundEnabled = e.target.checked; saveData(); });
             customNotificationSoundInput?.addEventListener('change', handleCustomSoundUpload);
             removeCustomSoundButton?.addEventListener('click', removeCustomSound);
             editMapButton.addEventListener('click', editClassroomMap);
             cancelMapEditButton.addEventListener('click', cancelClassroomMapEdit);
             saveMapButton.addEventListener('click', saveClassroomLayout);
             unassignedStudentsContainer.addEventListener('dragover', handleDragOver);
             unassignedStudentsContainer.addEventListener('dragleave', handleDragLeave);
             unassignedStudentsContainer.addEventListener('drop', handleDropOnUnassignedList);
             classDetailsSection.addEventListener('click', (e) => { const toggleButton = e.target.closest('.card-toggle-button'); if (toggleButton) { toggleCardCollapse(toggleButton); } });
             // Listener for Tools Grid
             toolsGrid?.addEventListener('click', (e) => {
                 const toolCard = e.target.closest('.tool-card');
                 if (toolCard && toolCard.dataset.tool) {
                     const toolType = toolCard.dataset.tool;
                     openToolModal(toolType); // Use the generalized opener
                 }
             });

             window.addEventListener('beforeunload', saveAppState);

            // --- Inicialização ---
            loadData();
            restoreAppState();
            renderScheduleList();
            renderSchoolList();
            const todayStr = getCurrentDateString();
            if (attendanceDateInput) attendanceDateInput.value = todayStr;
            if (lessonPlanDateInput) lessonPlanDateInput.value = todayStr;
            if (currentSection === 'classes-section' && currentSchoolId) { renderClassList(currentSchoolId); }
            else if (currentSection === 'class-details-section' && currentClassId) { selectClass(currentClassId, true); }
            showSection(currentSection || 'schedule-section');
            if (appData.settings.globalNotificationsEnabled) { startNotificationChecker(); }
            updateCustomSoundUI();

        });
            // --- Service Worker Registration ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/super-professor-pro/pwabuilder-sw.js') // <<< VERIFIQUE ESSE CAMINHO!
          .then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }

}); // Fechamento do DOMContentLoaded
    </script>

</body>
</html>
