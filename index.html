<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Professor Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <!-- Incluir html2pdf.js via CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* Reset Básico */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scroll */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
            transition: background-color 0.4s ease, color 0.4s ease, background-image 0.4s ease;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            position: relative;
            background-color: var(--bg-primary);
            background-image: var(--theme-background-image);
        }

        /* Variáveis de Tema (Default: Claro) */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --bg-secondary-alpha: rgba(248, 249, 250, 0.98);
            --bg-tertiary-alpha: rgba(233, 236, 239, 0.96);
            --bg-sticky-alpha: rgba(248, 249, 250, 0.98);
            --bg-modal-alpha: #ffffff;
            --bg-notification: #4caf50; /* Green for notifications */
            --text-notification: #ffffff;

            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-primary: #007bff;
            --accent-secondary: #6c757d;
            --accent-success: #28a745;
            --accent-danger: #dc3545;
            --accent-warning: #ffc107; /* Amarelo para FJ */
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --input-bg: #fff;
            --input-border: #ced4da;
            --nav-height: 65px;
            --fab-bottom-margin: 15px;
            --theme-background-image: none;
            --theme-background-opacity: 1;
            --theme-background-blend-mode: normal;
            --theme-background-filter: none;
             /* Grade Colors (Light) - Fallback if no custom ranges */
             --grade-low-bg: #f8d7da; --grade-low-text: #721c24;
             --grade-medium-bg: #fff3cd; --grade-medium-text: #856404;
             --grade-high-bg: #d4edda; --grade-high-text: #155724;
             /* Attendance Colors (Light) */
             --attendance-holiday-bg: #e2e3e5; --attendance-holiday-text: #495057; /* Non-school day */
             --attendance-suspended-bg: repeating-linear-gradient(45deg, var(--bg-tertiary-alpha), var(--bg-tertiary-alpha) 5px, var(--accent-danger) 5px, var(--accent-danger) 7px);
             --attendance-suspended-text: #000;
             /* Classroom Map Colors */
             --map-seat-bg: var(--input-bg);
             --map-seat-border: var(--input-border);
             --map-seat-text: var(--text-secondary);
             --map-seat-occupied-bg: color-mix(in srgb, var(--accent-primary) 15%, transparent);
             --map-seat-occupied-text: var(--text-primary);
             --map-teacher-desk-bg: var(--bg-tertiary);
             --map-teacher-desk-border: var(--accent-secondary);
             --map-drag-over-bg: color-mix(in srgb, var(--accent-success) 30%, transparent);
             --map-seat-selected-border: var(--accent-warning);
             /* Teacher Desk Dimensions */
             --teacher-desk-width: 80px;
             --teacher-desk-height: 45px;
             --teacher-desk-border-width: 3px;
             /* Seat Dimensions */
             --seat-width: 65px;
             --seat-height: 45px;
             --seat-gap: 6px;
             /* Tools Grid */
             --tool-card-min-width: 130px;
             /* Calculator */
            --calc-display-bg: var(--bg-tertiary-alpha);
            --calc-button-bg: var(--accent-primary);
            --calc-button-text: #ffffff;
            --calc-op-button-bg: color-mix(in srgb, var(--accent-primary) 80%, #ffffff);
            --calc-util-button-bg: var(--accent-secondary);
            --calc-danger-button-bg: var(--accent-danger);
            --calc-warn-button-bg: var(--accent-warning);
            --calc-button-hover-opacity: 0.85;
            --calc-button-active-scale: 0.96;
            --calc-mode-button-bg: var(--bg-tertiary);
            --calc-mode-button-text: var(--text-secondary);
            --calc-mode-button-active-bg: var(--accent-primary);
            --calc-mode-button-active-text: #ffffff;
            /* Observation Categories */
            --obs-cat-anotacao-bg: transparent; --obs-cat-anotacao-text: var(--text-secondary);
            --obs-cat-observacao-bg: color-mix(in srgb, var(--accent-primary) 15%, transparent); --obs-cat-observacao-text: var(--text-primary);
            --obs-cat-ocorrencia-bg: color-mix(in srgb, var(--accent-warning) 25%, transparent); --obs-cat-ocorrencia-text: var(--text-primary);
            --obs-cat-advertencia-bg: color-mix(in srgb, var(--accent-danger) 20%, transparent); --obs-cat-advertencia-text: var(--text-primary);
            --obs-cat-suspensao-bg: var(--accent-danger); --obs-cat-suspensao-text: #ffffff;

        }

        /* Pseudo-elemento para background pattern com opacidade */
        body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: var(--theme-background-image); background-color: transparent; background-repeat: repeat; background-attachment: fixed; background-size: auto; background-position: center; opacity: var(--theme-background-opacity); mix-blend-mode: var(--theme-background-blend-mode); filter: var(--theme-background-filter); z-index: -1; pointer-events: none; transition: opacity 0.4s ease; }

        /* --- TEMAS --- */
         body.theme-light { --bg-secondary-alpha: var(--bg-secondary); --bg-tertiary-alpha: var(--bg-tertiary); --bg-sticky-alpha: var(--bg-secondary); --bg-modal-alpha: var(--bg-primary); --theme-background-image: none; --theme-background-opacity: 0; --grade-low-bg: #f8d7da; --grade-low-text: #721c24; --grade-medium-bg: #fff3cd; --grade-medium-text: #856404; --grade-high-bg: #d4edda; --grade-high-text: #155724; --attendance-holiday-bg: #e2e3e5; --attendance-holiday-text: #495057; --bg-notification: #4caf50; --text-notification: #ffffff; }
         body.theme-light button.absent.justified.selected { color: var(--text-primary); }
         body.theme-light .monthly-attendance-table td.status-F { background-color: var(--grade-low-bg); color: var(--grade-low-text); }
         body.theme-light .monthly-attendance-table td.status-FJ { background-color: var(--grade-medium-bg); color: var(--grade-medium-text); }
         body.theme-light .monthly-attendance-table td.status-P { background-color: var(--grade-high-bg); color: var(--grade-high-text); }
         body.theme-light .monthly-attendance-table td.status-H { background-color: var(--attendance-holiday-bg); color: var(--attendance-holiday-text); font-style: italic; }
         body.theme-light .seat-placeholder-text { color: var(--map-seat-text); }
         body.theme-light .calculator-buttons button.op { background-color: #6c757d; color: #fff; }
         body.theme-light .calculator-buttons button.util { background-color: #adb5bd; color: var(--text-primary); }
         body.theme-light .calculator-buttons button.danger { background-color: #dc3545; color: #fff; }
         body.theme-light .calculator-buttons button.warn { background-color: #ffc107; color: var(--text-primary); }
         body.theme-light .calculator-buttons button.eq { background-color: #28a745; color: #fff; }
         body.theme-light .calculator-modal .pairs-list { background-color: var(--bg-tertiary-alpha); }
         body.theme-light .calculator-modal .pair-item { background-color: var(--bg-secondary-alpha); }
         body.theme-light .observation-item.category-ocorrencia { background-color: var(--obs-cat-ocorrencia-bg); }
         body.theme-light .observation-item.category-advertencia { background-color: var(--obs-cat-advertencia-bg); }
         body.theme-light .observation-item.category-suspensao { background-color: var(--obs-cat-suspensao-bg); color: var(--obs-cat-suspensao-text); }
         body.theme-light .observation-item.category-suspensao .observation-date, body.theme-light .observation-item.category-suspensao .observation-category { color: var(--obs-cat-suspensao-text); opacity: 0.8; }
         body.theme-light td.attendance-status.status-S { background-image: var(--attendance-suspended-bg); color: var(--attendance-suspended-text); font-weight: bold; }


        body.theme-dark { --bg-primary: #212529; --bg-secondary: #343a40; --bg-tertiary: #495057; --bg-secondary-alpha: var(--bg-secondary); --bg-tertiary-alpha: var(--bg-tertiary); --bg-sticky-alpha: var(--bg-secondary); --bg-modal-alpha: #2c3034; --text-primary: #f8f9fa; --text-secondary: #adb5bd; --accent-primary: #3b82f6; --accent-secondary: #6b7280; --accent-success: #22c55e; --accent-danger: #ef4444; --accent-warning: #f59e0b; --border-color: #4b5563; --shadow-color: rgba(255, 255, 255, 0.08); --input-bg: #374151; --input-border: #4b5563; --theme-background-image: none; --theme-background-opacity: 0; --grade-low-bg: color-mix(in srgb, var(--accent-danger) 25%, transparent); --grade-low-text: #f8f9fa; --grade-medium-bg: color-mix(in srgb, var(--accent-warning) 30%, transparent); --grade-medium-text: #111827; --grade-high-bg: color-mix(in srgb, var(--accent-success) 25%, transparent); --grade-high-text: #f8f9fa; --attendance-holiday-bg: #495057; --attendance-holiday-text: #ced4da; --attendance-suspended-bg: repeating-linear-gradient(45deg, var(--bg-tertiary), var(--bg-tertiary) 5px, var(--accent-danger) 5px, var(--accent-danger) 7px); --attendance-suspended-text: var(--text-primary); --bg-notification: #22c55e; --text-notification: #111827; --map-seat-bg: var(--input-bg); --map-seat-border: var(--input-border); --map-seat-text: var(--text-secondary); --map-seat-occupied-bg: color-mix(in srgb, var(--accent-primary) 20%, transparent); --map-seat-occupied-text: var(--text-primary); --map-teacher-desk-bg: var(--bg-tertiary); --map-teacher-desk-border: var(--accent-secondary); --map-drag-over-bg: color-mix(in srgb, var(--accent-success) 35%, transparent); --map-seat-selected-border: var(--accent-warning); --calc-button-bg: var(--accent-primary); --calc-button-text: #ffffff; --calc-op-button-bg: color-mix(in srgb, var(--accent-primary) 70%, #000000); --calc-util-button-bg: var(--accent-secondary); --calc-danger-button-bg: var(--accent-danger); --calc-warn-button-bg: var(--accent-warning); --calc-mode-button-bg: var(--bg-tertiary); --calc-mode-button-text: var(--text-secondary); --calc-mode-button-active-bg: var(--accent-primary); --calc-mode-button-active-text: #ffffff; --obs-cat-anotacao-bg: transparent; --obs-cat-anotacao-text: var(--text-secondary); --obs-cat-observacao-bg: color-mix(in srgb, var(--accent-primary) 15%, transparent); --obs-cat-observacao-text: var(--text-primary); --obs-cat-ocorrencia-bg: color-mix(in srgb, var(--accent-warning) 25%, transparent); --obs-cat-ocorrencia-text: var(--text-primary); --obs-cat-advertencia-bg: color-mix(in srgb, var(--accent-danger) 20%, transparent); --obs-cat-advertencia-text: var(--text-primary); --obs-cat-suspensao-bg: var(--accent-danger); --obs-cat-suspensao-text: #ffffff; }
         body.theme-dark button.warning { color: #111827; }
         body.theme-dark button.absent.justified.selected { color: #111827; }
         body.theme-dark .monthly-attendance-table td.status-F { background-color: var(--grade-low-bg); color: var(--grade-low-text); }
         body.theme-dark .monthly-attendance-table td.status-FJ { background-color: var(--grade-medium-bg); color: var(--grade-medium-text); }
         body.theme-dark .monthly-attendance-table td.status-P { background-color: var(--grade-high-bg); color: var(--grade-high-text); }
         body.theme-dark .monthly-attendance-table td.status-H { background-color: var(--attendance-holiday-bg); color: var(--attendance-holiday-text); font-style: italic; }
         body.theme-dark .seat-placeholder-text { color: var(--map-seat-text); }
         body.theme-dark .calculator-buttons button.warn { color: var(--text-primary); }
         body.theme-dark .calculator-modal .pairs-list { background-color: var(--bg-tertiary-alpha); }
         body.theme-dark .calculator-modal .pair-item { background-color: var(--bg-secondary-alpha); border-color: var(--input-border); }
         body.theme-dark .observation-item.category-ocorrencia { background-color: var(--obs-cat-ocorrencia-bg); color: var(--obs-cat-ocorrencia-text); }
         body.theme-dark .observation-item.category-advertencia { background-color: var(--obs-cat-advertencia-bg); color: var(--obs-cat-advertencia-text);}
         body.theme-dark .observation-item.category-suspensao { background-color: var(--obs-cat-suspensao-bg); color: var(--obs-cat-suspensao-text); }
         body.theme-dark td.attendance-status.status-S { background-image: var(--attendance-suspended-bg); color: var(--attendance-suspended-text); font-weight: bold;}

        /* Restante dos temas... (colocar aqui as adaptações de cores para --obs-cat-* e --attendance-suspended-* se necessário) */
        body.theme-forest-green { --bg-primary: #f0fff4; --bg-secondary: #dff1e5; --bg-tertiary: #c8e6d1; --bg-secondary-alpha: var(--bg-secondary); --bg-tertiary-alpha: var(--bg-tertiary); --bg-sticky-alpha: var(--bg-secondary); --bg-modal-alpha: #e8f5e9; --text-primary: #1e3a1f; --text-secondary: #4a7c59; --accent-primary: #588157; --accent-secondary: #3a5a40; --accent-warning: #e9c46a; --border-color: #a3c9a8; --shadow-color: rgba(58, 90, 64, 0.15); --input-bg: #ffffff; --input-border: #a3c9a8; --theme-background-image: none; --theme-background-opacity: 0; --grade-low-bg: #f1dede; --grade-low-text: #a94442; --grade-medium-bg: #faf2cc; --grade-medium-text: #8a6d3b; --grade-high-bg: #dff1e5; --grade-high-text: #3c763d; --attendance-holiday-bg: #d1e7dd; --attendance-holiday-text: #4a7c59; --attendance-suspended-bg: repeating-linear-gradient(45deg, var(--bg-tertiary-alpha), var(--bg-tertiary-alpha) 5px, #c1666b 5px, #c1666b 7px); --attendance-suspended-text: #000; --bg-notification: #588157; --text-notification: #ffffff; --map-seat-bg: var(--input-bg); --map-seat-border: var(--input-border); --map-seat-text: var(--text-secondary); --map-seat-occupied-bg: color-mix(in srgb, var(--accent-primary) 15%, transparent); --map-seat-occupied-text: var(--text-primary); --map-teacher-desk-bg: var(--bg-tertiary); --map-teacher-desk-border: var(--accent-secondary); --map-drag-over-bg: color-mix(in srgb, var(--accent-success) 30%, transparent); --map-seat-selected-border: var(--accent-warning); --calc-button-bg: var(--accent-primary); --calc-button-text: #ffffff; --calc-op-button-bg: color-mix(in srgb, var(--accent-primary) 85%, #ffffff); --calc-util-button-bg: var(--accent-secondary); --calc-danger-button-bg: #c1666b; --calc-warn-button-bg: var(--accent-warning); --calc-mode-button-bg: var(--bg-tertiary); --calc-mode-button-text: var(--text-secondary); --calc-mode-button-active-bg: var(--accent-primary); --calc-mode-button-active-text: #ffffff; --obs-cat-observacao-bg: color-mix(in srgb, var(--accent-primary) 15%, transparent); --obs-cat-ocorrencia-bg: color-mix(in srgb, var(--accent-warning) 25%, transparent); --obs-cat-advertencia-bg: color-mix(in srgb, var(--accent-danger) 20%, transparent); --obs-cat-suspensao-bg: var(--accent-danger); --obs-cat-suspensao-text: #ffffff; }
         body.theme-forest-green button.warning { color: var(--text-primary); }
         body.theme-forest-green button.absent.justified.selected { color: var(--text-primary); }
         body.theme-forest-green .monthly-attendance-table td.status-F { background-color: var(--grade-low-bg); color: var(--grade-low-text); }
         body.theme-forest-green .monthly-attendance-table td.status-FJ { background-color: var(--grade-medium-bg); color: var(--grade-medium-text); }
         body.theme-forest-green .monthly-attendance-table td.status-P { background-color: var(--grade-high-bg); color: var(--grade-high-text); }
         body.theme-forest-green .monthly-attendance-table td.status-H { background-color: var(--attendance-holiday-bg); color: var(--attendance-holiday-text); font-style: italic; }
         body.theme-forest-green .seat-placeholder-text { color: var(--map-seat-text); }
         body.theme-forest-green .calculator-buttons button.warn { color: var(--text-primary); }
         body.theme-forest-green .calculator-modal .pairs-list { background-color: var(--bg-tertiary-alpha); }
         body.theme-forest-green .calculator-modal .pair-item { background-color: var(--bg-secondary-alpha); border-color: var(--input-border); }
         body.theme-forest-green .observation-item.category-ocorrencia { background-color: var(--obs-cat-ocorrencia-bg); }
         body.theme-forest-green .observation-item.category-advertencia { background-color: var(--obs-cat-advertencia-bg); }
         body.theme-forest-green .observation-item.category-suspensao { background-color: var(--obs-cat-suspensao-bg); color: var(--obs-cat-suspensao-text); }
         body.theme-forest-green .observation-item.category-suspensao .observation-date, body.theme-forest-green .observation-item.category-suspensao .observation-category { color: var(--obs-cat-suspensao-text); opacity: 0.8; }
         body.theme-forest-green td.attendance-status.status-S { background-image: var(--attendance-suspended-bg); color: var(--attendance-suspended-text); font-weight: bold; }

        body.theme-math-master { --bg-primary: #e0f7ff; --bg-secondary: #ccecf7; --bg-tertiary: #b8e5f0; --bg-secondary-alpha: rgba(204, 236, 247, 0.96); --bg-tertiary-alpha: rgba(184, 229, 240, 0.94); --bg-sticky-alpha: rgba(204, 236, 247, 0.98); --bg-modal-alpha: #e0f7ff; --text-primary: #00405a; --text-secondary: #40788c; --accent-primary: #006688; --accent-secondary: #5a9cb0; --accent-warning: #fca311; --border-color: #a8d8e6; --input-bg: #ffffff; --input-border: #8fc5d6; --theme-background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 160 160'%3E%3Cstyle%3E text %7B fill: %23006688; opacity: 0.06; font-weight: 500; font-family: 'Cambria Math', 'Latin Modern Math', serif; %7D path, line %7B stroke: %23006688; opacity: 0.05; stroke-width: 1px; fill: none; %7D %3C/style%3E%3Ctext x='15' y='40' font-size='18' transform='rotate(-12 15,40)'%3Eƒ(x)%3C/text%3E%3Ctext x='100' y='30' font-size='22'%3E∑%3C/text%3E%3Cpath d='M 70 60 q 20 25 40 0 t 40 0' stroke-dasharray='3 3'/%3E%3Ctext x='30' y='110' font-size='20'%3E∫%3C/text%3E%3Cpath d='M 110 80 c -15 15 -15 40 0 55' /%3E%3Ctext x='130' y='145' font-size='16'%3E2πr%3C/text%3E%3Ctext x='60' y='135' font-size='24'%3E±%3C/text%3E%3Cline x1='10' y1='140' x2='40' y2='150'/%3E%3C/svg%3E"); --theme-background-opacity: 1; --theme-background-blend-mode: overlay; --theme-background-filter: grayscale(10%); --grade-low-bg: #f8d7da; --grade-low-text: #721c24; --grade-medium-bg: #fff3cd; --grade-medium-text: #856404; --grade-high-bg: #d4edda; --grade-high-text: #155724; --attendance-holiday-bg: #b8e5f0; --attendance-holiday-text: #00405a; --attendance-suspended-bg: repeating-linear-gradient(45deg, var(--bg-tertiary-alpha), var(--bg-tertiary-alpha) 5px, var(--accent-danger) 5px, var(--accent-danger) 7px); --attendance-suspended-text: #000; --bg-notification: #006688; --text-notification: #ffffff; --map-seat-bg: var(--input-bg); --map-seat-border: var(--input-border); --map-seat-text: var(--text-secondary); --map-seat-occupied-bg: color-mix(in srgb, var(--accent-primary) 15%, transparent); --map-seat-occupied-text: var(--text-primary); --map-teacher-desk-bg: var(--bg-tertiary); --map-teacher-desk-border: var(--accent-secondary); --map-drag-over-bg: color-mix(in srgb, var(--accent-success) 30%, transparent); --map-seat-selected-border: var(--accent-warning); --calc-button-bg: #0077a0; --calc-button-text: #ffffff; --calc-op-button-bg: #005577; --calc-util-button-bg: var(--accent-secondary); --calc-danger-button-bg: #d9534f; --calc-warn-button-bg: var(--accent-warning); --calc-mode-button-bg: var(--bg-tertiary); --calc-mode-button-text: var(--text-secondary); --calc-mode-button-active-bg: var(--accent-primary); --calc-mode-button-active-text: #ffffff; --obs-cat-observacao-bg: color-mix(in srgb, var(--accent-primary) 15%, transparent); --obs-cat-ocorrencia-bg: color-mix(in srgb, var(--accent-warning) 25%, transparent); --obs-cat-advertencia-bg: color-mix(in srgb, var(--accent-danger) 20%, transparent); --obs-cat-suspensao-bg: var(--accent-danger); --obs-cat-suspensao-text: #ffffff; }
         body.theme-math-master button.warning { color: var(--text-primary); }
         body.theme-math-master button.absent.justified.selected { color: #fff; }
         body.theme-math-master .monthly-attendance-table td.status-F { background-color: var(--grade-low-bg); color: var(--grade-low-text); }
         body.theme-math-master .monthly-attendance-table td.status-FJ { background-color: var(--grade-medium-bg); color: var(--grade-medium-text); }
         body.theme-math-master .monthly-attendance-table td.status-P { background-color: var(--grade-high-bg); color: var(--grade-high-text); }
         body.theme-math-master .monthly-attendance-table td.status-H { background-color: var(--attendance-holiday-bg); color: var(--attendance-holiday-text); font-style: italic; }
         body.theme-math-master .seat-placeholder-text { color: var(--map-seat-text); }
         body.theme-math-master .calculator-buttons button.warn { color: var(--text-primary); }
         body.theme-math-master .calculator-modal .pairs-list { background-color: var(--bg-tertiary-alpha); }
         body.theme-math-master .calculator-modal .pair-item { background-color: var(--bg-secondary-alpha); border-color: var(--input-border); }
         body.theme-math-master .observation-item.category-ocorrencia { background-color: var(--obs-cat-ocorrencia-bg); }
         body.theme-math-master .observation-item.category-advertencia { background-color: var(--obs-cat-advertencia-bg); }
         body.theme-math-master .observation-item.category-suspensao { background-color: var(--obs-cat-suspensao-bg); color: var(--obs-cat-suspensao-text); }
         body.theme-math-master .observation-item.category-suspensao .observation-date, body.theme-math-master .observation-item.category-suspensao .observation-category { color: var(--obs-cat-suspensao-text); opacity: 0.8; }
         body.theme-math-master td.attendance-status.status-S { background-image: var(--attendance-suspended-bg); color: var(--attendance-suspended-text); font-weight: bold; }

        body.theme-historic-scroll { --bg-primary: #fdf6e3; --bg-secondary: #f5efdc; --bg-tertiary: #ebe3cd; --bg-secondary-alpha: rgba(245, 239, 220, 0.97); --bg-tertiary-alpha: rgba(235, 227, 205, 0.96); --bg-sticky-alpha: rgba(245, 239, 220, 0.98); --bg-modal-alpha: #fdf6e3; --text-primary: #654b28; --text-secondary: #8c785e; --accent-primary: #8b4513; --accent-secondary: #a0522d; --accent-warning: #d4a373; --border-color: #d2b48c; --input-bg: #fffaf0; --input-border: #deb887; --theme-background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'%3E%3Cstyle%3E text %7B fill: %238b4513; opacity: 0.08; font-family: 'Segoe UI Symbol', sans-serif; %7D path %7B stroke: %238b4513; opacity: 0.07; stroke-width: 0.7px; fill: none; %7D %3C/style%3E%3Ctext x='20' y='45' font-size='30'%3E𓂀%3C/text%3E %3C!-- Eye of Horus --%3E%3Ctext x='120' y='35' font-size='26'%3E𓆗%3C/text%3E %3C!-- Cobra --%3E%3Cpath d='M 60 70 h 50 v 15 h -50 z' /%3E%3Ctext x='30' y='120' font-size='28'%3E𓅊%3C/text%3E %3C!-- Bird --%3E%3Cpath d='M 100 90 l 25 50 l -50 0 z' /%3E%3Ctext x='130' y='150' font-size='24'%3E𓍑%3C/text%3E%3C!-- Staff --%3E%3Ctext x='70' y='140' font-size='22'%3E🏺%3C/text%3E%3C/svg%3E"); --theme-background-opacity: 1; --theme-background-blend-mode: multiply; --theme-background-filter: sepia(25%); --grade-low-bg: #f1dede; --grade-low-text: #a94442; --grade-medium-bg: #faf2cc; --grade-medium-text: #8a6d3b; --grade-high-bg: #dff1e5; --grade-high-text: #3c763d; --attendance-holiday-bg: #ebe3cd; --attendance-holiday-text: #654b28; --attendance-suspended-bg: repeating-linear-gradient(45deg, var(--bg-tertiary-alpha), var(--bg-tertiary-alpha) 5px, #ae2012 5px, #ae2012 7px); --attendance-suspended-text: #000; --bg-notification: #8b4513; --text-notification: #fdf6e3; --map-seat-bg: var(--input-bg); --map-seat-border: var(--input-border); --map-seat-text: var(--text-secondary); --map-seat-occupied-bg: color-mix(in srgb, var(--accent-primary) 15%, transparent); --map-seat-occupied-text: var(--text-primary); --map-teacher-desk-bg: var(--bg-tertiary); --map-teacher-desk-border: var(--accent-secondary); --map-drag-over-bg: color-mix(in srgb, var(--accent-success) 30%, transparent); --map-seat-selected-border: var(--accent-warning); --calc-button-bg: var(--accent-primary); --calc-button-text: #fdf6e3; --calc-op-button-bg: var(--accent-secondary); --calc-util-button-bg: #b08968; --calc-danger-button-bg: #ae2012; --calc-warn-button-bg: var(--accent-warning); --calc-mode-button-bg: var(--bg-tertiary); --calc-mode-button-text: var(--text-secondary); --calc-mode-button-active-bg: var(--accent-primary); --calc-mode-button-active-text: #fdf6e3; --obs-cat-observacao-bg: color-mix(in srgb, var(--accent-primary) 15%, transparent); --obs-cat-ocorrencia-bg: color-mix(in srgb, var(--accent-warning) 25%, transparent); --obs-cat-advertencia-bg: color-mix(in srgb, var(--accent-danger) 20%, transparent); --obs-cat-suspensao-bg: var(--accent-danger); --obs-cat-suspensao-text: #ffffff; }
         body.theme-historic-scroll button.warning { color: var(--text-primary); }
         body.theme-historic-scroll button.absent.justified.selected { color: var(--text-primary); }
         body.theme-historic-scroll .monthly-attendance-table td.status-F { background-color: var(--grade-low-bg); color: var(--grade-low-text); }
         body.theme-historic-scroll .monthly-attendance-table td.status-FJ { background-color: var(--grade-medium-bg); color: var(--grade-medium-text); }
         body.theme-historic-scroll .monthly-attendance-table td.status-P { background-color: var(--grade-high-bg); color: var(--grade-high-text); }
         body.theme-historic-scroll .monthly-attendance-table td.status-H { background-color: var(--attendance-holiday-bg); color: var(--attendance-holiday-text); font-style: italic; }
         body.theme-historic-scroll .seat-placeholder-text { color: var(--map-seat-text); }
         body.theme-historic-scroll .calculator-buttons button.warn { color: var(--text-primary); }
         body.theme-historic-scroll .calculator-modal .pairs-list { background-color: var(--bg-tertiary-alpha); }
         body.theme-historic-scroll .calculator-modal .pair-item { background-color: var(--bg-secondary-alpha); border-color: var(--input-border); }
         body.theme-historic-scroll .observation-item.category-ocorrencia { background-color: var(--obs-cat-ocorrencia-bg); }
         body.theme-historic-scroll .observation-item.category-advertencia { background-color: var(--obs-cat-advertencia-bg); }
         body.theme-historic-scroll .observation-item.category-suspensao { background-color: var(--obs-cat-suspensao-bg); color: var(--obs-cat-suspensao-text); }
         body.theme-historic-scroll .observation-item.category-suspensao .observation-date, body.theme-historic-scroll .observation-item.category-suspensao .observation-category { color: var(--obs-cat-suspensao-text); opacity: 0.8; }
          body.theme-historic-scroll td.attendance-status.status-S { background-image: var(--attendance-suspended-bg); color: var(--attendance-suspended-text); font-weight: bold;}

        body.theme-alchemist { --bg-primary: #2a2a3e; --bg-secondary: #3a3a52; --bg-tertiary: #4a4a66; --bg-secondary-alpha: rgba(58, 58, 82, 0.97); --bg-tertiary-alpha: rgba(74, 74, 102, 0.95); --bg-sticky-alpha: rgba(58, 58, 82, 0.98); --bg-modal-alpha: #2a2a3e; --text-primary: #e0e0ff; --text-secondary: #a0a0cc; --accent-primary: #ffd700; --accent-secondary: #c0c0c0; --accent-success: #32cd32; --accent-danger: #dc143c; --accent-warning: #ff8c00; --border-color: #5a5a7a; --shadow-color: rgba(0, 0, 0, 0.25); --input-bg: #4a4a66; --input-border: #6a6a8a; --theme-background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150' viewBox='0 0 150 150'%3E%3Cstyle%3E text %7B fill: %23ffd700; opacity: 0.07; font-size: 24px; %7D path, circle %7B stroke: %23ffd700; opacity: 0.06; stroke-width: 0.8px; fill: none; %7D %3C/style%3E%3Ctext x='20' y='45'%3E☉%3C/text%3E%3Ccircle cx='95' cy='35' r='12'/%3E%3Cpath d='M 90 35 h 10 M 95 30 v 10'/%3E%3Ctext x='30' y='110' font-size='28'%3E△%3C/text%3E%3Cpath d='M 70 85 l 40 0 l -20 35 z' transform='rotate(180 90 102.5)'/%3E%3Ctext x='120' y='135' font-size='20'%3E♃%3C/text%3E%3Ctext x='65' y='70' font-size='28'%3E☾%3C/text%3E%3Ctext x='100' y='80' font-size='22'%3E⚕%3C/text%3E%3C/svg%3E"); --theme-background-opacity: 1; --theme-background-blend-mode: overlay; --grade-low-bg: color-mix(in srgb, var(--accent-danger) 25%, transparent); --grade-low-text: #f8f9fa; --grade-medium-bg: color-mix(in srgb, var(--accent-warning) 30%, transparent); --grade-medium-text: #1a1a2e; --grade-high-bg: color-mix(in srgb, var(--accent-success) 25%, transparent); --grade-high-text: #f8f9fa; --attendance-holiday-bg: #4a4a66; --attendance-holiday-text: #a0a0cc; --attendance-suspended-bg: repeating-linear-gradient(45deg, var(--bg-tertiary), var(--bg-tertiary) 5px, var(--accent-danger) 5px, var(--accent-danger) 7px); --attendance-suspended-text: var(--text-primary); --bg-notification: #ffd700; --text-notification: #2a2a3e; --map-seat-bg: var(--input-bg); --map-seat-border: var(--input-border); --map-seat-text: var(--text-secondary); --map-seat-occupied-bg: color-mix(in srgb, var(--accent-primary) 20%, transparent); --map-seat-occupied-text: var(--text-primary); --map-teacher-desk-bg: var(--bg-tertiary); --map-teacher-desk-border: var(--accent-secondary); --map-drag-over-bg: color-mix(in srgb, var(--accent-success) 35%, transparent); --map-seat-selected-border: var(--accent-warning); --calc-button-bg: #6a6a8a; --calc-button-text: #e0e0ff; --calc-op-button-bg: #5a5a7a; --calc-util-button-bg: var(--accent-secondary); --calc-danger-button-bg: var(--accent-danger); --calc-warn-button-bg: var(--accent-warning); --calc-mode-button-bg: var(--bg-tertiary); --calc-mode-button-text: var(--text-secondary); --calc-mode-button-active-bg: var(--accent-primary); --calc-mode-button-active-text: #2a2a3e; --obs-cat-observacao-bg: color-mix(in srgb, var(--accent-primary) 15%, transparent); --obs-cat-ocorrencia-bg: color-mix(in srgb, var(--accent-warning) 25%, transparent); --obs-cat-advertencia-bg: color-mix(in srgb, var(--accent-danger) 20%, transparent); --obs-cat-suspensao-bg: var(--accent-danger); --obs-cat-suspensao-text: #ffffff; }
         body.theme-alchemist button.warning { color: #1a1a2e; }
         body.theme-alchemist button.absent.justified.selected { color: #1a1a2e; }
         body.theme-alchemist .monthly-attendance-table td.status-F { background-color: var(--grade-low-bg); color: var(--grade-low-text); }
         body.theme-alchemist .monthly-attendance-table td.status-FJ { background-color: var(--grade-medium-bg); color: var(--grade-medium-text); }
         body.theme-alchemist .monthly-attendance-table td.status-P { background-color: var(--grade-high-bg); color: var(--grade-high-text); }
         body.theme-alchemist .monthly-attendance-table td.status-H { background-color: var(--attendance-holiday-bg); color: var(--attendance-holiday-text); font-style: italic; }
         body.theme-alchemist .seat-placeholder-text { color: var(--map-seat-text); }
         body.theme-alchemist .calculator-buttons button.warn { color: var(--text-primary); }
         body.theme-alchemist .calculator-modal .pairs-list { background-color: var(--bg-tertiary-alpha); }
         body.theme-alchemist .calculator-modal .pair-item { background-color: var(--bg-secondary-alpha); border-color: var(--input-border); }
         body.theme-alchemist .observation-item.category-ocorrencia { background-color: var(--obs-cat-ocorrencia-bg); color: var(--obs-cat-ocorrencia-text); }
         body.theme-alchemist .observation-item.category-advertencia { background-color: var(--obs-cat-advertencia-bg); color: var(--obs-cat-advertencia-text);}
         body.theme-alchemist .observation-item.category-suspensao { background-color: var(--obs-cat-suspensao-bg); color: var(--obs-cat-suspensao-text); }
         body.theme-alchemist .observation-item.category-suspensao .observation-date, body.theme-alchemist .observation-item.category-suspensao .observation-category { color: var(--obs-cat-suspensao-text); opacity: 0.8; }
         body.theme-alchemist td.attendance-status.status-S { background-image: var(--attendance-suspended-bg); color: var(--attendance-suspended-text); font-weight: bold;}
        /* --- FIM TEMAS --- */

        /* Estilos Gerais, Layout Principal, Seções, Cards, Listas, Modal, Tabelas */
        body { background-color: var(--bg-primary); color: var(--text-primary); }
        h1, h2, h3, h4, h5, h6 { color: var(--text-primary); margin-bottom: 0.75rem; font-weight: 600; }
        h2 { text-align: center; width: 100%; margin-top: 0.5rem; margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5em; }
        p { color: var(--text-secondary); line-height: 1.6; margin-bottom: 1rem; }
        a { color: var(--accent-primary); text-decoration: none; transition: color 0.2s ease; }
        a:hover { color: var(--accent-secondary); text-decoration: underline; }
        button, .button-like, .list-item, .tool-card, .nav-button { /* Efeitos de Clique */
            transition: background-color 0.2s ease, transform 0.15s cubic-bezier(0.2, 0, 0.38, 0.9), opacity 0.2s ease, box-shadow 0.2s ease;
            user-select: none; /* Prevent text selection */
            -webkit-tap-highlight-color: rgba(0,0,0,0.05); /* Feedback sutil no mobile */
        }
        button:active, .button-like:active, .list-item:active, .tool-card:active, .nav-button:active {
            transform: scale(0.97); /* Leve encolhimento */
            filter: brightness(0.95); /* Leve escurecimento */
            /* box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); */ /* Sombra interna opcional */
        }
        button, .button-like { padding: 0.6rem 1.2rem; border: none; border-radius: 5px; cursor: pointer; font-size: 0.95rem; font-weight: 500; background-color: var(--accent-primary); color: #fff; margin: 0.25rem; display: inline-flex; align-items: center; justify-content: center; text-align: center; vertical-align: middle; line-height: 1.4; }
        button:hover, .button-like:hover { opacity: 0.85; }
        /* :active já definido acima */
        button:disabled, .button-like:disabled { opacity: 0.6; cursor: not-allowed; background-color: var(--accent-secondary); transform: none; filter: none; }
        form button:not([type="submit"]) { type: button; }
        button.secondary, .button-like.secondary { background-color: var(--accent-secondary); color: #fff; }
        button.danger, .button-like.danger { background-color: var(--accent-danger); color: #fff; }
        button.success, .button-like.success { background-color: var(--accent-success); color: #fff; }
        button.warning, .button-like.warning { background-color: var(--accent-warning); color: var(--text-primary); }
        button.icon-button, .button-like.icon-button { padding: 0.4rem; font-size: 1.1rem; line-height: 1; background-color: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 5px; margin: 0 2px; }
        button.icon-button:hover, .button-like.icon-button:hover { color: var(--accent-primary); background-color: var(--bg-tertiary-alpha); border-color: var(--accent-primary); }
        button.icon-button:disabled { background-color: transparent; border-color: var(--border-color); color: var(--text-secondary); opacity: 0.5; }
        input[type="text"], input[type="time"], input[type="number"], input[type="date"], select, textarea, input[type="search"], input[type="color"] { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid var(--input-border); border-radius: 5px; background-color: var(--input-bg); color: var(--text-primary); font-size: 1rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        input[type="color"] { padding: 0.2rem; height: 40px; width: 50px; vertical-align: middle; cursor: pointer;}
        input:focus, select:focus, textarea:focus, input[type="search"]:focus, input[type="color"]:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-primary) 20%, transparent); }
        input[type="checkbox"] { width: auto; margin-bottom: 0; margin-right: 5px; vertical-align: middle; }
        textarea { min-height: 100px; resize: vertical; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        label[for*="checkbox"], label[for*="radio"] { display: inline; font-weight: normal; margin-bottom: 0; }
        .form-group { margin-bottom: 1rem; }
        .form-group.inline-input { display: inline-block; width: auto; margin-right: 10px; } /* Para inputs lado a lado */
        .form-group.inline-input input, .form-group.inline-input select { width: auto; margin-bottom: 0; }
        .checkbox-group { margin-bottom: 0.5rem; padding: 5px 0; display: flex; align-items: center;}
        .app-header { background-color: var(--bg-secondary-alpha); padding: 0.6rem 1rem; border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 4px var(--shadow-color); position: sticky; top: 0; z-index: 1000; flex-shrink: 0; transition: background-color 0.4s ease; display: flex; flex-direction: column; gap: 0.5rem; }
        .header-top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 0.8rem; min-height: 2em; }
        .app-header h1 { margin: 0; font-size: 1.3rem; color: var(--accent-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; min-width: 0; flex-basis: auto; }
        .header-info { font-size: 0.8rem; color: var(--text-secondary); text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; min-width: 0; margin-left: auto; padding-left: 10px; }
        #search-input { width: 100%; margin: 0; padding: 0.4rem 0.8rem; font-size: 0.9rem; margin-bottom: 0; }
        .app-content { flex-grow: 1; overflow-y: auto; padding: 1rem; background-color: transparent; -webkit-overflow-scrolling: touch; padding-bottom: calc(var(--nav-height) + 10px); }
        .app-nav { background-color: var(--bg-secondary-alpha); padding: 0.4rem 0; display: flex; justify-content: space-around; align-items: stretch; border-top: 1px solid var(--border-color); position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; flex-shrink: 0; height: var(--nav-height); box-shadow: 0 -2px 5px var(--shadow-color); transition: background-color 0.4s ease; }
        /* Ajuste para 7 botões */
        .nav-button { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.7rem; /* Reduzido */ text-align: center; padding: 0.4rem 0.2rem; /* Reduzido padding horizontal */ display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; height: 100%; border-radius: 0; overflow: hidden; } /* transition movida para grupo :active */
        .nav-button .icon { font-size: 1.3rem; /* Levemente reduzido */ margin-bottom: 0.1rem; }
        .nav-button span:not(.icon) { white-space: nowrap; /* Garante que fique em uma linha */ }
        .nav-button.active { color: var(--accent-primary); background-color: var(--bg-tertiary-alpha); }
        .nav-button:hover:not(.active) { background-color: var(--bg-tertiary-alpha); }
        .nav-button:disabled { opacity: 0.5; cursor: not-allowed; background-color: transparent !important; }
        .section { display: none; animation: fadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .card { background-color: var(--bg-secondary-alpha); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 5px var(--shadow-color); transition: box-shadow 0.3s ease, background-color 0.4s ease, padding-bottom 0.3s ease; }
        .card:hover { box-shadow: 0 5px 12px color-mix(in srgb, var(--shadow-color) 150%, black); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 5px; }
        .card-header h3 { margin: 0; font-size: 1.1rem; flex-basis: calc(100% - 50px); margin-bottom: 5px; display: flex; align-items: center; gap: 0.5em; margin-top: 0.1rem; }
        .card-header .options { display: flex; align-items: center; flex-wrap: wrap; gap: 5px; margin-left: auto; flex-shrink: 0; }
        .card-actions button, .card-actions .button-like { margin-left: 0.3rem; padding: 0.3rem 0.6rem; font-size: 0.85rem; }
        .card-content { padding-top: 0.5rem; transition: opacity 0.3s ease, max-height 0.4s ease-out; max-height: 1500px; overflow: hidden; opacity: 1; }
        .card-toggle-button { padding: 0.3rem !important; font-size: 0.9rem !important; line-height: 1; background: transparent !important; border: none !important; color: var(--text-secondary); cursor: pointer; margin-left: auto; order: 99; margin-top: 0.1rem; }
        .card-toggle-button:hover { color: var(--accent-primary); }
        .card.collapsed { padding-bottom: 0.5rem; }
        .card.collapsed .card-content { max-height: 0; opacity: 0; padding-top: 0; margin-top: -1px; border-top: none; visibility: hidden; }
        .card.collapsed .card-header { border-bottom: none; margin-bottom: 0; }
        .item-list { list-style: none; padding: 0; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background-color: var(--bg-secondary-alpha); border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 0.5rem; cursor: pointer; } /* transition movida para grupo :active */
        .list-item:hover { background-color: var(--bg-tertiary-alpha); }
        .list-item span, .list-item .item-info { flex-grow: 1; margin-right: 1rem; overflow: hidden; text-overflow: ellipsis; }
        .list-item .item-info p { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item .item-info h4 { margin-bottom: 0.2rem; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item-actions { flex-shrink: 0; display: flex; gap: 3px; }
        .list-item-actions button, .list-item-actions .button-like { margin-left: 0; padding: 0.3rem; font-size: 1rem; }
        .search-result-item .item-info { margin-right: 0.5rem; }
        .search-result-item .result-type { font-size: 0.75rem; color: var(--text-secondary); background-color: var(--bg-tertiary); padding: 0.1rem 0.4rem; border-radius: 3px; margin-left: auto; flex-shrink: 0; }
        .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; animation: modalFadeIn 0.3s ease-out; }
        .modal.show { display: flex; }
        .modal-content { background-color: var(--bg-modal-alpha); margin: auto; padding: 15px; border: 1px solid var(--border-color); border-radius: 10px; width: 95%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 25px var(--shadow-color); animation: modalSlideIn 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94); transition: background-color 0.4s ease; }
         .monthly-attendance-modal .modal-content,
         .student-report-card-modal .modal-content { max-width: 95%; width: auto; } /* Modal maior para frequência e boletim */
         /* Specific modal styles */
        .name-sorter-modal .modal-content { max-width: 450px; }
        .name-sorter-modal #sorter-result-display { min-height: 60px; background-color: var(--bg-tertiary); border: 1px dashed var(--border-color); border-radius: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem; margin-bottom: 1rem; font-size: 1.4rem; font-weight: bold; text-align: center; word-break: break-word; }
        .name-sorter-modal .sorter-controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; margin-bottom: 1rem;}
        .name-sorter-modal .sorter-info { font-size: 0.8rem; color: var(--text-secondary); }
        .timer-modal .modal-content { max-width: 400px; }
        .timer-modal #timer-display { font-size: 3rem; font-weight: bold; text-align: center; margin-bottom: 1.5rem; background-color: var(--bg-tertiary); padding: 1rem; border-radius: 5px; font-family: monospace; }
        .timer-modal .timer-controls { display: flex; justify-content: space-around; gap: 10px; }
        .timer-modal .timer-controls button { flex-grow: 1; }
        /* Group Generator Modal */
        .group-generator-modal .modal-content { max-width: 90%; width: auto; }
        .group-generator-modal .group-options { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);}
        .group-generator-modal .group-options .radio-group { display: flex; align-items: center; gap: 5px; margin-bottom: 0; }
        .group-generator-modal .group-options input[type="radio"] { width: auto; margin: 0; }
        .group-generator-modal .group-options label { margin-bottom: 0; }
        .group-generator-modal .group-options input[type="number"] { width: 70px; margin-bottom: 0; padding: 0.4rem; font-size: 0.9rem; }
        .group-generator-modal #group-results-container { margin-top: 1rem; max-height: 50vh; overflow-y: auto; padding-right: 5px;}
        .group-generator-modal .generated-group { margin-bottom: 1rem; padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--bg-tertiary-alpha); }
        .group-generator-modal .generated-group h5 { margin-bottom: 0.5rem; font-size: 1rem; color: var(--accent-primary); }
        .group-generator-modal .generated-group ul { list-style: none; padding-left: 0; }
        .group-generator-modal .generated-group li { font-size: 0.9rem; margin-bottom: 0.3rem; display: flex; align-items: baseline; }
        .group-generator-modal .generated-group li .student-number { font-weight: bold; margin-right: 6px; min-width: 20px; text-align: right; font-size: 0.8em; color: var(--text-secondary); }
        /* Advanced Calculator Modal */
        .calculator-modal .modal-content { max-width: 380px; padding: 10px; }
        .calculator-mode-selector { display: flex; gap: 5px; margin-bottom: 10px; }
        .calculator-mode-selector button { flex: 1; font-size: 0.85rem; padding: 0.4rem 0.6rem; background-color: var(--calc-mode-button-bg); color: var(--calc-mode-button-text); border: 1px solid var(--border-color); }
        .calculator-mode-selector button.active { background-color: var(--calc-mode-button-active-bg); color: var(--calc-mode-button-active-text); border-color: var(--calc-mode-button-active-bg); }
        .calculator-display { width: 100%; background-color: var(--calc-display-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px 15px; font-size: 2rem; text-align: right; margin-bottom: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-height: 60px; display: flex; align-items: center; justify-content: flex-end; }
        .calculator-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 10px; }
        .calculator-buttons button { padding: 0.8rem; font-size: 1.1rem; margin: 0; border: 1px solid transparent; background-color: var(--calc-button-bg); color: var(--calc-button-text); } /* transition movida para grupo :active */
        .calculator-buttons button:hover { opacity: var(--calc-button-hover-opacity); }
        /* :active já definido acima */
        .calculator-buttons button.num { background-color: var(--calc-button-bg); color: var(--calc-button-text); }
        .calculator-buttons button.op { background-color: var(--calc-op-button-bg); }
        .calculator-buttons button.util { background-color: var(--calc-util-button-bg); }
        .calculator-buttons button.danger { background-color: var(--calc-danger-button-bg); }
        .calculator-buttons button.warn { background-color: var(--calc-warn-button-bg); }
        .calculator-buttons button.eq { background-color: var(--accent-success); }
        .calculator-buttons button.zero { grid-column: span 2; }
        .calculator-buttons button.disabled { opacity: 0.5; cursor: not-allowed; background-color: var(--accent-secondary) !important; }
        .weighted-average-section { padding-top: 10px; border-top: 1px solid var(--border-color); }
        .weighted-average-section h5 { font-size: 1rem; margin-bottom: 0.8rem; text-align: center; color: var(--text-secondary); }
        .grade-weight-input-group { display: flex; gap: 8px; margin-bottom: 0.8rem; }
        .grade-weight-input-group input[type="number"] { margin-bottom: 0; padding: 0.5rem; font-size: 0.9rem; text-align: center; width: 40%; }
        .grade-weight-input-group button { padding: 0.5rem 0.8rem; font-size: 0.9rem; width: auto; flex-shrink: 0; margin: 0; }
        .pairs-list { list-style: none; padding: 8px; margin-bottom: 0.8rem; max-height: 150px; overflow-y: auto; background-color: var(--bg-tertiary-alpha); border: 1px dashed var(--border-color); border-radius: 5px; }
        .pairs-list p { font-size: 0.8rem; color: var(--text-secondary); text-align: center; margin: 1rem 0; }
        .pair-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-secondary-alpha); padding: 5px 8px; border-radius: 4px; margin-bottom: 5px; font-size: 0.9rem; border: 1px solid var(--border-color); }
        .pair-item span { flex-grow: 1; }
        .pair-item button { padding: 0.1rem 0.4rem; font-size: 0.8rem; line-height: 1; margin-left: 8px; }
        .weighted-average-result { margin-top: 0.5rem; font-weight: bold; text-align: center; background-color: var(--bg-tertiary); padding: 8px; border-radius: 5px; min-height: 30px; }
        .weighted-average-section button.calculate { width: 100%; }

        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; flex-shrink: 0; }
        .modal-header h2 { margin: 0; font-size: 1.2rem; text-align: left; justify-content: flex-start; gap: 0; }
        .close-button { background: none; border: none; font-size: 1.8rem; font-weight: bold; color: var(--text-secondary); cursor: pointer; padding: 0 0.5rem; line-height: 1; }
        .close-button:hover { color: var(--text-primary); }
        .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 5px; padding-bottom: 5px; /* Remove explicit padding if calc modal needs full space */ }
         .calculator-modal .modal-body { padding: 0 5px 5px 5px; } /* Adjust calculator padding */
        .modal-body form { margin-bottom: 0; }
        .modal-body textarea { min-height: 150px; }
        .modal-footer { border-top: 1px solid var(--border-color); padding-top: 10px; margin-top: 15px; text-align: right; flex-shrink: 0; display: flex; justify-content: flex-end; gap: 5px; }
        .modal-footer button { margin-left: 0; }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalSlideIn { from { transform: translateY(-25px) scale(0.98); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .justification-modal .modal-body textarea { min-height: 250px; }
        .text-sm { font-size: 0.8rem; }

        /* Tabela de Dados */
        .table-scroll-wrapper { width: 100%; overflow-x: auto; margin-top: 0.5rem; -webkit-overflow-scrolling: touch; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--bg-primary); }
        .data-table { width: 100%; min-width: 280px; border-collapse: collapse; font-size: 0.85rem; table-layout: fixed; word-wrap: break-word; border: none; }
        .data-table th, .data-table td { border: 1px solid var(--border-color); padding: 0.5rem 0.4rem; text-align: left; vertical-align: middle; white-space: nowrap; }
        .data-table th { background-color: var(--bg-tertiary); font-weight: 600; position: sticky; top: 0; z-index: 2; font-size: 0.8rem; }
        .data-table th:first-child, .data-table td:first-child { position: sticky; left: 0; z-index: 1; background-color: var(--bg-sticky-alpha); border-right: 1px solid var(--border-color); white-space: normal; }
        .data-table th:first-child { z-index: 3; }
        .data-table td input[type="number"], .data-table td select { padding: 0.3rem; margin-bottom: 0; font-size: 0.85rem; width: 55px; max-width: 100%; border-radius: 3px; text-align: center; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-primary); }
        .data-table td input.grade-input { transition: background-color 0.3s ease, color 0.3s ease; }
        .data-table td select { width: 80px; }
        .data-table td button { padding: 0.2rem 0.4rem; font-size: 0.75rem; margin: 0 1px; min-width: 30px; }
        .data-table td textarea { display: none; }

       /* --- ATTENDANCE TABLE --- */
        #attendance-table-container .data-table .attendance-status { width: 90px; text-align: center; vertical-align: middle; flex-shrink: 0; border-left: none; }
        #attendance-table-container .data-table .attendance-status.status-H { font-weight: bold; font-style: italic; color: var(--attendance-holiday-text); background-color: var(--attendance-holiday-bg); cursor: default; }
        #attendance-table-container .data-table .attendance-status.status-S { font-weight: bold; color: var(--attendance-suspended-text); background-image: var(--attendance-suspended-bg); cursor: help; } /* Estilo para suspenso */
        #attendance-table-container .data-table .student-col { width: auto; min-width: 160px; white-space: normal; word-break: break-word; display: flex; align-items: center; gap: 5px; padding-left: 0.6rem; border-right: none; }
        #attendance-table-container .data-table th.attendance-status { text-align: center; border-left: none;}
        #attendance-table-container .data-table th.student-col { text-align: left; padding-left: 0.6rem;}
        #attendance-table-container .data-table .student-col .student-number { flex-shrink: 0; min-width: 20px; text-align: right; font-weight: bold; font-size: 0.8rem; }
        #attendance-table-container .data-table .student-col .student-name { flex-grow: 1; white-space: normal; word-break: break-word; font-size: 0.85rem; }

        /* --- GRADES TABLE --- */
        #grades-table-container .data-table .grade-col { width: 55px; text-align: center; }
        #grades-table-container .data-table .sum-col { width: 60px; text-align: center; }
        #grades-table-container .data-table .avg-col { width: 60px; text-align: center; font-weight: bold; transition: background-color 0.3s ease, color 0.3s ease; }
        #grades-table-container .data-table .student-col { width: 120px; min-width: 100px; white-space: normal; word-break: break-word; border-right: 2px solid var(--border-color); }
        .data-table td.average.grade-low { background-color: var(--grade-low-bg); color: var(--grade-low-text); }
        .data-table td.average.grade-medium { background-color: var(--grade-medium-bg); color: var(--grade-medium-text); }
        .data-table td.average.grade-high { background-color: var(--grade-high-bg); color: var(--grade-high-text); }

        /* Attendance Buttons Styling */
        .attendance-toggle { padding: 0.3rem 0.45rem; margin: 0 1px; font-size: 0.8rem; font-weight: 600; opacity: 0.7; border: 2px solid transparent; min-width: 34px; transition: all 0.2s cubic-bezier(0.68, -0.55, 0.27, 1.55); display: inline-flex; align-items: center; justify-content: center; gap: 0.2em; line-height: 1; vertical-align: middle; }
        #attendance-table-container .data-table .attendance-status { text-align: center; white-space: nowrap; }
        .attendance-toggle .icon { margin-right: 0; font-size: 0.9em; }
        .attendance-toggle.selected { opacity: 1; border-width: 2px; border-style: solid; transform: scale(1.05); }
        .attendance-toggle.present.selected { background-color: var(--accent-success); border-color: var(--accent-success); color: #fff; }
        .attendance-toggle.absent.selected:not(.justified) { background-color: var(--accent-danger); border-color: var(--accent-danger); color: #fff; }
        .attendance-toggle.absent.justified.selected { background-color: var(--accent-warning); border-color: var(--accent-warning); }
        .attendance-toggle:disabled { opacity: 0.4 !important; cursor: not-allowed !important; background-color: transparent !important; border-color: transparent !important; transform: none !important; color: var(--text-secondary) !important; }

        /* --- Attendance Actions Container --- */
        .attendance-actions-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px; margin-top: 0.5rem; margin-bottom: 0.8rem; }
        .attendance-actions-container button { margin: 0; padding: 0.4rem 0.7rem; font-size: 0.8rem; flex-grow: 1; flex-basis: 0; max-width: 50%; white-space: nowrap; }
        .attendance-actions-container button .icon { margin-right: 0.3em; }

        /* --- Monthly Attendance --- */
        #monthly-attendance-controls { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 0.5rem; }
        #monthly-attendance-controls .date-selectors { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        #monthly-attendance-controls label { margin-bottom: 0; }
        #monthly-attendance-controls select { width: auto; padding: 0.4rem; font-size: 0.9rem; margin-bottom: 0; }
        #monthly-attendance-controls .export-buttons { display: flex; gap: 5px; }
        #monthly-attendance-table-wrapper { max-height: 60vh; overflow: auto; margin-top: 10px; }
        .monthly-attendance-table { width: 100%; min-width: 800px; border-collapse: collapse; font-size: 0.75rem; }
        .monthly-attendance-table th, .monthly-attendance-table td { border: 1px solid var(--border-color); padding: 0.3rem; text-align: center; min-width: 32px; white-space: nowrap; }
        .monthly-attendance-table th { background-color: var(--bg-tertiary); font-weight: 600; }
        .monthly-attendance-table th.student-col-monthly, .monthly-attendance-table td.student-col-monthly { min-width: 150px; text-align: left; position: sticky; left: 0; background-color: var(--bg-sticky-alpha); z-index: 1; white-space: normal; border-right: 2px solid var(--border-color); }
        .monthly-attendance-table th.student-col-monthly { z-index: 3; }
        .monthly-attendance-table th.freq-col-monthly, .monthly-attendance-table td.freq-col-monthly { min-width: 50px; font-weight: bold; position: sticky; right: 0; background-color: var(--bg-sticky-alpha); z-index: 1; border-left: 2px solid var(--border-color); }
         .monthly-attendance-table th.freq-col-monthly { z-index: 3; }
        .monthly-attendance-table td.weekend { background-color: var(--bg-tertiary-alpha); opacity: 0.7; cursor: not-allowed; }
        .monthly-attendance-table td.status-H { background-color: var(--attendance-holiday-bg); color: var(--attendance-holiday-text); font-style: italic; font-weight: bold; }
        #monthly-attendance-summary { margin-top: 1rem; text-align: center; font-weight: bold; }
        #monthly-attendance-chart-container { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); display: flex; flex-wrap: wrap; gap: 5px; align-items: flex-end; min-height: 100px; overflow-x: auto; padding-bottom: 10px; }
        .chart-bar-container { display: flex; flex-direction: column; align-items: center; flex: 0 0 auto; min-width: 40px; text-align: center; }
        .chart-bar { width: 25px; background-color: var(--accent-primary); border-radius: 3px 3px 0 0; transition: height 0.3s ease-out; position: relative; }
         .chart-bar::after { content: attr(data-percentage); position: absolute; top: -1.5em; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.7); color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.7rem; white-space: nowrap; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
         .chart-bar:hover::after { opacity: 1; }
        .chart-label { font-size: 0.7rem; margin-top: 3px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 50px; }

        /* --- Student Observations --- */
        #student-observations-list { max-height: 45vh; overflow-y: auto; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 5px; padding: 0.5rem; background-color: var(--bg-tertiary-alpha); }
        .observation-item { background-color: var(--bg-secondary-alpha); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.6rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .observation-item .observation-details { flex-grow: 1; }
        .observation-item .observation-category { font-size: 0.7rem; font-weight: bold; color: var(--text-secondary); margin-bottom: 0.25rem; display: inline-block; padding: 1px 5px; border-radius: 3px; text-transform: uppercase; margin-right: 5px; background-color: var(--obs-cat-anotacao-bg); color: var(--obs-cat-anotacao-text); }
        .observation-item.category-observacao .observation-category { background-color: var(--obs-cat-observacao-bg); color: var(--obs-cat-observacao-text); }
        .observation-item.category-ocorrencia .observation-category { background-color: var(--obs-cat-ocorrencia-bg); color: var(--obs-cat-ocorrencia-text); }
        .observation-item.category-advertencia .observation-category { background-color: var(--obs-cat-advertencia-bg); color: var(--obs-cat-advertencia-text); }
        .observation-item.category-suspensao .observation-category { background-color: var(--obs-cat-suspensao-bg); color: var(--obs-cat-suspensao-text); }
        .observation-item .observation-date { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.25rem; display: inline; } /* inline para ficar ao lado da categoria */
        .observation-item .observation-suspension-dates { font-size: 0.7rem; font-style: italic; color: var(--text-secondary); display: block; margin-top: 2px; }
        .observation-item.category-suspensao .observation-suspension-dates { color: inherit; } /* Herdar cor da suspensão */
        .observation-item .observation-text { font-size: 0.9rem; white-space: pre-wrap; word-break: break-word; margin-top: 4px; clear: both; } /* Clear float/inline */
        .observation-item .list-item-actions { flex-shrink: 0; } /* Container para botões */
        .observation-item .delete-observation-button,
        .observation-item .edit-observation-button { padding: 0.2rem 0.4rem !important; font-size: 0.8rem !important; margin-left: 3px !important; border: none; } /* Estilo comum para botões de obs */

         #add-observation-section { margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem; }
         #add-observation-section label { margin-bottom: 0.3rem; font-size: 0.9rem; }
         #add-observation-section select#new-observation-category { margin-bottom: 0.5rem; width: auto; display: inline-block; padding: 0.5rem; }
         #new-observation-text { min-height: 80px; margin-bottom: 0.5rem; font-size: 0.95rem; }
         #add-observation-button { width: 100%; }
         #suspension-dates-group { margin-left: 1rem; margin-bottom: 0.5rem; }
         #suspension-dates-group label { font-size: 0.8rem; margin-right: 5px;}
         #suspension-dates-group input[type="date"] { width: auto; padding: 0.3rem; font-size: 0.85rem; margin-bottom: 0; }

        /* --- Boletim Modal --- */
        .student-report-card-modal .modal-body { padding-top: 5px; }
        .report-card-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        .report-card-table th, .report-card-table td { border: 1px solid var(--border-color); padding: 0.5rem; text-align: left; }
        .report-card-table th { background-color: var(--bg-tertiary); font-weight: 600; }
        .report-card-table .subject-header td { background-color: var(--bg-tertiary-alpha); font-weight: bold; color: var(--accent-primary); padding-top: 0.8rem; border-top: 2px solid var(--border-color); } /* Cabeçalho da Matéria */
        .report-card-table td.grade-sum, .report-card-table td.grade-average { text-align: center; }
        .report-card-table td.grade-average { font-weight: bold; }

        /* --- Class List Reordering --- */
        .list-item-actions .reorder-button { padding: 0.2rem; font-size: 1.1rem; line-height: 1; background-color: transparent; border: none; color: var(--text-secondary); margin: 0 1px; }
        .list-item-actions .reorder-button:hover { color: var(--accent-primary); }
        .list-item-actions .reorder-button:disabled { opacity: 0.3; cursor: not-allowed; color: var(--text-secondary); }


        /* Ajustes específicos */
        #save-grades-button, #save-attendance-button, #save-lesson-plan-button, #save-monthly-attendance-button, #save-map-button { margin-top: 0.8rem !important; }
        .fab-button { position: fixed; bottom: calc(var(--nav-height) + var(--fab-bottom-margin)); right: 20px; width: 50px; height: 50px; border-radius: 50%; font-size: 1.8rem; line-height: 1; box-shadow: 0 4px 10px var(--shadow-color); z-index: 1010; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .fab-button:active { transform: scale(0.9); }
        #classes-section h2, #class-details-section h2 { color: var(--accent-primary); font-size: 1.3rem; margin-bottom: 1rem; display: flex; align-items: center; position: relative; text-align: center; justify-content: center; padding-left: 45px; padding-right: 45px; gap: 0.5em; }
        #classes-section h2 .back-button, #class-details-section h2 .back-button { position: absolute; left: 0; top: 50%; transform: translateY(-50%); margin-right: 0; padding: 0.3rem 0.6rem; font-size: 1rem; }
        #classes-section h2 span:not(.icon):not(.back-button), #class-details-section h2 span:not(.icon):not(.back-button) { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1; text-align: center; }
        .icon { display: inline-block; font-style: normal; font-variant: normal; text-rendering: auto; -webkit-font-smoothing: antialiased; margin-right: 0; line-height: 1; flex-shrink: 0; }
        .icon-only { margin-right: 0 !important; }
        .icon-horario::before { content: "🕒"; font-size: 1.1em; } .icon-escola::before { content: "🏫"; font-size: 1.1em; } .icon-turmas::before { content: "📚"; font-size: 1.1em; } .icon-alunos::before { content: "🧑‍🎓"; font-size: 1.1em; } .icon-notas::before { content: "📊"; font-size: 1.1em; } .icon-config::before { content: "⚙️"; font-size: 1.1em; } .icon-contato::before { content: "✉️"; font-size: 1.1em; } .icon-editar::before { content: "✏️"; } .icon-excluir::before { content: "🗑️"; } .icon-anotacao::before { content: "📝"; } .icon-salvar::before { content: "💾"; } .icon-voltar::before { content: "⬅️"; } .icon-presenca::before { content: "✔️"; } .icon-falta::before { content: "❌"; } .icon-justificar::before { content: "💬"; } .icon-adicionar::before { content: "➕"; font-size: 1.1em; } .icon-estrutura::before { content: "🧱"; } .icon-calendario::before { content: "📅"; } .icon-plano::before { content: "🗒️"; } .icon-copiar::before { content: "📋"; } .icon-pdf::before { content: "📄"; font-size: 1.0em;}
        .icon-mover::before { content: "🔁"; font-size: 1.0em; }
        .icon-todos-presentes::before { content: "👥✔️"; font-size: 1.0em; }
        .icon-notificacao-on::before { content: "🔔"; font-size: 1em; color: var(--accent-warning); }
        .icon-notificacao-off::before { content: "🔕"; font-size: 1em; color: var(--text-secondary); opacity: 0.6; }
        .icon-nao-letivo::before { content: "🏖️"; font-size: 1.0em; }
         .icon-mapa::before { content: "🗺️"; font-size: 1.1em; }
         .icon-chevron-down::before { content: "▼"; font-size: 0.8em; }
         .icon-chevron-up::before { content: "▲"; font-size: 0.8em; }
         .icon-som::before { content: "🔊"; font-size: 1em; }
         .icon-arquivo::before { content: "📁"; font-size: 1em; }
         .icon-boletim::before { content: "📜"; font-size: 1.0em; } /* Ícone do boletim */
         .icon-compartilhar::before { content: "📤"; font-size: 1.0em; } /* Ícone de compartilhar */
         .icon-mover-cima::before { content: "🔼"; font-size: 1.0em; }
         .icon-mover-baixo::before { content: "🔽"; font-size: 1.0em; }
         .icon-suspensao::before { content: "🚫"; font-size: 0.9em; color: var(--accent-danger); } /* Ícone para suspensão na chamada */
         .icon-share-app::before { content: "📲"; font-size: 1em;} /* Ícone para compartilhar app */

         /* Tool Icons */
         .icon-ferramentas::before { content: "🔧"; font-size: 1.1em; }
         .icon-sorteio::before { content: "🎲"; font-size: 1.3em; }
         .icon-cronometro::before { content: "⏱️"; font-size: 1.3em; }
         .icon-grupos::before { content: "👨‍👩‍👧‍👦"; font-size: 1.3em; }
         .icon-calculadora-avancada::before { content: "🧮"; font-size: 1.3em; }

        .hidden { display: none !important; } .text-center { text-align: center; } .text-right { text-align: right; } .mt-1 { margin-top: 0.5rem; } .mt-2 { margin-top: 1rem; } .mb-0 { margin-bottom: 0; } .mb-1 { margin-bottom: 0.5rem; } .mb-2 { margin-bottom: 1rem; } .mr-1 { margin-right: 0.5rem; } .ml-1 { margin-left: 0.5rem; } .d-flex { display: flex; } .justify-between { justify-content: space-between; } .align-center { align-items: center; } .w-100 { width: 100%; }
        .list-item.active { background-color: var(--bg-tertiary-alpha); border-left: 4px solid var(--accent-primary); }

        /* Schedule List specific styles */
        .schedule-day-group { margin-bottom: 1.5rem; }
        .schedule-day-title { font-size: 1.2rem; font-weight: 600; color: var(--accent-primary); margin-bottom: 0.5rem; padding-bottom: 0.3rem; border-bottom: 2px solid var(--accent-primary); text-align: left; justify-content: flex-start; gap: 0; }
        .schedule-item { display: flex; align-items: center; padding: 0.6rem 0.8rem; background-color: var(--bg-secondary-alpha); border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 0.5rem; }
        .schedule-time { font-weight: 600; width: 100px; flex-shrink: 0; }
        .schedule-info { flex-grow: 1; margin: 0 0.8rem; }
        .schedule-info .school-name { font-weight: 500; }
        .schedule-info .note { font-size: 0.8rem; color: var(--text-secondary); }
        .schedule-actions { flex-shrink: 0; display: flex; align-items: center; gap: 4px;}
        .schedule-actions button { padding: 0.2rem 0.4rem; font-size: 0.8rem; }
        .notification-toggle-button { padding: 0.2rem 0.3rem !important; font-size: 1rem !important; background: transparent !important; border: none !important; cursor: pointer; }
        .notification-toggle-button:hover { opacity: 0.7; }

        /* --- Grade Structure Modal Styles --- */
        .grade-structure-modal .card { padding: 0.8rem; margin-bottom: 0.8rem; }
        .grade-structure-modal .card-header { padding-bottom: 0.4rem; margin-bottom: 0.4rem; align-items: flex-start; gap: 8px; }
        .grade-structure-modal .gs-name { font-size: 1.05rem; margin-bottom: 0 !important; flex-grow: 1; padding: 0.5rem; }
        .grade-structure-modal .delete-gs-button { margin-left: auto; flex-shrink: 0; }
        .grade-structure-modal .gs-section { border-top: 1px solid var(--border-color); margin-top: 0.8rem; padding-top: 0.8rem; }
        .grade-structure-modal .gs-section h4 { font-size: 0.95rem; color: var(--text-secondary); margin-bottom: 0.6rem; font-weight: 500; }
        .grade-structure-modal .gs-instruments-container { padding-top: 0rem; }
        .grade-label-item { display: flex; align-items: center; margin-bottom: 0.5rem; gap: 5px; }
        .grade-label-item input { flex-grow: 1; margin-right: 0; margin-bottom: 0; font-size: 0.95rem; padding: 0.5rem; }
        .grade-label-item button { flex-shrink: 0; }
        .grade-structure-modal .add-gs-label-button { font-size: 0.85rem !important; padding: 0.3rem 0.8rem !important; margin-top: 0.5rem !important; }
        #add-grade-set-button { width: 100%; margin-top: 0.5rem; }
        /* Color Range Styles */
        .color-range-item { display: flex; align-items: center; gap: 8px; margin-bottom: 0.6rem; border: 1px dashed var(--border-color); padding: 0.5rem; border-radius: 4px; flex-wrap: wrap; }
        .color-range-item label { margin-bottom: 0; font-size: 0.85rem; flex-shrink: 0;}
        .color-range-item input[type="number"] { width: 65px; padding: 0.4rem; margin-bottom: 0; font-size: 0.9rem; text-align: center;}
        .color-range-item input[type="color"] { width: 40px; height: 30px; padding: 2px; margin-bottom: 0;}
        .color-range-item button { flex-shrink: 0; margin-left: auto; }
        .grade-structure-modal .add-color-range-button { font-size: 0.85rem !important; padding: 0.3rem 0.8rem !important; margin-top: 0.3rem !important; display: block; margin-left: auto; margin-right: auto; }
        /* Campo Matéria na Estrutura de Notas */
        .grade-structure-modal .gs-subject-container label { margin-bottom: 0.3rem; }
        .grade-structure-modal .gs-subject-container select { margin-bottom: 0.5rem; width: auto; padding: 0.5rem; max-width: 200px;}
        .grade-structure-modal .gs-subject-container input[type="text"] { margin-bottom: 0; max-width: 180px; }


        /* --- Notas e Médias Header Adjustment --- */
         #class-details-section > .card:nth-of-type(4) .card-header .options { display: flex; align-items: center; flex-wrap: wrap; gap: 5px; margin-left: auto; }
         #class-details-section > .card:nth-of-type(4) .card-header .options label { margin-bottom: 0; font-size: 0.85rem; white-space: nowrap; margin-right: 2px; }
         #class-details-section > .card:nth-of-type(4) .card-header .options select { padding: 0.3rem 0.4rem; font-size: 0.85rem; margin-bottom: 0; flex-shrink: 0; margin-right: 5px; }
         #class-details-section > .card:nth-of-type(4) .card-header .options button.icon-button { margin-left: 0; margin-right: 5px; }
         #class-details-section > .card:nth-of-type(4) .card-header .options .export-buttons { display: flex; gap: 5px; margin-left: 0; }
         /* Modificação para Notas e Médias */
         #class-details-section > .card:nth-of-type(4) .card-header .options > label:first-of-type { margin-left: 10px; } /* Espaço antes do 1º dropdown */
         #class-details-section > .card:nth-of-type(4) .card-header .options #grades-subject-select { max-width: 120px; }
         #class-details-section > .card:nth-of-type(4) .card-header .options #grade-set-select { max-width: 150px; }


        /* --- Class Notes Area Adjustment --- */
         #class-notes-edit textarea { min-height: 120px; margin-bottom: 0.5rem;}
         #class-notes-edit .text-right { margin-bottom: 0.5rem; margin-top: 0; }
        /* --- Lesson Plan Area --- */
        #lesson-plan-textarea { min-height: 100px; margin-bottom: 0.5rem; }

        .footer-message { text-align: center; font-size: 0.85rem; color: var(--text-secondary); margin-top: 2rem; margin-bottom: 1rem; padding: 0 1rem; }
        #contact-section .card p { margin-bottom: 1rem; }
        #contact-section .card a { font-weight: 500; word-break: break-all; }
        #contact-section .card h4 { font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; }

        /* Estilos para Chave PIX e Botão Copiar */
        .pix-key-container { background-color: var(--bg-tertiary-alpha); padding: 0.8rem; border-radius: 5px; font-family: monospace, 'Courier New', Courier; word-break: break-all; margin-top: 0.5rem; margin-bottom: 1rem; border: 1px dashed var(--border-color); user-select: all; cursor: text; }
        #copy-pix-button { width: 100%; max-width: 300px; margin: 0 auto; display: flex; gap: 0.5em; background-color: var(--accent-success); transition: background-color 0.3s ease; }
        #copy-pix-button.error { background-color: var(--accent-danger); }

        /* --- Notification Banner Styles --- */
        #notification-banner { position: fixed; top: 0; left: 0; width: 100%; background-color: var(--bg-notification); color: var(--text-notification); padding: 10px 15px; z-index: 2000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; transform: translateY(-120%); transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); font-size: 0.9rem; line-height: 1.3; }
        #notification-banner.show { transform: translateY(0); }
        #notification-message { flex-grow: 1; margin-right: 10px; }
        #notification-close-button { background: none; border: none; color: inherit; opacity: 0.8; font-size: 1.6rem; font-weight: bold; cursor: pointer; padding: 0 5px; line-height: 1; }
        #notification-close-button:hover { opacity: 1; }

        /* --- Settings: Custom Notification Sound Styles --- */
        .custom-sound-container { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        .custom-sound-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 0.5rem; flex-wrap: wrap; }
        #custom-sound-filename { font-size: 0.85rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1; background: var(--bg-tertiary-alpha); padding: 0.4rem 0.6rem; border-radius: 4px; border: 1px solid var(--border-color); min-width: 100px; }
        #current-custom-sound-display { border: 1px dashed var(--border-color); background-color: var(--bg-tertiary-alpha); padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary); display: flex; align-items: center; justify-content: space-between; }
        #current-custom-sound-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: calc(100% - 40px); }
        #remove-custom-sound-button { padding: 0.3rem 0.5rem; font-size: 0.8rem; flex-shrink: 0; }

        /* --- Classroom Map Styles (FINAL - Grid Layout & Desk Alignment v4) --- */
        .classroom-container { display: grid; grid-template-rows: auto 1fr auto; grid-template-columns: auto 1fr auto; gap: 10px; padding: 15px; border: 1px solid var(--border-color); border-radius: 5px; margin-top: 1rem; overflow: auto; align-items: center; justify-items: center; min-height: 200px; }
        .classroom-map-grid { grid-area: 2 / 2 / 3 / 3; display: grid; gap: var(--seat-gap); justify-content: center; padding: 5px; width: fit-content; max-width: 100%; }
        .seat { width: var(--seat-width); height: var(--seat-height); border: 2px solid var(--map-seat-border); background-color: var(--map-seat-bg); border-radius: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-size: 0.7rem; color: var(--map-seat-text); overflow: hidden; cursor: default; position: relative; transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease; }
        .seat.occupied { background-color: var(--map-seat-occupied-bg); color: var(--map-seat-occupied-text); font-weight: 500; border-style: solid; }
        .map-edit-area .seat.occupied { cursor: pointer; }
        .map-edit-area .seat.empty { cursor: pointer; }
        .map-edit-area .seat.occupied[draggable="true"] { cursor: grab; }
        .map-edit-area .seat.occupied[draggable="true"]:active { cursor: grabbing; }
        .seat.occupied .seat-student-number { font-size: 0.65rem; opacity: 0.8; display: block; line-height: 1; margin-bottom: 2px; pointer-events: none; }
        .seat.occupied .seat-student-name { display: block; line-height: 1.1; max-height: 2.2em; overflow: hidden; padding: 0 2px; pointer-events: none; }
        .seat.empty::before { display: none; }
        .seat.empty .seat-placeholder-text { font-size: 0.65rem; line-height: 1.1; padding: 2px; display: block; opacity: 0.6; color: var(--map-seat-text); }
        .seat span.seat-placeholder-text { display: none; }
        .teacher-desk { border: var(--teacher-desk-border-width) solid var(--map-teacher-desk-border); background-color: var(--map-teacher-desk-bg); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--text-primary); z-index: 5; transition: transform 0.3s, width 0.3s, height 0.3s, grid-area 0s; width: var(--teacher-desk-width); height: var(--teacher-desk-height); transform-origin: center center; margin: 0; }
        .teacher-desk.position-top-center    { grid-area: 1 / 2 / 2 / 3; }
        .teacher-desk.position-bottom-center { grid-area: 3 / 2 / 4 / 3; }
        .teacher-desk.position-left-center   { grid-area: 2 / 1 / 3 / 2; transform: rotate(-90deg); }
        .teacher-desk.position-right-center  { grid-area: 2 / 3 / 3 / 4; transform: rotate(90deg); }
        .teacher-desk.position-top-left   { grid-area: 1 / 2 / 2 / 3; justify-self: start; }
        .teacher-desk.position-top-right  { grid-area: 1 / 2 / 2 / 3; justify-self: end;   }
        .teacher-desk.position-bottom-left   { grid-area: 3 / 2 / 4 / 3; justify-self: start; }
        .teacher-desk.position-bottom-right  { grid-area: 3 / 2 / 4 / 3; justify-self: end;   }
        .teacher-desk.position-left-top    { grid-area: 2 / 1 / 3 / 2; align-self: start; transform: rotate(-90deg); }
        .teacher-desk.position-left-bottom { grid-area: 2 / 1 / 3 / 2; align-self: end;   transform: rotate(-90deg); }
        .teacher-desk.position-right-top    { grid-area: 2 / 3 / 3 / 4; align-self: start; transform: rotate(90deg); }
        .teacher-desk.position-right-bottom { grid-area: 2 / 3 / 3 / 4; align-self: end;   transform: rotate(90deg); }
        .classroom-map-edit-controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .classroom-map-edit-controls .form-group { margin-bottom: 0; display: flex; align-items: center; gap: 5px;}
        .classroom-map-edit-controls label { margin-bottom: 0; flex-shrink: 0; }
        .classroom-map-edit-controls input[type="number"], .classroom-map-edit-controls select { width: auto; max-width: 80px; margin-bottom: 0; padding: 0.4rem; font-size: 0.9rem; }
        .classroom-map-edit-controls select { max-width: 140px; }
        .map-edit-area { display: flex; gap: 20px; margin-top: 1rem; flex-wrap: wrap; }
        .unassigned-students-list { border: 1px dashed var(--map-seat-border); padding: 10px; border-radius: 5px; min-height: 100px; max-height: 40vh; overflow-y: auto; background-color: var(--bg-tertiary-alpha); flex: 1; min-width: 180px; }
        .unassigned-students-list h5 { margin-bottom: 0.5rem; font-size: 0.9rem; text-align: center; color: var(--text-secondary); }
         .draggable-student { background-color: var(--map-seat-occupied-bg); color: var(--map-seat-occupied-text); padding: 5px 8px; border: 1px solid var(--map-seat-border); border-radius: 4px; margin-bottom: 5px; font-size: 0.8rem; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; user-select: none; }
         .draggable-student[draggable="true"]:active { cursor: grabbing; }
         .draggable-student .student-number { font-weight: bold; margin-right: 4px; pointer-events: none; }
         .draggable-student .student-name { pointer-events: none; }
         .seat.drag-over { border-color: var(--accent-success); background-color: var(--map-drag-over-bg); box-shadow: 0 0 8px var(--map-drag-over-bg); }
         .unassigned-students-list.drag-over { border-color: var(--accent-danger); background-color: color-mix(in srgb, var(--accent-danger) 15%, transparent); }
         .seat.occupied.dragging, .draggable-student.dragging { opacity: 0.4; }
         .seat.selected-for-assignment { border-color: var(--map-seat-selected-border); box-shadow: 0 0 0 3px color-mix(in srgb, var(--map-seat-selected-border) 40%, transparent); }

        /* --- Tools Grid --- */
        .tools-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(var(--tool-card-min-width), 1fr)); gap: 1rem; padding: 0.5rem 0; }
        .tool-card { background-color: var(--bg-secondary-alpha); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.2rem 0.8rem; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 2px 4px var(--shadow-color); min-height: 100px; }
        .tool-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px color-mix(in srgb, var(--shadow-color) 120%, black); }
        .tool-card:active { transform: scale(0.97); }
        .tool-card .icon { font-size: 2rem; margin-bottom: 0.6rem; color: var(--accent-primary); }
        .tool-card-title { font-size: 0.9rem; font-weight: 500; color: var(--text-primary); line-height: 1.3; }

    </style>
</head>
<body>

    <div id="notification-banner"> <span id="notification-message">Mensagem...</span> <button id="notification-close-button" type="button">&times;</button> </div>
    <audio id="notification-sound-default" preload="auto"> <source src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YUReT18AAAAAAAAAAAAAAAAAAAAAAP////8AAAAA///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////8=" type="audio/wav"> </audio>
    <header class="app-header"> <div class="header-top-row"> <h1>Super Professor Pro</h1> <div id="header-info" class="header-info"></div> </div> <input type="search" id="search-input" placeholder="Buscar aluno, turma, escola..."> </header>
    <main class="app-content" id="main-content">
        <section id="schedule-section" class="section"> <h2><span class="icon icon-horario"></span>Meus Horários</h2> <button type="button" id="add-schedule-button" class="fab-button success"><span class="icon icon-adicionar icon-only"></span></button> <div id="schedule-list"><p style="text-align: center; padding: 1rem;">Nenhum horário cadastrado.</p></div> <p class="footer-message">Feito com ❤️ para professores</p> </section>
        <section id="schools-section" class="section"> <h2><span class="icon icon-escola"></span>Minhas Escolas</h2> <button type="button" id="add-school-button" class="fab-button success"><span class="icon icon-adicionar icon-only"></span></button> <div id="school-list"><p style="text-align: center; padding: 1rem;">Nenhuma escola cadastrada.</p></div> </section>
        <section id="classes-section" class="section"> <h2> <button type="button" id="back-to-schools-button" class="button-like secondary icon-button back-button"><span class="icon icon-voltar icon-only"></span></button> <span class="icon icon-turmas"></span>Turmas - <span id="classes-school-name">Selecione Escola</span> </h2> <button type="button" id="add-class-button" class="fab-button success"><span class="icon icon-adicionar icon-only"></span></button> <div id="class-list"><p style="text-align: center; padding: 1rem;">Selecione uma escola.</p></div> </section>
        <section id="class-details-section" class="section"> <h2 id="class-details-header"> <button type="button" id="back-to-classes-button" class="button-like secondary icon-button back-button"><span class="icon icon-voltar icon-only"></span></button> <span id="class-details-title">Detalhes da Turma</span> </h2>
            <div class="card"> <div class="card-header"> <h3><span class="icon icon-alunos"></span>Alunos</h3> <div class="options"> <button type="button" id="add-student-button" class="success"><span class="icon icon-adicionar"></span> Novo Aluno</button> <button type="button" class="card-toggle-button" title="Esconder Alunos"><span class="icon icon-chevron-up"></span></button> </div> </div> <div id="student-list-container" class="card-content collapsible-content"><p style="text-align: center; padding: 1rem;">Nenhum aluno nesta turma.</p></div> </div>
            <div class="card"> <div class="card-header"> <h3><span class="icon icon-mapa"></span>Mapa da Sala</h3> <div class="options"> <button type="button" id="edit-map-button" class="secondary icon-button" title="Editar Mapa"><span class="icon icon-editar icon-only"></span></button> <button type="button" class="card-toggle-button" title="Esconder Mapa"><span class="icon icon-chevron-up"></span></button> </div> </div> <div class="card-content collapsible-content"> <div id="classroom-map-edit-controls" class="classroom-map-edit-controls hidden"> <div class="form-group"> <label for="map-rows-input">Fileiras:</label> <input type="number" id="map-rows-input" min="1" max="20" value="5"> </div> <div class="form-group"> <label for="map-cols-input">Colunas:</label> <input type="number" id="map-cols-input" min="1" max="20" value="6"> </div> <div class="form-group"> <label for="teacher-desk-position-select">Mesa Prof.:</label> <select id="teacher-desk-position-select"> <option value="top-center">Topo (Centro)</option> <option value="top-left">Topo (Esquerda)</option> <option value="top-right">Topo (Direita)</option> <option value="bottom-center">Fundo (Centro)</option> <option value="bottom-left">Fundo (Esquerda)</option> <option value="bottom-right">Fundo (Direita)</option> <option value="left-center">Esquerda (Centro)</option> <option value="left-top">Esquerda (Topo)</option> <option value="left-bottom">Esquerda (Fundo)</option> <option value="right-center">Direita (Centro)</option> <option value="right-top">Direita (Topo)</option> <option value="right-bottom">Direita (Fundo)</option> </select> </div> <div class="form-group" style="margin-left: auto;"> <button type="button" id="cancel-map-edit-button" class="secondary">Cancelar</button> <button type="button" id="save-map-button" class="success"><span class="icon icon-salvar"></span> Salvar Mapa</button> </div> </div> <div id="map-edit-area" class="map-edit-area hidden"> <div id="unassigned-students-container" class="unassigned-students-list" droppable="true"> <h5>Alunos sem lugar (Clique aqui após selecionar mesa vazia)</h5> </div> <div id="classroom-container-edit" class="classroom-container"> </div> </div> <div id="classroom-container-display" class="classroom-container"> <div class="teacher-desk">🧑‍🏫</div> <div class="classroom-map-grid"> <p style="padding: 1rem; text-align: center; grid-column: 1 / -1;">Configure o mapa clicando no botão <span class="icon icon-editar"></span>.</p> </div> </div> </div> </div>
            <div class="card"> <div class="card-header"> <h3><span class="icon icon-presenca"></span>Presença</h3> <div class="options"> <label for="attendance-date" class="mb-0 mr-1 align-center">Data:</label> <input type="date" id="attendance-date" style="width: auto; padding: 0.3rem 0.5rem; margin-bottom: 0;"> <button type="button" id="view-monthly-attendance-button" class="secondary icon-button ml-1" title="Ver Frequência Mensal"><span class="icon icon-calendario icon-only"></span></button> <button type="button" class="card-toggle-button" title="Esconder Presença"><span class="icon icon-chevron-up"></span></button> </div> </div> <div class="card-content collapsible-content"> <div id="attendance-actions-container" class="attendance-actions-container hidden"> <button type="button" id="mark-all-present-button" class="success"> <span class="icon icon-todos-presentes"></span>Todos P. </button> <button type="button" id="mark-non-school-day-button" class="secondary"> <span class="icon icon-nao-letivo"></span>Não Letivo </button> </div> <div class="table-scroll-wrapper"> <div id="attendance-table-container"><p style="padding: 1rem; text-align: center;">Selecione uma data.</p></div> </div> <button type="button" id="save-attendance-button" class="success mt-1 hidden"><span class="icon icon-salvar"></span>Salvar Presença</button> </div> </div>
            <div class="card"> <div class="card-header"> <h3><span class="icon icon-notas"></span>Notas e Médias</h3> <div class="options"> <!-- MODIFICADO: Dois selects --> <label for="grades-subject-select" class="mb-0 align-center">Matéria:</label> <select id="grades-subject-select"> <option value="">--</option> </select> <label for="grade-set-select" class="mb-0 align-center">Período/Conjunto:</label> <select id="grade-set-select"> <option value="">--</option> </select> <button type="button" id="manage-grade-structure-button" class="secondary icon-button" title="Gerenciar Estrutura de Notas"><span class="icon icon-estrutura icon-only"></span></button> <div class="export-buttons"> <button type="button" id="export-grades-csv-button" class="secondary icon-button hidden" title="Exportar Notas (CSV)"><span class="icon">📤</span></button> <button type="button" id="export-grades-pdf-button" class="secondary icon-button hidden" title="Exportar Notas (PDF)"><span class="icon icon-pdf"></span></button> </div> <button type="button" class="card-toggle-button" title="Esconder Notas"><span class="icon icon-chevron-up"></span></button> </div> </div> <div class="card-content collapsible-content"> <div class="table-scroll-wrapper"> <div id="grades-table-container"><p style="padding: 1rem; text-align: center;">Selecione Matéria e Período/Conjunto.</p></div> </div> <button type="button" id="save-grades-button" class="success mt-1 hidden"><span class="icon icon-salvar"></span>Salvar Notas</button> </div> </div>
             <div class="card"> <div class="card-header"> <h3><span class="icon icon-plano"></span>Planejamento da Aula</h3> <div class="options"> <label for="lesson-plan-date" class="mb-0 mr-1 align-center">Data:</label> <input type="date" id="lesson-plan-date" style="display: inline-block; width: auto; padding: 0.3rem 0.5rem; margin-bottom: 0;"> <button type="button" class="card-toggle-button" title="Esconder Planejamento"><span class="icon icon-chevron-up"></span></button> </div> </div> <div class="card-content collapsible-content"> <textarea id="lesson-plan-textarea" placeholder="Digite o conteúdo/tópico da aula para esta data..."></textarea> <button type="button" id="save-lesson-plan-button" class="success mt-1 hidden"><span class="icon icon-salvar"></span>Salvar Plano</button> </div> </div>
             <div class="card"> <div class="card-header"> <h3><span class="icon icon-anotacao"></span>Anotações da Turma</h3> <div class="options"> <button type="button" id="edit-class-notes-button" class="secondary icon-button" title="Editar Anotações"><span class="icon icon-editar icon-only"></span></button> <button type="button" class="card-toggle-button" title="Esconder Anotações"><span class="icon icon-chevron-up"></span></button> </div> </div> <div id="class-notes-display" class="card-content collapsible-content"> <p id="class-notes-content">Nenhuma anotação para esta turma.</p> </div> <div id="class-notes-edit" class="hidden card-content collapsible-content"> <textarea id="class-notes-textarea" placeholder="Digite suas anotações sobre a turma..."></textarea> <div class="text-right mt-1 mb-1"> <button type="button" id="cancel-class-notes-button" class="secondary">Cancelar</button> <button type="button" id="save-class-notes-button" class="success"><span class="icon icon-salvar"></span> Salvar</button> </div> </div> </div>
        </section>
        <section id="tools-section" class="section"> <h2><span class="icon icon-ferramentas"></span>Ferramentas</h2> <div class="tools-grid"> <button type="button" class="tool-card" data-tool="name-sorter"> <span class="icon icon-sorteio"></span> <span class="tool-card-title">Sorteador de Nomes</span> </button> <button type="button" class="tool-card" data-tool="timer-stopwatch"> <span class="icon icon-cronometro"></span> <span class="tool-card-title">Cronômetro/ Timer</span> </button> <button type="button" class="tool-card" data-tool="group-generator"> <span class="icon icon-grupos"></span> <span class="tool-card-title">Gerador de Grupos</span> </button> <button type="button" class="tool-card" data-tool="advanced-calculator"> <span class="icon icon-calculadora-avancada"></span> <span class="tool-card-title">Calculadora Avançada</span> </button> </div> <p class="footer-message">Feito com ❤️ para professores</p> </section>
        <section id="contact-section" class="section"> <h2><span class="icon icon-contato"></span>Contato & Apoio</h2> <div class="card"> <h3 style="text-align: center; color: var(--accent-primary);">Gostou do App? Apoie o Desenvolvedor!</h3> <p class="mt-2">Olá, Professor(a)! 👋</p> <p>O Super Professor Pro foi criado com muito carinho e dedicação para ser uma ferramenta útil e gratuita no seu dia a dia.</p> <p>Se este app tem facilitado sua rotina e você gostaria de incentivar a continuidade do projeto (novas funcionalidades, melhorias e correções!), considere fazer uma contribuição voluntária via PIX.</p> <p>É como pagar um cafezinho ☕ pelo bom trabalho! Qualquer valor é bem-vindo e ajuda muito a manter a ferramenta evoluindo.</p> <h4 class="text-center">PIX Copia e Cola:</h4> <div id="pix-key-text" class="pix-key-container">00020126580014BR.GOV.BCB.PIX01365787c86e-c2cb-44ac-8799-428e17e6b4635204000053039865802BR5925Paulo Ricardo Correa de A6009SAO PAULO6214051058aRkBp4Fm6304175C</div> <button type="button" id="copy-pix-button" class="success"> <span class="icon icon-copiar"></span> Copiar Código PIX </button> <p class="text-center mt-2"><strong>Muito obrigado pelo seu apoio!</strong></p> <hr style="border: none; border-top: 1px solid var(--border-color); margin: 1.5rem 0;"> <p>Para dúvidas, sugestões ou reporte de erros:</p> <p style="text-align: center;"> <a href="mailto:paulinhoandroidnf@gmail.com">paulinhoandroidnf@gmail.com</a> </p> <!-- Botão Compartilhar App Adicionado Aqui --> <button type="button" id="share-app-button" class="button-like secondary mt-2 w-100"><span class="icon icon-share-app"></span> Compartilhar App com Colegas</button> </div> <p class="footer-message">Feito com ❤️ para professores</p> </section>
        <section id="settings-section" class="section"> <h2><span class="icon icon-config"></span>Configurações</h2> <div class="card"> <h3>Temas</h3> <div id="theme-selector" style="display: flex; flex-wrap: wrap; gap: 5px;"> <button type="button" class="theme-button" data-theme="theme-light">Claro</button> <button type="button" class="theme-button" data-theme="theme-dark">Escuro</button> <button type="button" class="theme-button" data-theme="theme-forest-green">Verde Floresta</button> <button type="button" class="theme-button" data-theme="theme-math-master">Mestre da Matemática</button> <button type="button" class="theme-button" data-theme="theme-historic-scroll">Papiro Histórico</button> <button type="button" class="theme-button" data-theme="theme-alchemist">O Alquimista</button> </div> </div> <div class="card mt-2"> <h3>Dados</h3> <div style="display: flex; flex-direction: column; gap: 10px;"> <button type="button" id="export-data-button" class="secondary"><span class="icon">📤</span> Exportar/Copiar Dados (JSON)</button> <label for="import-data-input" class="button-like secondary" style="cursor: pointer;"><span class="icon">📥</span> Importar Dados (JSON)</label> <input type="file" id="import-data-input" accept=".json" class="hidden"> <button type="button" id="clear-data-button" class="danger"><span class="icon">⚠️</span> Limpar Todos os Dados</button> </div> </div> <div class="card mt-2"> <h3>Notificações de Horários</h3> <div class="checkbox-group"> <input type="checkbox" id="enable-global-notifications"> <label for="enable-global-notifications">Ativar Notificações Globais</label> </div> <div class="checkbox-group"> <input type="checkbox" id="enable-notification-sound"> <label for="enable-notification-sound">Ativar Som nas Notificações</label> </div> <div class="custom-sound-container"> <label for="custom-notification-sound-input">Som Personalizado (Opcional - máx 2MB):</label> <div class="custom-sound-input-group"> <label for="custom-notification-sound-input" class="button-like secondary" style="cursor: pointer;"><span class="icon icon-arquivo"></span> Escolher arquivo</label> <span id="custom-sound-filename">Nenhum arquivo escolhido</span> <input type="file" id="custom-notification-sound-input" accept="audio/*" class="hidden"> </div> <div id="current-custom-sound-display" class="hidden"> <span id="current-custom-sound-name"></span> <button type="button" id="remove-custom-sound-button" class="danger icon-button" title="Remover Som Personalizado"><span class="icon icon-excluir icon-only"></span></button> </div> </div> <p class="text-sm text-secondary mt-1"> Notificações podem ser ativadas/desativadas individualmente para cada horário na tela "Meus Horários" (clicando no 🔔/🔕). Elas aparecerão 5 minutos antes do início e do fim da aula programada. </p> </div> <p class="footer-message">Feito com ❤️ para professores</p> </section>
    </main>
    <nav class="app-nav"> <button type="button" class="nav-button" data-section="schedule-section"><span class="icon icon-horario"></span>Horários</button> <button type="button" class="nav-button" data-section="schools-section"><span class="icon icon-escola"></span>Escolas</button> <button type="button" class="nav-button" data-section="classes-section" id="nav-classes-button" disabled><span class="icon icon-turmas"></span>Turmas</button> <button type="button" class="nav-button" data-section="class-details-section" id="nav-details-button" disabled><span class="icon icon-alunos"></span>Detalhes</button> <button type="button" class="nav-button" data-section="tools-section"><span class="icon icon-ferramentas"></span>Ferramentas</button> <button type="button" class="nav-button" data-section="contact-section"><span class="icon icon-contato"></span>Contato</button> <button type="button" class="nav-button" data-section="settings-section"><span class="icon icon-config"></span>Config</button> </nav>

    <!-- Generic Modal -->
    <div id="generic-modal" class="modal"> <div class="modal-content"> <div class="modal-header"> <h2 id="modal-title">Título do Modal</h2> <button type="button" class="close-button" data-dismiss="modal">&times;</button> </div> <div id="modal-body" class="modal-body"></div> <div id="modal-footer" class="modal-footer"> <button type="button" data-dismiss="modal" class="secondary">Fechar</button> </div> </div> </div>

    <!-- Advanced Calculator Modal -->
    <div id="advanced-calculator-modal" class="modal calculator-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="calculator-modal-title">Calculadora Avançada</h2>
                <button type="button" class="close-button" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="calculator-mode-selector">
                    <button type="button" id="calc-mode-standard" class="active" data-mode="standard">Padrão</button>
                    <button type="button" id="calc-mode-weighted" data-mode="weighted">Média Ponderada</button>
                </div>

                <!-- Standard Calculator Section -->
                <div id="calculator-standard-section">
                    <div id="calculator-display" class="calculator-display">0</div>
                    <div class="calculator-buttons">
                        <button type="button" class="danger util" data-action="clearAll">AC</button>
                        <button type="button" class="warn util" data-action="clearEntry">C</button>
                        <button type="button" class="util" data-action="backspace">←</button>
                        <button type="button" class="op" data-operator="divide">÷</button>

                        <button type="button" class="num" data-value="7">7</button>
                        <button type="button" class="num" data-value="8">8</button>
                        <button type="button" class="num" data-value="9">9</button>
                        <button type="button" class="op" data-operator="multiply">×</button>

                        <button type="button" class="num" data-value="4">4</button>
                        <button type="button" class="num" data-value="5">5</button>
                        <button type="button" class="num" data-value="6">6</button>
                        <button type="button" class="op" data-operator="subtract">−</button>

                        <button type="button" class="num" data-value="1">1</button>
                        <button type="button" class="num" data-value="2">2</button>
                        <button type="button" class="num" data-value="3">3</button>
                        <button type="button" class="op" data-operator="add">+</button>

                        <button type="button" class="num zero" data-value="0">0</button>
                        <button type="button" class="num" data-action="decimal">.</button>
                        <button type="button" class="eq" data-action="calculate">=</button>
                    </div>
                </div>

                <!-- Weighted Average Section -->
                <div id="calculator-weighted-section" class="weighted-average-section hidden">
                    <h5>Adicionar Notas e Pesos</h5>
                    <div class="grade-weight-input-group">
                        <input type="number" id="weighted-grade-input" placeholder="Nota" step="any">
                        <input type="number" id="weighted-weight-input" placeholder="Peso" step="any">
                        <button type="button" id="add-pair-button" class="success"><span class="icon icon-adicionar"></span> Add</button>
                    </div>
                    <h5>Pares Adicionados:</h5>
                    <ul id="weighted-pairs-list" class="pairs-list">
                        <p>Nenhum par adicionado.</p>
                    </ul>
                    <button type="button" id="calculate-weighted-avg-button" class="success calculate">
                        <span class="icon icon-calculadora-avancada"></span> Calcular Média Ponderada
                    </button>
                    <div id="weighted-average-result" class="weighted-average-result">--</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" data-dismiss="modal" class="secondary">Fechar</button>
            </div>
        </div>
    </div>


    <!-- Templates -->
     <template id="school-item-template">
         <div class="list-item" data-id="">
             <div class="item-info">
                 <h4 class="school-name"></h4>
             </div>
             <div class="list-item-actions">
                 <button type="button" class="share-school-button warning icon-button" title="Compartilhar Dados da Escola"><span class="icon icon-compartilhar"></span></button> <!-- Botão Compartilhar Adicionado -->
                 <button type="button" class="view-classes-button primary" title="Ver Turmas"><span class="icon icon-turmas"></span> Turmas</button>
                 <button type="button" class="edit-school-button secondary icon-button" title="Editar Escola"><span class="icon icon-editar icon-only"></span></button>
                 <button type="button" class="delete-school-button danger icon-button" title="Excluir Escola"><span class="icon icon-excluir icon-only"></span></button>
             </div>
         </div>
     </template>
     <template id="class-item-template">
         <div class="list-item" data-id="">
             <div class="item-info">
                 <h4 class="class-name"></h4>
                 <p class="class-details"></p>
             </div>
             <div class="list-item-actions">
                 <button type="button" class="move-class-up-button reorder-button" title="Mover para Cima"><span class="icon icon-mover-cima icon-only"></span></button> <!-- Botão Mover Cima -->
                 <button type="button" class="move-class-down-button reorder-button" title="Mover para Baixo"><span class="icon icon-mover-baixo icon-only"></span></button> <!-- Botão Mover Baixo -->
                 <span style="border-left: 1px solid var(--border-color); margin: 0 5px; height: 20px; align-self: center;"></span> <!-- Separador Visual -->
                 <button type="button" class="view-details-button primary" title="Ver Detalhes"><span class="icon icon-alunos"></span> Ver</button>
                 <button type="button" class="edit-class-button secondary icon-button" title="Editar Turma"><span class="icon icon-editar icon-only"></span></button>
                 <button type="button" class="delete-class-button danger icon-button" title="Excluir Turma"><span class="icon icon-excluir icon-only"></span></button>
             </div>
         </div>
     </template>
     <template id="student-list-item-template">
         <div class="list-item" data-id="">
             <span class="student-number" style="font-weight: bold; margin-right: 10px; min-width: 30px; text-align: right;"></span>
             <span class="student-name" style="white-space: normal; word-break: break-word;"></span>
             <div class="list-item-actions">
                 <button type="button" class="view-report-card-button secondary icon-button" title="Ver Boletim"><span class="icon icon-boletim icon-only"></span></button> <!-- Botão Boletim Adicionado -->
                 <button type="button" class="edit-student-button secondary icon-button" title="Editar Aluno"><span class="icon icon-editar icon-only"></span></button>
                 <button type="button" class="delete-student-button danger icon-button" title="Excluir Aluno"><span class="icon icon-excluir icon-only"></span></button>
                 <button type="button" class="notes-student-button warning icon-button" title="Observações do Aluno"><span class="icon icon-anotacao icon-only"></span></button>
                 <button type="button" class="move-student-button secondary icon-button" title="Mover Aluno para Outra Turma"><span class="icon icon-mover icon-only"></span></button>
             </div>
         </div>
     </template>
    <template id="grades-header-template"> <th class="student-col">Aluno</th> <th class="sum-col">Soma</th> <th class="avg-col">Média</th> </template>
    <template id="grades-row-template"> <tr> <td class="student-col"> <span class="student-number" style="font-weight:bold; margin-right: 5px;"></span> <span class="student-name"></span> </td> <td class="sum-col sum">--</td> <td class="avg-col average">--</td> </tr> </template>
    <template id="attendance-row-template"> <tr> <td class="student-col"> <span class="student-number"></span> <span class="student-name"></span> </td> <td class="attendance-status"></td> </tr> </template>
     <!-- Modificado para incluir botão editar -->
     <template id="observation-item-template">
         <div class="observation-item" data-id=""> <!-- Usa data-id -->
             <div class="observation-details">
                 <!-- Categoria e data serão inseridas pelo JS -->
                 <p class="observation-text"></p>
             </div>
             <div class="list-item-actions"> <!-- Agrupa botões -->
                 <button type="button" class="edit-observation-button secondary icon-button" title="Editar Registro"><span class="icon icon-editar icon-only"></span></button>
                 <button type="button" class="delete-observation-button danger icon-button" title="Excluir Registro"><span class="icon icon-excluir icon-only"></span></button>
             </div>
         </div>
     </template>
    <template id="schedule-item-template"> <div class="schedule-item" data-id=""> <span class="schedule-time"></span> <div class="schedule-info"> <div class="school-name"></div> <div class="note"></div> </div> <div class="schedule-actions"> <button type="button" class="notification-toggle-button" title="Ativar/Desativar Notificações"> <span class="icon notification-indicator"></span> </button> <button type="button" class="edit-schedule-button secondary icon-button" title="Editar Horário"> <span class="icon icon-editar icon-only"></span> </button> <button type="button" class="delete-schedule-button danger icon-button" title="Excluir Horário"> <span class="icon icon-excluir icon-only"></span> </button> </div> </div> </template>
    <template id="grade-label-item-template"> <div class="grade-label-item"> <input type="text" class="gs-label" value="" placeholder="Nome da Avaliação (Ex: Prova 1)"> <button type="button" class="delete-gs-label-button danger icon-button" title="Excluir Instrumento"><span class="icon icon-excluir icon-only"></span></button> </div> </template>
    <template id="color-range-item-template"> <div class="color-range-item"> <label>De:</label> <input type="number" class="gs-color-min" step="0.1" placeholder="0.0" value=""> <label>Até:</label> <input type="number" class="gs-color-max" step="0.1" placeholder="10.0" value=""> <label>Cor:</label> <input type="color" class="gs-color-input" value="#ffffff"> <button type="button" class="delete-color-range-button danger icon-button" title="Excluir Faixa"> <span class="icon icon-excluir icon-only"></span> </button> </div> </template>
    <template id="seat-template"> <div class="seat" draggable="false"> <span class="seat-student-number"></span> <span class="seat-student-name"></span> <span class="seat-placeholder-text"></span> </div> </template>
    <template id="draggable-student-template"> <div class="draggable-student" draggable="true"> <span class="student-number"></span> <span class="student-name"></span> </div> </template>
    <template id="teacher-desk-template"> <div class="teacher-desk">🧑‍🏫</div> </template>
    <template id="classroom-grid-template"> <div class="classroom-map-grid"></div> </template>
    <!-- Template for Weighted Pair Item -->
    <template id="weighted-pair-item-template">
        <li class="pair-item" data-index="">
            <span>Nota: <strong></strong>, Peso: <strong></strong></span>
            <button type="button" class="delete-pair-button danger icon-button" title="Remover Par"><span class="icon icon-excluir icon-only"></span></button>
        </li>
    </template>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Seletores Globais (Existentes) ---
            const mainContent = document.getElementById('main-content');
            const sections = document.querySelectorAll('.section');
            const navButtons = document.querySelectorAll('.nav-button');
            const modal = document.getElementById('generic-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            const headerInfo = document.getElementById('header-info');
            const searchInput = document.getElementById('search-input');
            const scheduleListContainer = document.getElementById('schedule-list');
            const schoolListContainer = document.getElementById('school-list');
            const classListContainer = document.getElementById('class-list');
            const classesSchoolName = document.getElementById('classes-school-name');
            const studentListContainer = document.getElementById('student-list-container');
            const classDetailsSection = document.getElementById('class-details-section');
            const classDetailsHeader = document.getElementById('class-details-header');
            const classDetailsTitle = document.getElementById('class-details-title');
            const backToSchoolsButton = document.getElementById('back-to-schools-button');
            const backToClassesButton = document.getElementById('back-to-classes-button');
            const navClassesButton = document.getElementById('nav-classes-button');
            const navDetailsButton = document.getElementById('nav-details-button');
            const gradesTableContainer = document.getElementById('grades-table-container');
            const attendanceTableContainer = document.getElementById('attendance-table-container');
             // Modificado: seleciona os dois dropdowns de notas
             const gradesSubjectSelect = document.getElementById('grades-subject-select');
             const gradeSetSelect = document.getElementById('grade-set-select');
            const manageGradeStructureButton = document.getElementById('manage-grade-structure-button');
            const saveGradesButton = document.getElementById('save-grades-button');
            const exportGradesCsvButton = document.getElementById('export-grades-csv-button');
            const exportGradesPdfButton = document.getElementById('export-grades-pdf-button');
            const attendanceDateInput = document.getElementById('attendance-date');
            const saveAttendanceButton = document.getElementById('save-attendance-button');
            const viewMonthlyAttendanceButton = document.getElementById('view-monthly-attendance-button');
            const attendanceActionsContainer = document.getElementById('attendance-actions-container');
            const markAllPresentButton = document.getElementById('mark-all-present-button');
            const markNonSchoolDayButton = document.getElementById('mark-non-school-day-button');
            const lessonPlanDateInput = document.getElementById('lesson-plan-date');
            const lessonPlanTextarea = document.getElementById('lesson-plan-textarea');
            const saveLessonPlanButton = document.getElementById('save-lesson-plan-button');
            const classNotesDisplay = document.getElementById('class-notes-display');
            const classNotesContent = document.getElementById('class-notes-content');
            const classNotesEdit = document.getElementById('class-notes-edit');
            const classNotesTextarea = document.getElementById('class-notes-textarea');
            const editClassNotesButton = document.getElementById('edit-class-notes-button');
            const saveClassNotesButton = document.getElementById('save-class-notes-button');
            const cancelClassNotesButton = document.getElementById('cancel-class-notes-button');
            const addScheduleButton = document.getElementById('add-schedule-button');
            const addSchoolButton = document.getElementById('add-school-button');
            const addClassButton = document.getElementById('add-class-button');
            const copyPixButton = document.getElementById('copy-pix-button');
            const pixKeyTextElement = document.getElementById('pix-key-text');
            const notificationBanner = document.getElementById('notification-banner');
            const notificationMessage = document.getElementById('notification-message');
            const notificationCloseButton = document.getElementById('notification-close-button');
            const defaultNotificationSound = document.getElementById('notification-sound-default');
            const enableGlobalNotificationsCheckbox = document.getElementById('enable-global-notifications');
            const enableNotificationSoundCheckbox = document.getElementById('enable-notification-sound');
            const customNotificationSoundInput = document.getElementById('custom-notification-sound-input');
            const customSoundFilenameDisplay = document.getElementById('custom-sound-filename');
            const currentCustomSoundDisplay = document.getElementById('current-custom-sound-display');
            const currentCustomSoundName = document.getElementById('current-custom-sound-name');
            const removeCustomSoundButton = document.getElementById('remove-custom-sound-button');
            const editMapButton = document.getElementById('edit-map-button');
            const classroomContainerDisplay = document.getElementById('classroom-container-display');
            const classroomContainerEdit = document.getElementById('classroom-container-edit');
            const mapEditArea = document.getElementById('map-edit-area');
            const classroomMapEditControls = document.getElementById('classroom-map-edit-controls');
            const mapRowsInput = document.getElementById('map-rows-input');
            const mapColsInput = document.getElementById('map-cols-input');
            const teacherDeskPositionSelect = document.getElementById('teacher-desk-position-select');
            const unassignedStudentsContainer = document.getElementById('unassigned-students-container');
            const cancelMapEditButton = document.getElementById('cancel-map-edit-button');
            const saveMapButton = document.getElementById('save-map-button');
            const teacherDeskTemplate = document.getElementById('teacher-desk-template');
            const classroomGridTemplate = document.getElementById('classroom-grid-template');
            const toolsGrid = document.querySelector('#tools-section .tools-grid');

            // --- Seletores da Calculadora ---
            const calculatorModal = document.getElementById('advanced-calculator-modal');
            const calculatorDisplay = document.getElementById('calculator-display');
            const standardCalcSection = document.getElementById('calculator-standard-section');
            const weightedCalcSection = document.getElementById('calculator-weighted-section');
            const calcModeStandardBtn = document.getElementById('calc-mode-standard');
            const calcModeWeightedBtn = document.getElementById('calc-mode-weighted');
            const calcButtonsContainer = document.querySelector('.calculator-buttons'); // For standard buttons
            const weightedGradeInput = document.getElementById('weighted-grade-input');
            const weightedWeightInput = document.getElementById('weighted-weight-input');
            const addPairButton = document.getElementById('add-pair-button');
            const weightedPairsList = document.getElementById('weighted-pairs-list');
            const calculateWeightedAvgButton = document.getElementById('calculate-weighted-avg-button');
            const weightedAverageResult = document.getElementById('weighted-average-result');

            // Export Buttons (Need to be selected if not already)
            const exportDataButton = document.getElementById('export-data-button');
            //const exportMonthlyAttendanceCsvButton = document.getElementById('export-attendance-csv-button'); // Found dynamically
            //const exportMonthlyAttendancePdfButton = document.getElementById('export-attendance-pdf-button'); // Found dynamically


            const weekdays = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const commonSubjects = ["Português", "Matemática", "História", "Geografia", "Ciências", "Inglês", "Espanhol", "Artes", "Ed. Física", "Redação", "Outra..."]; // Adicionado
            const commonSeries = [ // Adicionado
                "Ed. Infantil - Maternal I", "Ed. Infantil - Maternal II", "Ed. Infantil - Pré I", "Ed. Infantil - Pré II",
                "1º Ano - EF", "2º Ano - EF", "3º Ano - EF", "4º Ano - EF", "5º Ano - EF",
                "6º Ano - EF", "7º Ano - EF", "8º Ano - EF", "9º Ano - EF",
                "1º Ano - EM", "2º Ano - EM", "3º Ano - EM",
                "EJA - Fundamental", "EJA - Médio",
                "Outra..."
            ];
            const observationCategories = ["Anotação", "Observação", "Ocorrência", "Advertência", "Suspensão"]; // Adicionado

            const NOTIFICATION_LEAD_TIME_MINUTES = 5;
            const MAX_CUSTOM_SOUND_SIZE_MB = 2;
            let notificationCheckInterval = null;
            let shownNotificationsThisMinute = {};
            let draggedStudentId = null;
            let draggedElement = null;
            let tempClassroomLayout = null;
            let selectedSeatForAssignment = null;

            // Tool States
            let sorterStudentList = [];
            let sorterAvailableStudents = [];
            let sorterDrawnStudents = [];
            let stopwatchInterval = null;
            let stopwatchSeconds = 0;
            let isStopwatchRunning = false;

            // Calculator State
            let calculator = {
                displayValue: '0',
                firstOperand: null,
                waitingForSecondOperand: false,
                operator: null,
                mode: 'standard', // 'standard' or 'weighted'
                weightedPairs: [] // Array of { grade: number, weight: number }
            };


            let appData = {
                schools: [], classes: [], students: [], schedule: [], gradeStructures: [], // Movido para global
                settings: { theme: 'theme-light', globalNotificationsEnabled: true, notificationSoundEnabled: true, customNotificationSound: null }
            };
            let currentSchoolId = null; let currentClassId = null; let currentSection = 'schedule-section';

            // --- Funções de Estado e Persistência ---
            const saveAppState = () => { try { localStorage.setItem('lastSection', currentSection || 'schedule-section'); localStorage.setItem('lastSchoolId', currentSchoolId || ''); localStorage.setItem('lastClassId', currentClassId || ''); } catch (e) { console.error("Erro ao salvar estado:", e); } };
            const restoreAppState = () => {
                 const lastSection = localStorage.getItem('lastSection');
                 const lastSchoolId = localStorage.getItem('lastSchoolId');
                 const lastClassId = localStorage.getItem('lastClassId');
                 console.log("Restoring App State:", {lastSection, lastSchoolId, lastClassId});
                 currentSection = 'schedule-section';
                 currentSchoolId = null;
                 currentClassId = null;

                 if (appData.schools.length > 0) {
                     currentSchoolId = lastSchoolId && findSchoolById(lastSchoolId) ? lastSchoolId : appData.schools[0].id;
                     currentClassId = lastClassId && findClassById(lastClassId) && findClassById(lastClassId).schoolId === currentSchoolId ? lastClassId : null;

                     if (lastSection) {
                         if (lastSection === 'class-details-section' && currentClassId) {
                             currentSection = 'class-details-section';
                         } else if (lastSection === 'classes-section' && currentSchoolId) {
                             currentSection = 'classes-section';
                             currentClassId = null; // Garante que não fique preso nos detalhes sem classe
                         } else if (lastSection === 'schools-section') {
                             currentSection = 'schools-section';
                             currentSchoolId = null; // Reseta escola e classe
                             currentClassId = null;
                         } else if (['schedule-section', 'tools-section', 'contact-section', 'settings-section'].includes(lastSection)){
                              const sectionExists = document.getElementById(lastSection);
                              if (sectionExists) {
                                 currentSection = lastSection;
                                 currentSchoolId = null; // Reseta escola e classe para seções não relacionadas
                                 currentClassId = null;
                             } else {
                                 currentSection = currentSchoolId ? 'classes-section' : 'schools-section'; // Fallback
                             }
                         } else {
                              currentSection = currentSchoolId ? 'classes-section' : 'schools-section'; // Fallback
                              currentClassId = null;
                         }
                     } else {
                         // Sem lastSection, define baseado nos IDs restaurados
                         if (currentClassId) currentSection = 'class-details-section';
                         else if (currentSchoolId) currentSection = 'classes-section';
                         else currentSection = 'schools-section'; // Ou 'schedule-section' se preferir
                     }
                 } else {
                     currentSection = 'schedule-section'; // Se não há escolas, vai para horários
                 }


                 // Carregar ordem customizada das turmas (se existir)
                 appData.schools.forEach(school => {
                    try {
                        const savedOrder = localStorage.getItem(`classOrder_${school.id}`);
                        if (savedOrder) {
                             school.classOrder = JSON.parse(savedOrder);
                             // Validar se os IDs ainda existem nas classes da escola
                             const currentClassIds = new Set(appData.classes.filter(c => c.schoolId === school.id).map(c => c.id));
                             school.classOrder = school.classOrder.filter(id => currentClassIds.has(id));
                         } else {
                            school.classOrder = null; // Ou []
                         }
                    } catch(e) {
                        console.error("Erro ao restaurar ordem das turmas para escola:", school.id, e);
                        school.classOrder = null;
                    }
                 });
                 console.log(`Estado Final Restaurado: Section=${currentSection}, School=${currentSchoolId}, Class=${currentClassId}`);
             };

            // --- Funções Utilitárias ---
            const generateId = (prefix = 'id') => `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const saveData = () => {
                 try {
                    // Salvar ordem customizada das turmas antes de salvar appData
                    appData.schools.forEach(school => {
                         if (school.classOrder && school.classOrder.length > 0) {
                            localStorage.setItem(`classOrder_${school.id}`, JSON.stringify(school.classOrder));
                         } else {
                             localStorage.removeItem(`classOrder_${school.id}`); // Remove se a ordem for resetada/vazia
                         }
                    });
                    // Salvar o resto dos dados
                    localStorage.setItem('superProfessorProData_v15', JSON.stringify(appData)); // Incrementa versão
                    console.log("Data saved (v15).");
                 } catch (e) {
                     console.error("Erro salvar:", e);
                     if (e.name === 'QuotaExceededError') {
                         alert("Erro: Não há espaço suficiente para salvar os dados. Isso pode ser devido a um arquivo de som personalizado muito grande.");
                     } else {
                         alert("Erro ao salvar dados.");
                     }
                 }
            };
            const loadData = () => {
                console.log("Iniciando loadData..."); // Log início
                // Prioriza v15, depois v14, depois v13
                 const dataV15 = localStorage.getItem('superProfessorProData_v15');
                 let dataToParse = dataV15; let loadedVersion = 15;

                if (!dataToParse) { const dataV14 = localStorage.getItem('superProfessorProData_v14'); if (dataV14) { console.log("Importing data from v14..."); dataToParse = dataV14; loadedVersion = 14; } }
                if (!dataToParse) { const dataV13 = localStorage.getItem('superProfessorProData_v13'); if (dataV13) { console.log("Importing data from v13..."); dataToParse = dataV13; loadedVersion = 13; } }

                if (dataToParse) {
                    try {
                        appData = JSON.parse(dataToParse);
                        console.log("Dados JSON analisados com sucesso.");

                        // --- Migrações e Valores Padrão (v13 -> v14 -> v15) ---
                        // Garante que as propriedades principais existam
                        appData.schools = appData.schools || [];
                        appData.classes = appData.classes || [];
                        appData.students = appData.students || [];
                        appData.schedule = appData.schedule || [];
                        appData.settings = appData.settings || {};
                         // Adicionado em v15: Estruturas de notas globais
                         appData.gradeStructures = appData.gradeStructures || [];

                        // ** INÍCIO DO BLOCO DE MIGRAÇÃO COM TRY...CATCH **
                        if (loadedVersion < 15) {
                            console.log(`Iniciando migração de dados da v${loadedVersion} para v15...`);
                            try { // <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< TRY AQUI
                                // 1. Mover gradeStructures das classes para o global e adicionar subject
                                appData.classes.forEach(cls => {
                                     if (cls.gradeStructure && Array.isArray(cls.gradeStructure) && cls.gradeStructure.length > 0) {
                                        cls.gradeStructure.forEach(gs => {
                                             // Adiciona subject (tentativa de extrair ou padrão)
                                             gs.subject = extractSubjectFromName(gs.name) || cls.subject || 'Geral'; // Tenta extrair do nome do conjunto, fallback para matéria da turma, fallback para 'Geral'
                                             // Adiciona ID se não tiver (improvável, mas seguro)
                                             gs.id = gs.id || generateId('gs');
                                             // Adiciona a estrutura global se não existir uma com mesmo ID
                                             if (!appData.gradeStructures.some(globalGs => globalGs.id === gs.id)) {
                                                 appData.gradeStructures.push({...gs}); // Copia a estrutura
                                                 console.log(`Estrutura ${gs.id} (${gs.name}) movida para global. Matéria: ${gs.subject}`);
                                             }
                                         });
                                     }
                                     delete cls.gradeStructure; // Remove o campo antigo da classe
                                     // 2. Adicionar campo series padrão
                                     cls.series = cls.series || ''; // Adiciona campo de série vazio
                                 });

                                 // 3. Migrar student.notes para novo formato
                                 appData.students.forEach(std => {
                                     // Garante que notes exista como array
                                    if (!Array.isArray(std.notes)) {
                                        std.notes = []; // Garante que seja array se não for
                                    }
                                    // Itera e converte/garante formato
                                    std.notes = std.notes.map((note) => {
                                        if (typeof note === 'string') { // Formato muito antigo
                                            return { id: generateId('obs'), date: 'N/A', category: 'Anotação', text: note };
                                        } else if (typeof note === 'object' && note && note.text && !note.category) { // Formato {text, date}
                                            return { id: generateId('obs'), date: note.date || 'N/A', category: 'Anotação', text: note.text };
                                        } else if (typeof note === 'object' && note && note.text && note.category) { // Formato já novo, apenas garante ID
                                            note.id = note.id || generateId('obs');
                                            return note;
                                        }
                                        return null; // Ignora formatos inválidos
                                    }).filter(Boolean); // Remove nulos
                                 });
                                 console.log("Migration to v15 complete.");

                            } catch (migrationError) { // <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< CATCH AQUI
                                console.error("!!!!! ERRO DURANTE A MIGRAÇÃO DE DADOS !!!!!", migrationError);
                                alert("Ocorreu um erro ao tentar atualizar o formato dos dados antigos. Alguns dados podem não ter sido migrados corretamente. Se o problema persistir, considere limpar os dados do app (Configurações > Limpar Todos os Dados) ou entrar em contato com o suporte.");
                                // Continua a execução mesmo com erro na migração
                            } // <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< FIM DO CATCH
                        }
                        // ** FIM DO BLOCO DE MIGRAÇÃO **


                        // --- Validações e Padrões Gerais (Pós-Migração ou Carregamento v15) ---
                        appData.settings.theme = appData.settings.theme || 'theme-light';
                        appData.settings.globalNotificationsEnabled = appData.settings.globalNotificationsEnabled !== undefined ? appData.settings.globalNotificationsEnabled : true;
                        appData.settings.notificationSoundEnabled = appData.settings.notificationSoundEnabled !== undefined ? appData.settings.notificationSoundEnabled : true;
                        appData.settings.customNotificationSound = appData.settings.customNotificationSound || null;
                        if (appData.settings.nonSchoolDays) delete appData.settings.nonSchoolDays;

                        appData.classes.forEach(c => {
                            c.notes = c.notes || '';
                            c.schoolId = c.schoolId || null;
                             c.series = c.series || ''; // Garante campo series
                            c.lessonPlans = c.lessonPlans || {};
                            if (!c.classroomLayout) { c.classroomLayout = { rows: 5, cols: 6, teacherDeskPosition: 'top-center', seats: [] }; } else { c.classroomLayout.seats = c.classroomLayout.seats || []; const validPositions = ['top-left', 'top-center', 'top-right', 'bottom-left', 'bottom-center', 'bottom-right', 'left-top', 'left-center', 'left-bottom', 'right-top', 'right-center', 'right-bottom']; if (!validPositions.includes(c.classroomLayout.teacherDeskPosition)) { c.classroomLayout.teacherDeskPosition = 'top-center'; } }
                        });
                        appData.students.forEach(s => {
                            s.grades = s.grades || {};
                            s.attendance = s.attendance || {};
                            Object.keys(s.attendance).forEach(date => { const record = s.attendance[date]; if (record && typeof record === 'object') { record.status = record.status || null; record.justification = String(record.justification || ''); } else { s.attendance[date] = { status: null, justification: '' }; } });
                             s.notes = s.notes || []; // Garante array
                             // Garante formato de notas (pós-migração)
                             s.notes.forEach(note => {
                                 note.id = note.id || generateId('obs');
                                 note.category = note.category || 'Anotação';
                                 note.date = note.date || 'N/A';
                                 note.text = note.text || '';
                                 if(note.category !== 'Suspensão') { // Remove datas se não for suspensão
                                    delete note.startDate;
                                    delete note.endDate;
                                 }
                             });
                         });
                        appData.schedule.forEach(item => { if (item.notificationsEnabled === undefined) { item.notificationsEnabled = true; } });
                         // Garante que estruturas de notas globais tenham os campos necessários
                         appData.gradeStructures.forEach(gs => {
                             gs.id = gs.id || generateId('gs');
                             gs.name = gs.name || 'Conjunto Sem Nome';
                             gs.subject = gs.subject || 'Geral'; // Assunto padrão se migrado sem um claro
                             gs.gradeLabels = gs.gradeLabels || [];
                             gs.colorRanges = gs.colorRanges || [];
                         });


                        console.log(`Data loaded (from version ${loadedVersion}):`, appData);
                        if (loadedVersion < 15) {
                            saveData(); // Salva os dados migrados como v15
                            // Remove dados antigos se a migração foi bem sucedida (ou mesmo se falhou, para evitar tentar de novo)
                            if (localStorage.getItem('superProfessorProData_v14')) localStorage.removeItem('superProfessorProData_v14');
                            if (localStorage.getItem('superProfessorProData_v13')) localStorage.removeItem('superProfessorProData_v13');
                            console.log("Attempted migration to v15. Old versions removed.");
                        }
                    } catch (e) {
                        console.error("Erro fatal ao carregar ou validar dados:", e);
                        appData = { schools: [], classes: [], students: [], schedule: [], gradeStructures: [], settings: { theme: 'theme-light', globalNotificationsEnabled: true, notificationSoundEnabled: true, customNotificationSound: null } };
                        // Limpa versões antigas em caso de erro grave
                        localStorage.removeItem('superProfessorProData_v13');
                        localStorage.removeItem('superProfessorProData_v14');
                        localStorage.removeItem('superProfessorProData_v15');
                         alert("Ocorreu um erro crítico ao carregar seus dados. Os dados foram resetados para evitar problemas. Se você tiver um backup, pode tentar importá-lo.");

                    }
                } else {
                     // Dados completamente novos
                    appData = { schools: [], classes: [], students: [], schedule: [], gradeStructures: [], settings: { theme: 'theme-light', globalNotificationsEnabled: true, notificationSoundEnabled: true, customNotificationSound: null } };
                     console.log("Nenhum dado salvo encontrado. Iniciando com dados vazios.");
                }
                applyTheme(appData.settings.theme);
                updateNotificationSettingsUI();
                updateCustomSoundUI();
                 console.log("loadData concluído."); // Log fim
            };
            // Função auxiliar para tentar extrair matéria do nome do conjunto (ex: "Portugues - Bim 1")
            const extractSubjectFromName = (name) => {
                if (!name) return null;
                const commonSubs = commonSubjects.filter(s => s !== "Outra..."); // Não usar 'Outra'
                // Tenta encontrar uma matéria exata no início do nome, seguida por espaço ou traço
                for (const sub of commonSubs) {
                     const regex = new RegExp(`^${sub}\\s*-*`, 'i'); // Case-insensitive, opcional traço
                     if (regex.test(name)) {
                         return sub; // Retorna a matéria encontrada
                     }
                }
                // Se não encontrar, tenta uma lógica mais simples (primeira palavra se for conhecida)
                const firstWord = name.split(/[\s-]+/)[0];
                if (commonSubs.some(sub => sub.toLowerCase() === firstWord.toLowerCase())) {
                    // Retorna a primeira palavra capitalizada corretamente
                    return commonSubs.find(sub => sub.toLowerCase() === firstWord.toLowerCase());
                }
                return null; // Não conseguiu extrair
            };

            const applyTheme = (themeName) => { document.body.className = themeName || 'theme-light'; appData.settings.theme = themeName; document.querySelectorAll('.theme-button').forEach(btn => { btn.style.border = btn.dataset.theme === themeName ? '2px solid var(--accent-primary)' : 'none'; }); };
            const showSection = (sectionId) => { sections.forEach(section => section.classList.toggle('active', section.id === sectionId)); navButtons.forEach(button => button.classList.toggle('active', button.dataset.section === sectionId)); currentSection = sectionId; navClassesButton.disabled = !currentSchoolId; navDetailsButton.disabled = !currentClassId; updateHeaderInfo(); document.querySelectorAll('.fab-button').forEach(fab => fab.classList.add('hidden')); let fabToShow = null; if (sectionId === 'schedule-section') fabToShow = addScheduleButton; else if (sectionId === 'schools-section') fabToShow = addSchoolButton; else if (sectionId === 'classes-section') fabToShow = addClassButton; if (fabToShow) fabToShow.classList.remove('hidden'); mainContent.scrollTop = 0; saveAppState(); if(sectionId === 'settings-section') { updateNotificationSettingsUI(); updateCustomSoundUI(); } };
            const updateHeaderInfo = () => { let info = ''; if (currentSection === 'classes-section' && currentSchoolId) { const school = findSchoolById(currentSchoolId); info = `Escola: ${school?.name || '?'}`; } else if (currentSection === 'class-details-section' && currentClassId) { const classData = findClassById(currentClassId); const school = findSchoolById(classData?.schoolId); const seriesText = classData?.series ? ` (${sanitizeHTML(classData.series)})` : ''; info = `Escola: ${school?.name || '?'} / Turma: ${classData?.name || '?'}${seriesText}`; } else if (currentSection === 'tools-section') { info = 'Ferramentas'; } headerInfo.textContent = info; headerInfo.title = info; };
            const showModal = (title, contentHtml, footerButtonsHtml = '', modalClass = '') => { modalTitle.textContent = title; modalBody.innerHTML = contentHtml; const defaultFooter = `<button type="button" data-dismiss="modal" class="secondary">Fechar</button>`; modalFooter.innerHTML = footerButtonsHtml ? footerButtonsHtml + defaultFooter : defaultFooter; modal.className = 'modal'; if (modalClass) modal.classList.add(modalClass); modal.classList.add('show'); modal.querySelectorAll('[data-dismiss="modal"]').forEach(btn => { if (!btn.listenerAttached) { btn.addEventListener('click', hideModal); btn.listenerAttached = true; } }); };
             const hideModal = () => {
                 if (stopwatchInterval) { clearInterval(stopwatchInterval); stopwatchInterval = null; isStopwatchRunning = false; }
                 // Hide generic modal
                 modal.classList.remove('show');
                 // Hide calculator modal specifically if it's the one being shown
                 calculatorModal?.classList.remove('show');

                 setTimeout(() => {
                     // Reset generic modal content
                     modalTitle.textContent = '';
                     modalBody.innerHTML = '';
                     modalFooter.innerHTML = '';
                     modal.className = 'modal';
                     // Reset calculator modal state if needed (might be done in openAdvancedCalculatorModal)
                 }, 300);
            };
            const findSchoolById = (id) => appData.schools.find(s => s.id === id);
            const findClassById = (id) => appData.classes.find(c => c.id === id);
            const findStudentById = (id) => appData.students.find(s => s.id === id);
            const findScheduleById = (id) => appData.schedule.find(sch => sch.id === id);
            const findGradeStructureById = (id) => appData.gradeStructures.find(gs => gs.id === id); // Nova função
            const getStudentsByClass = (classId) => appData.students.filter(s => s.classId === classId).sort((a, b) => { const numA = parseInt(a.number) || Infinity; const numB = parseInt(b.number) || Infinity; if (numA !== numB) return numA - numB; return a.name.localeCompare(b.name); });
            const formatDate = (dateString) => { if(!dateString || dateString === 'N/A') return 'Data Indefinida'; try { const date = new Date(dateString + 'T00:00:00'); if (isNaN(date.getTime())) return 'Data Inválida'; return date.toLocaleDateString('pt-BR'); } catch { return dateString; } };
            const getCurrentDateString = () => new Date().toISOString().slice(0, 10);
            const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const getDayOfWeek = (year, month, day) => new Date(year, month, day).getDay();
            const sanitizeHTML = (str) => { if (str === null || str === undefined) return ''; const temp = document.createElement('div'); temp.textContent = String(str); return temp.innerHTML; };
            function getContrastYIQ(hexcolor){ if (!hexcolor || hexcolor.length < 4) return '#000000'; hexcolor = hexcolor.replace("#", ""); let r,g,b; if (hexcolor.length === 3) { r = parseInt(hexcolor.substr(0,1)+hexcolor.substr(0,1), 16); g = parseInt(hexcolor.substr(1,1)+hexcolor.substr(1,1), 16); b = parseInt(hexcolor.substr(2,1)+hexcolor.substr(2,1), 16); } else if (hexcolor.length === 6) { r = parseInt(hexcolor.substr(0,2), 16); g = parseInt(hexcolor.substr(2,2), 16); b = parseInt(hexcolor.substr(4,2), 16); } else { return '#000000'; } const yiq = ((r*299)+(g*587)+(b*114))/1000; return (yiq >= 128) ? '#000000' : '#FFFFFF'; }
            const getGradeBackgroundColor = (value, ranges) => { if (value === null || value === undefined || !Array.isArray(ranges) || ranges.length === 0) { return null; } const numericValue = parseFloat(value); if (isNaN(numericValue)) { return null; } for (const range of ranges) { const min = parseFloat(range.min); const max = parseFloat(range.max); if (!isNaN(min) && !isNaN(max) && numericValue >= min && numericValue <= max) { return range.color; } } return null; };
            const applyGradeColor = (element, value, ranges) => { const bgColor = getGradeBackgroundColor(value, ranges); if (bgColor) { element.style.backgroundColor = bgColor; element.style.color = getContrastYIQ(bgColor); } else { element.style.backgroundColor = ''; element.style.color = ''; } };

            // --- WebView/Export Helpers ---
            const isAndroidWebView = () => {
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                 // Verifica se é Android e contém 'wv' (WebView padrão) ou se não é Chrome/SamsungBrowser
                 // Isso ajuda a identificar WebViews customizados que podem não ter 'wv'
                 const isAndroid = /Android/.test(userAgent);
                 const isStandardWebView = /wv/.test(userAgent);
                 const isChrome = /Chrome/.test(userAgent) && !/Edg/.test(userAgent); // Chrome, não Edge
                 const isSamsungBrowser = /SamsungBrowser/.test(userAgent);

                 // É considerado WebView se for Android e (tiver 'wv' OU não for Chrome nem SamsungBrowser)
                 return isAndroid && (isStandardWebView || (!isChrome && !isSamsungBrowser));
            };

            const copyTextToClipboard = async (text, typeDescription = 'Dados') => {
                if (!navigator.clipboard) {
                    alert(`Erro: A Cópia para Área de Transferência não é suportada neste ambiente.`);
                    return false; // Indica falha
                }
                try {
                    await navigator.clipboard.writeText(text);
                    alert(`${typeDescription} copiados para a área de transferência!`);
                    return true; // Indica sucesso
                } catch (err) {
                    console.error(`Erro ao copiar ${typeDescription} para a área de transferência:`, err);
                    alert(`Falha ao copiar ${typeDescription}. Tente manualmente se possível.`);
                    return false; // Indica falha
                }
            };

            // --- Funções de Renderização ---
            const renderScheduleList = () => {
                 scheduleListContainer.innerHTML = '';
                 if (appData.schedule.length === 0) {
                     scheduleListContainer.innerHTML = '<p style="text-align: center; padding: 1rem;">Nenhum horário cadastrado.</p>';
                     return;
                 }

                 const todayIndex = new Date().getDay();
                 const weekdaysOrder = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
                 const getDayIndex = (dayName) => weekdaysOrder.indexOf(dayName);

                 // Ordena a lista completa
                 const sortedSchedule = [...appData.schedule].sort((a, b) => {
                     const dayIndexA = getDayIndex(a.day);
                     const dayIndexB = getDayIndex(b.day);
                     const adjustedIndexA = (dayIndexA - todayIndex + 7) % 7;
                     const adjustedIndexB = (dayIndexB - todayIndex + 7) % 7;

                     if (adjustedIndexA !== adjustedIndexB) {
                         return adjustedIndexA - adjustedIndexB;
                     } else {
                         return (a.startTime || '').localeCompare(b.startTime || '');
                     }
                 });

                 // Agrupa por dia para exibição com títulos
                 const scheduleByDay = {};
                 sortedSchedule.forEach(item => {
                     if (!scheduleByDay[item.day]) {
                         scheduleByDay[item.day] = [];
                     }
                     scheduleByDay[item.day].push(item);
                 });

                 // Renderiza na ordem correta
                 const scheduleTemplate = document.getElementById('schedule-item-template');
                 const dayOrder = [...new Set(sortedSchedule.map(item => item.day))]; // Pega a ordem dos dias da lista ordenada

                 dayOrder.forEach(day => {
                     if (scheduleByDay[day] && scheduleByDay[day].length > 0) {
                         const dayGroup = document.createElement('div');
                         dayGroup.classList.add('schedule-day-group');
                         const dayTitle = document.createElement('h3');
                         dayTitle.classList.add('schedule-day-title');
                         const isToday = getDayIndex(day) === todayIndex;
                         dayTitle.textContent = `${day}${isToday ? ' (Hoje)' : ''}`;
                         if (isToday) {
                             dayTitle.style.color = 'var(--accent-success)'; // Destaque
                         }
                         dayGroup.appendChild(dayTitle);

                         scheduleByDay[day].forEach(item => { // Itera sobre os itens já ordenados por hora dentro do dia
                             const clone = scheduleTemplate.content.cloneNode(true);
                             const scheduleElement = clone.querySelector('.schedule-item');
                             scheduleElement.dataset.id = item.id;
                             const school = findSchoolById(item.schoolId);
                             scheduleElement.querySelector('.schedule-time').textContent = `${item.startTime || '?'} - ${item.endTime || '?'}`;
                             scheduleElement.querySelector('.school-name').textContent = school ? sanitizeHTML(school.name) : 'Escola não encontrada';
                             scheduleElement.querySelector('.note').textContent = sanitizeHTML(item.note || '');
                             const notificationButton = clone.querySelector('.notification-toggle-button');
                             const notificationIndicator = clone.querySelector('.notification-indicator');
                             updateNotificationIcon(notificationIndicator, item.notificationsEnabled);
                             notificationButton.addEventListener('click', (e) => { e.stopPropagation(); toggleScheduleNotification(item.id, notificationIndicator); });
                             clone.querySelector('.edit-schedule-button').addEventListener('click', (e) => { e.stopPropagation(); openScheduleModal(item.id); });
                             clone.querySelector('.delete-schedule-button').addEventListener('click', (e) => { e.stopPropagation(); if (confirm(`Excluir horário (${item.startTime} na ${school?.name || 'escola'})?`)) { deleteScheduleEntry(item.id); } });
                             dayGroup.appendChild(clone);
                         });
                         scheduleListContainer.appendChild(dayGroup);
                     }
                 });
            };

            const updateNotificationIcon = (indicatorElement, isEnabled) => { if (!indicatorElement) return; indicatorElement.classList.remove('icon-notificacao-on', 'icon-notificacao-off'); if (isEnabled) { indicatorElement.classList.add('icon-notificacao-on'); indicatorElement.parentElement.title = "Notificações Ativadas (Clique para desativar)"; } else { indicatorElement.classList.add('icon-notificacao-off'); indicatorElement.parentElement.title = "Notificações Desativadas (Clique para ativar)"; } };

            const renderSchoolList = () => {
                schoolListContainer.innerHTML = '';
                if (appData.schools.length === 0) {
                    schoolListContainer.innerHTML = '<p style="text-align: center; padding: 1rem;">Nenhuma escola cadastrada.</p>';
                    return;
                }
                const template = document.getElementById('school-item-template');
                appData.schools.sort((a,b) => a.name.localeCompare(b.name)).forEach(school => {
                    const clone = template.content.cloneNode(true);
                    const item = clone.querySelector('.list-item');
                    item.dataset.id = school.id;
                    item.querySelector('.school-name').textContent = sanitizeHTML(school.name);
                     // Adiciona listener para o novo botão Share
                    item.querySelector('.share-school-button').addEventListener('click', (e) => {
                         e.stopPropagation();
                         openShareOptionsModal(school.id);
                     });
                    item.querySelector('.view-classes-button').addEventListener('click', (e) => { e.stopPropagation(); selectSchool(school.id); showSection('classes-section'); });
                    item.querySelector('.edit-school-button').addEventListener('click', (e) => { e.stopPropagation(); openSchoolModal(school.id); });
                    item.querySelector('.delete-school-button').addEventListener('click', (e) => { e.stopPropagation(); if (confirm(`Excluir escola "${sanitizeHTML(school.name)}" e TODOS os dados associados (turmas, alunos, notas, etc.)?`)) { deleteSchool(school.id); } });
                    item.addEventListener('click', () => { selectSchool(school.id); showSection('classes-section'); });
                    schoolListContainer.appendChild(clone);
                });
            };

             // Função de comparação para ordenar turmas
             const compareClasses = (classA, classB) => {
                const seriesA = classA.series || '';
                const seriesB = classB.series || '';
                const nameA = classA.name || '';
                const nameB = classB.name || '';

                // Tenta extrair números do início da série/ano
                const numA = parseInt(seriesA.match(/^\d+/)?.[0] || 'NaN');
                const numB = parseInt(seriesB.match(/^\d+/)?.[0] || 'NaN');

                // Compara numericamente se ambos tiverem números no início
                if (!isNaN(numA) && !isNaN(numB)) {
                    if (numA !== numB) return numA - numB;
                    // Se os números são iguais, compara o resto da string da série
                    const restA = seriesA.replace(/^\d+\s*/, '');
                    const restB = seriesB.replace(/^\d+\s*/, '');
                    if (restA !== restB) return restA.localeCompare(restB);
                } else if (!isNaN(numA)) {
                    return -1; // Número vem antes de texto
                } else if (!isNaN(numB)) {
                    return 1; // Texto vem depois de número
                }

                // Se nenhum tem número no início, ou se os números/resto são iguais, compara a string inteira da série
                if (seriesA !== seriesB) return seriesA.localeCompare(seriesB);

                // Se as séries são iguais, compara pelo nome da turma
                return nameA.localeCompare(nameB);
            };

            const renderClassList = (schoolId) => {
                 classListContainer.innerHTML = '';
                 const school = findSchoolById(schoolId);
                 classesSchoolName.textContent = school ? sanitizeHTML(school.name) : 'Selecione Escola';
                 if (!school) {
                     classListContainer.innerHTML = '<p style="text-align: center; padding: 1rem;">Escola não encontrada.</p>';
                     return;
                 }

                 let classesInSchool = appData.classes.filter(c => c.schoolId === schoolId);

                 if (classesInSchool.length === 0) {
                     classListContainer.innerHTML = `<p style="text-align: center; padding: 1rem;">Nenhuma turma cadastrada para ${sanitizeHTML(school.name)}.</p>`;
                     return;
                 }

                 // Aplicar ordem customizada se existir, senão usar a ordem padrão
                 if (school.classOrder && school.classOrder.length > 0) {
                     // Garante que a ordem customizada contenha apenas IDs válidos da escola atual
                     const currentClassIdsSet = new Set(classesInSchool.map(c => c.id));
                     school.classOrder = school.classOrder.filter(id => currentClassIdsSet.has(id));

                     const orderedClasses = [];
                     const classMap = new Map(classesInSchool.map(c => [c.id, c]));
                     school.classOrder.forEach(id => {
                         if (classMap.has(id)) {
                             orderedClasses.push(classMap.get(id));
                             classMap.delete(id); // Remove da lista original para não duplicar
                         }
                     });
                     // Adiciona classes que não estavam na ordem salva (novas classes?) no final, ordenadas por padrão
                     const remainingClasses = [...classMap.values()].sort(compareClasses);
                     classesInSchool = [...orderedClasses, ...remainingClasses];
                     // Atualiza a ordem salva caso tenha sido limpa de IDs inválidos ou novas turmas adicionadas
                     school.classOrder = classesInSchool.map(c => c.id);
                     // Não salva aqui, salva apenas quando o usuário reordena manualmente
                 } else {
                     // Ordenação padrão
                     classesInSchool.sort(compareClasses);
                 }


                 const template = document.getElementById('class-item-template');
                 classesInSchool.forEach((cls, index) => {
                     const clone = template.content.cloneNode(true);
                     const item = clone.querySelector('.list-item');
                     item.dataset.id = cls.id;
                     item.querySelector('.class-name').textContent = sanitizeHTML(cls.name);
                     // Adiciona Série/Ano aos detalhes
                     const details = [
                         cls.series ? `Série: ${sanitizeHTML(cls.series)}` : '',
                         cls.subject ? `Matéria: ${sanitizeHTML(cls.subject)}` : '',
                         cls.shift ? `Turno: ${sanitizeHTML(cls.shift)}` : '',
                         cls.schedule ? `Horário: ${sanitizeHTML(cls.schedule)}` : ''
                     ].filter(Boolean).join(' - '); // Filtra vazios e junta com hífen
                     item.querySelector('.class-details').textContent = details;


                     if(cls.id === currentClassId) item.classList.add('active');

                     // Botões de Ação
                     item.querySelector('.view-details-button').addEventListener('click', (e) => { e.stopPropagation(); selectClass(cls.id); showSection('class-details-section'); });
                     item.querySelector('.edit-class-button').addEventListener('click', (e) => { e.stopPropagation(); openClassModal(cls.id); });
                     item.querySelector('.delete-class-button').addEventListener('click', (e) => { e.stopPropagation(); if (confirm(`Excluir turma "${sanitizeHTML(cls.name)}" e TODOS os dados associados?`)) { deleteClass(cls.id); } });

                      // Botões de Reordenar
                     const upButton = item.querySelector('.move-class-up-button');
                     const downButton = item.querySelector('.move-class-down-button');
                     upButton.addEventListener('click', (e) => { e.stopPropagation(); moveClass(schoolId, cls.id, -1); });
                     downButton.addEventListener('click', (e) => { e.stopPropagation(); moveClass(schoolId, cls.id, 1); });
                     // Desabilitar botões nas extremidades
                     upButton.disabled = index === 0;
                     downButton.disabled = index === classesInSchool.length - 1;


                     item.addEventListener('click', () => { selectClass(cls.id); showSection('class-details-section'); });
                     classListContainer.appendChild(clone);
                 });
            };
            // Função para mover turma e salvar ordem
            const moveClass = (schoolId, classId, direction) => {
                 const school = findSchoolById(schoolId);
                 if (!school) return;
                 let classesInSchool = appData.classes.filter(c => c.schoolId === schoolId);

                 // Usa a ordem customizada se existir, senão cria a partir da ordem padrão
                 let currentOrder = school.classOrder && school.classOrder.length > 0
                     ? [...school.classOrder]
                     : classesInSchool.sort(compareClasses).map(c => c.id);

                  // Garante que todos os IDs atuais estejam na lista de ordem
                 const currentClassIds = new Set(classesInSchool.map(c => c.id));
                 currentOrder = currentOrder.filter(id => currentClassIds.has(id)); // Remove IDs órfãos
                 classesInSchool.forEach(c => { // Adiciona IDs novos se não existirem na ordem
                    if (!currentOrder.includes(c.id)) {
                        currentOrder.push(c.id); // Adiciona no final por padrão
                    }
                 });


                 const index = currentOrder.indexOf(classId);
                 const newIndex = index + direction;

                 if (index > -1 && newIndex >= 0 && newIndex < currentOrder.length) {
                     // Remove o item da posição antiga e insere na nova
                     const [item] = currentOrder.splice(index, 1);
                     currentOrder.splice(newIndex, 0, item);

                     // Salva a nova ordem no objeto da escola e persiste
                     school.classOrder = currentOrder;
                     saveData();
                     // Re-renderiza a lista para refletir a nova ordem
                     renderClassList(schoolId);
                 }
            };


            const renderStudentList = (classId) => {
                 studentListContainer.innerHTML = '';
                 const studentsInClass = getStudentsByClass(classId);
                 if (studentsInClass.length === 0) {
                     studentListContainer.innerHTML = '<p style="text-align: center; padding: 1rem;">Nenhum aluno nesta turma ainda.</p>';
                     return;
                 }
                 const template = document.getElementById('student-list-item-template');
                 studentsInClass.forEach(std => {
                     const clone = template.content.cloneNode(true);
                     const item = clone.querySelector('.list-item');
                     item.dataset.id = std.id;
                     item.querySelector('.student-number').textContent = std.number ? `${std.number}.` : '-.';
                     item.querySelector('.student-name').textContent = sanitizeHTML(std.name);
                     // Adiciona listener para o botão do boletim
                     item.querySelector('.view-report-card-button').addEventListener('click', (e) => {
                        e.stopPropagation();
                        openStudentReportCardModal(std.id);
                     });
                     item.querySelector('.edit-student-button').addEventListener('click', (e) => { e.stopPropagation(); openStudentModal(std.id); });
                     item.querySelector('.delete-student-button').addEventListener('click', (e) => { e.stopPropagation(); if (confirm(`Excluir aluno "${sanitizeHTML(std.name)}"?`)) { deleteStudent(std.id); } });
                     item.querySelector('.notes-student-button').addEventListener('click', (e) => { e.stopPropagation(); openStudentNotesModal(std.id); });
                     item.querySelector('.move-student-button').addEventListener('click', (e) => { e.stopPropagation(); openMoveStudentModal(std.id); });
                     item.style.cursor = 'default'; // Itens não são clicáveis diretamente
                     studentListContainer.appendChild(clone);
                 });
             };
             // Modificada para usar a estrutura global appData.gradeStructures e ter dropdown de matéria
             const renderGradeSets = (classId) => {
                 const gradesSubjectSelect = document.getElementById('grades-subject-select'); // Novo select de matéria
                 const gradeSetSelect = document.getElementById('grade-set-select'); // Select de conjunto/período
                 gradesSubjectSelect.innerHTML = '<option value="">-- Matéria --</option>';
                 gradeSetSelect.innerHTML = '<option value="">-- Período/Conjunto --</option>';
                 gradesTableContainer.innerHTML = '<p style="padding: 1rem; text-align: center;">Selecione Matéria e Período/Conjunto.</p>';
                 saveGradesButton.classList.add('hidden');
                 exportGradesCsvButton.classList.add('hidden');
                 exportGradesPdfButton.classList.add('hidden');
                 manageGradeStructureButton.style.borderColor = 'transparent'; // Reset border initially

                 // Encontrar todas as matérias únicas que têm estruturas de notas cadastradas
                 const subjectsWithStructures = [...new Set(appData.gradeStructures.map(gs => gs.subject))].sort((a,b) => a.localeCompare(b));

                 if (subjectsWithStructures.length === 0) {
                     gradesSubjectSelect.innerHTML = '<option value="">Configure 🧱</option>';
                     manageGradeStructureButton.style.borderColor = 'var(--accent-warning)';
                     return;
                 }

                 // Preencher dropdown de matérias
                 subjectsWithStructures.forEach(subject => {
                     const option = document.createElement('option');
                     option.value = subject;
                     option.textContent = sanitizeHTML(subject);
                     gradesSubjectSelect.appendChild(option);
                 });

                 // Listener para o dropdown de matérias
                 gradesSubjectSelect.onchange = () => {
                     const selectedSubject = gradesSubjectSelect.value;
                     gradeSetSelect.innerHTML = '<option value="">-- Período/Conjunto --</option>';
                     gradesTableContainer.innerHTML = '<p style="padding: 1rem; text-align: center;">Selecione um Período/Conjunto.</p>';
                     saveGradesButton.classList.add('hidden');
                     exportGradesCsvButton.classList.add('hidden');
                     exportGradesPdfButton.classList.add('hidden');

                     if (selectedSubject) {
                         // Filtrar estruturas pela matéria selecionada
                         const structuresForSubject = appData.gradeStructures.filter(gs => gs.subject === selectedSubject).sort((a,b) => a.name.localeCompare(b.name));
                         if (structuresForSubject.length > 0) {
                             structuresForSubject.forEach(gs => {
                                 const option = document.createElement('option');
                                 option.value = gs.id;
                                 option.textContent = sanitizeHTML(gs.name); // Exibe o nome completo (ex: Português - 1º Bim)
                                 gradeSetSelect.appendChild(option);
                             });
                         } else {
                              gradeSetSelect.innerHTML = '<option value="">Nenhum para esta matéria</option>';
                         }
                     }
                 };

                  // Listener para o dropdown de conjunto/período
                 gradeSetSelect.onchange = () => {
                      const selectedGradeSetId = gradeSetSelect.value;
                      if (currentClassId && selectedGradeSetId) {
                          renderGradesTable(currentClassId, selectedGradeSetId);
                      } else {
                          gradesTableContainer.innerHTML = '<p style="padding: 1rem; text-align: center;">Selecione Matéria e Período/Conjunto.</p>';
                          saveGradesButton.classList.add('hidden');
                          exportGradesCsvButton.classList.add('hidden');
                          exportGradesPdfButton.classList.add('hidden');
                      }
                 };
             };
             // Modificada para usar a estrutura global appData.gradeStructures
             const renderGradesTable = (classId, gradeSetId) => {
                 gradesTableContainer.innerHTML = '';
                 const gradeSet = findGradeStructureById(gradeSetId); // Usa a função global
                 const studentsInClass = getStudentsByClass(classId);
                 const colorRanges = gradeSet?.colorRanges || [];

                 if (!gradeSet || studentsInClass.length === 0) {
                     gradesTableContainer.innerHTML = `<p style="padding: 1rem; text-align: center;">${!gradeSet ? 'Selecione um conjunto de notas válido.' : 'Nenhum aluno para exibir notas.'}</p>`;
                     saveGradesButton.classList.add('hidden');
                     if(exportGradesCsvButton) exportGradesCsvButton.classList.add('hidden');
                     if(exportGradesPdfButton) exportGradesPdfButton.classList.add('hidden');
                     return;
                 }
                 saveGradesButton.classList.remove('hidden');
                 if(exportGradesCsvButton) exportGradesCsvButton.classList.remove('hidden');
                 if(exportGradesPdfButton) exportGradesPdfButton.classList.remove('hidden');

                 const table = document.createElement('table');
                 table.classList.add('data-table');
                 const thead = table.createTHead();
                 const tbody = table.createTBody();
                 const headerRow = thead.insertRow();

                 // Template do Cabeçalho
                 const headerTemplate = document.getElementById('grades-header-template');
                 const headerContent = headerTemplate.content.cloneNode(true);
                 headerRow.appendChild(headerContent.querySelector('.student-col').cloneNode(true));

                 // Cabeçalhos das Avaliações
                 gradeSet.gradeLabels.forEach(label => {
                     const th = document.createElement('th');
                     th.classList.add('grade-col');
                     th.textContent = sanitizeHTML(label);
                     headerRow.appendChild(th);
                 });

                 // Cabeçalhos Soma e Média
                 headerRow.appendChild(headerContent.querySelector('.sum-col').cloneNode(true));
                 headerRow.appendChild(headerContent.querySelector('.avg-col').cloneNode(true));

                 // Linhas dos Alunos
                 const rowTemplate = document.getElementById('grades-row-template');
                 studentsInClass.forEach(std => {
                     const clone = rowTemplate.content.cloneNode(true);
                     const row = clone.querySelector('tr');
                     row.dataset.studentId = std.id;
                     const studentCol = row.querySelector('.student-col');
                     if(studentCol) {
                         studentCol.querySelector('.student-number').textContent = std.number ? `${std.number}.` : '-.';
                         studentCol.querySelector('.student-name').textContent = sanitizeHTML(std.name);
                     }

                     // Remover células placeholder de soma/média do template
                     const sumCellTemplate = row.querySelector('.sum');
                     const avgCellTemplate = row.querySelector('.average');
                     if(sumCellTemplate) sumCellTemplate.remove();
                     if(avgCellTemplate) avgCellTemplate.remove();

                     const studentGradesForSet = std.grades[gradeSetId] || {};
                     const fragment = document.createDocumentFragment();

                     // Células de Notas (Inputs)
                     gradeSet.gradeLabels.forEach(label => {
                         const td = document.createElement('td');
                         td.classList.add('grade-col');
                         const input = document.createElement('input');
                         input.type = 'number';
                         input.classList.add('grade-input');
                         input.dataset.label = label;
                         input.min = "0"; input.max = "100"; input.step = "0.1";
                         input.placeholder = "-"; // Placeholder mais simples
                         const gradeValue = studentGradesForSet[label] ?? '';
                         input.value = gradeValue;
                         applyGradeColor(input, gradeValue, colorRanges);
                         input.addEventListener('input', (e) => {
                             applyGradeColor(e.target, e.target.value, colorRanges);
                             calculateAndUpdateSumAndAverage(row, gradeSet.gradeLabels, colorRanges);
                         });
                         td.appendChild(input);
                         fragment.appendChild(td);
                     });
                     studentCol.after(fragment); // Insere as colunas de notas depois da coluna do aluno

                     // Adiciona células de Soma e Média (vazias por enquanto)
                     const sumCell = document.createElement('td');
                     sumCell.classList.add('sum-col', 'sum');
                     const avgCell = document.createElement('td');
                     avgCell.classList.add('avg-col', 'average');
                     row.appendChild(sumCell);
                     row.appendChild(avgCell);

                     calculateAndUpdateSumAndAverage(row, gradeSet.gradeLabels, colorRanges); // Calcula inicial
                     tbody.appendChild(row);
                 });

                 gradesTableContainer.appendChild(table);
             };

            // --- Funções de CRUD ---
            const openScheduleModal = (scheduleIdToEdit = null) => { const isEditing = scheduleIdToEdit !== null; const scheduleData = isEditing ? findScheduleById(scheduleIdToEdit) : { day: weekdays[new Date().getDay()], notificationsEnabled: true }; const title = isEditing ? 'Editar Horário' : 'Novo Horário'; let schoolOptions = '<option value="">-- Selecione --</option>'; appData.schools.sort((a, b) => a.name.localeCompare(b.name)).forEach(s => { schoolOptions += `<option value="${s.id}" ${scheduleData.schoolId === s.id ? 'selected' : ''}>${sanitizeHTML(s.name)}</option>`; }); let dayOptions = ''; weekdays.slice(1, 6).forEach(day => { dayOptions += `<option value="${day}" ${scheduleData.day === day ? 'selected' : ''}>${day}</option>`; }); if (weekdays.includes(scheduleData.day) && !weekdays.slice(1, 6).includes(scheduleData.day)) { dayOptions += `<option value="${scheduleData.day}" selected>${scheduleData.day}</option>`; } if (!weekdays.includes(scheduleData.day)) { dayOptions += `<option value="Sábado" ${scheduleData.day === 'Sábado' ? 'selected' : ''}>Sábado</option>`; dayOptions += `<option value="Domingo" ${scheduleData.day === 'Domingo' ? 'selected' : ''}>Domingo</option>`; } const modalContent = ` <form id="schedule-form"> <input type="hidden" id="schedule-id" value="${isEditing ? scheduleIdToEdit : ''}"> <div class="form-group"> <label for="schedule-day">Dia:</label> <select id="schedule-day" required>${dayOptions}</select> </div> <div class="form-group d-flex"> <div style="flex: 1; margin-right: 5px;"> <label for="schedule-start-time">Início:</label> <input type="time" id="schedule-start-time" required value="${scheduleData.startTime || ''}"> </div> <div style="flex: 1; margin-left: 5px;"> <label for="schedule-end-time">Fim:</label> <input type="time" id="schedule-end-time" required value="${scheduleData.endTime || ''}"> </div> </div> <div class="form-group"> <label for="schedule-school">Escola:</label> <select id="schedule-school" required>${schoolOptions}</select> </div> <div class="form-group"> <label for="schedule-note">Anotação:</label> <input type="text" id="schedule-note" placeholder="Ex: Aula Turma 8B" value="${sanitizeHTML(scheduleData.note || '')}"> </div> <div class="checkbox-group"> <input type="checkbox" id="enable-schedule-notification" ${scheduleData.notificationsEnabled ? 'checked' : ''}> <label for="enable-schedule-notification">Ativar Notificações para este Horário</label> </div> </form> `; const footerButtons = `<button type="button" id="save-schedule-button" class="success"><span class="icon icon-salvar"></span> Salvar</button>`; showModal(title, modalContent, footerButtons); document.getElementById('save-schedule-button').addEventListener('click', saveScheduleEntry); };
             const saveScheduleEntry = () => { const form = document.getElementById('schedule-form'); if (!form || !form.checkValidity()) { alert('Preencha os campos obrigatórios (Dia, Horários, Escola).'); form?.reportValidity(); return; } const id = document.getElementById('schedule-id').value; const newData = { id: id || generateId('sch'), day: document.getElementById('schedule-day').value, startTime: document.getElementById('schedule-start-time').value, endTime: document.getElementById('schedule-end-time').value, schoolId: document.getElementById('schedule-school').value, note: document.getElementById('schedule-note').value.trim(), notificationsEnabled: document.getElementById('enable-schedule-notification').checked }; if (!newData.schoolId) { alert('Selecione uma escola.'); return; } if (id) { const index = appData.schedule.findIndex(item => item.id === id); if (index > -1) appData.schedule[index] = newData; } else { appData.schedule.push(newData); } saveData(); renderScheduleList(); hideModal(); };
             const deleteScheduleEntry = (id) => { appData.schedule = appData.schedule.filter(item => item.id !== id); saveData(); renderScheduleList(); };
             const toggleScheduleNotification = (scheduleId, indicatorElement) => { const item = findScheduleById(scheduleId); if (item) { item.notificationsEnabled = !item.notificationsEnabled; saveData(); updateNotificationIcon(indicatorElement, item.notificationsEnabled); console.log(`Notification for ${scheduleId} set to: ${item.notificationsEnabled}`); } };
             const openSchoolModal = (schoolIdToEdit = null) => { const isEditing = schoolIdToEdit !== null; const schoolData = isEditing ? findSchoolById(schoolIdToEdit) : {}; const title = isEditing ? 'Editar Escola' : 'Nova Escola'; const modalContent = `<form id="school-form"><input type="hidden" id="school-id" value="${isEditing ? schoolIdToEdit : ''}"><div class="form-group"><label for="school-name">Nome:</label><input type="text" id="school-name" required value="${sanitizeHTML(schoolData.name || '')}"></div></form>`; const footerButtons = `<button type="button" id="save-school-button" class="success"><span class="icon icon-salvar"></span> Salvar</button>`; showModal(title, modalContent, footerButtons); document.getElementById('save-school-button').addEventListener('click', saveSchool); };
             const saveSchool = () => { const form = document.getElementById('school-form'); if (!form || !form.checkValidity()) { alert('Preencha o nome da escola.'); form?.reportValidity(); return; } const id = document.getElementById('school-id').value; const newSchoolData = { id: id || generateId('sch'), name: document.getElementById('school-name').value.trim() }; if (id) { const index = appData.schools.findIndex(s => s.id === id); if (index > -1) appData.schools[index] = newSchoolData; } else { appData.schools.push(newSchoolData); } saveData(); renderSchoolList(); if(currentSection === 'schedule-section') renderScheduleList(); hideModal(); };
             const deleteSchool = (id) => { const classesToDelete = appData.classes.filter(c => c.schoolId === id).map(c => c.id); const studentsToDelete = appData.students.filter(s => classesToDelete.includes(s.classId)).map(s => s.id); // Guarda IDs dos alunos a serem deletados const gradeStructuresToDelete = appData.gradeStructures.filter(gs => gs.schoolId === id); // Assumindo que estruturas podem ser por escola no futuro if (!confirm(`Excluir escola "${findSchoolById(id)?.name || '?'}" e TODAS as turmas, alunos, notas, horários e estruturas de notas associadas?`)) { return; } appData.schools = appData.schools.filter(s => s.id !== id); appData.classes = appData.classes.filter(c => c.schoolId !== id); appData.students = appData.students.filter(s => !classesToDelete.includes(s.classId)); appData.schedule = appData.schedule.filter(sch => sch.schoolId !== id); // Remove estruturas de notas (se aplicável, adaptar lógica se for global) // appData.gradeStructures = appData.gradeStructures.filter(gs => gs.schoolId !== id); if (currentSchoolId === id) { currentSchoolId = null; currentClassId = null; showSection('schools-section'); } saveData(); renderSchoolList(); if (currentSection === 'schedule-section') renderScheduleList(); if (currentSection === 'classes-section' && !currentSchoolId) { showSection('schools-section'); } else if (currentSection === 'classes-section') { renderClassList(currentSchoolId); } saveAppState(); };
             const selectSchool = (id) => { currentSchoolId = id; currentClassId = null; renderClassList(id); navClassesButton.disabled = false; navDetailsButton.disabled = true; updateHeaderInfo(); saveAppState(); };
              // Modificado para incluir Série/Ano
             const openClassModal = (classIdToEdit = null) => {
                 if (!currentSchoolId) return;
                 const isEditing = classIdToEdit !== null;
                 const classData = isEditing ? findClassById(classIdToEdit) : { series: '' }; // Default series to empty string
                 const title = isEditing ? 'Editar Turma' : 'Nova Turma';
                 const schoolName = findSchoolById(currentSchoolId)?.name || '?';

                 // Criar opções para Série/Ano
                 let seriesOptionsHtml = commonSeries.map(s =>
                     `<option value="${s}" ${classData.series === s ? 'selected' : ''}>${s}</option>`
                 ).join('');
                 // Verificar se o valor atual não está na lista padrão (exceto 'Outra...')
                 const isOtherSeries = classData.series && !commonSeries.includes(classData.series);
                 // A opção 'Outra...' só deve estar selecionada se o valor NÃO estiver na lista padrão E não for vazio
                 const otherOptionSelected = isOtherSeries ? 'selected' : '';
                 const otherSeriesValue = isOtherSeries ? sanitizeHTML(classData.series) : '';


                 const modalContent = `
                     <form id="class-form">
                         <input type="hidden" id="class-id" value="${isEditing ? classIdToEdit : ''}">
                         <p class="mb-1"><strong>Escola:</strong> ${sanitizeHTML(schoolName)}</p>
                         <div class="form-group">
                             <label for="class-name">Nome Turma:</label>
                             <input type="text" id="class-name" required value="${sanitizeHTML(classData.name || '')}">
                         </div>
                         <div class="form-group">
                             <label for="class-subject">Matéria Principal:</label>
                             <input type="text" id="class-subject" placeholder="Ex: Polivalente, Português..." value="${sanitizeHTML(classData.subject || '')}">
                         </div>
                         <div class="form-group">
                             <label for="class-series-select">Série/Ano:</label>
                             <select id="class-series-select">
                                 <option value="">-- Selecione --</option>
                                 ${seriesOptionsHtml.replace('value="Outra..."', `value="Outra..." ${otherOptionSelected}`)}
                             </select>
                             <input type="text" id="class-series-other" class="${isOtherSeries ? '' : 'hidden'}" placeholder="Digite a Série/Ano" value="${otherSeriesValue}" style="margin-top: 5px;">
                         </div>
                         <div class="form-group d-flex">
                             <div style="flex: 1; margin-right: 5px;">
                                 <label for="class-schedule">Horário (Opcional):</label>
                                 <input type="time" id="class-schedule" value="${classData.schedule || ''}">
                             </div>
                             <div style="flex: 1; margin-left: 5px;">
                                 <label for="class-shift">Turno:</label>
                                 <select id="class-shift">
                                     <option value="">--</option>
                                     <option value="Manhã" ${classData.shift === 'Manhã' ? 'selected' : ''}>Manhã</option>
                                     <option value="Tarde" ${classData.shift === 'Tarde' ? 'selected' : ''}>Tarde</option>
                                     <option value="Noite" ${classData.shift === 'Noite' ? 'selected' : ''}>Noite</option>
                                     <option value="Integral" ${classData.shift === 'Integral' ? 'selected' : ''}>Integral</option>
                                 </select>
                             </div>
                         </div>
                     </form>
                 `;
                 const footerButtons = `<button type="button" id="save-class-button" class="success"><span class="icon icon-salvar"></span> Salvar</button>`;
                 showModal(title, modalContent, footerButtons);

                 // Lógica para mostrar/esconder input "Outra" Série/Ano
                 const seriesSelect = document.getElementById('class-series-select');
                 const seriesOtherInput = document.getElementById('class-series-other');
                 seriesSelect.addEventListener('change', () => {
                     seriesOtherInput.classList.toggle('hidden', seriesSelect.value !== 'Outra...');
                     if(seriesSelect.value !== 'Outra...') {
                         seriesOtherInput.value = ''; // Limpa se escolher opção padrão
                     } else {
                        seriesOtherInput.focus();
                     }
                 });

                 document.getElementById('save-class-button').addEventListener('click', saveClass);
             };
             // Modificado para salvar Série/Ano
             const saveClass = () => {
                 const form = document.getElementById('class-form');
                 if (!form || !form.checkValidity() || !currentSchoolId) {
                     alert('Preencha nome da turma e verifique escola.');
                     form?.reportValidity();
                     return;
                 }
                 const id = document.getElementById('class-id').value;
                 const isEditing = !!id;

                 // Determinar valor da Série/Ano
                 const seriesSelect = document.getElementById('class-series-select');
                 const seriesOtherInput = document.getElementById('class-series-other');
                 let finalSeries = '';
                 if (seriesSelect.value === 'Outra...') {
                    finalSeries = seriesOtherInput.value.trim();
                    if (!finalSeries) {
                        alert("Por favor, digite a Série/Ano no campo 'Outra'.");
                        seriesOtherInput.focus();
                        return;
                    }
                 } else {
                     finalSeries = seriesSelect.value; // Pode ser "" se não selecionado
                 }


                 const newClassData = {
                     id: id || generateId('cls'),
                     schoolId: currentSchoolId,
                     name: document.getElementById('class-name').value.trim(),
                     subject: document.getElementById('class-subject').value.trim(),
                     series: finalSeries, // Salva o valor final da série/ano
                     schedule: document.getElementById('class-schedule').value,
                     shift: document.getElementById('class-shift').value,
                     notes: '',
                     // gradeStructure: NÃO FICA MAIS AQUI
                     lessonPlans: {},
                     classroomLayout: { rows: 5, cols: 6, teacherDeskPosition: 'top-center', seats: [] }
                 };

                 if (isEditing) {
                     const index = appData.classes.findIndex(c => c.id === id);
                     if (index > -1) {
                         // Preservar dados existentes não editados no modal
                         newClassData.notes = appData.classes[index].notes || '';
                         newClassData.lessonPlans = appData.classes[index].lessonPlans || {};
                         newClassData.classroomLayout = appData.classes[index].classroomLayout || { rows: 5, cols: 6, teacherDeskPosition: 'top-center', seats: [] };
                         // Sobrescrever dados editados
                         appData.classes[index] = newClassData;
                     }
                 } else {
                     appData.classes.push(newClassData);
                 }

                 saveData();
                 renderClassList(currentSchoolId);
                 if (id && id === currentClassId && currentSection === 'class-details-section') {
                     selectClass(id, true); // Força recarga para mostrar novos detalhes
                 }
                 hideModal();
             };
            const deleteClass = (id) => {
                 const cls = findClassById(id);
                 if (!cls) return;
                  // Remover notas associadas a esta turma nos alunos (mais complexo com estrutura global)
                  // Poderia iterar nos alunos e remover entradas de grades cujo gradeSetId pertença a esta turma (precisaria de lógica para mapear)
                  // Por ora, apenas remove a turma e os alunos
                 appData.classes = appData.classes.filter(c => c.id !== id);
                 appData.students = appData.students.filter(s => s.classId !== id);
                 // Remover ordem customizada se existir
                 const school = findSchoolById(cls.schoolId);
                 if (school && school.classOrder) {
                     school.classOrder = school.classOrder.filter(classId => classId !== id);
                 }

                 if (currentClassId === id) {
                     currentClassId = null;
                     showSection('classes-section'); // Volta para a lista de turmas da escola
                 }
                 saveData();
                 renderClassList(currentSchoolId); // Re-renderiza a lista da escola atual
                 if (!currentClassId) navDetailsButton.disabled = true;
                 updateHeaderInfo();
                 saveAppState();
            };
             const selectClass = (id, forceReload = false) => { if (currentClassId !== id || forceReload) { console.log(`Selecionando Turma: ${id}, Forçar Recarga: ${forceReload}`); if (tempClassroomLayout) { cancelClassroomMapEdit(); } currentClassId = id; const selectedClass = findClassById(id); if (selectedClass) { // Atualiza Título com Série/Ano const seriesText = selectedClass.series ? ` (${sanitizeHTML(selectedClass.series)})` : ''; classDetailsTitle.textContent = `${sanitizeHTML(selectedClass.name)}${seriesText} (${sanitizeHTML(selectedClass.subject || 'Sem matéria')})`; renderStudentList(id); renderGradeSets(id); // Atualizado para novo sistema de seleção const currentDate = attendanceDateInput.value || getCurrentDateString(); attendanceDateInput.value = currentDate; lessonPlanDateInput.value = currentDate; renderAttendanceTable(id, currentDate); renderLessonPlan(id, currentDate); renderClassroomMap(id); classNotesContent.textContent = sanitizeHTML(selectedClass.notes || 'Nenhuma anotação.'); classNotesTextarea.value = selectedClass.notes || ''; classNotesEdit.classList.add('hidden'); classNotesDisplay.classList.remove('hidden'); if (currentSection === 'classes-section') renderClassList(selectedClass.schoolId); navDetailsButton.disabled = false; classDetailsSection.querySelectorAll('.card').forEach(card => { card.classList.remove('collapsed'); const toggleBtn = card.querySelector('.card-toggle-button .icon'); if (toggleBtn) { toggleBtn.classList.remove('icon-chevron-down'); toggleBtn.classList.add('icon-chevron-up'); toggleBtn.parentElement.title = 'Esconder'; } }); } else { currentClassId = null; classDetailsTitle.textContent = "Erro: Turma não encontrada"; studentListContainer.innerHTML = '<p>Erro</p>'; gradesTableContainer.innerHTML = '<p>Erro</p>'; attendanceTableContainer.innerHTML = '<p>Erro</p>'; lessonPlanTextarea.value = ''; saveLessonPlanButton.classList.add('hidden'); classNotesContent.textContent = 'Erro'; classroomContainerDisplay.innerHTML = '<p style="padding: 1rem; text-align: center; grid-column: 1 / -1; grid-row: 1 / -1;">Erro ao carregar mapa.</p>'; navDetailsButton.disabled = true; } updateHeaderInfo(); saveAppState(); } else if (forceReload && currentSection === 'class-details-section') { console.log(`Forçando recarga da Turma ${id}`); if (tempClassroomLayout) { cancelClassroomMapEdit(); } renderStudentList(id); renderGradeSets(id); renderAttendanceTable(id, attendanceDateInput.value || getCurrentDateString()); renderLessonPlan(id, lessonPlanDateInput.value || getCurrentDateString()); renderClassroomMap(id); } else { console.log(`Turma ${id} já selecionada, sem recarga forçada.`); } };
             const openStudentModal = (studentIdToEdit = null) => { if (!currentClassId) return; const isEditing = studentIdToEdit !== null; const studentData = isEditing ? findStudentById(studentIdToEdit) : {}; const title = isEditing ? 'Editar Aluno' : 'Novo Aluno'; const className = findClassById(currentClassId)?.name || '?'; const modalContent = `<form id="student-form"><p class="mb-1"><strong>Turma:</strong> ${sanitizeHTML(className)}</p><input type="hidden" id="student-id" value="${isEditing ? studentIdToEdit : ''}"><div class="form-group d-flex align-items-center"><div style="width: 80px; margin-right: 10px;"><label for="student-number">Nº:</label><input type="number" id="student-number" min="1" step="1" value="${studentData.number || ''}" style="padding: 0.7rem 0.5rem;"></div><div style="flex-grow: 1;"><label for="student-name">Nome:</label><input type="text" id="student-name" required value="${sanitizeHTML(studentData.name || '')}"></div></div></form>`; const footerButtons = `<button type="button" id="save-student-button" class="success"><span class="icon icon-salvar"></span> Salvar</button>`; showModal(title, modalContent, footerButtons); document.getElementById('save-student-button').addEventListener('click', saveStudent); };
             const saveStudent = () => { const form = document.getElementById('student-form'); if (!form || !form.checkValidity()) { alert('Preencha o nome do aluno.'); form?.reportValidity(); return; } const id = document.getElementById('student-id').value; const studentName = document.getElementById('student-name').value.trim(); const studentNumberInput = document.getElementById('student-number').value; const studentNumber = studentNumberInput ? parseInt(studentNumberInput) : null; if (!currentClassId) return; if (id) { const student = findStudentById(id); if (student) { student.name = studentName; student.number = studentNumber; } } else { const newStudent = { id: generateId('std'), name: studentName, number: studentNumber, classId: currentClassId, grades: {}, attendance: {}, notes: [] }; appData.students.push(newStudent); } saveData(); renderStudentList(currentClassId); // Re-renderiza lista de alunos renderAttendanceTable(currentClassId, attendanceDateInput.value || getCurrentDateString()); // Atualiza tabela de presença se visível renderClassroomMap(currentClassId); hideModal(); };
             const deleteStudent = (id) => { if (currentClassId) { const cls = findClassById(currentClassId); if (cls?.classroomLayout?.seats) { cls.classroomLayout.seats.forEach(seat => { if (seat.studentId === id) { seat.studentId = null; } }); } } appData.students = appData.students.filter(s => s.id !== id); saveData(); renderStudentList(currentClassId); // Re-renderiza as tabelas afetadas if (gradesSubjectSelect.value && gradeSetSelect.value) renderGradesTable(currentClassId, gradeSetSelect.value); if (attendanceDateInput.value) renderAttendanceTable(currentClassId, attendanceDateInput.value); renderClassroomMap(currentClassId); };
              // Modificado para Categorias e Suspensão
              const openStudentNotesModal = (studentId) => {
                 const student = findStudentById(studentId);
                 if (!student) return;
                 if (!Array.isArray(student.notes)) student.notes = [];

                 const title = `Observações - ${student.number ? student.number + '. ' : ''}${sanitizeHTML(student.name)}`;

                 let categoryOptions = observationCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');

                 const modalContent = `
                     <div id="student-observations-list" style="margin-bottom: 1rem;"></div>
                     <div id="add-observation-section" style="border-top: 1px solid var(--border-color); padding-top: 1rem;">
                         <form id="add-observation-form">
                             <input type="hidden" id="editing-observation-id" value="">
                             <div class="form-group">
                                 <label for="new-observation-category">Tipo:</label>
                                 <select id="new-observation-category" style="width: auto; padding: 0.5rem;">
                                     ${categoryOptions}
                                 </select>
                             </div>
                              <div id="suspension-dates-group" class="form-group hidden" style="display: flex; gap: 10px; align-items: center;">
                                 <label>Período Suspensão:</label>
                                 <div class="form-group inline-input">
                                     <label for="new-observation-start-date" class="text-sm">Início:</label>
                                     <input type="date" id="new-observation-start-date" style="padding: 0.4rem;">
                                 </div>
                                 <div class="form-group inline-input">
                                     <label for="new-observation-end-date" class="text-sm">Fim:</label>
                                     <input type="date" id="new-observation-end-date" style="padding: 0.4rem;">
                                 </div>
                             </div>
                             <div class="form-group">
                                 <label for="new-observation-text">Descrição:</label>
                                 <textarea id="new-observation-text" placeholder="Digite a descrição..."></textarea>
                             </div>
                             <button type="button" id="save-observation-button" class="success">
                                 <span class="icon icon-adicionar"></span> Salvar Registro
                             </button>
                              <button type="button" id="cancel-edit-observation-button" class="secondary hidden" style="margin-left: 5px;">Cancelar Edição</button>
                         </form>
                     </div>`;

                 showModal(title, modalContent, '', 'student-notes-modal');
                 renderStudentObservations(studentId); // Renderiza a lista inicial

                 const categorySelect = document.getElementById('new-observation-category');
                 const suspensionDatesGroup = document.getElementById('suspension-dates-group');
                 const saveButton = document.getElementById('save-observation-button');
                 const cancelButton = document.getElementById('cancel-edit-observation-button');
                 const textInput = document.getElementById('new-observation-text');
                 const startDateInput = document.getElementById('new-observation-start-date');
                 const endDateInput = document.getElementById('new-observation-end-date');
                 const editingIdInput = document.getElementById('editing-observation-id');

                 // Mostrar/esconder datas de suspensão
                 categorySelect.addEventListener('change', () => {
                     suspensionDatesGroup.classList.toggle('hidden', categorySelect.value !== 'Suspensão');
                 });

                 // Salvar (Adicionar ou Editar)
                 saveButton.addEventListener('click', () => {
                     const category = categorySelect.value;
                     const text = textInput.value.trim();
                     const startDate = category === 'Suspensão' ? startDateInput.value : null;
                     const endDate = category === 'Suspensão' ? endDateInput.value : null;
                     const editingId = editingIdInput.value;

                     if (!text) {
                         alert("Por favor, digite a descrição.");
                         textInput.focus();
                         return;
                     }
                     if (category === 'Suspensão' && (!startDate || !endDate)) {
                         alert("Por favor, preencha as datas de início e fim da suspensão.");
                         return;
                     }
                      if (category === 'Suspensão' && startDate > endDate) {
                         alert("A data de início da suspensão não pode ser depois da data final.");
                         return;
                     }


                     if (editingId) {
                         // Editando existente
                         editStudentObservation(studentId, editingId, category, text, startDate, endDate);
                     } else {
                         // Adicionando nova
                         addStudentObservation(studentId, category, text, startDate, endDate);
                     }

                     // Limpar formulário após salvar/editar
                     editingIdInput.value = '';
                     categorySelect.value = 'Anotação';
                     textInput.value = '';
                     startDateInput.value = '';
                     endDateInput.value = '';
                     suspensionDatesGroup.classList.add('hidden');
                     saveButton.innerHTML = '<span class="icon icon-adicionar"></span> Salvar Registro';
                     cancelButton.classList.add('hidden');
                 });

                 // Cancelar Edição
                 cancelButton.addEventListener('click', () => {
                      editingIdInput.value = '';
                      categorySelect.value = 'Anotação';
                      textInput.value = '';
                      startDateInput.value = '';
                      endDateInput.value = '';
                      suspensionDatesGroup.classList.add('hidden');
                      saveButton.innerHTML = '<span class="icon icon-adicionar"></span> Salvar Registro';
                      cancelButton.classList.add('hidden');
                 });


                 // Listeners para Editar/Excluir na lista
                 document.getElementById('student-observations-list').addEventListener('click', (e) => {
                     const deleteButton = e.target.closest('.delete-observation-button');
                     const editButton = e.target.closest('.edit-observation-button'); // Precisa adicionar este botão no template

                     if (deleteButton) {
                         const itemElement = deleteButton.closest('.observation-item');
                         const obsId = itemElement.dataset.id;
                         if (obsId && confirm("Excluir este registro?")) {
                             deleteStudentObservation(studentId, obsId);
                         }
                     } else if (editButton) {
                         const itemElement = editButton.closest('.observation-item');
                         const obsId = itemElement.dataset.id;
                         const student = findStudentById(studentId);
                         const noteToEdit = student?.notes.find(n => n.id === obsId);
                         if(noteToEdit) {
                             editingIdInput.value = noteToEdit.id;
                             categorySelect.value = noteToEdit.category;
                             textInput.value = noteToEdit.text;
                             startDateInput.value = noteToEdit.startDate || '';
                             endDateInput.value = noteToEdit.endDate || '';
                             suspensionDatesGroup.classList.toggle('hidden', noteToEdit.category !== 'Suspensão');
                             saveButton.innerHTML = '<span class="icon icon-salvar"></span> Atualizar Registro';
                             cancelButton.classList.remove('hidden');
                             textInput.focus(); // Foca no texto para edição
                         }
                     }
                 });
             };
             // Modificada para Categorias
             const renderStudentObservations = (studentId) => {
                 const student = findStudentById(studentId);
                 const listContainer = document.getElementById('student-observations-list');
                 if (!student || !listContainer) return;
                 listContainer.innerHTML = '';
                 if (!student.notes || student.notes.length === 0) {
                     listContainer.innerHTML = '<p style="text-align: center; padding: 1rem; color: var(--text-secondary);">Nenhum registro encontrado.</p>';
                     return;
                 }

                 // Ordena por data (mais recente primeiro)
                 const sortedNotes = [...student.notes].sort((a, b) => (b.date || '').localeCompare(a.date || ''));

                 const template = document.getElementById('observation-item-template');
                 sortedNotes.forEach(note => {
                     const clone = template.content.cloneNode(true);
                     const itemElement = clone.querySelector('.observation-item');
                     itemElement.dataset.id = note.id; // Usa o ID único
                     // Adiciona classe css para estilo baseado na categoria
                     const categoryClass = `category-${note.category.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, '-')}`;
                     itemElement.classList.add(categoryClass);


                     const detailsDiv = itemElement.querySelector('.observation-details');
                     detailsDiv.innerHTML = `
                         <span class="observation-category">${sanitizeHTML(note.category)}</span>
                         <span class="observation-date">${formatDate(note.date)}</span>
                         ${note.category === 'Suspensão' && note.startDate && note.endDate ? `<span class="observation-suspension-dates">(${formatDate(note.startDate)} a ${formatDate(note.endDate)})</span>` : ''}
                         <p class="observation-text">${sanitizeHTML(note.text)}</p>
                     `;

                     // Adiciona botão de editar ao lado do de excluir
                      const actionContainer = itemElement.querySelector('.list-item-actions'); // Pega o container de botões
                      if(!actionContainer) { // Cria se não existir no template
                        actionContainer = document.createElement('div');
                        actionContainer.className = 'list-item-actions';
                        itemElement.appendChild(actionContainer)
                      }

                      const deleteButton = itemElement.querySelector('.delete-observation-button'); // Pega o botão original
                      const editButton = document.createElement('button');
                      editButton.type = 'button';
                      editButton.className = 'edit-observation-button secondary icon-button';
                      editButton.title = 'Editar Registro';
                      editButton.innerHTML = '<span class="icon icon-editar icon-only"></span>';
                      actionContainer.insertBefore(editButton, deleteButton); // Insere antes

                     listContainer.appendChild(clone);
                 });
             };
             // Modificada para Categorias
             const addStudentObservation = (studentId, category, text, startDate = null, endDate = null) => {
                 const student = findStudentById(studentId);
                 if (!student) return;
                 const newObservation = {
                     id: generateId('obs'), // Gera ID único
                     date: getCurrentDateString(),
                     category: category,
                     text: text
                 };
                 if (category === 'Suspensão' && startDate && endDate) {
                    newObservation.startDate = startDate;
                    newObservation.endDate = endDate;
                 }

                 if (!Array.isArray(student.notes)) student.notes = [];
                 student.notes.push(newObservation);
                 saveData();
                 renderStudentObservations(studentId); // Re-renderiza a lista
                 if(category === 'Suspensão') renderAttendanceTable(currentClassId, attendanceDateInput.value); // Atualiza chamada
             };
             // Nova função para Editar
              const editStudentObservation = (studentId, observationId, category, text, startDate = null, endDate = null) => {
                 const student = findStudentById(studentId);
                 if (!student || !student.notes) return;
                 const noteIndex = student.notes.findIndex(n => n.id === observationId);
                 if (noteIndex > -1) {
                     student.notes[noteIndex].category = category;
                     student.notes[noteIndex].text = text;
                     student.notes[noteIndex].date = getCurrentDateString(); // Atualiza data da edição
                     if (category === 'Suspensão' && startDate && endDate) {
                         student.notes[noteIndex].startDate = startDate;
                         student.notes[noteIndex].endDate = endDate;
                     } else {
                         // Remove datas se não for mais suspensão
                         delete student.notes[noteIndex].startDate;
                         delete student.notes[noteIndex].endDate;
                     }
                     saveData();
                     renderStudentObservations(studentId); // Re-renderiza a lista
                     renderAttendanceTable(currentClassId, attendanceDateInput.value); // Atualiza chamada
                 }
             };
             // Modificada para usar ID
             const deleteStudentObservation = (studentId, observationId) => {
                 const student = findStudentById(studentId);
                 if (!student || !Array.isArray(student.notes)) return;
                 const originalNote = student.notes.find(note => note.id === observationId); // Pega a nota antes de deletar
                 student.notes = student.notes.filter(note => note.id !== observationId);
                 saveData();
                 renderStudentObservations(studentId); // Re-renderiza a lista
                  if(originalNote && originalNote.category === 'Suspensão') renderAttendanceTable(currentClassId, attendanceDateInput.value); // Atualiza chamada se era suspensão
             };
             // Função para verificar suspensão
             const isStudentSuspended = (studentId, dateString) => {
                const student = findStudentById(studentId);
                if (!student || !student.notes || !dateString) return false;
                return student.notes.some(note =>
                    note.category === 'Suspensão' &&
                    note.startDate &&
                    note.endDate &&
                    dateString >= note.startDate &&
                    dateString <= note.endDate
                );
             };
              // Modificada para verificar suspensão
             const renderAttendanceTable = (classId, date) => {
                 attendanceTableContainer.innerHTML = '';
                 saveAttendanceButton.classList.add('hidden');
                 attendanceActionsContainer.classList.add('hidden');
                 const studentsInClass = getStudentsByClass(classId);

                 if (!date) {
                     attendanceTableContainer.innerHTML = '<p style="padding: 1rem; text-align: center;">Selecione uma data.</p>';
                     return;
                 }
                 if (studentsInClass.length === 0) {
                     attendanceTableContainer.innerHTML = '<p style="padding: 1rem; text-align: center;">Nenhum aluno para registrar presença.</p>';
                     return;
                 }

                 const isNonSchoolDay = studentsInClass.every(std => std.attendance[date]?.status === 'H');
                 console.log(`Rendering attendance for ${date}. Is Non-School Day: ${isNonSchoolDay}`);

                 attendanceActionsContainer.classList.remove('hidden');
                 saveAttendanceButton.classList.remove('hidden');
                 markAllPresentButton.disabled = isNonSchoolDay;

                 if (isNonSchoolDay) {
                     markNonSchoolDayButton.innerHTML = `<span class="icon icon-nao-letivo"></span>Desm. Não Letivo`;
                     markNonSchoolDayButton.classList.remove('secondary');
                     markNonSchoolDayButton.classList.add('danger');
                     markNonSchoolDayButton.title = "Reverter para dia letivo normal";
                 } else {
                     markNonSchoolDayButton.innerHTML = `<span class="icon icon-nao-letivo"></span>Não Letivo`;
                     markNonSchoolDayButton.classList.remove('danger');
                     markNonSchoolDayButton.classList.add('secondary');
                     markNonSchoolDayButton.title = "Marcar este dia como não letivo";
                 }

                 const table = document.createElement('table');
                 table.classList.add('data-table');
                 table.innerHTML = `<thead><tr><th class="student-col">Aluno</th><th class="attendance-status">Status</th></tr></thead><tbody></tbody>`;
                 const tbody = table.querySelector('tbody');
                 const template = document.getElementById('attendance-row-template');

                 studentsInClass.forEach(std => {
                     const studentId = std.id;
                     const clone = template.content.cloneNode(true);
                     const row = clone.querySelector('tr');
                     row.dataset.studentId = studentId;
                     const studentCol = row.querySelector('.student-col');
                     studentCol.querySelector('.student-number').textContent = std.number ? `${std.number}.` : '-.';
                     studentCol.querySelector('.student-name').textContent = sanitizeHTML(std.name);

                     const statusCell = row.querySelector('.attendance-status');
                     if (!std.attendance[date]) std.attendance[date] = { status: null, justification: '' };
                     const currentStatus = std.attendance[date].status;
                     const currentJustification = std.attendance[date].justification || '';
                     const suspended = isStudentSuspended(studentId, date); // Verifica suspensão

                     statusCell.innerHTML = '';
                     statusCell.className = 'attendance-status'; // Reset classes

                     if (suspended) {
                         statusCell.innerHTML = `<span class="icon icon-suspensao"></span> Susp.`;
                         statusCell.classList.add('status-S'); // Classe para estilo de suspenso
                         statusCell.title = `Suspenso nesta data (${formatDate(date)})`;
                     } else if (currentStatus === 'H') {
                         statusCell.textContent = 'H';
                         statusCell.classList.add('status-H');
                         statusCell.title = `Dia não letivo (${formatDate(date)})`;
                     } else {
                         statusCell.innerHTML = `
                             <button type="button" class="attendance-toggle present" data-status="P" title="Presente"><span class="icon icon-presenca"></span> P</button>
                             <button type="button" class="attendance-toggle absent" data-status="F" title="Faltou/Justificar"><span class="icon icon-falta"></span> F</button>
                         `;
                         const presentButton = statusCell.querySelector('.attendance-toggle.present');
                         const absentButton = statusCell.querySelector('.attendance-toggle.absent');
                         presentButton.disabled = isNonSchoolDay;
                         absentButton.disabled = isNonSchoolDay;

                         const updateButtonUI = (status, justification) => {
                             presentButton.classList.toggle('selected', status === 'P');
                             absentButton.classList.toggle('selected', status === 'F');
                             absentButton.classList.toggle('justified', status === 'F' && !!justification);
                             const isJustified = status === 'F' && !!justification;
                             absentButton.innerHTML = `<span class="icon icon-falta"></span> ${isJustified ? 'FJ' : 'F'}`;
                             absentButton.title = isJustified ? `Falta Justificada: ${sanitizeHTML(justification.substring(0, 30))}... (Clique para editar)` : 'Faltou (Clique para justificar)';
                         };
                         updateButtonUI(currentStatus, currentJustification);

                         presentButton.addEventListener('click', () => {
                             if (presentButton.disabled) return;
                             const student = findStudentById(studentId);
                             if (!student) return;
                             if (!student.attendance[date]) student.attendance[date] = { status: null, justification: '' };
                             if (student.attendance[date].status === 'P') {
                                 student.attendance[date].status = null;
                             } else {
                                 student.attendance[date].status = 'P';
                             }
                             student.attendance[date].justification = '';
                             updateButtonUI(student.attendance[date].status, '');
                         });

                         absentButton.addEventListener('click', () => {
                             if (absentButton.disabled) return;
                             const student = findStudentById(studentId);
                             if (!student) return;
                             if (!student.attendance[date]) student.attendance[date] = { status: null, justification: '' };
                             if (student.attendance[date].status === 'F') {
                                 openJustificationModal(studentId, date);
                             } else {
                                 student.attendance[date].status = 'F';
                                 student.attendance[date].justification = '';
                                 updateButtonUI('F', '');
                             }
                         });
                     }
                     tbody.appendChild(row);
                 });
                 attendanceTableContainer.appendChild(table);
             };

            // --- MODIFIED/NEW EXPORT/IMPORT FUNCTIONS ---

             const isAndroidWebView = () => {
                 const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                 // Verifica se é Android e contém 'wv' (WebView padrão) ou se não é Chrome/SamsungBrowser
                 // Isso ajuda a identificar WebViews customizados que podem não ter 'wv'
                 const isAndroid = /Android/.test(userAgent);
                 const isStandardWebView = /wv/.test(userAgent);
                 const isChrome = /Chrome/.test(userAgent) && !/Edg/.test(userAgent); // Chrome, não Edge
                 const isSamsungBrowser = /SamsungBrowser/.test(userAgent);

                 // É considerado WebView se for Android e (tiver 'wv' OU não for Chrome nem SamsungBrowser)
                 return isAndroid && (isStandardWebView || (!isChrome && !isSamsungBrowser));
             };

             const copyTextToClipboard = async (text, typeDescription = 'Dados') => {
                 if (!navigator.clipboard) {
                     alert(`Erro: A Cópia para Área de Transferência não é suportada neste ambiente.`);
                     return false; // Indica falha
                 }
                 try {
                     await navigator.clipboard.writeText(text);
                     alert(`${typeDescription} copiados para a área de transferência!`);
                     return true; // Indica sucesso
                 } catch (err) {
                     console.error(`Erro ao copiar ${typeDescription} para a área de transferência:`, err);
                     alert(`Falha ao copiar ${typeDescription}. Tente manualmente se possível.`);
                     return false; // Indica falha
                 }
             };

             const exportData = () => {
                 const dataStr = JSON.stringify(appData, null, 2);
                 const exportFileDefaultName = `super_professor_pro_backup_v15_${new Date().toISOString().slice(0,10)}.json`; // Versiona o backup

                 if (isAndroidWebView()) {
                     copyTextToClipboard(dataStr, 'Backup Completo (JSON)');
                 } else {
                     const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                     const linkElement = document.createElement('a');
                     linkElement.setAttribute('href', dataUri);
                     linkElement.setAttribute('download', exportFileDefaultName);
                     document.body.appendChild(linkElement);
                     linkElement.click();
                     document.body.removeChild(linkElement);
                 }
             };

            const exportGradesCSV = () => {
                const gradeSetId = gradeSetSelect.value; // Usa o select de período/conjunto
                if (!currentClassId || !gradeSetId) { alert("Selecione uma turma, matéria e período/conjunto para exportar notas."); return; }
                const gradeSet = findGradeStructureById(gradeSetId);
                const students = getStudentsByClass(currentClassId);
                                if (!gradeSet || students.length === 0) { alert("Nenhum dado de nota para exportar."); return; }
                const currentClass = findClassById(currentClassId);
                const className = currentClass?.name.replace(/[^a-z0-9]/gi, '_') || 'Turma';
                const setName = gradeSet.name.replace(/[^a-z0-9]/gi, '_') || 'Conjunto';
                const filename = `notas_${className}_${setName}.csv`;

                // Gerar conteúdo CSV
                let csvContent = "\uFEFF";
                let header = [escapeCsvField("Aluno"), escapeCsvField("No.")];
                gradeSet.gradeLabels.forEach(label => header.push(escapeCsvField(label)));
                header.push(escapeCsvField("Soma"));
                header.push(escapeCsvField("Média"));
                csvContent += header.join(",") + "\r\n";
                students.forEach(student => {
                    const studentGrades = student.grades[gradeSetId] || {};
                    const calculated = calculateSumAndAverageForData(studentGrades); // Reusa a função de cálculo
                    let row = [escapeCsvField(student.name), escapeCsvField(student.number || '')];
                    gradeSet.gradeLabels.forEach(label => {
                        const gradeValue = studentGrades[label];
                        // Usa vírgula como separador decimal para CSV
                        row.push(escapeCsvField(gradeValue !== null && gradeValue !== undefined ? String(gradeValue).replace('.', ',') : ''));
                    });
                    row.push(escapeCsvField(calculated.sum !== null ? calculated.sum.toFixed(1).replace('.', ',') : ''));
                    row.push(escapeCsvField(calculated.average !== null ? calculated.average.toFixed(1).replace('.', ',') : ''));
                    csvContent += row.join(",") + "\r\n";
                });

                // Exportar ou Copiar
                if (isAndroidWebView()) {
                    copyTextToClipboard(csvContent, `Notas CSV (${setName})`);
                } else {
                    const encodedUri = encodeURI(`data:text/csv;charset=utf-8,${csvContent}`);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", filename);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };

             const exportGradesPDF = async (button = exportGradesPdfButton) => {
                const gradeSetId = gradeSetSelect.value; // Usa o select de período/conjunto
                if (!currentClassId || !gradeSetId) { alert("Selecione uma turma, matéria e período/conjunto para gerar PDF."); return; }
                const gradeSet = findGradeStructureById(gradeSetId);
                const students = getStudentsByClass(currentClassId);
                 if (!gradeSet || students.length === 0) { alert("Nenhum dado de nota para gerar PDF."); return; }
                 const currentClass = findClassById(currentClassId);

                 if (isAndroidWebView()) {
                    alert("Exportação de PDF não suportada diretamente no app. Use a versão web ou exporte como CSV e converta externamente.");
                    return; // Aborta a geração no WebView
                 }

                 // Geração de PDF continua apenas para navegador
                 const classNameSanitized = currentClass?.name.replace(/[^a-z0-9]/gi, '_') || 'Turma';
                 const setNameSanitized = gradeSet.name.replace(/[^a-z0-9]/gi, '_') || 'Conjunto';
                 const filename = `notas_${classNameSanitized}_${setNameSanitized}.pdf`;

                 let tableHTML = ` <style> body { font-family: sans-serif; font-size: 9pt; } .pdf-table { border-collapse: collapse; width: 100%; margin-top: 10px; table-layout: fixed; } .pdf-table th, .pdf-table td { border: 1px solid #ccc; padding: 3px 4px; text-align: left; word-wrap: break-word; overflow-wrap: break-word; } .pdf-table th { background-color: #f2f2f2; font-weight: bold; text-align: center; font-size: 8pt; } .pdf-table td { font-size: 8pt; } .pdf-table td.grade, .pdf-table td.sum, .pdf-table td.avg { text-align: center; } .pdf-table td.student-name { min-width: 100px; white-space: normal; } .pdf-table th.student-col { min-width: 105px; } .pdf-table th.grade-col { min-width: 40px; } .pdf-table th.sum-col, .pdf-table th.avg-col { min-width: 45px; } .pdf-table .number { font-weight: bold; display: inline-block; min-width: 15px; text-align: right; margin-right: 4px;} h4 { text-align: center; margin-bottom: 10px; font-size: 11pt; } </style> <h4>Notas - Turma: ${sanitizeHTML(currentClass.name)} (${sanitizeHTML(currentClass.series || '')}) - ${sanitizeHTML(gradeSet.subject || '')} - ${sanitizeHTML(gradeSet.name)}</h4> <table class="pdf-table"> <thead> <tr> <th class="student-col">Aluno</th> `; gradeSet.gradeLabels.forEach(label => { tableHTML += `<th class="grade-col">${sanitizeHTML(label)}</th>`; }); tableHTML += `<th class="sum-col">Soma</th><th class="avg-col">Média</th></tr></thead><tbody>`; students.forEach(student => { const studentGrades = student.grades[gradeSetId] || {}; const calculated = calculateSumAndAverageForData(studentGrades); tableHTML += `<tr><td class="student-name"><span class="number">${student.number || '-.'}</span>${sanitizeHTML(student.name)}</td>`; gradeSet.gradeLabels.forEach(label => { const gradeValue = studentGrades[label]; tableHTML += `<td class="grade">${(gradeValue !== null && gradeValue !== undefined) ? sanitizeHTML(String(gradeValue).replace('.',',')) : '-'}</td>`; }); tableHTML += `<td class="sum">${(calculated.sum !== null) ? calculated.sum.toFixed(1).replace('.', ',') : '-'}</td>`; tableHTML += `<td class="avg">${(calculated.average !== null) ? calculated.average.toFixed(1).replace('.', ',') : '-'}</td>`; tableHTML += `</tr>`; }); tableHTML += `</tbody></table>`;

                 const opt = { margin: [8, 5, 8, 5], filename: filename, image: { type: 'jpeg', quality: 0.95 }, html2canvas: { scale: 2, useCORS: true, logging: false, }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }, pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } };

                 const originalButtonText = button.innerHTML;
                 button.disabled = true;
                 button.innerHTML = '<span class="icon">⏳</span>';

                 try {
                     console.log("Gerando PDF para download (Browser)...");
                     await html2pdf().set(opt).from(tableHTML).save();
                     console.log("PDF de notas gerado com sucesso.");
                 } catch (error) {
                     console.error("Erro ao gerar PDF de notas:", error);
                     alert("Ocorreu um erro ao gerar o PDF de notas. Verifique o console para detalhes.");
                 } finally {
                     button.disabled = false;
                     button.innerHTML = originalButtonText;
                 }
            };

             const exportMonthlyAttendanceCSV = (classId, year, month) => {
                 const students = getStudentsByClass(classId);
                 if (students.length === 0) { alert("Nenhum aluno na turma para exportar."); return; }
                 const currentClass = findClassById(classId);
                 const className = currentClass?.name.replace(/[^a-z0-9]/gi, '_') || 'Turma';
                 const monthName = monthNames[month];
                 const daysInMonth = getDaysInMonth(year, month);
                 const filename = `frequencia_${className}_${year}_${monthName}.csv`;

                 // Generate CSV Content (same as before)
                 let csvContent = "\uFEFF"; // BOM
                 let header = [escapeCsvField("Aluno"), escapeCsvField("No.")];
                 for (let day = 1; day <= daysInMonth; day++) { header.push(escapeCsvField(String(day))); }
                 header.push(escapeCsvField("Presente"));
                 header.push(escapeCsvField("Falta"));
                 header.push(escapeCsvField("Falta Just."));
                 header.push(escapeCsvField("Dias Não Letivos/Susp.")); // Inclui Suspensão aqui
                 header.push(escapeCsvField("% Freq. (Letivos)"));
                 csvContent += header.join(",") + "\r\n";

                 students.forEach(student => {
                     let row = [escapeCsvField(student.name), escapeCsvField(student.number || '')];
                     let studentP = 0, studentF = 0, studentFJ = 0, studentH = 0, studentS = 0, studentPossibleDays = 0; // Adiciona contador Suspenso (S)
                     for (let day = 1; day <= daysInMonth; day++) {
                         const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                         const attendanceRecord = student.attendance[dateStr];
                         const status = attendanceRecord?.status;
                         const justification = attendanceRecord?.justification || '';
                         const dayOfWeek = getDayOfWeek(year, month, day);
                         const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                         const isSuspended = isStudentSuspended(student.id, dateStr); // Verifica suspensão
                         let cellValue = '';

                         if (isWeekend) { cellValue = ''; }
                         else if (isSuspended) { cellValue = 'S'; studentS++; } // Marca como Suspenso
                         else if (status === 'H') { cellValue = 'H'; studentH++; }
                         else {
                             studentPossibleDays++; // Só conta como dia letivo se não for Fim de Semana, Feriado ou Suspensão
                             if (status === 'P') { cellValue = 'P'; studentP++; }
                             else if (status === 'F') { if (justification) { cellValue = 'FJ'; studentFJ++; } else { cellValue = 'F'; studentF++; } }
                             else { cellValue = '-'; } // Dia letivo sem marcação
                         }
                         row.push(escapeCsvField(cellValue));
                     }
                     // Calcula frequência apenas sobre dias letivos possíveis (excluindo H e S)
                     const frequency = studentPossibleDays > 0 ? ((studentP / studentPossibleDays) * 100).toFixed(0) + '%' : (students.length > 0 ? '0%' : '--');
                     row.push(escapeCsvField(studentP));
                     row.push(escapeCsvField(studentF));
                     row.push(escapeCsvField(studentFJ));
                     row.push(escapeCsvField(studentH + studentS)); // Soma Feriados e Suspensões
                     row.push(escapeCsvField(frequency));
                     csvContent += row.join(",") + "\r\n";
                 });

                 // Exportar ou Copiar
                 if (isAndroidWebView()) {
                     copyTextToClipboard(csvContent, `Frequência CSV (${monthName}/${year})`);
                 } else {
                     const encodedUri = encodeURI(`data:text/csv;charset=utf-8,${csvContent}`);
                     const link = document.createElement("a");
                     link.setAttribute("href", encodedUri);
                     link.setAttribute("download", filename);
                     document.body.appendChild(link);
                     link.click();
                     document.body.removeChild(link);
                 }
             };

             const exportMonthlyAttendancePDF = async (classId, year, month, button) => {
                 const students = getStudentsByClass(classId);
                 if (students.length === 0) { alert("Nenhum aluno na turma para gerar PDF."); return; }
                 const currentClass = findClassById(classId);

                 if (isAndroidWebView()) {
                     alert("Exportação de PDF não suportada diretamente no app. Use a versão web ou exporte como CSV.");
                     return; // Aborta no WebView
                 }

                 // Continua apenas no navegador
                 const classNameSanitized = currentClass?.name.replace(/[^a-z0-9]/gi, '_') || 'Turma';
                 const monthName = monthNames[month];
                 const filename = `frequencia_${classNameSanitized}_${year}_${monthName}.pdf`;
                 const daysInMonth = getDaysInMonth(year, month);

                 let tableHTML = ` <style> body { font-family: sans-serif; font-size: 7pt; } .pdf-table { border-collapse: collapse; width: 100%; margin-top: 8px; table-layout: fixed; } .pdf-table th, .pdf-table td { border: 1px solid #ccc; padding: 2px 3px; text-align: center; word-wrap: break-word; overflow-wrap: break-word; } .pdf-table th { background-color: #f2f2f2; font-weight: bold; font-size: 7pt; } .pdf-table td { font-size: 7pt; } .pdf-table td.student-col { text-align: left; min-width: 90px; white-space: normal; } .pdf-table th.student-col { min-width: 90px; } .pdf-table th.day-col, .pdf-table td.day-col { min-width: 15px; max-width:16px; } .pdf-table td.weekend { background-color: #eee; } .pdf-table td.status-H { background-color: #e2e3e5; color: #495057; font-style: italic; } .pdf-table td.status-S { background-color: #f8d7da; color: #721c24; font-weight: bold; font-style: italic; } /* Estilo PDF para Suspenso */ .pdf-table th.summary-col, .pdf-table td.summary-col { font-weight: bold; min-width: 20px; max-width: 25px; font-size: 6pt; } .pdf-table .number { font-weight: bold; display: inline-block; min-width: 12px; text-align: right; margin-right: 3px;} h4 { text-align: center; margin-bottom: 6px; font-size: 10pt; } </style> <h4>Frequência Mensal - Turma: ${sanitizeHTML(currentClass.name)} (${sanitizeHTML(currentClass.series || '')}) - ${monthName}/${year}</h4> <table class="pdf-table"> <thead> <tr> <th class="student-col">Aluno</th>`; for (let day = 1; day <= daysInMonth; day++) { tableHTML += `<th class="day-col">${day}</th>`; } tableHTML += `<th class="summary-col">P</th><th class="summary-col">F</th><th class="summary-col">FJ</th><th class="summary-col">H/S</th><th class="summary-col">%</th></tr></thead><tbody>`;
                 students.forEach(student => {
                     tableHTML += `<tr><td class="student-col"><span class="number">${student.number || '-.'}</span>${sanitizeHTML(student.name)}</td>`;
                     let studentP = 0, studentF = 0, studentFJ = 0, studentH = 0, studentS = 0, studentPossibleDays = 0;
                     for (let day = 1; day <= daysInMonth; day++) {
                         const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                         const attendanceRecord = student.attendance[dateStr];
                         const status = attendanceRecord?.status;
                         const justification = attendanceRecord?.justification || '';
                         const dayOfWeek = getDayOfWeek(year, month, day);
                         const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                         const isSuspended = isStudentSuspended(student.id, dateStr);
                         let cellContent = ''; let cellClass = 'day-col';

                         if (isWeekend) { cellClass += ' weekend'; }
                         else if (isSuspended) { cellContent = 'S'; cellClass += ' status-S'; studentS++; }
                         else if (status === 'H') { cellContent = 'H'; cellClass += ' status-H'; studentH++; }
                         else {
                             studentPossibleDays++;
                             if (status === 'P') { cellContent = 'P'; studentP++; }
                             else if (status === 'F') { if (justification) { cellContent = 'FJ'; studentFJ++; } else { cellContent = 'F'; studentF++; } }
                             else { cellContent = '-'; }
                         }
                         tableHTML += `<td class="${cellClass}">${cellContent}</td>`;
                     }
                     const frequency = studentPossibleDays > 0 ? ((studentP / studentPossibleDays) * 100).toFixed(0) : (students.length > 0 ? '0' : '-');
                     tableHTML += `<td class="summary-col">${studentP}</td>`;
                     tableHTML += `<td class="summary-col">${studentF}</td>`;
                     tableHTML += `<td class="summary-col">${studentFJ}</td>`;
                     tableHTML += `<td class="summary-col">${studentH + studentS}</td>`; // Soma Feriados e Suspensões
                     tableHTML += `<td class="summary-col">${frequency}${frequency !== '-' ? '%' : ''}</td>`;
                     tableHTML += `</tr>`;
                 });
                 tableHTML += `</tbody></table>`;

                 const opt = { margin: [5, 5, 5, 5], filename: filename, image: { type: 'jpeg', quality: 0.9 }, html2canvas: { scale: 2, useCORS: true, logging: false, }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }, pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } };

                 const originalButtonText = button.innerHTML;
                 button.disabled = true;
                 button.innerHTML = '<span class="icon">⏳</span>';

                 try {
                     console.log("Gerando PDF de frequência para download (Browser)...");
                     await html2pdf().set(opt).from(tableHTML).save();
                     console.log("PDF de frequência gerado com sucesso.");
                 } catch (error) {
                     console.error("Erro ao gerar PDF de frequência:", error);
                     alert("Ocorreu um erro ao gerar o PDF de frequência. Verifique o console para detalhes.");
                 } finally {
                     button.disabled = false;
                     button.innerHTML = originalButtonText;
                 }
             };

             const performSearch = (term) => { term = term.toLowerCase().trim(); if (!term) { hideModal(); return; } const results = { schools: [], classes: [], students: [] }; results.schools = appData.schools.filter(s => s.name.toLowerCase().includes(term)); results.classes = appData.classes.filter(c => c.name.toLowerCase().includes(term) || (c.subject && c.subject.toLowerCase().includes(term))); results.students = appData.students.filter(s => s.name.toLowerCase().includes(term) || (s.number && String(s.number) === term)); renderSearchResults(results, term); };
             const renderSearchResults = (results, term) => { let resultsHtml = `<p>Resultados para: <strong>${sanitizeHTML(term)}</strong></p><div class="item-list mt-1">`; let count = 0; const renderItem = (item, type, details = '') => { count++; const itemSchoolId = type === 'school' ? item.id : (item.schoolId || findClassById(item.classId)?.schoolId); const itemClassId = type === 'student' ? item.classId : (type === 'class' ? item.id : ''); return `<div class="list-item search-result-item" data-type="${type}" data-id="${item.id}" ${itemSchoolId ? `data-school-id="${itemSchoolId}"` : ''} ${itemClassId ? `data-class-id="${itemClassId}"` : ''}> <div class="item-info">${sanitizeHTML(item.name)} ${details ? `<small style='display:block; color: var(--text-secondary);'>${sanitizeHTML(details)}</small>` : ''}</div> <span class="result-type">${type.charAt(0).toUpperCase() + type.slice(1)}</span> </div>`; }; if (results.schools.length > 0) { resultsHtml += `<h5>Escolas</h5>`; results.schools.forEach(s => resultsHtml += renderItem(s, 'school')); } if (results.classes.length > 0) { resultsHtml += `<h5 class="mt-2">Turmas</h5>`; results.classes.forEach(c => { const school = findSchoolById(c.schoolId); resultsHtml += renderItem(c, 'class', `(${c.subject || 'N/A'}) - ${school?.name || '?'}`); }); } if (results.students.length > 0) { resultsHtml += `<h5 class="mt-2">Alunos</h5>`; results.students.forEach(s => { const cls = findClassById(s.classId); const school = findSchoolById(cls?.schoolId); resultsHtml += renderItem(s, 'student', `${s.number || '-'}. ${cls?.name || '?'} / ${school?.name || '?'}`); }); } if (count === 0) { resultsHtml += `<p style="text-align:center; padding: 1rem;">Nenhum resultado encontrado.</p>`; } resultsHtml += `</div>`; showModal(`Resultados da Busca`, resultsHtml, '', 'search-results-modal'); modalBody.querySelectorAll('.search-result-item').forEach(item => { item.addEventListener('click', () => { const type = item.dataset.type; const id = item.dataset.id; const classId = item.dataset.classId; const schoolId = item.dataset.schoolId; hideModal(); searchInput.value = ''; if (type === 'school') { selectSchool(id); showSection('classes-section'); } else if (type === 'class') { if(schoolId) selectSchool(schoolId); selectClass(id); showSection('class-details-section'); } else if (type === 'student') { if(schoolId) selectSchool(schoolId); if(classId) selectClass(classId); showSection('class-details-section'); setTimeout(() => { const studentElement = studentListContainer.querySelector(`.list-item[data-id="${id}"]`); studentElement?.scrollIntoView({ behavior: 'smooth', block: 'center' }); studentElement?.classList.add('active'); setTimeout(() => studentElement?.classList.remove('active'), 2000); }, 300); } }); }); };
             const toggleClassNotesEdit = (showEdit) => { classNotesDisplay.classList.toggle('hidden', showEdit); classNotesEdit.classList.toggle('hidden', !showEdit); if (showEdit) { const currentClass = findClassById(currentClassId); classNotesTextarea.value = currentClass?.notes || ''; classNotesTextarea.focus(); } };
             const saveClassNotes = () => { if(!currentClassId) return; const currentClass = findClassById(currentClassId); if(currentClass) { currentClass.notes = classNotesTextarea.value.trim(); classNotesContent.textContent = sanitizeHTML(currentClass.notes || 'Nenhuma anotação.'); saveData(); toggleClassNotesEdit(false); } };

             // Modificada para importar também dados compartilhados
             const importData = (event) => {
                 const file = event.target.files[0];
                 if (!file) return;
                 const reader = new FileReader();
                 reader.onload = (e) => {
                     let importedData;
                     try {
                         importedData = JSON.parse(e.target.result);
                     } catch (error) {
                         console.error("Erro ao analisar JSON importado:", error);
                         alert("Erro ao ler o arquivo JSON. Verifique se o formato está correto.");
                         return;
                     } finally {
                        event.target.value = null; // Reset file input
                     }

                     if (!importedData || typeof importedData !== 'object') {
                         alert("Erro: Arquivo JSON inválido ou vazio.");
                         return;
                     }

                     // Detectar tipo de importação
                     if (importedData.type === 'SuperProfessorPro_SchoolShare_v1') {
                         // É um arquivo de compartilhamento de escola
                         if (confirm("Você selecionou um arquivo de dados compartilhados de uma escola. Deseja mesclar esses dados com os seus?\n\n(Isso NÃO substituirá seus dados existentes, apenas adicionará ou atualizará informações específicas como presença, anotações e mapas das turmas/alunos contidos no arquivo.)")) {
                             importSharedSchoolData(importedData);
                         }
                     } else if (importedData.schools || importedData.classes || importedData.students) {
                         // Parece ser um backup completo
                         if (confirm("Você selecionou um arquivo de backup completo. Importar este arquivo substituirá TODOS os seus dados atuais (escolas, turmas, alunos, notas, frequência, configurações, etc.). Continuar?")) {
                             importFullBackupData(importedData);
                         }
                     } else {
                         alert("Erro: Formato de arquivo JSON não reconhecido.");
                     }
                 };
                 reader.readAsText(file);
             };

             // Função para importar Backup Completo
             const importFullBackupData = (importedData) => {
                  console.log("Iniciando importação de backup completo...");
                  try {
                        // Aplica e valida os dados (a lógica que já estava em loadData)
                         appData = {
                             schools: importedData.schools || [],
                             classes: importedData.classes || [],
                             students: importedData.students || [],
                             schedule: importedData.schedule || [],
                             gradeStructures: importedData.gradeStructures || [], // Importa estruturas globais
                             settings: importedData.settings || { theme: 'theme-light', globalNotificationsEnabled: true, notificationSoundEnabled: true, customNotificationSound: null }
                         };
                        // Validações e Padrões (essencial repetir aqui)
                        if (typeof appData.settings !== 'object' || appData.settings === null) appData.settings = {};
                        appData.settings.theme = appData.settings.theme || 'theme-light';
                        appData.settings.globalNotificationsEnabled = appData.settings.globalNotificationsEnabled !== undefined ? appData.settings.globalNotificationsEnabled : true;
                        appData.settings.notificationSoundEnabled = appData.settings.notificationSoundEnabled !== undefined ? appData.settings.notificationSoundEnabled : true;
                        appData.settings.customNotificationSound = appData.settings.customNotificationSound || null;
                        if (appData.settings.nonSchoolDays) delete appData.settings.nonSchoolDays;
                        if (appData.settings.customNotificationSound && typeof appData.settings.customNotificationSound === 'string' && !appData.settings.customNotificationSound.startsWith('data:audio')) {
                            appData.settings.customNotificationSound = null;
                            localStorage.removeItem('superProfessorPro_customSoundName');
                        }

                         // Validar e migrar estruturas internas se necessário (copiado de loadData)
                         appData.gradeStructures.forEach(gs => { // Valida estruturas importadas
                            gs.id = gs.id || generateId('gs');
                            gs.name = gs.name || 'Conjunto Sem Nome';
                            gs.subject = gs.subject || 'Geral';
                            gs.gradeLabels = gs.gradeLabels || [];
                            gs.colorRanges = gs.colorRanges || [];
                         });
                         appData.classes.forEach(c => {
                            c.id = c.id || generateId('cls');
                            c.notes = c.notes || '';
                            c.schoolId = c.schoolId || null;
                            c.series = c.series || '';
                            c.lessonPlans = c.lessonPlans || {};
                            if (c.gradeStructure) delete c.gradeStructure; // Remove o campo antigo se existir no backup
                            if (!c.classroomLayout) { c.classroomLayout = { rows: 5, cols: 6, teacherDeskPosition: 'top-center', seats: [] }; } else { c.classroomLayout.seats = c.classroomLayout.seats || []; const validPositions = ['top-left', 'top-center', 'top-right', 'bottom-left', 'bottom-center', 'bottom-right', 'left-top', 'left-center', 'left-bottom', 'right-top', 'right-center', 'right-bottom']; if (!validPositions.includes(c.classroomLayout.teacherDeskPosition)) { c.classroomLayout.teacherDeskPosition = 'top-center'; } }
                         });
                         appData.students.forEach(s => {
                            s.id = s.id || generateId('std');
                            s.grades = s.grades || {};
                            s.attendance = s.attendance || {};
                            Object.keys(s.attendance).forEach(date => { const record = s.attendance[date]; if (record && typeof record === 'object') { record.status = record.status || null; record.justification = String(record.justification || ''); } else { s.attendance[date] = { status: null, justification: '' }; } });
                            s.notes = s.notes || [];
                            s.notes.forEach(note => { // Garante formato das notas importadas
                                note.id = note.id || generateId('obs');
                                note.category = note.category || 'Anotação';
                                note.date = note.date || 'N/A';
                                note.text = note.text || '';
                             });
                         });
                         appData.schedule.forEach(item => {
                             item.id = item.id || generateId('sch');
                             if (item.notificationsEnabled === undefined) { item.notificationsEnabled = true; }
                         });

                         // Resetar estado atual e salvar
                         currentSchoolId = null;
                         currentClassId = null;
                         saveData(); // Salva os dados importados e validados

                         // Atualizar UI
                         applyTheme(appData.settings.theme);
                         updateNotificationSettingsUI();
                         updateCustomSoundUI();
                         restoreAppState();
                         renderSchoolList();
                         renderScheduleList();
                         // Limpar telas de turma/detalhes
                         classListContainer.innerHTML = '<p style="text-align: center; padding: 1rem;">Selecione escola.</p>';
                         studentListContainer.innerHTML = '<p style="text-align: center; padding: 1rem;">Selecione turma.</p>';
                         gradesTableContainer.innerHTML = '<p style="padding: 1rem; text-align: center;">Selecione conjunto.</p>';
                         attendanceTableContainer.innerHTML = '<p style="text-align: center; padding: 1rem;">Selecione data.</p>';
                         lessonPlanTextarea.value = '';
                         saveGradesButton.classList.add('hidden');
                         saveAttendanceButton.classList.add('hidden');
                         saveLessonPlanButton.classList.add('hidden');
                         attendanceActionsContainer.classList.add('hidden');
                         classroomContainerDisplay.innerHTML = '<p style="padding: 1rem; text-align: center; grid-column: 1 / -1; grid-row: 1 / -1;">Configure o mapa.</p>';

                         showSection(currentSection || 'schedule-section');
                         alert("Backup completo importado com sucesso!");

                     } catch (error) {
                         console.error("Erro ao processar backup completo:", error);
                         alert("Erro ao processar o arquivo de backup. Os dados podem estar corrompidos ou em formato antigo incompatível.");
                     }
             };

             // Função para importar Dados Compartilhados
             const importSharedSchoolData = (sharedData) => {
                  console.log("Iniciando importação de dados compartilhados...", sharedData);
                  let classesMerged = 0;
                  let studentsMerged = 0;
                  let attendanceMergedCount = 0;
                  let studentNotesMergedCount = 0;
                  let classNotesMergedCount = 0;
                  let mapsMergedCount = 0;

                  // 1. Mesclar Estruturas de Notas Globais (se presentes no compartilhado)
                  if (sharedData.gradeStructures && Array.isArray(sharedData.gradeStructures)) {
                    sharedData.gradeStructures.forEach(importedGs => {
                        if (!findGradeStructureById(importedGs.id)) { // Adiciona apenas se não existir
                            // Validar campos básicos antes de adicionar
                            importedGs.id = importedGs.id || generateId('gs'); // Garante ID
                            importedGs.name = importedGs.name || 'Conjunto Importado';
                            importedGs.subject = importedGs.subject || 'Geral';
                            importedGs.gradeLabels = importedGs.gradeLabels || [];
                            importedGs.colorRanges = importedGs.colorRanges || [];
                            appData.gradeStructures.push(importedGs);
                            console.log(`Estrutura de nota importada: ${importedGs.name}`);
                        } else {
                            console.log(`Estrutura de nota ${importedGs.id} já existe, pulando.`);
                             // Poderia adicionar lógica de mesclagem aqui se quisesse atualizar existentes
                        }
                    });
                  }


                  // 2. Mesclar Turmas
                  sharedData.classes.forEach(importedClass => {
                      let existingClass = findClassById(importedClass.id);
                      if (!existingClass) {
                          // Turma não existe, verificar se a escola existe no receptor pelo ID da escola (se presente)
                           // OU pelo nome da escola se não tiver ID no share
                           let targetSchoolId = null;
                           const importedSchoolInfo = sharedData.school;
                           if (importedSchoolInfo?.id) {
                               targetSchoolId = findSchoolById(importedSchoolInfo.id) ? importedSchoolInfo.id : null;
                           }
                           if (!targetSchoolId && importedSchoolInfo?.name) {
                               const foundSchool = appData.schools.find(s => s.name === importedSchoolInfo.name);
                               if(foundSchool) targetSchoolId = foundSchool.id;
                           }

                           if(targetSchoolId) {
                               // Escola encontrada, perguntar se adiciona a turma
                               if(confirm(`A turma "${importedClass.name}" não existe no seu app, mas a escola "${findSchoolById(targetSchoolId).name}" foi encontrada. Deseja adicionar esta turma à escola?`)) {
                                    const newClass = { ...importedClass };
                                    newClass.schoolId = targetSchoolId; // Associa à escola existente
                                    newClass.id = importedClass.id || generateId('cls'); // Garante ID
                                    newClass.subject = ''; // OMITE a matéria conforme solicitado
                                    newClass.series = newClass.series || ''; // Garante campo
                                    newClass.notes = newClass.notes || '';
                                    newClass.lessonPlans = newClass.lessonPlans || {};
                                    newClass.classroomLayout = newClass.classroomLayout || { rows: 5, cols: 6, teacherDeskPosition: 'top-center', seats: [] };
                                    appData.classes.push(newClass);
                                    classesMerged++;
                                    console.log(`Turma "${newClass.name}" importada e adicionada à escola "${findSchoolById(targetSchoolId).name}".`);
                               } else {
                                    console.log(`Usuário optou por não adicionar a turma "${importedClass.name}".`);
                               }
                           } else {
                               console.log(`Escola da turma importada "${importedClass.name}" não encontrada no app receptor. Pulando turma.`);
                           }

                      } else {
                           // Turma existe, mesclar dados SE presentes no importado
                           console.log(`Mesclando dados para turma existente: ${existingClass.name}`);
                           // NÃO MISTURA A MATÉRIA (subject)
                           if (importedClass.notes !== undefined) {
                               existingClass.notes = importedClass.notes; // Sobrescreve anotações da turma
                               classNotesMergedCount++;
                           }
                           if (importedClass.classroomLayout !== undefined) {
                                // Validação básica do layout importado
                                if(importedClass.classroomLayout.rows && importedClass.classroomLayout.cols && importedClass.classroomLayout.teacherDeskPosition) {
                                    existingClass.classroomLayout = importedClass.classroomLayout; // Sobrescreve mapa
                                    mapsMergedCount++;
                                } else {
                                    console.warn("Layout de sala importado inválido, ignorando.");
                                }
                           }
                           // Atualizar outros campos se necessário (nome, série, turno, horário)? Por enquanto, não.
                           classesMerged++;
                      }
                  });

                  // 3. Mesclar Alunos (APENAS para turmas que agora existem no receptor)
                  sharedData.students.forEach(importedStudent => {
                       let existingStudent = findStudentById(importedStudent.id);
                       const targetClass = findClassById(importedStudent.classId); // Verifica se a turma do aluno existe AGORA no receptor

                       if (!targetClass) {
                            console.log(`Turma ${importedStudent.classId} do aluno importado ${importedStudent.name} não existe ou não foi importada. Pulando aluno.`);
                            return; // Pula para o próximo aluno
                       }

                       if (!existingStudent) {
                           // Aluno não existe, mas a turma sim. Perguntar se quer adicionar?
                            if(confirm(`Aluno "${importedStudent.name}" (ID: ${importedStudent.id}) não existe na turma "${targetClass.name}". Deseja adicioná-lo?`)) {
                                const newStudent = { ...importedStudent };
                                newStudent.id = importedStudent.id || generateId('std'); // Usa ID importado ou gera novo
                                newStudent.grades = {}; // Notas NÃO são compartilhadas neste fluxo
                                newStudent.attendance = newStudent.attendance || {}; // Mantém presença se veio
                                newStudent.notes = newStudent.notes || []; // Mantém notas se veio
                                // Validar formato das notas importadas
                                 newStudent.notes.forEach(note => {
                                     note.id = note.id || generateId('obs');
                                     note.category = note.category || 'Anotação';
                                     note.date = note.date || 'N/A';
                                     note.text = note.text || '';
                                     if(note.category !== 'Suspensão') { delete note.startDate; delete note.endDate;}
                                 });
                                appData.students.push(newStudent);
                                studentsMerged++;
                                console.log(`Aluno "${newStudent.name}" importado e adicionado à turma "${targetClass.name}".`);
                                // Contabilizar dados mesclados para este novo aluno
                                if(newStudent.attendance) attendanceMergedCount += Object.keys(newStudent.attendance).length;
                                if(newStudent.notes) studentNotesMergedCount++;


                            } else {
                                console.log(`Usuário optou por não adicionar o aluno "${importedStudent.name}".`);
                            }
                       } else {
                           // Aluno existe E a turma dele existe, mesclar dados SE presentes
                           console.log(`Mesclando dados para aluno existente: ${existingStudent.name}`);
                            // Garante que o aluno esteja associado à turma correta (caso tenha sido movido antes)
                           existingStudent.classId = targetClass.id;

                           if (importedStudent.notes && Array.isArray(importedStudent.notes)) {
                                // Estratégia de mesclagem de notas: Adiciona notas importadas se não houver uma com o mesmo ID.
                                importedStudent.notes.forEach(importedNote => {
                                    const existingNoteIndex = existingStudent.notes.findIndex(n => n.id === importedNote.id);
                                    importedNote.id = importedNote.id || generateId('obs'); // Garante ID
                                    importedNote.category = importedNote.category || 'Anotação';
                                    importedNote.date = importedNote.date || 'N/A';
                                    importedNote.text = importedNote.text || '';
                                    if(importedNote.category !== 'Suspensão') { delete importedNote.startDate; delete importedNote.endDate;}

                                    if (existingNoteIndex === -1) {
                                        existingStudent.notes.push(importedNote); // Adiciona nova nota
                                    } else {
                                         // Nota com mesmo ID existe, sobrescrever? Ou manter a mais recente?
                                         // Simples: sobrescreve com a importada.
                                         existingStudent.notes[existingNoteIndex] = importedNote;
                                    }
                                });
                                studentNotesMergedCount++; // Conta como 1 merge por aluno com notas
                           }
                           if (importedStudent.attendance && typeof importedStudent.attendance === 'object') {
                                // Mescla presença: adiciona/sobrescreve apenas as datas do arquivo importado
                                Object.keys(importedStudent.attendance).forEach(date => {
                                    // Valida o registro importado
                                    const record = importedStudent.attendance[date];
                                    if(record && typeof record === 'object') {
                                       existingStudent.attendance[date] = {
                                           status: record.status || null,
                                           justification: String(record.justification || '')
                                       };
                                       attendanceMergedCount++;
                                    }
                                });
                           }
                           studentsMerged++;
                       }
                  });

                  // 4. Salvar e Atualizar UI
                  if (classesMerged > 0 || studentsMerged > 0) {
                     saveData();
                     alert(`Dados compartilhados mesclados:\n- ${classesMerged} Turma(s) atualizada(s)/adicionada(s)\n- ${studentsMerged} Aluno(s) atualizado(s)/adicionado(s)\n(Presença: ${attendanceMergedCount} registros, Anot. Aluno: ${studentNotesMergedCount}, Anot. Turma: ${classNotesMergedCount}, Mapas: ${mapsMergedCount})`);
                     // Re-renderizar se estiver na tela certa
                     if (currentClassId && findClassById(currentClassId)) {
                         selectClass(currentClassId, true); // Força recarga da tela de detalhes
                     } else if (currentSchoolId && findSchoolById(currentSchoolId)) {
                         renderClassList(currentSchoolId); // Atualiza lista de turmas
                     } else {
                        renderSchoolList(); // Atualiza lista de escolas caso uma nova tenha sido criada (embora não implementado acima)
                     }
                  } else {
                     alert("Nenhum dado correspondente encontrado ou adicionado para mesclar.");
                  }

             };

            // --- Funções do Boletim ---
             const openStudentReportCardModal = (studentId) => {
                const student = findStudentById(studentId);
                const currentClass = findClassById(student?.classId);
                if (!student || !currentClass) {
                    alert("Aluno ou turma não encontrados.");
                    return;
                }

                const title = `Boletim - ${student.number || 'S/N'}. ${sanitizeHTML(student.name)}`;
                let modalContent = `<p><strong>Turma:</strong> ${sanitizeHTML(currentClass.name)} (${sanitizeHTML(currentClass.series || 'Série não informada')})</p>`;
                let reportHtml = '<p style="text-align: center; padding: 1rem;">Nenhuma nota registrada para este aluno.</p>';
                let tableContent = '';

                const gradesBySubject = {};

                // Agrupar estruturas e notas por matéria
                appData.gradeStructures.forEach(gs => {
                    if (student.grades[gs.id]) { // Verifica se há nota para esta estrutura
                        const subject = gs.subject || 'Outras'; // Agrupa sem matéria em 'Outras'
                        if (!gradesBySubject[subject]) {
                            gradesBySubject[subject] = [];
                        }
                        gradesBySubject[subject].push({
                            structureName: gs.name,
                            sum: student.grades[gs.id].sum,
                            average: student.grades[gs.id].average,
                            colorRanges: gs.colorRanges || [] // Passa as faixas de cores
                        });
                    }
                });

                const sortedSubjects = Object.keys(gradesBySubject).sort((a, b) => a.localeCompare(b));

                if (sortedSubjects.length > 0) {
                    tableContent += '<table class="report-card-table">';
                    tableContent += '<thead><tr><th>Conjunto/Período</th><th>Soma</th><th>Média</th></tr></thead><tbody>';

                    sortedSubjects.forEach(subject => {
                        // Linha de Cabeçalho da Matéria
                        tableContent += `<tr class="subject-header"><td colspan="3">${sanitizeHTML(subject)}</td></tr>`;

                        // Ordenar conjuntos dentro da matéria pelo nome
                        gradesBySubject[subject].sort((a, b) => a.structureName.localeCompare(b.structureName));

                        // Linhas dos Conjuntos/Períodos
                        gradesBySubject[subject].forEach(item => {
                             const avg = item.average;
                             const sum = item.sum;
                             const avgFormatted = avg !== null ? avg.toFixed(1).replace('.', ',') : '--';
                             const sumFormatted = sum !== null ? sum.toFixed(1).replace('.', ',') : '--';
                             // Aplicar cor à célula da média
                             const avgCellStyle = getGradeBackgroundColor(avg, item.colorRanges)
                                ? `style="background-color: ${getGradeBackgroundColor(avg, item.colorRanges)}; color: ${getContrastYIQ(getGradeBackgroundColor(avg, item.colorRanges))}"`
                                : '';

                             tableContent += `
                                <tr>
                                    <td>${sanitizeHTML(item.structureName)}</td>
                                    <td class="grade-sum">${sumFormatted}</td>
                                    <td class="grade-average" ${avgCellStyle}>${avgFormatted}</td>
                                </tr>
                            `;
                        });
                    });

                    tableContent += '</tbody></table>';
                    reportHtml = tableContent;
                }

                modalContent += reportHtml;
                 // Adiciona botão de exportar PDF ao footer do modal
                 const footerButtons = `
                     <button type="button" id="export-report-card-pdf" class="secondary icon-button" title="Gerar PDF do Boletim">
                         <span class="icon icon-pdf"></span> Gerar PDF
                     </button>
                 `;

                showModal(title, modalContent, footerButtons, 'student-report-card-modal');

                 // Adiciona listener ao botão de exportar PDF do boletim
                 const exportButton = document.getElementById('export-report-card-pdf');
                 if(exportButton) {
                     exportButton.onclick = () => exportStudentReportCardPDF(studentId, student.name, currentClass.name);
                     // Desabilita se estiver em webview (após modal ser mostrado)
                     if (isAndroidWebView()) {
                        exportButton.disabled = true;
                        exportButton.title = "PDF Indisponível no App";
                     }
                 } else {
                    console.warn("Botão de exportar boletim não encontrado no modal.");
                 }
            };

            // --- FUNÇÃO PARA EXPORTAR BOLETIM PDF ---
             const exportStudentReportCardPDF = async (studentId, studentName, className) => {
                 const student = findStudentById(studentId);
                 const currentClass = findClassById(student?.classId);
                 if (!student || !currentClass) { alert("Aluno ou turma não encontrados."); return; }

                 if (isAndroidWebView()) {
                     alert("Exportação de PDF não suportada diretamente no app. Use a versão web.");
                     return; // Aborta no WebView
                 }

                 const button = document.getElementById('export-report-card-pdf'); // Botão dentro do modal
                 const originalButtonHTML = button ? button.innerHTML : '<span class="icon icon-pdf"></span> Gerar PDF'; // Guarda HTML original
                 if (button) {
                     button.disabled = true;
                     button.innerHTML = '<span class="icon">⏳</span> Gerando...';
                 }

                 // 1. Gerar o HTML do Boletim (similar ao do modal, mas talvez mais formatado para PDF)
                 let reportHtmlContent = `
                     <style>
                         body { font-family: sans-serif; font-size: 10pt; margin: 20px; }
                         h2, h3 { text-align: center; margin-bottom: 5px; }
                         h3 { font-size: 1.1em; margin-bottom: 15px; }
                         table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 9pt; }
                         th, td { border: 1px solid #ccc; padding: 5px 7px; text-align: left; }
                         th { background-color: #f2f2f2; font-weight: bold; text-align: center; }
                         .subject-header td { background-color: #e9ecef; font-weight: bold; color: #0056b3; padding-top: 8px; border-top: 2px solid #ccc; }
                         td.grade-sum, td.grade-average { text-align: center; }
                         td.grade-average { font-weight: bold; }
                     </style>
                     <h2>Boletim do Aluno</h2>
                     <h3>${sanitizeHTML(student.name)} (#${student.number || 'S/N'})</h3>
                     <p style="text-align:center; font-size: 9pt; margin-bottom: 15px;">Turma: ${sanitizeHTML(currentClass.name)} (${sanitizeHTML(currentClass.series || 'Série N/A')})</p>
                 `;

                 const gradesBySubject = {};
                 appData.gradeStructures.forEach(gs => {
                     if (student.grades[gs.id]) {
                         const subject = gs.subject || 'Outras';
                         if (!gradesBySubject[subject]) gradesBySubject[subject] = [];
                         gradesBySubject[subject].push({
                             structureName: gs.name,
                             sum: student.grades[gs.id].sum,
                             average: student.grades[gs.id].average,
                             colorRanges: gs.colorRanges || []
                         });
                     }
                 });
                 const sortedSubjects = Object.keys(gradesBySubject).sort((a, b) => a.localeCompare(b));

                 if (sortedSubjects.length > 0) {
                     reportHtmlContent += '<table><thead><tr><th>Conjunto/Período</th><th>Soma</th><th>Média</th></tr></thead><tbody>';
                     sortedSubjects.forEach(subject => {
                         reportHtmlContent += `<tr class="subject-header"><td colspan="3">${sanitizeHTML(subject)}</td></tr>`;
                         gradesBySubject[subject].sort((a, b) => a.structureName.localeCompare(b.structureName));
                         gradesBySubject[subject].forEach(item => {
                             const avg = item.average;
                             const sum = item.sum;
                             const avgFormatted = avg !== null ? avg.toFixed(1).replace('.', ',') : '--';
                             const sumFormatted = sum !== null ? sum.toFixed(1).replace('.', ',') : '--';
                             // Aplicar cor à célula da média no PDF
                             const avgCellStyle = getGradeBackgroundColor(avg, item.colorRanges)
                                ? `style="background-color: ${getGradeBackgroundColor(avg, item.colorRanges)}; color: ${getContrastYIQ(getGradeBackgroundColor(avg, item.colorRanges))};"`
                                : '';
                             reportHtmlContent += `<tr><td>${sanitizeHTML(item.structureName)}</td><td class="grade-sum">${sumFormatted}</td><td class="grade-average" ${avgCellStyle}>${avgFormatted}</td></tr>`;
                         });
                     });
                     reportHtmlContent += '</tbody></table>';
                 } else {
                     reportHtmlContent += '<p style="text-align: center; padding: 1rem;">Nenhuma nota registrada.</p>';
                 }

                 // 2. Configurar opções do html2pdf
                 const safeStudentName = student.name.replace(/[^a-z0-9]/gi, '_');
                 const safeClassName = currentClass.name.replace(/[^a-z0-9]/gi, '_');
                 const filename = `boletim_${safeStudentName}_${safeClassName}.pdf`;
                 const opt = {
                     margin: 15,
                     filename: filename,
                     image: { type: 'jpeg', quality: 0.95 },
                     html2canvas: { scale: 2, useCORS: true, logging: false },
                     jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } // Portrait para boletim
                 };

                 // 3. Gerar e salvar o PDF
                 try {
                     console.log("Gerando PDF do Boletim...");
                     await html2pdf().set(opt).from(reportHtmlContent).save();
                     console.log("PDF do Boletim gerado com sucesso.");
                 } catch (error) {
                     console.error("Erro ao gerar PDF do Boletim:", error);
                     alert("Ocorreu um erro ao gerar o PDF do Boletim.");
                 } finally {
                     if (button) {
                         button.disabled = false;
                         button.innerHTML = originalButtonHTML; // Restaura HTML original
                     }
                 }
             };

            // --- Funções de CRUD (Existentes, com modificações e adições) ---
            // ... (openScheduleModal, saveScheduleEntry, deleteScheduleEntry, toggleScheduleNotification) ...
            // ... (openSchoolModal, saveSchool, deleteSchool, selectSchool) ...
             // ... (openClassModal, saveClass, deleteClass, selectClass - JÁ MODIFICADAS ACIMA) ...
             // ... (openStudentModal, saveStudent, deleteStudent - JÁ MODIFICADAS ACIMA com botão boletim) ...
             // ... (openStudentNotesModal, renderStudentObservations, addStudentObservation, editStudentObservation, deleteStudentObservation, isStudentSuspended - JÁ MODIFICADAS ACIMA) ...
             // ... (openMoveStudentModal, confirmMoveStudent) ...
             // ... (openGradeStructureModal, setupGradeStructureModalListeners, handleGradeStructureClicks, addGradeSet, saveGradeStructure - JÁ MODIFICADAS ACIMA) ...
             // ... (saveGrades - JÁ MODIFICADA ACIMA) ...
             // ... (escapeCsvField - JÁ EXISTE) ...
             // ... (exportGradesCSV, exportGradesPDF, saveAttendance, openJustificationModal, saveLessonPlan - JÁ MODIFICADAS ACIMA) ...
             // ... (openMonthlyAttendanceModal, renderMonthlyAttendanceData, renderMonthlyAttendanceChart, exportMonthlyAttendanceCSV, exportMonthlyAttendancePDF - JÁ MODIFICADAS ACIMA) ...
             // ... (performSearch, renderSearchResults, toggleClassNotesEdit, saveClassNotes - JÁ EXISTEM) ...
             // ... (exportData, importData, importFullBackupData, importSharedSchoolData - JÁ MODIFICADAS ACIMA) ...
             // ... (toggleCardCollapse) ...
             // ... (Funções das Ferramentas: Name Sorter, Stopwatch, Group Generator, Calculator - JÁ EXISTEM) ...
             // ... (shareApp - JÁ ADICIONADA) ...


            // --- Event Listeners Globais ---
            navButtons.forEach(button => { button.addEventListener('click', () => { const targetSection = button.dataset.section; if (button.disabled) return; showSection(targetSection); }); });
            addScheduleButton.addEventListener('click', () => openScheduleModal());
            addSchoolButton.addEventListener('click', () => openSchoolModal());
            addClassButton.addEventListener('click', () => { if(currentSchoolId) openClassModal(); else alert("Selecione uma escola primeiro!"); });
            backToSchoolsButton.addEventListener('click', () => { currentSchoolId = null; currentClassId = null; showSection('schools-section'); });
            backToClassesButton.addEventListener('click', () => { if (tempClassroomLayout) { cancelClassroomMapEdit(); } currentClassId = null; navDetailsButton.disabled = true; showSection('classes-section'); renderClassList(currentSchoolId); }); // Volta para lista de turmas
             // Combinado
             const combinedModalCloseHandler = (e) => {
                 const targetModal = e.currentTarget;
                 if (e.target === targetModal || e.target.closest('.close-button[data-dismiss="modal"]') || e.target.matches('button[data-dismiss="modal"]')) {
                     if (targetModal.id === 'generic-modal' && targetModal.querySelector('.timer-modal .modal-content')) { pauseStopwatch(); }
                     hideModal();
                 }
             };
            modal.addEventListener('click', combinedModalCloseHandler);
            calculatorModal.addEventListener('click', combinedModalCloseHandler);

            document.getElementById('add-student-button').addEventListener('click', () => { if(currentClassId) openStudentModal(); else alert("Selecione uma turma primeiro!"); });
             // Adiciona listeners aos novos selects de notas
             gradesSubjectSelect?.addEventListener('change', () => { /* Lógica já está no onchange em renderGradeSets */ });
             gradeSetSelect?.addEventListener('change', () => { /* Lógica já está no onchange em renderGradeSets */ });
             manageGradeStructureButton.addEventListener('click', openGradeStructureModal);
             saveGradesButton.addEventListener('click', saveGrades);
              // Listeners dos botões de exportação principais (CSV/PDF de notas)
             exportGradesCsvButton?.addEventListener('click', exportGradesCSV);
             exportGradesPdfButton?.addEventListener('click', () => exportGradesPDF(exportGradesPdfButton)); // Passa o botão para feedback

            attendanceDateInput.addEventListener('change', (e) => { if(currentClassId) { renderAttendanceTable(currentClassId, e.target.value); } });
            markAllPresentButton.addEventListener('click', markAllStudentsPresent);
            markNonSchoolDayButton.addEventListener('click', toggleNonSchoolDay);
            lessonPlanDateInput.addEventListener('change', (e) => { if(currentClassId) { renderLessonPlan(currentClassId, e.target.value); } });
            saveLessonPlanButton.addEventListener('click', saveLessonPlan);
            saveAttendanceButton.addEventListener('click', saveAttendance);
            viewMonthlyAttendanceButton.addEventListener('click', openMonthlyAttendanceModal);
            editClassNotesButton.addEventListener('click', () => toggleClassNotesEdit(true));
            saveClassNotesButton.addEventListener('click', saveClassNotes);
            cancelClassNotesButton.addEventListener('click', () => toggleClassNotesEdit(false));
            document.querySelectorAll('.theme-button').forEach(button => { button.addEventListener('click', () => {applyTheme(button.dataset.theme); saveData();}); });
             exportDataButton.addEventListener('click', exportData); // Modificado para ter fallback WebView
             document.getElementById('import-data-input').addEventListener('change', importData); // Modificado para detectar tipo
             document.getElementById('clear-data-button').addEventListener('click', clearAllData);
             searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { performSearch(searchInput.value); } });
             searchInput.addEventListener('input', () => { /* No dynamic search */ });
             searchInput.addEventListener('search', () => { if (!searchInput.value) { hideModal(); } });
             notificationCloseButton?.addEventListener('click', hideNotification);
             enableGlobalNotificationsCheckbox?.addEventListener('change', (e) => { appData.settings.globalNotificationsEnabled = e.target.checked; enableNotificationSoundCheckbox.disabled = !e.target.checked; if (!e.target.checked) { stopNotificationChecker(); hideNotification(); } else { startNotificationChecker(); } saveData(); });
             enableNotificationSoundCheckbox?.addEventListener('change', (e) => { appData.settings.notificationSoundEnabled = e.target.checked; saveData(); });
             customNotificationSoundInput?.addEventListener('change', handleCustomSoundUpload);
             removeCustomSoundButton?.addEventListener('click', removeCustomSound);
             editMapButton.addEventListener('click', editClassroomMap);
             cancelMapEditButton.addEventListener('click', cancelClassroomMapEdit);
             saveMapButton.addEventListener('click', saveClassroomLayout);
             unassignedStudentsContainer.addEventListener('dragover', handleDragOver);
             unassignedStudentsContainer.addEventListener('dragleave', handleDragLeave);
             unassignedStudentsContainer.addEventListener('drop', handleDropOnUnassignedList);
             classDetailsSection.addEventListener('click', (e) => { const toggleButton = e.target.closest('.card-toggle-button'); if (toggleButton) { toggleCardCollapse(toggleButton); } });
             // Listener for Tools Grid
             toolsGrid?.addEventListener('click', (e) => {
                 const toolCard = e.target.closest('.tool-card');
                 if (toolCard && toolCard.dataset.tool) {
                     const toolType = toolCard.dataset.tool;
                     openToolModal(toolType); // Use the generalized opener
                 }
             });

             // Listener para o botão de compartilhar app (adicione um botão com id="share-app-button" onde quiser)
             const shareAppButton = document.getElementById('share-app-button'); // Procure por este ID
             if(shareAppButton) {
                shareAppButton.addEventListener('click', shareApp);
             } else {
                // Adiciona um botão de compartilhar em Contato & Apoio como exemplo, se não existir
                 const contactCard = document.querySelector('#contact-section .card');
                 if(contactCard && !document.getElementById('share-app-button')) {
                    const shareButton = document.createElement('button');
                     shareButton.id = 'share-app-button';
                     shareButton.className = 'button-like secondary mt-2 w-100';
                     shareButton.innerHTML = '<span class="icon icon-share-app"></span> Compartilhar App com Colegas';
                     shareButton.addEventListener('click', shareApp);
                     contactCard.appendChild(shareButton);
                 }
             }


             window.addEventListener('beforeunload', saveAppState);

            // --- Inicialização ---
            //loadData(); // Carrega e migra dados se necessário
            //restoreAppState(); // Restaura último estado de navegação
            //renderScheduleList(); // Renderiza horários com nova ordenação
            //renderSchoolList(); // Renderiza escolas com botão de compartilhar
            const todayStr = getCurrentDateString();
            if (attendanceDateInput) attendanceDateInput.value = todayStr;
            if (lessonPlanDateInput) lessonPlanDateInput.value = todayStr;
            // Renderiza lista de turmas ou detalhes se aplicável
            //if (currentSection === 'classes-section' && currentSchoolId) { renderClassList(currentSchoolId); }
            //else if (currentSection === 'class-details-section' && currentClassId) { selectClass(currentClassId, true); } // Força recarga para aplicar novas lógicas
             //else { showSection('schedule-section'); } // Garante que uma seção seja mostrada

            //if (appData.settings.globalNotificationsEnabled) { startNotificationChecker(); }
            //updateCustomSoundUI();

             // Update export button titles/text if in WebView AFTER elements are potentially rendered
             // Moved inside a small timeout to ensure dynamic buttons are potentially ready
             setTimeout(() => {
                if (isAndroidWebView()) {
                    if(exportDataButton) { exportDataButton.title = "Copiar Backup JSON"; exportDataButton.innerHTML = '<span class="icon icon-copiar"></span> Copiar Backup (JSON)'; }
                    if(exportGradesCsvButton) exportGradesCsvButton.title = "Copiar Notas (CSV)";
                    if(exportGradesPdfButton) { exportGradesPdfButton.title = "PDF Indisponível no App"; exportGradesPdfButton.disabled = true; } // Desabilita PDF
                    const monthlyCsvBtn = document.getElementById('export-attendance-csv-button'); // Re-seleciona caso modal esteja aberto
                    const monthlyPdfBtn = document.getElementById('export-attendance-pdf-button');
                    if(monthlyCsvBtn) monthlyCsvBtn.title = "Copiar Frequência (CSV)";
                    if(monthlyPdfBtn) { monthlyPdfBtn.title = "PDF Indisponível no App"; monthlyPdfBtn.disabled = true; }
                     // Desabilitar botão PDF do boletim se estiver no webview
                     const reportPdfBtn = document.getElementById('export-report-card-pdf'); // Pode não existir ainda
                     if (reportPdfBtn) { reportPdfBtn.disabled = true; reportPdfBtn.title = "PDF Indisponível no App"; }
                     // Atualizar botão de compartilhar dados da escola
                      // Note: Este botão é adicionado dinamicamente, então precisamos ter certeza que ele existe
                      document.querySelectorAll('.share-school-button').forEach(btn => {
                         btn.title = "Copiar Dados da Escola (JSON)";
                         btn.innerHTML = '<span class="icon icon-copiar"></span>'; // Mudar ícone para copiar
                      });

                }
            }, 100); // Pequeno delay para garantir que a UI inicializou

        }); // --- FIM DO DOMContentLoaded ---

        /*// --- Service Worker Registration --- (Corretamente fora do DOMContentLoaded)
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            // Confirme se o caminho está EXATAMENTE correto!
            navigator.serviceWorker.register('/super_professor-pro/pwabuilder-sw.js')
              .then(registration => {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
              })
              .catch(err => {
                console.log('ServiceWorker registration failed: ', err);
              });
          });
        }*/
    </script>

</body>
</html>
